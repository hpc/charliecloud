

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4. Frequently asked questions (FAQ) &mdash; Charliecloud 0.14~pre+webdocs.1fb5d18 documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="5. Contributor’s guide" href="dev.html" />
    <link rel="prev" title="3. Charliecloud command reference" href="command-usage.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Charliecloud
          

          
            
            <img src="_static/logo-sidebar.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.14~pre+webdocs.1fb5d18
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">1. Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">2. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="command-usage.html">3. Charliecloud command reference</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">4. Frequently asked questions (FAQ)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#about-the-project">4.1. About the project</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#where-did-the-name-charliecloud-come-from">4.1.1. Where did the name Charliecloud come from?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-you-spell-charliecloud">4.1.2. How do you spell Charliecloud?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#errors">4.2. Errors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-read-the-ch-run-error-messages">4.2.1. How do I read the <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> error messages?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tarball-build-fails-with-no-command-specified">4.2.2. Tarball build fails with “No command specified”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ch-run-fails-with-can-t-re-mount-image-read-only">4.2.3. <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> fails with “can’t re-mount image read-only”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#unexpected-behavior">4.3. Unexpected behavior</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-do-the-version-numbers-mean">4.3.1. What do the version numbers mean?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#uid-0-lets-me-read-files-i-cant-otherwise">4.3.2. <code class="code docutils literal notranslate"><span class="pre">--uid</span> <span class="pre">0</span></code> lets me read files I can’t otherwise!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#why-does-ping-not-work">4.3.3. Why does <code class="code docutils literal notranslate"><span class="pre">ping</span></code> not work?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#why-is-matlab-trying-and-failing-to-change-the-group-of-dev-pts-0">4.3.4. Why is MATLAB trying and failing to change the group of <code class="code docutils literal notranslate"><span class="pre">/dev/pts/0</span></code>?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ch-builder2tar-gives-incorrect-image-sizes">4.3.5. <code class="code docutils literal notranslate"><span class="pre">ch-builder2tar</span></code> gives incorrect image sizes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#my-second-level-directory-dev-is-empty">4.3.6. My second-level directory <code class="code docutils literal notranslate"><span class="pre">dev</span></code> is empty</a></li>
<li class="toctree-l3"><a class="reference internal" href="#my-password-that-contains-digits-doesn-t-work-in-virtualbox-console">4.3.7. My password that contains digits doesn’t work in VirtualBox console</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-do-i">4.4. How do I ...</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#my-app-needs-to-write-to-var-log-run-etc">4.4.1. My app needs to write to <code class="code docutils literal notranslate"><span class="pre">/var/log</span></code>, <code class="code docutils literal notranslate"><span class="pre">/run</span></code>, etc.</a></li>
<li class="toctree-l3"><a class="reference internal" href="#which-specific-sudo-commands-are-needed">4.4.2. Which specific <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> commands are needed?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#openmpi-charliecloud-jobs-dont-work">4.4.3. OpenMPI Charliecloud jobs don’t work</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mpirun-cant-launch-jobs">4.4.3.1. <code class="code docutils literal notranslate"><span class="pre">mpirun</span></code> can’t launch jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#communication-between-ranks-on-the-same-node-fails">4.4.3.2. Communication between ranks on the same node fails</a></li>
<li class="toctree-l4"><a class="reference internal" href="#i-get-a-bunch-of-independent-rank-0-processes-when-launching-with-srun">4.4.3.3. I get a bunch of independent rank-0 processes when launching with <code class="code docutils literal notranslate"><span class="pre">srun</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-run-x11-apps">4.4.4. How do I run X11 apps?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="dev.html">5. Contributor’s guide</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Charliecloud</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>4. Frequently asked questions (FAQ)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="frequently-asked-questions-faq">
<h1>4. Frequently asked questions (FAQ)<a class="headerlink" href="#frequently-asked-questions-faq" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#about-the-project" id="id1">About the project</a><ul>
<li><a class="reference internal" href="#where-did-the-name-charliecloud-come-from" id="id2">Where did the name Charliecloud come from?</a></li>
<li><a class="reference internal" href="#how-do-you-spell-charliecloud" id="id3">How do you spell Charliecloud?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#errors" id="id4">Errors</a><ul>
<li><a class="reference internal" href="#how-do-i-read-the-ch-run-error-messages" id="id5">How do I read the <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> error messages?</a></li>
<li><a class="reference internal" href="#tarball-build-fails-with-no-command-specified" id="id6">Tarball build fails with “No command specified”</a></li>
<li><a class="reference internal" href="#ch-run-fails-with-can-t-re-mount-image-read-only" id="id7"><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> fails with “can’t re-mount image read-only”</a></li>
</ul>
</li>
<li><a class="reference internal" href="#unexpected-behavior" id="id8">Unexpected behavior</a><ul>
<li><a class="reference internal" href="#what-do-the-version-numbers-mean" id="id9">What do the version numbers mean?</a></li>
<li><a class="reference internal" href="#uid-0-lets-me-read-files-i-cant-otherwise" id="id10"><code class="code docutils literal notranslate"><span class="pre">--uid</span> <span class="pre">0</span></code> lets me read files I can’t otherwise!</a></li>
<li><a class="reference internal" href="#why-does-ping-not-work" id="id11">Why does <code class="code docutils literal notranslate"><span class="pre">ping</span></code> not work?</a></li>
<li><a class="reference internal" href="#why-is-matlab-trying-and-failing-to-change-the-group-of-dev-pts-0" id="id12">Why is MATLAB trying and failing to change the group of <code class="code docutils literal notranslate"><span class="pre">/dev/pts/0</span></code>?</a></li>
<li><a class="reference internal" href="#ch-builder2tar-gives-incorrect-image-sizes" id="id13"><code class="code docutils literal notranslate"><span class="pre">ch-builder2tar</span></code> gives incorrect image sizes</a></li>
<li><a class="reference internal" href="#my-second-level-directory-dev-is-empty" id="id14">My second-level directory <code class="code docutils literal notranslate"><span class="pre">dev</span></code> is empty</a></li>
<li><a class="reference internal" href="#my-password-that-contains-digits-doesn-t-work-in-virtualbox-console" id="id15">My password that contains digits doesn’t work in VirtualBox console</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-do-i" id="id16">How do I ...</a><ul>
<li><a class="reference internal" href="#my-app-needs-to-write-to-var-log-run-etc" id="id17">My app needs to write to <code class="code docutils literal notranslate"><span class="pre">/var/log</span></code>, <code class="code docutils literal notranslate"><span class="pre">/run</span></code>, etc.</a></li>
<li><a class="reference internal" href="#which-specific-sudo-commands-are-needed" id="id18">Which specific <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> commands are needed?</a></li>
<li><a class="reference internal" href="#openmpi-charliecloud-jobs-dont-work" id="id19">OpenMPI Charliecloud jobs don’t work</a><ul>
<li><a class="reference internal" href="#mpirun-cant-launch-jobs" id="id20"><code class="code docutils literal notranslate"><span class="pre">mpirun</span></code> can’t launch jobs</a></li>
<li><a class="reference internal" href="#communication-between-ranks-on-the-same-node-fails" id="id21">Communication between ranks on the same node fails</a></li>
<li><a class="reference internal" href="#i-get-a-bunch-of-independent-rank-0-processes-when-launching-with-srun" id="id22">I get a bunch of independent rank-0 processes when launching with <code class="code docutils literal notranslate"><span class="pre">srun</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-do-i-run-x11-apps" id="id23">How do I run X11 apps?</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="about-the-project">
<h2><a class="toc-backref" href="#id1">4.1. About the project</a><a class="headerlink" href="#about-the-project" title="Permalink to this headline">¶</a></h2>
<div class="section" id="where-did-the-name-charliecloud-come-from">
<h3><a class="toc-backref" href="#id2">4.1.1. Where did the name Charliecloud come from?</a><a class="headerlink" href="#where-did-the-name-charliecloud-come-from" title="Permalink to this headline">¶</a></h3>
<p><em>Charlie</em> — Charles F. McMillan was director of Los Alamos National Laboratory
from June 2011 until December 2017, i.e., at the time Charliecloud was started
in early 2014. He is universally referred to as “Charlie” here.</p>
<p><em>cloud</em> — Charliecloud provides cloud-like flexibility for HPC systems.</p>
</div>
<div class="section" id="how-do-you-spell-charliecloud">
<h3><a class="toc-backref" href="#id3">4.1.2. How do you spell Charliecloud?</a><a class="headerlink" href="#how-do-you-spell-charliecloud" title="Permalink to this headline">¶</a></h3>
<p>We try to be consistent with <em>Charliecloud</em> — one word, no camel case. That
is, <em>Charlie Cloud</em> and <em>CharlieCloud</em> are both incorrect.</p>
</div>
</div>
<div class="section" id="errors">
<h2><a class="toc-backref" href="#id4">4.2. Errors</a><a class="headerlink" href="#errors" title="Permalink to this headline">¶</a></h2>
<div class="section" id="how-do-i-read-the-ch-run-error-messages">
<h3><a class="toc-backref" href="#id5">4.2.1. How do I read the <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> error messages?</a><a class="headerlink" href="#how-do-i-read-the-ch-run-error-messages" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> error messages look like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run foo -- <span class="nb">echo</span> hello
<span class="go">ch-run[25750]: can&#39;t find image: foo: No such file or directory (ch-run.c:107 2)</span>
</pre></div>
</div>
<p>There is a lot of information here, and it comes in this order:</p>
<ol class="arabic simple">
<li>Name of the executable; always <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>.</li>
<li>Process ID in square brackets; here <code class="code docutils literal notranslate"><span class="pre">25750</span></code>. This is useful when
debugging parallel <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> invocations.</li>
<li>Colon.</li>
<li>Main error message; here <code class="code docutils literal notranslate"><span class="pre">can't</span> <span class="pre">find</span> <span class="pre">image:</span> <span class="pre">foo</span></code>. This should be
informative as to what went wrong, and if it’s not, please file an issue,
because you may have found a usability bug. Note that in some cases you may
encounter the default message <code class="code docutils literal notranslate"><span class="pre">error</span></code>; if this happens and you’re not
doing something very strange, that’s also a usability bug.</li>
<li>Colon (but note that the main error itself can contain colons too), if and
only if the next item is present.</li>
<li>Operating system’s description of the the value of <code class="code docutils literal notranslate"><span class="pre">errno</span></code>; here
<code class="code docutils literal notranslate"><span class="pre">No</span> <span class="pre">such</span> <span class="pre">file</span> <span class="pre">or</span> <span class="pre">directory</span></code>. Omitted if not applicable.</li>
<li>Open parenthesis.</li>
<li>Name of the source file where the error occurred; here <code class="code docutils literal notranslate"><span class="pre">ch-run.c</span></code>.
This and the following item tell developers exactly where <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>
became confused, which greatly improves our ability to provide help and/or
debug.</li>
<li>Source line where the error occurred.</li>
<li>Value of <code class="code docutils literal notranslate"><span class="pre">errno</span></code> (see <a class="reference external" href="http://www.virtsync.com/c-error-codes-include-errno">C error codes in Linux</a> for the full
list of possibilities).</li>
<li>Close parenthesis.</li>
</ol>
<p><em>Note:</em> Despite the structured format, the error messages are not guaranteed
to be machine-readable.</p>
</div>
<div class="section" id="tarball-build-fails-with-no-command-specified">
<h3><a class="toc-backref" href="#id6">4.2.2. Tarball build fails with “No command specified”</a><a class="headerlink" href="#tarball-build-fails-with-no-command-specified" title="Permalink to this headline">¶</a></h3>
<p>The full error from <code class="code docutils literal notranslate"><span class="pre">ch-builder2tar</span></code> or <code class="code docutils literal notranslate"><span class="pre">ch-build2dir</span></code> is:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">docker: Error response from daemon: No command specified.</span>
</pre></div>
</div>
<p>You will also see it with various plain Docker commands.</p>
<p>This happens when there is no default command specified in the Dockerfile or
any of its ancestors. Some base images specify one (e.g., Debian) and others
don’t (e.g., Alpine). Docker requires this even for commands that don’t seem
like they should need it, such as <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">create</span></code> (which is what trips
up Charliecloud).</p>
<p>The solution is to add a default command to your Dockerfile, such as
<code class="code docutils literal notranslate"><span class="pre">CMD</span> <span class="pre">[&quot;true&quot;]</span></code>.</p>
</div>
<div class="section" id="ch-run-fails-with-can-t-re-mount-image-read-only">
<h3><a class="toc-backref" href="#id7">4.2.3. <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> fails with “can’t re-mount image read-only”</a><a class="headerlink" href="#ch-run-fails-with-can-t-re-mount-image-read-only" title="Permalink to this headline">¶</a></h3>
<p>Normally, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> re-mounts the image directory read-only within the
container. This fails if the image resides on certain filesystems, such as NFS
(see <a class="reference external" href="https://github.com/hpc/charliecloud/issues/9">issue #9</a>). There are
two solutions:</p>
<ol class="arabic simple">
<li>Unpack the image into a different filesystem, such as <code class="code docutils literal notranslate"><span class="pre">tmpfs</span></code> or
local disk. Consult your local admins for a recommendation. Note that
Lustre is probably not a good idea because it can give poor performance for
you and also everyone else on the system.</li>
<li>Use the <code class="code docutils literal notranslate"><span class="pre">-w</span></code> switch to leave the image mounted read-write. This may
have an impact on reproducibility (because the application can change the
image between runs) and/or stability (if there are multiple application
processes and one writes a file in the image that another is reading or
writing).</li>
</ol>
</div>
</div>
<div class="section" id="unexpected-behavior">
<h2><a class="toc-backref" href="#id8">4.3. Unexpected behavior</a><a class="headerlink" href="#unexpected-behavior" title="Permalink to this headline">¶</a></h2>
<div class="section" id="what-do-the-version-numbers-mean">
<h3><a class="toc-backref" href="#id9">4.3.1. What do the version numbers mean?</a><a class="headerlink" href="#what-do-the-version-numbers-mean" title="Permalink to this headline">¶</a></h3>
<p>Released versions of Charliecloud have a pretty standard version number, e.g.
0.9.7.</p>
<p>Work leading up to a released version also has version numbers, to satisfy
tools that require them and to give the executables something useful to report
on <code class="code docutils literal notranslate"><span class="pre">--version</span></code>, but these can be quite messy. We refer to such versions
informally as <em>pre-releases</em>, but Charliecloud does not have formal
pre-releases such as alpha, beta, or release candidate.</p>
<p><em>Pre-release version numbers are not in order</em>, because this work is in a DAG
rather than linear, except they precede the version we are working towards. If
you’re dealing with these versions, use Git.</p>
<p>Pre-release version numbers are the version we are working towards, followed
by: <code class="code docutils literal notranslate"><span class="pre">~pre</span></code>, the branch name if not <code class="code docutils literal notranslate"><span class="pre">master</span></code> with non-alphanumerics
removed, the commit hash, and finally <code class="code docutils literal notranslate"><span class="pre">dirty</span></code> if the working directory
had uncommitted changes.</p>
<p>Examples:</p>
<blockquote>
<div><ul class="simple">
<li><code class="code docutils literal notranslate"><span class="pre">0.2.0</span></code> : Version 0.2.0. Released versions don’t include Git
information, even if built in a Git working directory.</li>
<li><code class="code docutils literal notranslate"><span class="pre">0.2.1~pre</span></code> : Some snapshot of work leading up to 0.2.1, built from
source code where the Git information has been lost, e.g. the tarballs
Github provides. This should make you wary because you don’t have any
provenance. It might even be uncommitted work or an abandoned branch.</li>
<li><code class="code docutils literal notranslate"><span class="pre">0.2.1~pre.1a99f42</span></code> : Master branch commit 1a99f42, built from a
clean working directory (i.e., no changes since that commit).</li>
<li><code class="code docutils literal notranslate"><span class="pre">0.2.1~pre.foo1.0729a78</span></code> : Commit 0729a78 on branch <code class="code docutils literal notranslate"><span class="pre">foo-1</span></code>,
<code class="code docutils literal notranslate"><span class="pre">foo_1</span></code>, etc. built from clean working directory.</li>
<li><code class="code docutils literal notranslate"><span class="pre">0.2.1~pre.foo1.0729a78.dirty</span></code> : Commit 0729a78 on one of those
branches, plus un-committed changes.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="uid-0-lets-me-read-files-i-cant-otherwise">
<h3><a class="toc-backref" href="#id10">4.3.2. <code class="code docutils literal notranslate"><span class="pre">--uid</span> <span class="pre">0</span></code> lets me read files I can’t otherwise!</a><a class="headerlink" href="#uid-0-lets-me-read-files-i-cant-otherwise" title="Permalink to this headline">¶</a></h3>
<p>Some permission bits can give a surprising result with a container UID of 0.
For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> whoami
<span class="go">reidpr</span>
<span class="gp">$</span> <span class="nb">echo</span> surprise &gt; ~/cantreadme
<span class="gp">$</span> chmod <span class="m">000</span> ~/cantreadme
<span class="gp">$</span> ls -l ~/cantreadme
<span class="go">---------- 1 reidpr reidpr 9 Oct  3 15:03 /home/reidpr/cantreadme</span>
<span class="gp">$</span> cat ~/cantreadme
<span class="go">cat: /home/reidpr/cantreadme: Permission denied</span>
<span class="gp">$</span> ch-run /var/tmp/hello cat ~/cantreadme
<span class="go">cat: /home/reidpr/cantreadme: Permission denied</span>
<span class="gp">$</span> ch-run --uid <span class="m">0</span> /var/tmp/hello cat ~/cantreadme
<span class="go">surprise</span>
</pre></div>
</div>
<p>At first glance, it seems that we’ve found an escalation – we were able to
read a file inside a container that we could not read on the host! That seems
bad.</p>
<p>However, what is really going on here is more prosaic but complicated:</p>
<ol class="arabic simple">
<li>After <code class="code docutils literal notranslate"><span class="pre">unshare(CLONE_NEWUSER)</span></code>, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> gains all capabilities
inside the namespace. (Outside, capabilities are unchanged.)</li>
<li>This include <code class="code docutils literal notranslate"><span class="pre">CAP_DAC_OVERRIDE</span></code>, which enables a process to
read/write/execute a file or directory mostly regardless of its permission
bits. (This is why root isn’t limited by permissions.)</li>
<li>Within the container, <code class="code docutils literal notranslate"><span class="pre">exec(2)</span></code> capability rules are followed.
Normally, this basically means that all capabilities are dropped when
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> replaces itself with the user command. However, if EUID is
0, which it is inside the namespace given <code class="code docutils literal notranslate"><span class="pre">--uid</span> <span class="pre">0</span></code>, then the
subprocess keeps all its capabilities. (This makes sense: if root creates a
new process, it stays root.)</li>
<li><code class="code docutils literal notranslate"><span class="pre">CAP_DAC_OVERRIDE</span></code> within a user namespace is honored for a file or
directory only if its UID and GID are both mapped. In this case,
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> maps <code class="code docutils literal notranslate"><span class="pre">reidpr</span></code> to container <code class="code docutils literal notranslate"><span class="pre">root</span></code> and group
<code class="code docutils literal notranslate"><span class="pre">reidpr</span></code> to itself.</li>
<li>Thus, files and directories owned by the host EUID and EGID (here
<code class="code docutils literal notranslate"><span class="pre">reidpr:reidpr</span></code>) are available for all access with <code class="code docutils literal notranslate"><span class="pre">ch-run</span>
<span class="pre">--uid</span> <span class="pre">0</span></code>.</li>
</ol>
<p>This is not an escalation. The quirk applies only to files owned by the
invoking user, because <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> is unprivileged outside the namespace,
and thus he or she could simply <code class="code docutils literal notranslate"><span class="pre">chmod</span></code> the file to read it. Access
inside and outside the container remains equivalent.</p>
<p>References:</p>
<ul class="simple">
<li><a class="reference external" href="http://man7.org/linux/man-pages/man7/capabilities.7.html">http://man7.org/linux/man-pages/man7/capabilities.7.html</a></li>
<li><a class="reference external" href="http://lxr.free-electrons.com/source/kernel/capability.c?v=4.2#L442">http://lxr.free-electrons.com/source/kernel/capability.c?v=4.2#L442</a></li>
<li><a class="reference external" href="http://lxr.free-electrons.com/source/fs/namei.c?v=4.2#L328">http://lxr.free-electrons.com/source/fs/namei.c?v=4.2#L328</a></li>
</ul>
</div>
<div class="section" id="why-does-ping-not-work">
<h3><a class="toc-backref" href="#id11">4.3.3. Why does <code class="code docutils literal notranslate"><span class="pre">ping</span></code> not work?</a><a class="headerlink" href="#why-does-ping-not-work" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">ping</span></code> fails with “permission denied” or similar under Charliecloud,
even if you’re UID 0 inside the container:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run <span class="nv">$IMG</span> -- ping <span class="m">8</span>.8.8.8
<span class="go">PING 8.8.8.8 (8.8.8.8): 56 data bytes</span>
<span class="go">ping: permission denied (are you root?)</span>
<span class="gp">$</span> ch-run --uid<span class="o">=</span><span class="m">0</span> <span class="nv">$IMG</span> -- ping <span class="m">8</span>.8.8.8
<span class="go">PING 8.8.8.8 (8.8.8.8): 56 data bytes</span>
<span class="go">ping: permission denied (are you root?)</span>
</pre></div>
</div>
<p>This is because <code class="code docutils literal notranslate"><span class="pre">ping</span></code> needs a raw socket to construct the needed
<code class="code docutils literal notranslate"><span class="pre">ICMP</span> <span class="pre">ECHO</span></code> packets, which requires capability <code class="code docutils literal notranslate"><span class="pre">CAP_NET_RAW</span></code> or
root. Unprivileged users can normally use <code class="code docutils literal notranslate"><span class="pre">ping</span></code> because it’s a setuid
or setcap binary: it raises privilege using the filesystem bits on the
executable to obtain a raw socket.</p>
<p>Under Charliecloud, there are multiple reasons <code class="code docutils literal notranslate"><span class="pre">ping</span></code> can’t get a raw
socket. First, images are unpacked without privilege, meaning that setuid and
setcap bits are lost. But even if you do get privilege in the container (e.g.,
with <code class="code docutils literal notranslate"><span class="pre">--uid=0</span></code>), this only applies in the container. Charliecloud uses
the host’s network namespace, where your unprivileged host identity applies
and <code class="code docutils literal notranslate"><span class="pre">ping</span></code> still can’t get a raw socket.</p>
<p>The recommended alternative is to simply try the thing you want to do, without
testing connectivity using <code class="code docutils literal notranslate"><span class="pre">ping</span></code> first.</p>
</div>
<div class="section" id="why-is-matlab-trying-and-failing-to-change-the-group-of-dev-pts-0">
<h3><a class="toc-backref" href="#id12">4.3.4. Why is MATLAB trying and failing to change the group of <code class="code docutils literal notranslate"><span class="pre">/dev/pts/0</span></code>?</a><a class="headerlink" href="#why-is-matlab-trying-and-failing-to-change-the-group-of-dev-pts-0" title="Permalink to this headline">¶</a></h3>
<p>MATLAB and some other programs want pseudo-TTY (PTY) files to be group-owned
by <code class="code docutils literal notranslate"><span class="pre">tty</span></code>. If it’s not, Matlab will attempt to <code class="code docutils literal notranslate"><span class="pre">chown(2)</span></code> the file,
which fails inside a container.</p>
<p>The scenario in more detail is this. Assume you’re user <code class="code docutils literal notranslate"><span class="pre">charlie</span></code>
(UID=1000), your primary group is <code class="code docutils literal notranslate"><span class="pre">nerds</span></code> (GID=1001), <code class="code docutils literal notranslate"><span class="pre">/dev/pts/0</span></code>
is the PTY file in question, and its ownership is <code class="code docutils literal notranslate"><span class="pre">charlie:tty</span></code>
(<code class="code docutils literal notranslate"><span class="pre">1000:5</span></code>), as it should be. What happens in the container by default
is:</p>
<ol class="arabic simple">
<li>MATLAB <code class="code docutils literal notranslate"><span class="pre">stat(2)</span></code>s <code class="code docutils literal notranslate"><span class="pre">/dev/pts/0</span></code> and checks the GID.</li>
<li>This GID is <code class="code docutils literal notranslate"><span class="pre">nogroup</span></code> (65534) because <code class="code docutils literal notranslate"><span class="pre">tty</span></code> (5) is not mapped
on the host side (and cannot be, because only one’s EGID can be mapped in
an unprivileged user namespace).</li>
<li>MATLAB concludes this is bad.</li>
<li>MATLAB executes <code class="code docutils literal notranslate"><span class="pre">chown(&quot;/dev/pts/0&quot;,</span> <span class="pre">1000,</span> <span class="pre">5)</span></code>.</li>
<li>This fails because GID 5 is not mapped on the guest side.</li>
<li>MATLAB pukes.</li>
</ol>
<p>The workaround is to map your EGID of 1001 to 5 inside the container (instead
of the default 1001:1001), i.e. <code class="code docutils literal notranslate"><span class="pre">--gid=5</span></code>. Then, step 4 succeeds because
the call is mapped to <code class="code docutils literal notranslate"><span class="pre">chown(&quot;/dev/pts/0&quot;,</span> <span class="pre">1000,</span> <span class="pre">1001)</span></code> and MATLAB is
happy.</p>
</div>
<div class="section" id="ch-builder2tar-gives-incorrect-image-sizes">
<span id="faq-docker2tar-size"></span><h3><a class="toc-backref" href="#id13">4.3.5. <code class="code docutils literal notranslate"><span class="pre">ch-builder2tar</span></code> gives incorrect image sizes</a><a class="headerlink" href="#ch-builder2tar-gives-incorrect-image-sizes" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">ch-builder2tar</span></code> often finishes before the progress bar is complete. For
example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-builder2tar mpihello /var/tmp
<span class="go"> 373MiB 0:00:21 [============================&gt;                 ] 65%</span>
<span class="go">146M /var/tmp/mpihello.tar.gz</span>
</pre></div>
</div>
<p>In this case, the <code class="code docutils literal notranslate"><span class="pre">.tar.gz</span></code> contains 392 MB uncompressed:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> zcat /var/tmp/mpihello.tar.gz <span class="p">|</span> wc
<span class="go">2740966 14631550 392145408</span>
</pre></div>
</div>
<p>But Docker thinks the image is 597 MB:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> sudo docker image inspect mpihello <span class="p">|</span> fgrep -i size
<span class="go">        &quot;Size&quot;: 596952928,</span>
<span class="go">        &quot;VirtualSize&quot;: 596952928,</span>
</pre></div>
</div>
<p>We’ve also seen cases where the Docker-reported size is an <em>under</em>estimate:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-builder2tar spack /var/tmp
<span class="go"> 423MiB 0:00:22 [============================================&gt;] 102%</span>
<span class="go">162M /var/tmp/spack.tar.gz</span>
<span class="gp">$</span> zcat /var/tmp/spack.tar.gz <span class="p">|</span> wc
<span class="go">4181186 20317858 444212736</span>
<span class="gp">$</span> sudo docker image inspect spack <span class="p">|</span> fgrep -i size
<span class="go">        &quot;Size&quot;: 433812403,</span>
<span class="go">        &quot;VirtualSize&quot;: 433812403,</span>
</pre></div>
</div>
<p>We think that this is because Docker is computing size based on the size of
the layers rather than the unpacked image. We do not currently have a fix; see
<a class="reference external" href="https://github.com/hpc/charliecloud/issues/165">issue #165</a>.</p>
</div>
<div class="section" id="my-second-level-directory-dev-is-empty">
<h3><a class="toc-backref" href="#id14">4.3.6. My second-level directory <code class="code docutils literal notranslate"><span class="pre">dev</span></code> is empty</a><a class="headerlink" href="#my-second-level-directory-dev-is-empty" title="Permalink to this headline">¶</a></h3>
<p>Some image tarballs, such as official Ubuntu Docker images, put device files
in <code class="code docutils literal notranslate"><span class="pre">/dev</span></code>. These files prevent unpacking the tarball, because
unprivileged users cannot create device files. Further, these files are not
needed because <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> overmounts <code class="code docutils literal notranslate"><span class="pre">/dev</span></code> anyway.</p>
<p>We cannot reliably prevent device files from being included in the tar,
because often that is outside our control, e.g. <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">export</span></code> produces
a tarball. Thus, we must exclude them at unpacking time.</p>
<p>An additional complication is that <code class="code docutils literal notranslate"><span class="pre">ch-tar2dir</span></code> can handle tarballs both
with a single top-level directory and without, i.e. “tarbombs”. For example,
best practice use of <code class="code docutils literal notranslate"><span class="pre">tar</span></code> on the command line produces the former,
while <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">export</span></code> (perhaps via <code class="code docutils literal notranslate"><span class="pre">ch-builder2tar</span></code>) produces a
tarbomb.</p>
<p>Thus, <code class="code docutils literal notranslate"><span class="pre">ch-tar2dir</span></code> uses <code class="code docutils literal notranslate"><span class="pre">tar</span> <span class="pre">--exclude</span></code> to exclude from unpacking
everything under <code class="code docutils literal notranslate"><span class="pre">./dev</span></code> and <code class="code docutils literal notranslate"><span class="pre">*/dev</span></code>, i.e., directory <code class="code docutils literal notranslate"><span class="pre">dev</span></code>
appearing at either the first or second level are forced to be empty.</p>
<p>This yields false positives if you have a tarbomb image with a directory
<code class="code docutils literal notranslate"><span class="pre">dev</span></code> at the second level containing stuff you care about. Hopefully
this is rare, but please let us know if it is your use case.</p>
</div>
<div class="section" id="my-password-that-contains-digits-doesn-t-work-in-virtualbox-console">
<h3><a class="toc-backref" href="#id15">4.3.7. My password that contains digits doesn’t work in VirtualBox console</a><a class="headerlink" href="#my-password-that-contains-digits-doesn-t-work-in-virtualbox-console" title="Permalink to this headline">¶</a></h3>
<p>VirtualBox has confusing Num Lock behavior. Thus, you may be typing arrows,
page up/down, etc. instead of digits, without noticing because console
password fields give no feedback, not even whether a character has been typed.</p>
<p>Try using the number row instead, toggling Num Lock key, or SSHing into the
virtual machine.</p>
</div>
</div>
<div class="section" id="how-do-i">
<h2><a class="toc-backref" href="#id16">4.4. How do I ...</a><a class="headerlink" href="#how-do-i" title="Permalink to this headline">¶</a></h2>
<div class="section" id="my-app-needs-to-write-to-var-log-run-etc">
<h3><a class="toc-backref" href="#id17">4.4.1. My app needs to write to <code class="code docutils literal notranslate"><span class="pre">/var/log</span></code>, <code class="code docutils literal notranslate"><span class="pre">/run</span></code>, etc.</a><a class="headerlink" href="#my-app-needs-to-write-to-var-log-run-etc" title="Permalink to this headline">¶</a></h3>
<p>Because the image is mounted read-only by default, log files, caches, and
other stuff cannot be written anywhere in the image. You have three options:</p>
<ol class="arabic simple">
<li>Configure the application to use a different directory. <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> is
often a good choice, because it’s shared with the host and fast.</li>
<li>Use <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> commands in your Dockerfile to create symlinks that point
somewhere writeable, e.g. <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code>, or <code class="code docutils literal notranslate"><span class="pre">/mnt/0</span></code> with
<code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">--bind</span></code>.</li>
<li>Run the image read-write with <code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">-w</span></code>. Be careful that multiple
containers do not try to write to the same files.</li>
</ol>
</div>
<div class="section" id="which-specific-sudo-commands-are-needed">
<h3><a class="toc-backref" href="#id18">4.4.2. Which specific <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> commands are needed?</a><a class="headerlink" href="#which-specific-sudo-commands-are-needed" title="Permalink to this headline">¶</a></h3>
<p>For running images, <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> is not needed at all.</p>
<p>For building images, it depends on what you would like to support. For
example, do you want to let users build images with Docker? Do you want to let
them run the build tests?</p>
<p>We do not maintain specific lists, but you can search the source code and
documentation for uses of <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> and <code class="code docutils literal notranslate"><span class="pre">$DOCKER</span></code> and evaluate them
on a case-by-case basis. (The latter includes <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> if needed to invoke
<code class="code docutils literal notranslate"><span class="pre">docker</span></code> in your environment.) For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> find . <span class="se">\(</span>   -type f -executable <span class="se">\</span>
           -o -name Makefile <span class="se">\</span>
           -o -name <span class="s1">&#39;*.bats&#39;</span> <span class="se">\</span>
           -o -name <span class="s1">&#39;*.rst&#39;</span> <span class="se">\</span>
           -o -name <span class="s1">&#39;*.sh&#39;</span> <span class="se">\)</span> <span class="se">\</span>
         -exec egrep -H <span class="s1">&#39;(sudo|\$DOCKER)&#39;</span> <span class="o">{}</span> <span class="se">\;</span>
</pre></div>
</div>
</div>
<div class="section" id="openmpi-charliecloud-jobs-dont-work">
<h3><a class="toc-backref" href="#id19">4.4.3. OpenMPI Charliecloud jobs don’t work</a><a class="headerlink" href="#openmpi-charliecloud-jobs-dont-work" title="Permalink to this headline">¶</a></h3>
<p>MPI can be finicky. This section documents some of the problems we’ve seen.</p>
<div class="section" id="mpirun-cant-launch-jobs">
<h4><a class="toc-backref" href="#id20">4.4.3.1. <code class="code docutils literal notranslate"><span class="pre">mpirun</span></code> can’t launch jobs</a><a class="headerlink" href="#mpirun-cant-launch-jobs" title="Permalink to this headline">¶</a></h4>
<p>For example, you might see:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> mpirun -np <span class="m">1</span> ch-run /var/tmp/mpihello -- /hello/hello
<span class="go">App launch reported: 2 (out of 2) daemons - 0 (out of 1) procs</span>
<span class="go">[cn001:27101] PMIX ERROR: BAD-PARAM in file src/dstore/pmix_esh.c at line 996</span>
</pre></div>
</div>
<p>We’re not yet sure why this happens — it may be a mismatch between the OpenMPI
builds inside and outside the container — but in our experience launching with
<code class="code docutils literal notranslate"><span class="pre">srun</span></code> often works when <code class="code docutils literal notranslate"><span class="pre">mpirun</span></code> doesn’t, so try that.</p>
</div>
<div class="section" id="communication-between-ranks-on-the-same-node-fails">
<h4><a class="toc-backref" href="#id21">4.4.3.2. Communication between ranks on the same node fails</a><a class="headerlink" href="#communication-between-ranks-on-the-same-node-fails" title="Permalink to this headline">¶</a></h4>
<p>OpenMPI has many ways to transfer messages between ranks. If the ranks are on
the same node, it is faster to do these transfers using shared memory rather
than involving the network stack. There are two ways to use shared memory.</p>
<p>The first and older method is to use POSIX or SysV shared memory segments.
This approach uses two copies: one from Rank A to shared memory, and a second
from shared memory to Rank B. For example, the <code class="code docutils literal notranslate"><span class="pre">sm</span></code> <em>byte transport
layer</em> (BTL) does this.</p>
<p>The second and newer method is to use the <code class="code docutils literal notranslate"><span class="pre">process_vm_readv(2)</span></code> and/or
<code class="code docutils literal notranslate"><span class="pre">process_vm_writev(2)</span></code>) system calls to transfer messages directly from
Rank A’s virtual memory to Rank B’s. This approach is known as <em>cross-memory
attach</em> (CMA). It gives significant performance improvements in <a class="reference external" href="https://blogs.cisco.com/performance/the-vader-shared-memory-transport-in-open-mpi-now-featuring-3-flavors-of-zero-copy">benchmarks</a>,
though of course the real-world impact depends on the application. For
example, the <code class="code docutils literal notranslate"><span class="pre">vader</span></code> BTL (enabled by default in OpenMPI 2.0) and
<code class="code docutils literal notranslate"><span class="pre">psm2</span></code> <em>matching transport layer</em> (MTL) do this.</p>
<p>The problem in Charliecloud is that the second approach does not work by
default.</p>
<p>We can demonstrate the problem with LAMMPS molecular dynamics application:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> srun --cpus-per-task <span class="m">1</span> ch-run /var/tmp/lammps_mpi -- <span class="se">\</span>
  lmp_mpi -log none -in /lammps/examples/melt/in.melt
<span class="go">[cn002:21512] Read -1, expected 6144, errno = 1</span>
<span class="go">[cn001:23947] Read -1, expected 6144, errno = 1</span>
<span class="go">[cn002:21517] Read -1, expected 9792, errno = 1</span>
<span class="go">[... repeat thousands of times ...]</span>
</pre></div>
</div>
<p>With <code class="code docutils literal notranslate"><span class="pre">strace(1)</span></code>, one can isolate the problem to the system call noted
above:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">process_vm_readv(...) = -1 EPERM (Operation not permitted)</span>
<span class="go">write(33, &quot;[cn001:27673] Read -1, expected 6&quot;..., 48) = 48</span>
</pre></div>
</div>
<p>The <a class="reference external" href="http://man7.org/linux/man-pages/man2/process_vm_readv.2.html">man page</a>
reveals that these system calls require that the process have permission to
<code class="code docutils literal notranslate"><span class="pre">ptrace(2)</span></code> one another, but sibling user namespaces <a class="reference external" href="http://man7.org/linux/man-pages/man2/ptrace.2.html">do not</a>. (You <em>can</em>
<code class="code docutils literal notranslate"><span class="pre">ptrace(2)</span></code> into a child namespace, which is why <code class="code docutils literal notranslate"><span class="pre">gdb</span></code> doesn’t
require anything special in Charliecloud.)</p>
<p>This problem is not specific to containers; for example, many settings of
kernels with <a class="reference external" href="https://www.kernel.org/doc/Documentation/security/Yama.txt">YAMA</a> enabled will
similarly disallow this access.</p>
<p>So what can you do? There are a few options:</p>
<ul>
<li><p class="first">We recommend simply using the <code class="code docutils literal notranslate"><span class="pre">--join</span></code> family of arguments to
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>. This puts a group of <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> peers in the same
namespaces; then, the system calls work. See the <a class="reference internal" href="command-usage.html#man-ch-run"><span class="std std-ref">ch-run</span></a> man page
for details.</p>
</li>
<li><p class="first">You can also sometimes turn off single-copy. For example, for <code class="code docutils literal notranslate"><span class="pre">vader</span></code>,
set the MCA variable <code class="code docutils literal notranslate"><span class="pre">btl_vader_single_copy_mechanism</span></code> to
<code class="code docutils literal notranslate"><span class="pre">none</span></code>, e.g. with an environment variable:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">export</span> <span class="nv">OMPI_MCA_btl_vader_single_copy_mechanism</span><span class="o">=</span>none
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">psm2</span></code> does not let you turn off CMA, but it does fall back to
two-copy if CMA doesn’t work. However, this fallback crashed when we tried
it.</p>
</li>
<li><p class="first">The kernel module <a class="reference external" href="https://github.com/hjelmn/xpmem/tree/master/kernel">XPMEM</a> enables a different
single-copy approach. We have not yet tried this, and the module needs to be
evaluated for user namespace safety, but it’s quite a bit faster than CMA on
benchmarks.</p>
</li>
</ul>
</div>
<div class="section" id="i-get-a-bunch-of-independent-rank-0-processes-when-launching-with-srun">
<h4><a class="toc-backref" href="#id22">4.4.3.3. I get a bunch of independent rank-0 processes when launching with <code class="code docutils literal notranslate"><span class="pre">srun</span></code></a><a class="headerlink" href="#i-get-a-bunch-of-independent-rank-0-processes-when-launching-with-srun" title="Permalink to this headline">¶</a></h4>
<p>For example, you might be seeing this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> srun ch-run /var/tmp/mpihello -- /hello/hello
<span class="go">0: init ok cn036.localdomain, 1 ranks, userns 4026554634</span>
<span class="go">0: send/receive ok</span>
<span class="go">0: finalize ok</span>
<span class="go">0: init ok cn035.localdomain, 1 ranks, userns 4026554634</span>
<span class="go">0: send/receive ok</span>
<span class="go">0: finalize ok</span>
</pre></div>
</div>
<p>We were expecting a two-rank MPI job, but instead we got two independent
one-rank jobs that did not coordinate.</p>
<p>MPI ranks start as normal, independent processes that must find one another
somehow in order to sync up and begin the coupled parallel program; this
happens in <code class="code docutils literal notranslate"><span class="pre">MPI_Init()</span></code>.</p>
<p>There are lots of ways to do this coordination. Because we are launching with
the host’s Slurm, we need it to provide something for the containerized
processes for such coordination. OpenMPI must be compiled to use what that
Slurm has to offer, and Slurm must be told to offer it. What works for us is a
something called “PMI2”. You can see if your Slurm supports it with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> srun --mpi<span class="o">=</span>list
<span class="go">srun: MPI types are...</span>
<span class="go">srun: mpi/pmi2</span>
<span class="go">srun: mpi/openmpi</span>
<span class="go">srun: mpi/mpich1_shmem</span>
<span class="go">srun: mpi/mpich1_p4</span>
<span class="go">srun: mpi/lam</span>
<span class="go">srun: mpi/none</span>
<span class="go">srun: mpi/mvapich</span>
<span class="go">srun: mpi/mpichmx</span>
<span class="go">srun: mpi/mpichgm</span>
</pre></div>
</div>
<p>If <code class="code docutils literal notranslate"><span class="pre">pmi2</span></code> is not in the list, you must ask your admins to enable Slurm’s
PMI2 support. If it is in the list, but you’re seeing this problem, that means
it is not the default, and you need to tell Slurm you want it. Try:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">export</span> <span class="nv">SLURM_MPI_TYPE</span><span class="o">=</span>pmi2
<span class="gp">$</span> srun ch-run /var/tmp/mpihello -- /hello/hello
<span class="go">0: init ok wc035.localdomain, 2 ranks, userns 4026554634</span>
<span class="go">1: init ok wc036.localdomain, 2 ranks, userns 4026554634</span>
<span class="go">0: send/receive ok</span>
<span class="go">0: finalize ok</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="how-do-i-run-x11-apps">
<h3><a class="toc-backref" href="#id23">4.4.4. How do I run X11 apps?</a><a class="headerlink" href="#how-do-i-run-x11-apps" title="Permalink to this headline">¶</a></h3>
<p>X11 applications should “just work”. For example, try this Dockerfile:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span> <span class="s">debian:stretch</span>
<span class="k">RUN</span>    apt-get update <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apt-get install -y xterm
</pre></div>
</div>
<p>Build it and unpack it to <code class="code docutils literal notranslate"><span class="pre">/var/tmp</span></code>. Then:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run /scratch/ch/xterm -- xterm
</pre></div>
</div>
<p>should pop an xterm.</p>
<p>If your X11 application doesn’t work, please file an issue so we can
figure out why.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="dev.html" class="btn btn-neutral float-right" title="5. Contributor’s guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="command-usage.html" class="btn btn-neutral float-left" title="3. Charliecloud command reference" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014–2019, Triad National Security, LLC

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>11. Frequently asked questions (FAQ) &mdash; Charliecloud 0.39~pre+a1fe557 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="12. Best practices" href="best_practices.html" />
    <link rel="prev" title="10. ch-test" href="ch-test.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Charliecloud
              <img src="_static/logo-sidebar.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.39~pre+a1fe557
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">1. Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">2. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-checkns.html">3. <code class="code docutils literal notranslate"><span class="pre">ch-checkns</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-completion.bash.html">4. <code class="code docutils literal notranslate"><span class="pre">ch-completion.bash</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-convert.html">5. <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-fromhost.html">6. <code class="code docutils literal notranslate"><span class="pre">ch-fromhost</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-image.html">7. <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-run.html">8. <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-run-oci.html">9. <code class="code docutils literal notranslate"><span class="pre">ch-run-oci</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-test.html">10. <code class="code docutils literal notranslate"><span class="pre">ch-test</span></code></a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">11. Frequently asked questions (FAQ)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#about-the-project">11.1. About the project</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#where-did-the-name-charliecloud-come-from">11.1.1. Where did the name Charliecloud come from?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-you-spell-charliecloud">11.1.2. How do you spell Charliecloud?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-large-is-charliecloud">11.1.3. How large is Charliecloud?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#errors">11.2. Errors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-read-the-ch-run-error-messages">11.2.1. How do I read the <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> error messages?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ch-run-fails-with-cant-re-mount-image-read-only">11.2.2. <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> fails with “can’t re-mount image read-only”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ch-image-fails-with-certificate-verify-failed">11.2.3. <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> fails with “certificate verify failed”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#storage-directory-seems-invalid">11.2.4. “storage directory seems invalid”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transport-endpoint-is-not-connected">11.2.5. “Transport endpoint is not connected”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fatal-home-not-set-from-git-or-similar">11.2.6. “fatal: <code class="code docutils literal notranslate"><span class="pre">$HOME</span></code> not set” from Git, or similar</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ch-run-fails-with-cant-execve-2-permission-denied">11.2.7. <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> fails with “can’t execve(2): permission denied”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#unexpected-behavior">11.3. Unexpected behavior</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-do-the-version-numbers-mean">11.3.1. What do the version numbers mean?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#uid-0-lets-me-read-files-i-cant-otherwise">11.3.2. <code class="code docutils literal notranslate"><span class="pre">--uid</span> <span class="pre">0</span></code> lets me read files I can’t otherwise!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bind-creates-mount-points-within-un-writeable-directories">11.3.3. <code class="code docutils literal notranslate"><span class="pre">--bind</span></code> creates mount points within un-writeable directories!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#why-does-ping-not-work">11.3.4. Why does <code class="code docutils literal notranslate"><span class="pre">ping</span></code> not work?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#why-is-matlab-trying-and-failing-to-change-the-group-of-dev-pts-0">11.3.5. Why is MATLAB trying and failing to change the group of <code class="code docutils literal notranslate"><span class="pre">/dev/pts/0</span></code>?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ch-convert-from-docker-incorrect-image-sizes">11.3.6. <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> from Docker incorrect image sizes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#my-password-that-contains-digits-doesnt-work-in-virtualbox-console">11.3.7. My password that contains digits doesn’t work in VirtualBox console</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mode-bits-permission-bits-are-lost">11.3.8. Mode bits (permission bits) are lost</a></li>
<li class="toctree-l3"><a class="reference internal" href="#why-is-my-wildcard-in-ch-run-not-working">11.3.9. Why is my wildcard in <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> not working?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-do-i">11.4. How do I ...</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#my-app-needs-to-write-to-var-log-run-etc">11.4.1. My app needs to write to <code class="code docutils literal notranslate"><span class="pre">/var/log</span></code>, <code class="code docutils literal notranslate"><span class="pre">/run</span></code>, etc.</a></li>
<li class="toctree-l3"><a class="reference internal" href="#openmpi-charliecloud-jobs-dont-work">11.4.2. OpenMPI Charliecloud jobs don’t work</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mpirun-cant-launch-jobs">11.4.2.1. <code class="code docutils literal notranslate"><span class="pre">mpirun</span></code> can’t launch jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#communication-between-ranks-on-the-same-node-fails">11.4.2.2. Communication between ranks on the same node fails</a></li>
<li class="toctree-l4"><a class="reference internal" href="#i-get-a-bunch-of-independent-rank-0-processes-when-launching-with-srun">11.4.2.3. I get a bunch of independent rank-0 processes when launching with <code class="code docutils literal notranslate"><span class="pre">srun</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-run-x11-apps">11.4.3. How do I run X11 apps?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-specify-an-image-reference">11.4.4. How do I specify an image reference?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#can-i-build-or-pull-images-using-a-tool-charliecloud-doesnt-know-about">11.4.5. Can I build or pull images using a tool Charliecloud doesn’t know about?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-authenticate-with-ssh-during-ch-image-build">11.4.6. How do I authenticate with SSH during <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> build?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ssh-stops-ch-image-build-with-interactive-queries">11.4.7. SSH stops <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> build with interactive queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-use-docker-to-build-charliecloud-images">11.4.8. How do I use Docker to build Charliecloud images?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#security-implications-of-docker">11.4.8.1. Security implications of Docker</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuring-for-a-proxy">11.4.8.2. Configuring for a proxy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#how-can-i-build-images-for-a-foreign-architecture">11.4.9. How can I build images for a foreign architecture?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#qemu">11.4.9.1. QEMU</a></li>
<li class="toctree-l4"><a class="reference internal" href="#proot">11.4.9.2. PRoot</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#how-can-i-use-tarball-base-images-from-e-g-linuxcontainers-org">11.4.10. How can I use tarball base images from e.g. linuxcontainers.org?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-can-i-control-charlieclouds-quietness-or-verbosity">11.4.11. How can I control Charliecloud’s quietness or verbosity?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-handle-extended-attributes-in-charliecloud">11.4.12. How do I handle extended attributes in Charliecloud?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="best_practices.html">12. Best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev.html">13. Contributor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Charliecloud</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">11. </span>Frequently asked questions (FAQ)</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="frequently-asked-questions-faq">
<h1><span class="section-number">11. </span>Frequently asked questions (FAQ)<a class="headerlink" href="#frequently-asked-questions-faq" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#about-the-project" id="id4">About the project</a></p>
<ul>
<li><p><a class="reference internal" href="#where-did-the-name-charliecloud-come-from" id="id5">Where did the name Charliecloud come from?</a></p></li>
<li><p><a class="reference internal" href="#how-do-you-spell-charliecloud" id="id6">How do you spell Charliecloud?</a></p></li>
<li><p><a class="reference internal" href="#how-large-is-charliecloud" id="id7">How large is Charliecloud?</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#errors" id="id8">Errors</a></p>
<ul>
<li><p><a class="reference internal" href="#how-do-i-read-the-ch-run-error-messages" id="id9">How do I read the <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> error messages?</a></p></li>
<li><p><a class="reference internal" href="#ch-run-fails-with-cant-re-mount-image-read-only" id="id10"><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> fails with “can’t re-mount image read-only”</a></p></li>
<li><p><a class="reference internal" href="#ch-image-fails-with-certificate-verify-failed" id="id11"><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> fails with “certificate verify failed”</a></p></li>
<li><p><a class="reference internal" href="#storage-directory-seems-invalid" id="id12">“storage directory seems invalid”</a></p></li>
<li><p><a class="reference internal" href="#transport-endpoint-is-not-connected" id="id13">“Transport endpoint is not connected”</a></p></li>
<li><p><a class="reference internal" href="#fatal-home-not-set-from-git-or-similar" id="id14">“fatal: <code class="code docutils literal notranslate"><span class="pre">$HOME</span></code> not set” from Git, or similar</a></p></li>
<li><p><a class="reference internal" href="#ch-run-fails-with-cant-execve-2-permission-denied" id="id15"><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> fails with “can’t execve(2): permission denied”</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#unexpected-behavior" id="id16">Unexpected behavior</a></p>
<ul>
<li><p><a class="reference internal" href="#what-do-the-version-numbers-mean" id="id17">What do the version numbers mean?</a></p></li>
<li><p><a class="reference internal" href="#uid-0-lets-me-read-files-i-cant-otherwise" id="id18"><code class="code docutils literal notranslate"><span class="pre">--uid</span> <span class="pre">0</span></code> lets me read files I can’t otherwise!</a></p></li>
<li><p><a class="reference internal" href="#bind-creates-mount-points-within-un-writeable-directories" id="id19"><code class="code docutils literal notranslate"><span class="pre">--bind</span></code> creates mount points within un-writeable directories!</a></p></li>
<li><p><a class="reference internal" href="#why-does-ping-not-work" id="id20">Why does <code class="code docutils literal notranslate"><span class="pre">ping</span></code> not work?</a></p></li>
<li><p><a class="reference internal" href="#why-is-matlab-trying-and-failing-to-change-the-group-of-dev-pts-0" id="id21">Why is MATLAB trying and failing to change the group of <code class="code docutils literal notranslate"><span class="pre">/dev/pts/0</span></code>?</a></p></li>
<li><p><a class="reference internal" href="#ch-convert-from-docker-incorrect-image-sizes" id="id22"><code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> from Docker incorrect image sizes</a></p></li>
<li><p><a class="reference internal" href="#my-password-that-contains-digits-doesnt-work-in-virtualbox-console" id="id23">My password that contains digits doesn’t work in VirtualBox console</a></p></li>
<li><p><a class="reference internal" href="#mode-bits-permission-bits-are-lost" id="id24">Mode bits (permission bits) are lost</a></p></li>
<li><p><a class="reference internal" href="#why-is-my-wildcard-in-ch-run-not-working" id="id25">Why is my wildcard in <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> not working?</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-do-i" id="id26">How do I ...</a></p>
<ul>
<li><p><a class="reference internal" href="#my-app-needs-to-write-to-var-log-run-etc" id="id27">My app needs to write to <code class="code docutils literal notranslate"><span class="pre">/var/log</span></code>, <code class="code docutils literal notranslate"><span class="pre">/run</span></code>, etc.</a></p></li>
<li><p><a class="reference internal" href="#openmpi-charliecloud-jobs-dont-work" id="id28">OpenMPI Charliecloud jobs don’t work</a></p>
<ul>
<li><p><a class="reference internal" href="#mpirun-cant-launch-jobs" id="id29"><code class="code docutils literal notranslate"><span class="pre">mpirun</span></code> can’t launch jobs</a></p></li>
<li><p><a class="reference internal" href="#communication-between-ranks-on-the-same-node-fails" id="id30">Communication between ranks on the same node fails</a></p></li>
<li><p><a class="reference internal" href="#i-get-a-bunch-of-independent-rank-0-processes-when-launching-with-srun" id="id31">I get a bunch of independent rank-0 processes when launching with <code class="code docutils literal notranslate"><span class="pre">srun</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-do-i-run-x11-apps" id="id32">How do I run X11 apps?</a></p></li>
<li><p><a class="reference internal" href="#how-do-i-specify-an-image-reference" id="id33">How do I specify an image reference?</a></p></li>
<li><p><a class="reference internal" href="#can-i-build-or-pull-images-using-a-tool-charliecloud-doesnt-know-about" id="id34">Can I build or pull images using a tool Charliecloud doesn’t know about?</a></p></li>
<li><p><a class="reference internal" href="#how-do-i-authenticate-with-ssh-during-ch-image-build" id="id35">How do I authenticate with SSH during <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> build?</a></p></li>
<li><p><a class="reference internal" href="#ssh-stops-ch-image-build-with-interactive-queries" id="id36">SSH stops <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> build with interactive queries</a></p></li>
<li><p><a class="reference internal" href="#how-do-i-use-docker-to-build-charliecloud-images" id="id37">How do I use Docker to build Charliecloud images?</a></p>
<ul>
<li><p><a class="reference internal" href="#security-implications-of-docker" id="id38">Security implications of Docker</a></p></li>
<li><p><a class="reference internal" href="#configuring-for-a-proxy" id="id39">Configuring for a proxy</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-can-i-build-images-for-a-foreign-architecture" id="id40">How can I build images for a foreign architecture?</a></p>
<ul>
<li><p><a class="reference internal" href="#qemu" id="id41">QEMU</a></p></li>
<li><p><a class="reference internal" href="#proot" id="id42">PRoot</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-can-i-use-tarball-base-images-from-e-g-linuxcontainers-org" id="id43">How can I use tarball base images from e.g. linuxcontainers.org?</a></p></li>
<li><p><a class="reference internal" href="#how-can-i-control-charlieclouds-quietness-or-verbosity" id="id44">How can I control Charliecloud’s quietness or verbosity?</a></p></li>
<li><p><a class="reference internal" href="#how-do-i-handle-extended-attributes-in-charliecloud" id="id45">How do I handle extended attributes in Charliecloud?</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="about-the-project">
<h2><a class="toc-backref" href="#id4" role="doc-backlink"><span class="section-number">11.1. </span>About the project</a><a class="headerlink" href="#about-the-project" title="Permalink to this heading">¶</a></h2>
<section id="where-did-the-name-charliecloud-come-from">
<h3><a class="toc-backref" href="#id5" role="doc-backlink"><span class="section-number">11.1.1. </span>Where did the name Charliecloud come from?</a><a class="headerlink" href="#where-did-the-name-charliecloud-come-from" title="Permalink to this heading">¶</a></h3>
<p><em>Charlie</em> — Charles F. McMillan was director of Los Alamos National Laboratory
from June 2011 until December 2017, i.e., at the time Charliecloud was started
in early 2014. He is universally referred to as “Charlie” here.</p>
<p><em>cloud</em> — Charliecloud provides cloud-like flexibility for HPC systems.</p>
</section>
<section id="how-do-you-spell-charliecloud">
<h3><a class="toc-backref" href="#id6" role="doc-backlink"><span class="section-number">11.1.2. </span>How do you spell Charliecloud?</a><a class="headerlink" href="#how-do-you-spell-charliecloud" title="Permalink to this heading">¶</a></h3>
<p>We try to be consistent with <em>Charliecloud</em> — one word, no camel case. That
is, <em>Charlie Cloud</em> and <em>CharlieCloud</em> are both incorrect.</p>
</section>
<section id="how-large-is-charliecloud">
<h3><a class="toc-backref" href="#id7" role="doc-backlink"><span class="section-number">11.1.3. </span>How large is Charliecloud?</a><a class="headerlink" href="#how-large-is-charliecloud" title="Permalink to this heading">¶</a></h3>
<p>We pride ourselves on keeping Charliecloud lightweight and simple. The lines
of code as of version 0.38 is:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Program itself</p></td>
<td><p>9087</p></td>
</tr>
<tr class="row-even"><td><p>Test suite &amp; examples</p></td>
<td><p>12086</p></td>
</tr>
<tr class="row-odd"><td><p>Documentation</p></td>
<td><p>6526</p></td>
</tr>
<tr class="row-even"><td><p>Build system</p></td>
<td><p>1298</p></td>
</tr>
<tr class="row-odd"><td><p>Packaging</p></td>
<td><p>629</p></td>
</tr>
<tr class="row-even"><td><p>Miscellaneous</p></td>
<td><p>509</p></td>
</tr>
<tr class="row-odd"><td><p>Total</p></td>
<td><p>30135</p></td>
</tr>
</tbody>
</table>
<p>These include code only, excluding blank lines and comments. They were counted
using <a class="reference external" href="https://github.com/AlDanial/cloc">cloc</a> version 1.96.
We typically quote the “Program itself” number when describing the size of
Charliecloud. (Please do not quote the size in Priedhorsky and Randles 2017,
as that number is very out of date.)</p>
</section>
</section>
<section id="errors">
<h2><a class="toc-backref" href="#id8" role="doc-backlink"><span class="section-number">11.2. </span>Errors</a><a class="headerlink" href="#errors" title="Permalink to this heading">¶</a></h2>
<section id="how-do-i-read-the-ch-run-error-messages">
<h3><a class="toc-backref" href="#id9" role="doc-backlink"><span class="section-number">11.2.1. </span>How do I read the <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> error messages?</a><a class="headerlink" href="#how-do-i-read-the-ch-run-error-messages" title="Permalink to this heading">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> error messages look like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span>foo<span class="w"> </span>--<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>hello
<span class="go">ch-run[25750]: can’t find image: foo: No such file or directory (ch-run.c:107 2)</span>
</pre></div>
</div>
<p>There is a lot of information here, and it comes in this order:</p>
<ol class="arabic simple">
<li><p>Name of the executable; always <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>.</p></li>
<li><p>Process ID in square brackets; here <code class="code docutils literal notranslate"><span class="pre">25750</span></code>. This is useful when
debugging parallel <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> invocations.</p></li>
<li><p>Colon.</p></li>
<li><p>Main error message; here <code class="code docutils literal notranslate"><span class="pre">can’t</span> <span class="pre">find</span> <span class="pre">image:</span> <span class="pre">foo</span></code>. This should be
informative as to what went wrong, and if it’s not, please file an issue,
because you may have found a usability bug. Note that in some cases you may
encounter the default message <code class="code docutils literal notranslate"><span class="pre">error</span></code>; if this happens and you’re not
doing something very strange, that’s also a usability bug.</p></li>
<li><p>Colon (but note that the main error itself can contain colons too), if and
only if the next item is present.</p></li>
<li><p>Operating system’s description of the the value of <code class="code docutils literal notranslate"><span class="pre">errno</span></code>; here
<code class="code docutils literal notranslate"><span class="pre">No</span> <span class="pre">such</span> <span class="pre">file</span> <span class="pre">or</span> <span class="pre">directory</span></code>. Omitted if not applicable.</p></li>
<li><p>Open parenthesis.</p></li>
<li><p>Name of the source file where the error occurred; here <code class="code docutils literal notranslate"><span class="pre">ch-run.c</span></code>.
This and the following item tell developers exactly where <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>
became confused, which greatly improves our ability to provide help and/or
debug.</p></li>
<li><p>Source line where the error occurred.</p></li>
<li><p>Value of <code class="code docutils literal notranslate"><span class="pre">errno</span></code> (see <a class="reference external" href="http://www.virtsync.com/c-error-codes-include-errno">C error codes in Linux</a> for the full
list of possibilities).</p></li>
<li><p>Close parenthesis.</p></li>
</ol>
<p><em>Note:</em> Despite the structured format, the error messages are not guaranteed
to be machine-readable.</p>
</section>
<section id="ch-run-fails-with-cant-re-mount-image-read-only">
<h3><a class="toc-backref" href="#id10" role="doc-backlink"><span class="section-number">11.2.2. </span><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> fails with “can’t re-mount image read-only”</a><a class="headerlink" href="#ch-run-fails-with-cant-re-mount-image-read-only" title="Permalink to this heading">¶</a></h3>
<p>Normally, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> re-mounts the image directory read-only within the
container. This fails if the image resides on certain filesystems, such as NFS
(see <a class="reference external" href="https://github.com/hpc/charliecloud/issues/9">issue #9</a>). There are
two solutions:</p>
<ol class="arabic simple">
<li><p>Unpack the image into a different filesystem, such as <code class="code docutils literal notranslate"><span class="pre">tmpfs</span></code> or
local disk. Consult your local admins for a recommendation. Note that
Lustre is probably not a good idea because it can give poor performance for
you and also everyone else on the system.</p></li>
<li><p>Use the <code class="code docutils literal notranslate"><span class="pre">-w</span></code> switch to leave the image mounted read-write. This may
have an impact on reproducibility (because the application can change the
image between runs) and/or stability (if there are multiple application
processes and one writes a file in the image that another is reading or
writing).</p></li>
</ol>
</section>
<section id="ch-image-fails-with-certificate-verify-failed">
<h3><a class="toc-backref" href="#id11" role="doc-backlink"><span class="section-number">11.2.3. </span><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> fails with “certificate verify failed”</a><a class="headerlink" href="#ch-image-fails-with-certificate-verify-failed" title="Permalink to this heading">¶</a></h3>
<p>When <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> interacts with a remote registry (e.g., via <code class="code docutils literal notranslate"><span class="pre">push</span></code>
or <code class="code docutils literal notranslate"><span class="pre">pull</span></code> subcommands), it will verify the registry’s HTTPS certificate.
If this fails, <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> will exit with the error “certificate verify
failed”.</p>
<p>This situation tends to arise with self-signed or institutionally-signed
certificates, even if the OS is configured to trust them. We use the Python
HTTP library Requests, which on many platforms <a class="reference external" href="https://docs.python-requests.org/en/master/user/advanced/#ca-certificates">includes its own CA
certificates bundle</a>,
ignoring the bundle installed by the OS.</p>
<p>Requests can be directed to use an alternate bundle of trusted CAs by setting
environment variable <code class="code docutils literal notranslate"><span class="pre">REQUESTS_CA_BUNDLE</span></code> to the bundle path. (See <a class="reference external" href="https://docs.python-requests.org/en/master/user/advanced/#ssl-cert-verification">the
Requests documentation</a>
for details.) For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">REQUESTS_CA_BUNDLE</span><span class="o">=</span>/usr/local/share/ca-certificates/registry.crt
<span class="gp">$ </span>ch-image<span class="w"> </span>pull<span class="w"> </span>registry.example.com/image:tag
</pre></div>
</div>
<p>Alternatively, certificate verification can be disabled entirely with the
<code class="code docutils literal notranslate"><span class="pre">--tls-no-verify</span></code> flag. However, users should enable this option only if
they have other means to be confident in the registry’s identity.</p>
</section>
<section id="storage-directory-seems-invalid">
<h3><a class="toc-backref" href="#id12" role="doc-backlink"><span class="section-number">11.2.4. </span>“storage directory seems invalid”</a><a class="headerlink" href="#storage-directory-seems-invalid" title="Permalink to this heading">¶</a></h3>
<p>Charliecloud uses its <em>storage directory</em> (<code class="code docutils literal notranslate"><span class="pre">/var/tmp/$USER.ch</span></code> by
default) for various internal uses. As such, Charliecloud needs complete
control over this directory’s contents. This error happens when the storage
directory exists but its contents do not match what’s expected, including if
it’s an empty directory, which is to protect against using common temporary
directories like <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> or <code class="code docutils literal notranslate"><span class="pre">/var/tmp</span></code> as the storage directory.</p>
<p>Let Charliecloud create the storage directory. For example, if you want to use
<code class="code docutils literal notranslate"><span class="pre">/big/containers/$USER/charlie</span></code> for the storage directory (e.g., by
setting <code class="code docutils literal notranslate"><span class="pre">CH_IMAGE_STORAGE</span></code>), ensure <code class="code docutils literal notranslate"><span class="pre">/big/containers/$USER</span></code> exists
but do not create the final directory <code class="code docutils literal notranslate"><span class="pre">charlie</span></code>.</p>
</section>
<section id="transport-endpoint-is-not-connected">
<h3><a class="toc-backref" href="#id13" role="doc-backlink"><span class="section-number">11.2.5. </span>“Transport endpoint is not connected”</a><a class="headerlink" href="#transport-endpoint-is-not-connected" title="Permalink to this heading">¶</a></h3>
<p>This error likely means that the SquashFS mount process has exited or been
killed and you’re attempting to access the mount location. This is most often
seen when a parallel launcher like <code class="code docutils literal notranslate"><span class="pre">srun</span></code> is used to run the mount
command. <code class="code docutils literal notranslate"><span class="pre">srun</span></code> will see that the mount command has exited successfully
and clean up all child processes, including that of the active mount. A
workaround is to use a tool like <code class="code docutils literal notranslate"><span class="pre">pdsh</span></code>. For more details see
Charliecloud issue
<a class="reference external" href="https://github.com/hpc/charliecloud/issues/230">#230</a>.</p>
</section>
<section id="fatal-home-not-set-from-git-or-similar">
<h3><a class="toc-backref" href="#id14" role="doc-backlink"><span class="section-number">11.2.6. </span>“fatal: <code class="code docutils literal notranslate"><span class="pre">$HOME</span></code> not set” from Git, or similar</a><a class="headerlink" href="#fatal-home-not-set-from-git-or-similar" title="Permalink to this heading">¶</a></h3>
<p>For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>Dockerfile
<span class="go">FROM alpine:3.17</span>
<span class="go">RUN apk add git</span>
<span class="go">RUN git config --global http.sslVerify false</span>
<span class="gp">$ </span>ch-image<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>foo<span class="w"> </span>-f<span class="w"> </span>Dockerfile<span class="w"> </span>.
<span class="go">  1 FROM alpine:3.17</span>
<span class="go">  2 RUN [&#39;/bin/sh&#39;, &#39;-c&#39;, &#39;apk add git&#39;]</span>
<span class="go">[...]</span>
<span class="go">  3 RUN [&#39;/bin/sh&#39;, &#39;-c&#39;, &#39;git config --global http.sslVerify false&#39;]</span>
<span class="go">fatal: $HOME not set</span>
<span class="go">error: build failed: RUN command exited with 128</span>
</pre></div>
</div>
<p>The reason this happens is that <code class="code docutils literal notranslate"><span class="pre">ch-image</span> <span class="pre">build</span></code> executes <code class="code docutils literal notranslate"><span class="pre">RUN</span></code>
instructions with <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> options including the absence of
<code class="code docutils literal notranslate"><span class="pre">--home</span></code>, under which the environment variable <code class="code docutils literal notranslate"><span class="pre">$HOME</span></code> is unset.
Thus, tools like Git that try to use it will fail.</p>
<p>The reasoning for leaving the variable unset is that because Charliecloud runs
unprivileged, it isn’t really meaningful for a container to have multiple
users, and thus building images with things in the home directory is an
antipattern. In fact, with <code class="code docutils literal notranslate"><span class="pre">--home</span></code> specified, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> sets
<code class="code docutils literal notranslate"><span class="pre">$HOME</span></code> to <code class="code docutils literal notranslate"><span class="pre">/home/$USER</span></code> and bind-mounts the user’s host home
directory at that path.</p>
<p>The concern with setting <code class="code docutils literal notranslate"><span class="pre">$HOME</span></code> to some default value during build is
that it could simply hide the problem until runtime later, where it would be
even more confusing. (That said, if this pattern is desired, it can be
implemented with an <code class="code docutils literal notranslate"><span class="pre">ARG</span></code> or <code class="code docutils literal notranslate"><span class="pre">ENV</span></code> instruction.)</p>
<p>The recommended workaround and best practice is to put configuration at the
system level, not the user level. In the example above, this means changing
<code class="code docutils literal notranslate"><span class="pre">git</span> <span class="pre">config</span> <span class="pre">--global</span></code> to <code class="code docutils literal notranslate"><span class="pre">git</span> <span class="pre">config</span> <span class="pre">--system</span></code>.</p>
<p>See the man page for <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> for more on environment variable
handling.</p>
</section>
<section id="ch-run-fails-with-cant-execve-2-permission-denied">
<h3><a class="toc-backref" href="#id15" role="doc-backlink"><span class="section-number">11.2.7. </span><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> fails with “can’t execve(2): permission denied”</a><a class="headerlink" href="#ch-run-fails-with-cant-execve-2-permission-denied" title="Permalink to this heading">¶</a></h3>
<p>For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span>/var/tmp/hello<span class="w"> </span>--<span class="w"> </span>/bin/echo<span class="w"> </span>foo
<span class="go">ch-run[154334]: error: can’t execve(2): /bin/echo: Permission denied (ch_core.c:387 13)</span>
</pre></div>
</div>
<p>But <code class="code docutils literal notranslate"><span class="pre">/bin/echo</span></code> <em>does</em> have execute permission:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>-lh<span class="w"> </span>/var/tmp/hello/bin/echo
<span class="go">-rwxr-xr-x 1 charlie charlie 51 Oct  8  2021 /var/tmp/hello/bin/echo</span>
</pre></div>
</div>
<p>In this case, the error indicates the container image is on a filesystem
mounted with <code class="code docutils literal notranslate"><span class="pre">noexec</span></code>. To verify this, you can use e.g.
<code class="code docutils literal notranslate"><span class="pre">findmnt(8)</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>findmnt
<span class="go">TARGET      SOURCE  FSTYPE  OPTIONS</span>
<span class="go">[...]</span>
<span class="go">└─/var/tmp  tmpfs   tmpfs   rw,noexec,relatime,size=8675309k</span>
</pre></div>
</div>
<p>Note <code class="code docutils literal notranslate"><span class="pre">noexec</span></code> under <code class="code docutils literal notranslate"><span class="pre">OPTIONS</span></code>.</p>
<p>To fix this, you can:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Use a different filesystem mounted <code class="code docutils literal notranslate"><span class="pre">exec</span></code> (i.e., the opposite
of <code class="code docutils literal notranslate"><span class="pre">noexec</span></code> and typically the default).</p></li>
<li><p>Change the mount options for the filesystem (e.g., update
<code class="code docutils literal notranslate"><span class="pre">/etc/fstab</span></code> or remount with <code class="code docutils literal notranslate"><span class="pre">exec</span></code>).</p></li>
<li><p>Use SquashFS format images (only for images exported from Charliecloud’s
storage directory).</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="unexpected-behavior">
<h2><a class="toc-backref" href="#id16" role="doc-backlink"><span class="section-number">11.3. </span>Unexpected behavior</a><a class="headerlink" href="#unexpected-behavior" title="Permalink to this heading">¶</a></h2>
<section id="what-do-the-version-numbers-mean">
<h3><a class="toc-backref" href="#id17" role="doc-backlink"><span class="section-number">11.3.1. </span>What do the version numbers mean?</a><a class="headerlink" href="#what-do-the-version-numbers-mean" title="Permalink to this heading">¶</a></h3>
<p>Released versions of Charliecloud have a pretty standard version number, e.g.
0.9.7.</p>
<p>Work leading up to a released version also has version numbers, to satisfy
tools that require them and to give the executables something useful to report
on <code class="code docutils literal notranslate"><span class="pre">--version</span></code>, but these can be quite messy. We refer to such versions
informally as <em>pre-releases</em>, but Charliecloud does not have formal
pre-releases such as alpha, beta, or release candidate.</p>
<p><em>Pre-release version numbers are not in order</em>, because this work is in a DAG
rather than linear, except they precede the version we are working towards. If
you’re dealing with these versions, use Git.</p>
<p>Pre-release version numbers are the version we are working towards, followed
by: <code class="code docutils literal notranslate"><span class="pre">~pre</span></code>, the branch name if not <code class="code docutils literal notranslate"><span class="pre">master</span></code> with non-alphanumerics
removed, the commit hash, and finally <code class="code docutils literal notranslate"><span class="pre">dirty</span></code> if the working directory
had uncommitted changes.</p>
<p>Examples:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">0.2.0</span></code> : Version 0.2.0. Released versions don’t include Git
information, even if built in a Git working directory.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">0.2.1~pre</span></code> : Some snapshot of work leading up to 0.2.1, built from
source code where the Git information has been lost, e.g. the tarballs
Github provides. This should make you wary because you don’t have any
provenance. It might even be uncommitted work or an abandoned branch.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">0.2.1~pre+1a99f42</span></code> : Master branch commit 1a99f42, built from a
clean working directory (i.e., no changes since that commit).</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">0.2.1~pre+foo1.0729a78</span></code> : Commit 0729a78 on branch <code class="code docutils literal notranslate"><span class="pre">foo-1</span></code>,
<code class="code docutils literal notranslate"><span class="pre">foo_1</span></code>, etc. built from clean working directory.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">0.2.1~pre+foo1.0729a78.dirty</span></code> : Commit 0729a78 on one of those
branches, plus un-committed changes.</p></li>
</ul>
</div></blockquote>
</section>
<section id="uid-0-lets-me-read-files-i-cant-otherwise">
<h3><a class="toc-backref" href="#id18" role="doc-backlink"><span class="section-number">11.3.2. </span><code class="code docutils literal notranslate"><span class="pre">--uid</span> <span class="pre">0</span></code> lets me read files I can’t otherwise!</a><a class="headerlink" href="#uid-0-lets-me-read-files-i-cant-otherwise" title="Permalink to this heading">¶</a></h3>
<p>Some permission bits can give a surprising result with a container UID of 0.
For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>whoami
<span class="go">reidpr</span>
<span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span>surprise<span class="w"> </span>&gt;<span class="w"> </span>~/cantreadme
<span class="gp">$ </span>chmod<span class="w"> </span><span class="m">000</span><span class="w"> </span>~/cantreadme
<span class="gp">$ </span>ls<span class="w"> </span>-l<span class="w"> </span>~/cantreadme
<span class="go">---------- 1 reidpr reidpr 9 Oct  3 15:03 /home/reidpr/cantreadme</span>
<span class="gp">$ </span>cat<span class="w"> </span>~/cantreadme
<span class="go">cat: /home/reidpr/cantreadme: Permission denied</span>
<span class="gp">$ </span>ch-run<span class="w"> </span>/var/tmp/hello<span class="w"> </span>cat<span class="w"> </span>~/cantreadme
<span class="go">cat: /home/reidpr/cantreadme: Permission denied</span>
<span class="gp">$ </span>ch-run<span class="w"> </span>--uid<span class="w"> </span><span class="m">0</span><span class="w"> </span>/var/tmp/hello<span class="w"> </span>cat<span class="w"> </span>~/cantreadme
<span class="go">surprise</span>
</pre></div>
</div>
<p>At first glance, it seems that we’ve found an escalation – we were able to
read a file inside a container that we could not read on the host! That seems
bad.</p>
<p>However, what is really going on here is more prosaic but complicated:</p>
<ol class="arabic simple">
<li><p>After <code class="code docutils literal notranslate"><span class="pre">unshare(CLONE_NEWUSER)</span></code>, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> gains all capabilities
inside the namespace. (Outside, capabilities are unchanged.)</p></li>
<li><p>This include <code class="code docutils literal notranslate"><span class="pre">CAP_DAC_OVERRIDE</span></code>, which enables a process to
read/write/execute a file or directory mostly regardless of its permission
bits. (This is why root isn’t limited by permissions.)</p></li>
<li><p>Within the container, <code class="code docutils literal notranslate"><span class="pre">exec(2)</span></code> capability rules are followed.
Normally, this basically means that all capabilities are dropped when
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> replaces itself with the user command. However, if EUID is
0, which it is inside the namespace given <code class="code docutils literal notranslate"><span class="pre">--uid</span> <span class="pre">0</span></code>, then the
subprocess keeps all its capabilities. (This makes sense: if root creates a
new process, it stays root.)</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">CAP_DAC_OVERRIDE</span></code> within a user namespace is honored for a file or
directory only if its UID and GID are both mapped. In this case,
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> maps <code class="code docutils literal notranslate"><span class="pre">reidpr</span></code> to container <code class="code docutils literal notranslate"><span class="pre">root</span></code> and group
<code class="code docutils literal notranslate"><span class="pre">reidpr</span></code> to itself.</p></li>
<li><p>Thus, files and directories owned by the host EUID and EGID (here
<code class="code docutils literal notranslate"><span class="pre">reidpr:reidpr</span></code>) are available for all access with <code class="code docutils literal notranslate"><span class="pre">ch-run</span>
<span class="pre">--uid</span> <span class="pre">0</span></code>.</p></li>
</ol>
<p>This is not an escalation. The quirk applies only to files owned by the
invoking user, because <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> is unprivileged outside the namespace,
and thus he or she could simply <code class="code docutils literal notranslate"><span class="pre">chmod</span></code> the file to read it. Access
inside and outside the container remains equivalent.</p>
<p>References:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://man7.org/linux/man-pages/man7/capabilities.7.html">http://man7.org/linux/man-pages/man7/capabilities.7.html</a></p></li>
<li><p><a class="reference external" href="http://lxr.free-electrons.com/source/kernel/capability.c?v=4.2#L442">http://lxr.free-electrons.com/source/kernel/capability.c?v=4.2#L442</a></p></li>
<li><p><a class="reference external" href="http://lxr.free-electrons.com/source/fs/namei.c?v=4.2#L328">http://lxr.free-electrons.com/source/fs/namei.c?v=4.2#L328</a></p></li>
</ul>
</section>
<section id="bind-creates-mount-points-within-un-writeable-directories">
<span id="faq-mkdir-ro"></span><h3><a class="toc-backref" href="#id19" role="doc-backlink"><span class="section-number">11.3.3. </span><code class="code docutils literal notranslate"><span class="pre">--bind</span></code> creates mount points within un-writeable directories!</a><a class="headerlink" href="#bind-creates-mount-points-within-un-writeable-directories" title="Permalink to this heading">¶</a></h3>
<p>Consider this image:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>/var/tmp/image
<span class="go">bin  dev  home  media  opt   root  sbin  sys  usr</span>
<span class="go">ch   etc  lib   mnt    proc  run   srv   tmp  var</span>
<span class="gp">$ </span>ls<span class="w"> </span>-ld<span class="w"> </span>/var/tmp/image/mnt
<span class="go">drwxr-xr-x 4 root root 80 Jan  5 09:52 /var/tmp/image/mnt</span>
<span class="gp">$ </span>ls<span class="w"> </span>/var/tmp/image/mnt
<span class="go">bar  foo</span>
</pre></div>
</div>
<p>That is, <code class="code docutils literal notranslate"><span class="pre">/mnt</span></code> is owned by root, un-writeable by us even considering
the prior question, and contains two subdirectories. Indeed, we cannot create
a new directory there:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir<span class="w"> </span>/var/tmp/image/mnt/baz
<span class="go">mkdir: cannot create directory ‘/var/tmp/image/mnt/baz’: Permission denied</span>
</pre></div>
</div>
<p>Recall that bind-mounting to a path that does not exist in a read-only image
fails:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span>-b<span class="w"> </span>/tmp/baz:/mnt/baz<span class="w"> </span>/var/tmp/image<span class="w"> </span>--<span class="w"> </span>ls<span class="w"> </span>/mnt
<span class="go">ch-run[40498]: error: can&#39;t mkdir: /var/tmp/image/mnt/baz: Read-only file system (ch_misc.c:582 30)</span>
</pre></div>
</div>
<p>That’s fine; we’ll just use <code class="code docutils literal notranslate"><span class="pre">--write-fake</span></code> to create a writeable overlay
on the container. Then we can make any mount points we need. Right?</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span>-W<span class="w"> </span>/var/tmp/image<span class="w"> </span>--<span class="w"> </span>mkdir<span class="w"> </span>/qux<span class="w">      </span><span class="c1"># succeeds</span>
<span class="gp">$ </span>ch-run<span class="w"> </span>-W<span class="w"> </span>/var/tmp/image<span class="w"> </span>--<span class="w"> </span>mkdir<span class="w"> </span>/mnt/baz<span class="w">  </span><span class="c1"># fails</span>
<span class="go">mkdir: can&#39;t create directory &#39;/mnt/baz&#39;: Permission denied</span>
</pre></div>
</div>
<p>Wait — why could we create a subdirectory of (container path) <code class="code docutils literal notranslate"><span class="pre">/</span></code> but
not a subdirectory of <code class="code docutils literal notranslate"><span class="pre">/mnt</span></code>? This is because the latter, which is at
host path <code class="code docutils literal notranslate"><span class="pre">/var/tmp/image/mnt</span></code>, is not writeable by us: the overlayfs
propagates the directory’s no-write permissions. Despite this, we can in fact
use paths that do not yet exist for bind-mount destinations:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span>-W<span class="w"> </span>-b<span class="w"> </span>/tmp/baz:/mnt/baz<span class="w"> </span>/var/tmp/image<span class="w"> </span>--<span class="w"> </span>ls<span class="w"> </span>/mnt
<span class="go">bar  baz  foo</span>
</pre></div>
</div>
<p>What’s happening is bind-mount trickery and a symlink ranch. <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>
creates a new directory on the overlaid tmpfs, bind-mounts the old (host path)
<code class="code docutils literal notranslate"><span class="pre">/var/tmp/images/mnt</span></code> to a subdirectory of it, symlinks the old
contents, and finally overmounts the old, un-writeable directory with the new
one:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span>-W<span class="w"> </span>-b<span class="w"> </span>/tmp/baz:/mnt/baz<span class="w"> </span>/var/tmp/image<span class="w"> </span>--<span class="w"> </span>ls<span class="w"> </span>-la<span class="w"> </span>/mnt
<span class="go">drwxr-x---    4 reidpr   reidpr         120 Jan  5 17:11 .</span>
<span class="go">drwx------    1 reidpr   reidpr          40 Jan  5 17:11 ..</span>
<span class="go">drwxr-xr-x    4 nobody   nogroup         80 Jan  5 16:52 .orig</span>
<span class="go">lrwxrwxrwx    1 reidpr   reidpr           9 Jan  5 17:11 bar -&gt; .orig/bar</span>
<span class="go">drwxr-x---    2 reidpr   reidpr          40 Jan  3 23:49 baz</span>
<span class="go">lrwxrwxrwx    1 reidpr   reidpr           9 Jan  5 17:11 foo -&gt; .orig/foo</span>
<span class="gp">$ </span>ch-run<span class="w"> </span>-W<span class="w"> </span>-b<span class="w"> </span>/tmp/baz:/mnt/baz<span class="w"> </span>/var/tmp/image<span class="w"> </span>--<span class="w"> </span>cat<span class="w"> </span>/proc/mounts<span class="w"> </span><span class="p">|</span><span class="w"> </span>fgrep<span class="w"> </span><span class="s1">&#39; /mnt&#39;</span>
<span class="go">none /mnt tmpfs rw,relatime,size=3943804k,uid=1000,gid=1000,inode64 0 0</span>
<span class="go">none /mnt/.orig overlay rw,relatime,lowerdir=/var/tmp/image,upperdir=/mnt/upper,workdir=/mnt/work,volatile,userxattr 0 0</span>
<span class="go">tmpfs /mnt/baz tmpfs rw,relatime,size=8388608k,inode64 0 0</span>
</pre></div>
</div>
<p>This new directory is writeable, and <code class="code docutils literal notranslate"><span class="pre">mkdir(2)</span></code> succeeds. (The overlaid
tmpfs is mounted on <em>host</em> <code class="code docutils literal notranslate"><span class="pre">/mnt</span></code> during container assembly, which is
why it appears in mount options.)</p>
<p>There are differences from the original directory, of course. Most notably:</p>
<blockquote>
<div><ul class="simple">
<li><p>The ranched symlinks can be deleted by the user within the container,
contrary to the old directory’s read-only permissions.</p></li>
<li><p>The contents of the “ranched” directory become symlinks rather than their
original file type.</p></li>
</ul>
</div></blockquote>
<p>Software that cares about these things may break.</p>
</section>
<section id="why-does-ping-not-work">
<h3><a class="toc-backref" href="#id20" role="doc-backlink"><span class="section-number">11.3.4. </span>Why does <code class="code docutils literal notranslate"><span class="pre">ping</span></code> not work?</a><a class="headerlink" href="#why-does-ping-not-work" title="Permalink to this heading">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">ping</span></code> fails with “permission denied” or similar under Charliecloud,
even if you’re UID 0 inside the container:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span><span class="nv">$IMG</span><span class="w"> </span>--<span class="w"> </span>ping<span class="w"> </span><span class="m">8</span>.8.8.8
<span class="go">PING 8.8.8.8 (8.8.8.8): 56 data bytes</span>
<span class="go">ping: permission denied (are you root?)</span>
<span class="gp">$ </span>ch-run<span class="w"> </span>--uid<span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">$IMG</span><span class="w"> </span>--<span class="w"> </span>ping<span class="w"> </span><span class="m">8</span>.8.8.8
<span class="go">PING 8.8.8.8 (8.8.8.8): 56 data bytes</span>
<span class="go">ping: permission denied (are you root?)</span>
</pre></div>
</div>
<p>This is because <code class="code docutils literal notranslate"><span class="pre">ping</span></code> needs a raw socket to construct the needed
<code class="code docutils literal notranslate"><span class="pre">ICMP</span> <span class="pre">ECHO</span></code> packets, which requires capability <code class="code docutils literal notranslate"><span class="pre">CAP_NET_RAW</span></code> or
root. Unprivileged users can normally use <code class="code docutils literal notranslate"><span class="pre">ping</span></code> because it’s a setuid
or setcap binary: it raises privilege using the filesystem bits on the
executable to obtain a raw socket.</p>
<p>Under Charliecloud, there are multiple reasons <code class="code docutils literal notranslate"><span class="pre">ping</span></code> can’t get a raw
socket. First, images are unpacked without privilege, meaning that setuid and
setcap bits are lost. But even if you do get privilege in the container (e.g.,
with <code class="code docutils literal notranslate"><span class="pre">--uid=0</span></code>), this only applies in the container. Charliecloud uses
the host’s network namespace, where your unprivileged host identity applies
and <code class="code docutils literal notranslate"><span class="pre">ping</span></code> still can’t get a raw socket.</p>
<p>The recommended alternative is to simply try the thing you want to do, without
testing connectivity using <code class="code docutils literal notranslate"><span class="pre">ping</span></code> first.</p>
</section>
<section id="why-is-matlab-trying-and-failing-to-change-the-group-of-dev-pts-0">
<h3><a class="toc-backref" href="#id21" role="doc-backlink"><span class="section-number">11.3.5. </span>Why is MATLAB trying and failing to change the group of <code class="code docutils literal notranslate"><span class="pre">/dev/pts/0</span></code>?</a><a class="headerlink" href="#why-is-matlab-trying-and-failing-to-change-the-group-of-dev-pts-0" title="Permalink to this heading">¶</a></h3>
<p>MATLAB and some other programs want pseudo-TTY (PTY) files to be group-owned
by <code class="code docutils literal notranslate"><span class="pre">tty</span></code>. If it’s not, Matlab will attempt to <code class="code docutils literal notranslate"><span class="pre">chown(2)</span></code> the file,
which fails inside a container.</p>
<p>The scenario in more detail is this. Assume you’re user <code class="code docutils literal notranslate"><span class="pre">charlie</span></code>
(UID=1000), your primary group is <code class="code docutils literal notranslate"><span class="pre">nerds</span></code> (GID=1001), <code class="code docutils literal notranslate"><span class="pre">/dev/pts/0</span></code>
is the PTY file in question, and its ownership is <code class="code docutils literal notranslate"><span class="pre">charlie:tty</span></code>
(<code class="code docutils literal notranslate"><span class="pre">1000:5</span></code>), as it should be. What happens in the container by default
is:</p>
<ol class="arabic simple">
<li><p>MATLAB <code class="code docutils literal notranslate"><span class="pre">stat(2)</span></code>s <code class="code docutils literal notranslate"><span class="pre">/dev/pts/0</span></code> and checks the GID.</p></li>
<li><p>This GID is <code class="code docutils literal notranslate"><span class="pre">nogroup</span></code> (65534) because <code class="code docutils literal notranslate"><span class="pre">tty</span></code> (5) is not mapped
on the host side (and cannot be, because only one’s EGID can be mapped in
an unprivileged user namespace).</p></li>
<li><p>MATLAB concludes this is bad.</p></li>
<li><p>MATLAB executes <code class="code docutils literal notranslate"><span class="pre">chown(&quot;/dev/pts/0&quot;,</span> <span class="pre">1000,</span> <span class="pre">5)</span></code>.</p></li>
<li><p>This fails because GID 5 is not mapped on the guest side.</p></li>
<li><p>MATLAB pukes.</p></li>
</ol>
<p>The workaround is to map your EGID of 1001 to 5 inside the container (instead
of the default 1001:1001), i.e. <code class="code docutils literal notranslate"><span class="pre">--gid=5</span></code>. Then, step 4 succeeds because
the call is mapped to <code class="code docutils literal notranslate"><span class="pre">chown(&quot;/dev/pts/0&quot;,</span> <span class="pre">1000,</span> <span class="pre">1001)</span></code> and MATLAB is
happy.</p>
</section>
<section id="ch-convert-from-docker-incorrect-image-sizes">
<h3><a class="toc-backref" href="#id22" role="doc-backlink"><span class="section-number">11.3.6. </span><code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> from Docker incorrect image sizes</a><a class="headerlink" href="#ch-convert-from-docker-incorrect-image-sizes" title="Permalink to this heading">¶</a></h3>
<p>When converting from Docker, <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> often finishes before the
progress bar is complete. For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-convert<span class="w"> </span>-i<span class="w"> </span>docker<span class="w"> </span>foo<span class="w"> </span>/var/tmp/foo.tar.gz
<span class="go">input:   docker    foo</span>
<span class="go">output:  tar       /var/tmp/foo.tar.gz</span>
<span class="go">exporting ...</span>
<span class="go"> 373MiB 0:00:21 [============================&gt;                 ] 65%</span>
<span class="go">[...]</span>
</pre></div>
</div>
<p>In this case, the <code class="code docutils literal notranslate"><span class="pre">.tar.gz</span></code> contains 392 MB uncompressed:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>zcat<span class="w"> </span>/var/tmp/foo.tar.gz<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc
<span class="go">2740966 14631550 392145408</span>
</pre></div>
</div>
<p>But Docker thinks the image is 597 MB:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>docker<span class="w"> </span>image<span class="w"> </span>inspect<span class="w"> </span>foo<span class="w"> </span><span class="p">|</span><span class="w"> </span>fgrep<span class="w"> </span>-i<span class="w"> </span>size
<span class="go">        &quot;Size&quot;: 596952928,</span>
<span class="go">        &quot;VirtualSize&quot;: 596952928,</span>
</pre></div>
</div>
<p>We’ve also seen cases where the Docker-reported size is an <em>under</em>estimate:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-convert<span class="w"> </span>-i<span class="w"> </span>docker<span class="w"> </span>bar<span class="w"> </span>/var/tmp/bar.tar.gz
<span class="go">input:   docker    bar</span>
<span class="go">output:  tar       /var/tmp/bar.tar.gz</span>
<span class="go">exporting ...</span>
<span class="go"> 423MiB 0:00:22 [============================================&gt;] 102%</span>
<span class="go">[...]</span>
<span class="gp">$ </span>zcat<span class="w"> </span>/var/tmp/bar.tar.gz<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc
<span class="go">4181186 20317858 444212736</span>
<span class="gp">$ </span>sudo<span class="w"> </span>docker<span class="w"> </span>image<span class="w"> </span>inspect<span class="w"> </span>bar<span class="w"> </span><span class="p">|</span><span class="w"> </span>fgrep<span class="w"> </span>-i<span class="w"> </span>size
<span class="go">        &quot;Size&quot;: 433812403,</span>
<span class="go">        &quot;VirtualSize&quot;: 433812403,</span>
</pre></div>
</div>
<p>We think that this is because Docker is computing size based on the size of
the layers rather than the unpacked image. We do not currently have a fix; see
<a class="reference external" href="https://github.com/hpc/charliecloud/issues/165">issue #165</a>.</p>
</section>
<section id="my-password-that-contains-digits-doesnt-work-in-virtualbox-console">
<h3><a class="toc-backref" href="#id23" role="doc-backlink"><span class="section-number">11.3.7. </span>My password that contains digits doesn’t work in VirtualBox console</a><a class="headerlink" href="#my-password-that-contains-digits-doesnt-work-in-virtualbox-console" title="Permalink to this heading">¶</a></h3>
<p>VirtualBox has confusing Num Lock behavior. Thus, you may be typing arrows,
page up/down, etc. instead of digits, without noticing because console
password fields give no feedback, not even whether a character has been typed.</p>
<p>Try using the number row instead, toggling Num Lock key, or SSHing into the
virtual machine.</p>
</section>
<section id="mode-bits-permission-bits-are-lost">
<h3><a class="toc-backref" href="#id24" role="doc-backlink"><span class="section-number">11.3.8. </span>Mode bits (permission bits) are lost</a><a class="headerlink" href="#mode-bits-permission-bits-are-lost" title="Permalink to this heading">¶</a></h3>
<p>Charliecloud preserves only some mode bits, specifically user, group, and
world permissions, and the <a class="reference external" href="https://man7.org/linux/man-pages/man1/chmod.1.html#RESTRICTED_DELETION_FLAG_OR_STICKY_BIT">restricted deletion flag</a>
on directories; i.e. 777 on files and 1777 on directories.</p>
<p>The setuid (4000) and setgid (2000) bits are not preserved because ownership
of files within Charliecloud images is that of the user who unpacks the image.
Leaving these bits set could therefore surprise that user by unexpectedly
creating files and directories setuid/gid to them.</p>
<p>The sticky bit (1000) is not preserved for files because <code class="code docutils literal notranslate"><span class="pre">unsquashfs(1)</span></code>
unsets it even with umask 000. However, this is bit is largely obsolete for
files.</p>
<p>Note the non-preserved bits may <em>sometimes</em> be retained, but this is undefined
behavior. The specified behavior is that they may be zeroed at any time.</p>
</section>
<section id="why-is-my-wildcard-in-ch-run-not-working">
<h3><a class="toc-backref" href="#id25" role="doc-backlink"><span class="section-number">11.3.9. </span>Why is my wildcard in <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> not working?</a><a class="headerlink" href="#why-is-my-wildcard-in-ch-run-not-working" title="Permalink to this heading">¶</a></h3>
<p>Be aware that wildcards in the <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> command are interpreted by the
host, not the container, unless protected. One workaround is to use a
sub-shell. For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>/usr/bin/oldfind
<span class="go">ls: cannot access &#39;/usr/bin/oldfind&#39;: No such file or directory</span>
<span class="gp">$ </span>ch-run<span class="w"> </span>/var/tmp/hello.sqfs<span class="w"> </span>--<span class="w"> </span>ls<span class="w"> </span>/usr/bin/oldfind
<span class="go">/usr/bin/oldfind</span>
<span class="gp">$ </span>ls<span class="w"> </span>/usr/bin/oldf*
<span class="go">ls: cannot access &#39;/usr/bin/oldf*&#39;: No such file or directory</span>
<span class="gp">$ </span>ch-run<span class="w"> </span>/var/tmp/hello.sqfs<span class="w"> </span>--<span class="w"> </span>ls<span class="w"> </span>/usr/bin/oldf*
<span class="go">ls: cannot access /usr/bin/oldf*: No such file or directory</span>
<span class="gp">$ </span>ch-run<span class="w"> </span>/var/tmp/hello.sqfs<span class="w"> </span>--<span class="w"> </span>sh<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;ls /usr/bin/oldf*&#39;</span>
<span class="go">/usr/bin/oldfind</span>
</pre></div>
</div>
</section>
</section>
<section id="how-do-i">
<h2><a class="toc-backref" href="#id26" role="doc-backlink"><span class="section-number">11.4. </span>How do I ...</a><a class="headerlink" href="#how-do-i" title="Permalink to this heading">¶</a></h2>
<section id="my-app-needs-to-write-to-var-log-run-etc">
<h3><a class="toc-backref" href="#id27" role="doc-backlink"><span class="section-number">11.4.1. </span>My app needs to write to <code class="code docutils literal notranslate"><span class="pre">/var/log</span></code>, <code class="code docutils literal notranslate"><span class="pre">/run</span></code>, etc.</a><a class="headerlink" href="#my-app-needs-to-write-to-var-log-run-etc" title="Permalink to this heading">¶</a></h3>
<p>Because the image is mounted read-only by default, log files, caches, and
other stuff cannot be written anywhere in the image. You have three options:</p>
<ol class="arabic simple">
<li><p>Configure the application to use a different directory. <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> is
often a good choice, because it’s shared with the host and fast.</p></li>
<li><p>Use <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> commands in your Dockerfile to create symlinks that point
somewhere writeable, e.g. <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code>, or <code class="code docutils literal notranslate"><span class="pre">/mnt/0</span></code> with
<code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">--bind</span></code>.</p></li>
<li><p>Run the image read-write with <code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">-w</span></code>. Be careful that multiple
containers do not try to write to the same files.</p></li>
</ol>
</section>
<section id="openmpi-charliecloud-jobs-dont-work">
<h3><a class="toc-backref" href="#id28" role="doc-backlink"><span class="section-number">11.4.2. </span>OpenMPI Charliecloud jobs don’t work</a><a class="headerlink" href="#openmpi-charliecloud-jobs-dont-work" title="Permalink to this heading">¶</a></h3>
<p>MPI can be finicky. This section documents some of the problems we’ve seen.</p>
<section id="mpirun-cant-launch-jobs">
<h4><a class="toc-backref" href="#id29" role="doc-backlink"><span class="section-number">11.4.2.1. </span><code class="code docutils literal notranslate"><span class="pre">mpirun</span></code> can’t launch jobs</a><a class="headerlink" href="#mpirun-cant-launch-jobs" title="Permalink to this heading">¶</a></h4>
<p>For example, you might see:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">1</span><span class="w"> </span>ch-run<span class="w"> </span>/var/tmp/mpihello-openmpi<span class="w"> </span>--<span class="w"> </span>/hello/hello
<span class="go">App launch reported: 2 (out of 2) daemons - 0 (out of 1) procs</span>
<span class="go">[cn001:27101] PMIX ERROR: BAD-PARAM in file src/dstore/pmix_esh.c at line 996</span>
</pre></div>
</div>
<p>We’re not yet sure why this happens — it may be a mismatch between the OpenMPI
builds inside and outside the container — but in our experience launching with
<code class="code docutils literal notranslate"><span class="pre">srun</span></code> often works when <code class="code docutils literal notranslate"><span class="pre">mpirun</span></code> doesn’t, so try that.</p>
</section>
<section id="communication-between-ranks-on-the-same-node-fails">
<span id="faq-join"></span><h4><a class="toc-backref" href="#id30" role="doc-backlink"><span class="section-number">11.4.2.2. </span>Communication between ranks on the same node fails</a><a class="headerlink" href="#communication-between-ranks-on-the-same-node-fails" title="Permalink to this heading">¶</a></h4>
<p>OpenMPI has many ways to transfer messages between ranks. If the ranks are on
the same node, it is faster to do these transfers using shared memory rather
than involving the network stack. There are two ways to use shared memory.</p>
<p>The first and older method is to use POSIX or SysV shared memory segments.
This approach uses two copies: one from Rank A to shared memory, and a second
from shared memory to Rank B. For example, the <code class="code docutils literal notranslate"><span class="pre">sm</span></code> <em>byte transport
layer</em> (BTL) does this.</p>
<p>The second and newer method is to use the <code class="code docutils literal notranslate"><span class="pre">process_vm_readv(2)</span></code> and/or
<code class="code docutils literal notranslate"><span class="pre">process_vm_writev(2)</span></code>) system calls to transfer messages directly from
Rank A’s virtual memory to Rank B’s. This approach is known as <em>cross-memory
attach</em> (CMA). It gives significant performance improvements in <a class="reference external" href="https://blogs.cisco.com/performance/the-vader-shared-memory-transport-in-open-mpi-now-featuring-3-flavors-of-zero-copy">benchmarks</a>,
though of course the real-world impact depends on the application. For
example, the <code class="code docutils literal notranslate"><span class="pre">vader</span></code> BTL (enabled by default in OpenMPI 2.0) and
<code class="code docutils literal notranslate"><span class="pre">psm2</span></code> <em>matching transport layer</em> (MTL) do this.</p>
<p>The problem in Charliecloud is that the second approach does not work by
default.</p>
<p>We can demonstrate the problem with LAMMPS molecular dynamics application:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>srun<span class="w"> </span>--cpus-per-task<span class="w"> </span><span class="m">1</span><span class="w"> </span>ch-run<span class="w"> </span>/var/tmp/lammps_mpi<span class="w"> </span>--<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>lmp_mpi<span class="w"> </span>-log<span class="w"> </span>none<span class="w"> </span>-in<span class="w"> </span>/lammps/examples/melt/in.melt
<span class="go">[cn002:21512] Read -1, expected 6144, errno = 1</span>
<span class="go">[cn001:23947] Read -1, expected 6144, errno = 1</span>
<span class="go">[cn002:21517] Read -1, expected 9792, errno = 1</span>
<span class="go">[... repeat thousands of times ...]</span>
</pre></div>
</div>
<p>With <code class="code docutils literal notranslate"><span class="pre">strace(1)</span></code>, one can isolate the problem to the system call noted
above:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">process_vm_readv(...) = -1 EPERM (Operation not permitted)</span>
<span class="go">write(33, &quot;[cn001:27673] Read -1, expected 6&quot;..., 48) = 48</span>
</pre></div>
</div>
<p>The <a class="reference external" href="http://man7.org/linux/man-pages/man2/process_vm_readv.2.html">man page</a>
reveals that these system calls require that the process have permission to
<code class="code docutils literal notranslate"><span class="pre">ptrace(2)</span></code> one another, but sibling user namespaces <a class="reference external" href="http://man7.org/linux/man-pages/man2/ptrace.2.html">do not</a>. (You <em>can</em>
<code class="code docutils literal notranslate"><span class="pre">ptrace(2)</span></code> into a child namespace, which is why <code class="code docutils literal notranslate"><span class="pre">gdb</span></code> doesn’t
require anything special in Charliecloud.)</p>
<p>This problem is not specific to containers; for example, many settings of
kernels with <a class="reference external" href="https://www.kernel.org/doc/Documentation/security/Yama.txt">YAMA</a> enabled will
similarly disallow this access.</p>
<p>So what can you do? There are a few options:</p>
<ul>
<li><p>We recommend simply using the <code class="code docutils literal notranslate"><span class="pre">--join</span></code> family of arguments to
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>. This puts a group of <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> peers in the same
namespaces; then, the system calls work. See the <a class="reference internal" href="ch-run.html"><span class="doc">ch-run</span></a> man page for
details.</p></li>
<li><p>You can also sometimes turn off single-copy. For example, for <code class="code docutils literal notranslate"><span class="pre">vader</span></code>,
set the MCA variable <code class="code docutils literal notranslate"><span class="pre">btl_vader_single_copy_mechanism</span></code> to
<code class="code docutils literal notranslate"><span class="pre">none</span></code>, e.g. with an environment variable:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">OMPI_MCA_btl_vader_single_copy_mechanism</span><span class="o">=</span>none
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">psm2</span></code> does not let you turn off CMA, but it does fall back to
two-copy if CMA doesn’t work. However, this fallback crashed when we tried
it.</p>
</li>
<li><p>The kernel module <a class="reference external" href="https://github.com/hjelmn/xpmem/tree/master/kernel">XPMEM</a> enables a different
single-copy approach. We have not yet tried this, and the module needs to be
evaluated for user namespace safety, but it’s quite a bit faster than CMA on
benchmarks.</p></li>
</ul>
</section>
<section id="i-get-a-bunch-of-independent-rank-0-processes-when-launching-with-srun">
<h4><a class="toc-backref" href="#id31" role="doc-backlink"><span class="section-number">11.4.2.3. </span>I get a bunch of independent rank-0 processes when launching with <code class="code docutils literal notranslate"><span class="pre">srun</span></code></a><a class="headerlink" href="#i-get-a-bunch-of-independent-rank-0-processes-when-launching-with-srun" title="Permalink to this heading">¶</a></h4>
<p>For example, you might be seeing this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>srun<span class="w"> </span>ch-run<span class="w"> </span>/var/tmp/mpihello-openmpi<span class="w"> </span>--<span class="w"> </span>/hello/hello
<span class="go">0: init ok cn036.localdomain, 1 ranks, userns 4026554634</span>
<span class="go">0: send/receive ok</span>
<span class="go">0: finalize ok</span>
<span class="go">0: init ok cn035.localdomain, 1 ranks, userns 4026554634</span>
<span class="go">0: send/receive ok</span>
<span class="go">0: finalize ok</span>
</pre></div>
</div>
<p>We were expecting a two-rank MPI job, but instead we got two independent
one-rank jobs that did not coordinate.</p>
<p>MPI ranks start as normal, independent processes that must find one another
somehow in order to sync up and begin the coupled parallel program; this
happens in <code class="code docutils literal notranslate"><span class="pre">MPI_Init()</span></code>.</p>
<p>There are lots of ways to do this coordination. Because we are launching with
the host’s Slurm, we need it to provide something for the containerized
processes for such coordination. OpenMPI must be compiled to use what that
Slurm has to offer, and Slurm must be told to offer it. What works for us is a
something called “PMIx”. You can see if your Slurm supports it with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>srun<span class="w"> </span>--mpi<span class="o">=</span>list
<span class="go">  cray_shasta</span>
<span class="go">  none</span>
<span class="go">  pmi2</span>
<span class="go">  pmix</span>
</pre></div>
</div>
<p>If <code class="code docutils literal notranslate"><span class="pre">pmix</span></code> is not in the list, you must either (a) ask your admins to
enable Slurm’s PMIx support, or (b) rebuild your container MPI against an PMI
in the list. If it is in the list, but you’re seeing this problem, that means
it is not the default, and you need to tell Slurm you want it. Try:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>srun<span class="w"> </span>--mpi<span class="o">=</span>pmix<span class="w"> </span>ch-run<span class="w"> </span>/var/tmp/mpihello-openmpi<span class="w"> </span>--<span class="w"> </span>/hello/hello
<span class="go">0: init ok wc035.localdomain, 2 ranks, userns 4026554634</span>
<span class="go">1: init ok wc036.localdomain, 2 ranks, userns 4026554634</span>
<span class="go">0: send/receive ok</span>
<span class="go">0: finalize ok</span>
</pre></div>
</div>
</section>
</section>
<section id="how-do-i-run-x11-apps">
<h3><a class="toc-backref" href="#id32" role="doc-backlink"><span class="section-number">11.4.3. </span>How do I run X11 apps?</a><a class="headerlink" href="#how-do-i-run-x11-apps" title="Permalink to this heading">¶</a></h3>
<p>X11 applications should “just work”. For example, try this Dockerfile:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">debian:stretch</span>
<span class="k">RUN</span><span class="w">    </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>xterm
</pre></div>
</div>
<p>Build it and unpack it to <code class="code docutils literal notranslate"><span class="pre">/var/tmp</span></code>. Then:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span>/scratch/ch/xterm<span class="w"> </span>--<span class="w"> </span>xterm
</pre></div>
</div>
<p>should pop an xterm.</p>
<p>If your X11 application doesn’t work, please file an issue so we can
figure out why.</p>
</section>
<section id="how-do-i-specify-an-image-reference">
<h3><a class="toc-backref" href="#id33" role="doc-backlink"><span class="section-number">11.4.4. </span>How do I specify an image reference?</a><a class="headerlink" href="#how-do-i-specify-an-image-reference" title="Permalink to this heading">¶</a></h3>
<p>You must specify an image for many use cases, including <code class="code docutils literal notranslate"><span class="pre">FROM</span></code>
instructions, the source of an image pull (e.g. <code class="code docutils literal notranslate"><span class="pre">ch-image</span> <span class="pre">pull</span></code> or
<code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">pull</span></code>), the destination of an image push, and adding image tags.
Charliecloud calls this an <em>image reference</em>, but there appears to be no
established name for this concept.</p>
<p>The syntax of an image reference is not well documented. This FAQ represents
our understanding, which is cobbled together from the <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#from">Dockerfile reference</a>, the <code class="code docutils literal notranslate"><span class="pre">docker</span>
<span class="pre">tag</span></code> <a class="reference external" href="https://docs.docker.com/engine/reference/commandline/tag/">documentation</a>, and various
forum posts. It is not a precise match for how Docker implements it, but it
should be close enough.</p>
<p>We’ll start with two complete examples with all the bells and whistles:</p>
<ol class="arabic simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">example.com:8080/foo/bar/hello-world:version1.0</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">example.com:8080/foo/bar/hello-world&#64;sha256:f6c68e2ad82a</span></code></p></li>
</ol>
<p>These references parse into the following components, in this order:</p>
<ol class="arabic simple">
<li><p>A <a class="reference external" href="https://en.wikipedia.org/wiki/Hostname">valid hostname</a>; we assume
this matches the regular expression <code class="code docutils literal notranslate"><span class="pre">[A-Za-z0-9.-]+</span></code>, which is very
approximate. Optional; here <code class="code docutils literal notranslate"><span class="pre">example.com</span></code>.</p></li>
<li><p>A colon followed by a decimal port number. If hostname is given, optional;
otherwise disallowed; here <code class="code docutils literal notranslate"><span class="pre">8080</span></code>.</p></li>
<li><p>If hostname given, a slash.</p></li>
<li><p>A path, with one or more components separated by slash. Components match
the regex <code class="code docutils literal notranslate"><span class="pre">[a-z0-9_.-]+</span></code>. Optional; here <code class="code docutils literal notranslate"><span class="pre">foo/bar</span></code>. Pedantic
details:</p>
<ul class="simple">
<li><p>Under the hood, the default path is <code class="code docutils literal notranslate"><span class="pre">library</span></code>, but this is
generally not exposed to users.</p></li>
<li><p>Three or more underscores in a row is disallowed by Docker, but we don’t
check this.</p></li>
</ul>
</li>
<li><p>If path given, a slash.</p></li>
<li><p>The image name (tag), which matches <code class="code docutils literal notranslate"><span class="pre">[a-z0-9_.-]+</span></code>. Required; here
<code class="code docutils literal notranslate"><span class="pre">hello-world</span></code>.</p></li>
<li><p>Zero or one of:</p>
<ul class="simple">
<li><p>A tag matching the regular expression <code class="code docutils literal notranslate"><span class="pre">[A-Za-z0-9_.-]+</span></code> and
preceded by a colon. Here <code class="code docutils literal notranslate"><span class="pre">version1.0</span></code> (example 1).</p></li>
<li><p>A hexadecimal hash preceded by the string <code class="code docutils literal notranslate"><span class="pre">&#64;sha256:</span></code>. Here
<code class="code docutils literal notranslate"><span class="pre">f6c68e2ad82a</span></code> (example 2).</p>
<ul>
<li><p>Note: Digest algorithms other than SHA-256 are in principle allowed,
but we have not yet seen any.</p></li>
</ul>
</li>
</ul>
</li>
</ol>
<p>Detail-oriented readers may have noticed the following gotchas:</p>
<ul>
<li><p>A hostname without port number is ambiguous with the leading component of a
path. For example, in the reference <code class="code docutils literal notranslate"><span class="pre">foo/bar/baz</span></code>, it is ambiguous
whether <code class="code docutils literal notranslate"><span class="pre">foo</span></code> is a hostname or the first (and only) component of the
path <code class="code docutils literal notranslate"><span class="pre">foo/bar</span></code>. The <a class="reference external" href="https://stackoverflow.com/a/37867949">resolution rule</a> is: if the ambiguous substring
contains a dot, assume it’s a hostname; otherwise, assume it’s a path
component.</p></li>
<li><p>The only character that cannot go in a POSIX filename is slash. Thus,
Charliecloud uses image references in filenames, replacing slash with
percent (<code class="code docutils literal notranslate"><span class="pre">%</span></code>). Because this character cannot appear in image
references, the transformation is reversible.</p>
<p>Git branch names do not allow a colon. Thus, to maintain the image reference
as both the image filename and git branch in storage, we replace the colon
with plus (<code class="code docutils literal notranslate"><span class="pre">+</span></code>).</p>
<p>An alternate approach would be to replicate the reference path in the
filesystem, i.e., path components in the reference would correspond directly
to a filesystem path. This would yield a clearer filesystem structure.
However, we elected not to do it because it complicates the code to save and
clean up image reference-related data, and it does not address a few related
questions, e.g. should the host and port also be a directory level.</p>
</li>
</ul>
<p>Usually, most of the components are omitted. For example, you’ll more commonly
see image references like:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">debian</span></code>, which refers to the tag <code class="code docutils literal notranslate"><span class="pre">latest</span></code> of image
<code class="code docutils literal notranslate"><span class="pre">debian</span></code> from Docker Hub.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">debian:stretch</span></code>, which is the same except for tag <code class="code docutils literal notranslate"><span class="pre">stretch</span></code>.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">fedora/httpd</span></code>, which is tag <code class="code docutils literal notranslate"><span class="pre">latest</span></code> of <code class="code docutils literal notranslate"><span class="pre">fedora/httpd</span></code>
from Docker Hub.</p></li>
</ul>
</div></blockquote>
<p>See <code class="code docutils literal notranslate"><span class="pre">charliecloud.py</span></code> for a specific grammar that implements this.</p>
</section>
<section id="can-i-build-or-pull-images-using-a-tool-charliecloud-doesnt-know-about">
<h3><a class="toc-backref" href="#id34" role="doc-backlink"><span class="section-number">11.4.5. </span>Can I build or pull images using a tool Charliecloud doesn’t know about?</a><a class="headerlink" href="#can-i-build-or-pull-images-using-a-tool-charliecloud-doesnt-know-about" title="Permalink to this heading">¶</a></h3>
<p>Yes. Charliecloud deals in well-known UNIX formats like directories, tarballs,
and SquashFS images. So, once you get your image into some format Charliecloud
likes, you can enter the workflow.</p>
<p>For example, <a class="reference external" href="https://github.com/containers/skopeo">skopeo</a> is a tool to
pull images to OCI format, and <a class="reference external" href="https://umo.ci">umoci</a> can flatten an OCI
image to a directory. Thus, you can use the following commands to run an
Alpine 3.9 image pulled from Docker hub:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>skopeo<span class="w"> </span>copy<span class="w"> </span>docker://alpine:3.17<span class="w"> </span>oci:/tmp/oci:img
<span class="go">[...]</span>
<span class="gp">$ </span>ls<span class="w"> </span>/tmp/oci
<span class="go">blobs  index.json  oci-layout</span>
<span class="gp">$ </span>umoci<span class="w"> </span>unpack<span class="w"> </span>--rootless<span class="w"> </span>--image<span class="w"> </span>/tmp/oci:img<span class="w"> </span>/tmp/alpine:3.17
<span class="go">[...]</span>
<span class="gp">$ </span>ls<span class="w"> </span>/tmp/alpine:3.17
<span class="go">config.json</span>
<span class="go">rootfs</span>
<span class="go">sha256_2ca27acab3a0f4057852d9a8b775791ad8ff62fbedfc99529754549d33965941.mtree</span>
<span class="go">umoci.json</span>
<span class="gp">$ </span>ls<span class="w"> </span>/tmp/alpine:3.17/rootfs
<span class="go">bin  etc   lib    mnt  proc  run   srv  tmp  var</span>
<span class="go">dev  home  media  opt  root  sbin  sys  usr</span>
<span class="gp">$ </span>ch-run<span class="w"> </span>/tmp/alpine:3.17/rootfs<span class="w"> </span>--<span class="w"> </span>cat<span class="w"> </span>/etc/alpine-release
<span class="go">3.9.5</span>
</pre></div>
</div>
</section>
<section id="how-do-i-authenticate-with-ssh-during-ch-image-build">
<h3><a class="toc-backref" href="#id35" role="doc-backlink"><span class="section-number">11.4.6. </span>How do I authenticate with SSH during <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> build?</a><a class="headerlink" href="#how-do-i-authenticate-with-ssh-during-ch-image-build" title="Permalink to this heading">¶</a></h3>
<p>The simplest approach is to run the <a class="reference external" href="https://man.openbsd.org/ssh-agent">SSH agent</a> on the host. <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> then
leverages this with two steps:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>pass environment variable <code class="code docutils literal notranslate"><span class="pre">SSH_AUTH_SOCK</span></code> into the build, with no
need to put <code class="code docutils literal notranslate"><span class="pre">ARG</span></code> in the Dockerfile or specify <code class="code docutils literal notranslate"><span class="pre">--build-arg</span></code>
on the command line; and</p></li>
<li><p>bind-mount host <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> to guest <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code>, which is where the
SSH agent’s listening socket usually resides.</p></li>
</ol>
</div></blockquote>
<p>Thus, SSH within the container will use this existing SSH agent on the host to
authenticate without further intervention.</p>
<p>For example, after making <code class="code docutils literal notranslate"><span class="pre">ssh-agent</span></code> available on the host, which is OS
and site-specific:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$SSH_AUTH_SOCK</span>
<span class="go">/tmp/ssh-rHsFFqwwqh/agent.49041</span>
<span class="gp">$ </span>ssh-add
<span class="go">Enter passphrase for /home/charlie/.ssh/id_rsa:</span>
<span class="go">Identity added: /home/charlie/.ssh/id_rsa (/home/charlie/.ssh/id_rsa)</span>
<span class="gp">$ </span>ssh-add<span class="w"> </span>-l
<span class="go">4096 SHA256:aN4n2JeMah2ekwhyHnb0Ug9bYMASmY+5uGg6MrieaQ /home/charlie/.ssh/id_rsa (RSA)</span>
<span class="gp">$ </span>cat<span class="w"> </span>./Dockerfile
<span class="go">FROM alpine:latest</span>
<span class="go">RUN apk add openssh</span>
<span class="go">RUN echo $SSH_AUTH_SOCK</span>
<span class="go">RUN ssh git@github.com</span>
<span class="gp">$ </span>ch-image<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>foo<span class="w"> </span>-f<span class="w"> </span>./Dockerfile<span class="w"> </span>.
<span class="go">[...]</span>
<span class="go">  3 RUN [&#39;/bin/sh&#39;, &#39;-c&#39;, &#39;echo $SSH_AUTH_SOCK&#39;]</span>
<span class="go">  /tmp/ssh-rHsFFqwwqh/agent.49041</span>
<span class="go">  4 RUN [&#39;/bin/sh&#39;, &#39;-c&#39;, &#39;ssh git@github.com&#39;]</span>
<span class="go">[...]</span>
<span class="go">Hi charlie! You’ve successfully authenticated, but GitHub does not provide shell access.</span>
</pre></div>
</div>
<p>Note this example is rather contrived — bare SSH sessions in a Dockerfile
rarely make sense. In practice, SSH is used as a transport to fetch something,
e.g. with <code class="code docutils literal notranslate"><span class="pre">scp(1)</span></code> or <code class="code docutils literal notranslate"><span class="pre">git(1)</span></code>. See the next entry for a more
realistic example.</p>
</section>
<section id="ssh-stops-ch-image-build-with-interactive-queries">
<h3><a class="toc-backref" href="#id36" role="doc-backlink"><span class="section-number">11.4.7. </span>SSH stops <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> build with interactive queries</a><a class="headerlink" href="#ssh-stops-ch-image-build-with-interactive-queries" title="Permalink to this heading">¶</a></h3>
<p>This often occurs during an SSH-based Git clone. For example:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">alpine:latest</span>
<span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>git<span class="w"> </span>openssh
<span class="k">RUN</span><span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:hpc/charliecloud.git
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>foo<span class="w"> </span>-f<span class="w"> </span>./Dockerfile<span class="w"> </span>.
<span class="go">[...]</span>
<span class="go">3 RUN [&#39;/bin/sh&#39;, &#39;-c&#39;, &#39;git clone git@github.com:hpc/charliecloud.git&#39;]</span>
<span class="go">Cloning into &#39;charliecloud&#39;...</span>
<span class="go">The authenticity of host &#39;github.com (140.82.113.3)&#39; can’t be established.</span>
<span class="go">RSA key fingerprint is SHA256:nThbg6kXUpJWGl7E1IGOCspRomTxdCARLviKw6E5SY8.</span>
<span class="go">Are you sure you want to continue connecting (yes/no/[fingerprint])?</span>
</pre></div>
</div>
<p>At this point, the build stops while SSH waits for input.</p>
<p>This happens even if you have <code class="code docutils literal notranslate"><span class="pre">github.com</span></code> in your
<code class="code docutils literal notranslate"><span class="pre">~/.ssh/known_hosts</span></code>. This file is not available to the build because
<code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> runs <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> without <code class="code docutils literal notranslate"><span class="pre">--home</span></code>, so <code class="code docutils literal notranslate"><span class="pre">RUN</span></code>
instructions can’t see anything in your home directory.</p>
<p>Solutions include:</p>
<blockquote>
<div><ol class="arabic">
<li><p>Change to anonymous HTTPS clone, if available. Most public repositories
will support this. For example:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">alpine:latest</span>
<span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>git
<span class="k">RUN</span><span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/hpc/charliecloud.git
</pre></div>
</div>
</li>
<li><p>Approve the connection interactively by typing <code class="code docutils literal notranslate"><span class="pre">yes</span></code>. Note this
will record details of the connection within the image, including IP
address and the fingerprint. The build also remains interactive.</p></li>
<li><p>Edit the image’s system <a class="reference external" href="https://man.openbsd.org/ssh_config">SSH config</a> to turn off host key checking.
Note this can be rather hairy, because the SSH config language is quite
flexible and the first instance of a directive is the one used. However,
often the changes can be simply appended:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">alpine:latest</span>
<span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>git<span class="w"> </span>openssh
<span class="k">RUN</span><span class="w"> </span><span class="nb">printf</span><span class="w"> </span><span class="s1">&#39;StrictHostKeyChecking=no\nUserKnownHostsFile=/dev/null\n&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>&gt;&gt;<span class="w"> </span>/etc/ssh/ssh_config
<span class="k">RUN</span><span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:hpc/charliecloud.git
</pre></div>
</div>
<p>Check your institutional policy on whether this is permissible, though
it’s worth noting that users <a class="reference external" href="https://www.usenix.org/system/files/login/articles/105484-Gutmann.pdf">almost never</a>
verify the host fingerprints anyway.</p>
<p>This will not record details of the connection in the image.</p>
</li>
<li><p>Turn off host key checking on the SSH command line. (See caveats in the
previous item.) The wrapping tool should provide a way to configure this
command line. For example, for Git:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">alpine:latest</span>
<span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>git<span class="w"> </span>openssh
<span class="k">ARG</span><span class="w"> </span><span class="nv">GIT_SSH_COMMAND</span><span class="o">=</span><span class="s2">&quot;ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null&quot;</span>
<span class="k">RUN</span><span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:hpc/charliecloud.git
</pre></div>
</div>
</li>
<li><p>Add the remote host to the system known hosts file, e.g.:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">alpine:latest</span>
<span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>git<span class="w"> </span>openssh
<span class="k">RUN</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;github.com,140.82.112.4 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/ssh/ssh_known_hosts
<span class="k">RUN</span><span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:hpc/charliecloud.git
</pre></div>
</div>
<p>This records connection details in both the Dockerfile and the image.</p>
</li>
</ol>
</div></blockquote>
<p>Other approaches could be found with web searches such as “automate unattended
SSH” or “SSH in cron jobs”.</p>
</section>
<section id="how-do-i-use-docker-to-build-charliecloud-images">
<span id="faq-building-with-docker"></span><h3><a class="toc-backref" href="#id37" role="doc-backlink"><span class="section-number">11.4.8. </span>How do I use Docker to build Charliecloud images?</a><a class="headerlink" href="#how-do-i-use-docker-to-build-charliecloud-images" title="Permalink to this heading">¶</a></h3>
<p>The short version is to run Docker commands like <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code> and
<code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">pull</span></code> like usual, and then use <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> to copy the
image from Docker storage to a SquashFS archive, tarball, or directory. If you
are behind an HTTP proxy, that requires some extra setup for Docker; see
below.</p>
<section id="security-implications-of-docker">
<h4><a class="toc-backref" href="#id38" role="doc-backlink"><span class="section-number">11.4.8.1. </span>Security implications of Docker</a><a class="headerlink" href="#security-implications-of-docker" title="Permalink to this heading">¶</a></h4>
<p>Because Docker (a) makes installing random crap from the internet simple and
(b) is easy to deploy insecurely, you should take care. Some of the
implications are below. This list should not be considered comprehensive nor a
substitute for appropriate expertise; adhere to your ethical and institutional
responsibilities.</p>
<ul>
<li><p><strong>Docker equals root.</strong> Anyone who can run the <code class="code docutils literal notranslate"><span class="pre">docker</span></code> command or
interact with the Docker daemon can <a class="reference external" href="http://web.archive.org/web/20170614013206/http://www.reventlov.com/advisories/using-the-docker-command-to-root-the-host">trivially escalate to root</a>.
This is considered a feature.</p>
<p>For this reason, don’t create the <code class="code docutils literal notranslate"><span class="pre">docker</span></code> group, as this will allow
passwordless, unlogged escalation for anyone in the group. Run it with
<code class="code docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">docker</span></code>.</p>
<p>Also, Docker runs container processes as root by default. In addition to
being poor hygiene, this can be an escalation path, e.g. if you bind-mount
host directories.</p>
</li>
<li><p><strong>Docker alters your network configuration.</strong> To see what it did:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ifconfig<span class="w">    </span><span class="c1"># note docker0 interface</span>
<span class="gp">$ </span>brctl<span class="w"> </span>show<span class="w">  </span><span class="c1"># note docker0 bridge</span>
<span class="gp">$ </span>route<span class="w"> </span>-n
</pre></div>
</div>
</li>
<li><p><strong>Docker installs services.</strong> If you don’t want the Docker service starting
automatically at boot, e.g.:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>systemctl<span class="w"> </span>is-enabled<span class="w"> </span>docker
<span class="go">enabled</span>
<span class="gp">$ </span>systemctl<span class="w"> </span>disable<span class="w"> </span>docker
<span class="gp">$ </span>systemctl<span class="w"> </span>is-enabled<span class="w"> </span>docker
<span class="go">disabled</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="configuring-for-a-proxy">
<h4><a class="toc-backref" href="#id39" role="doc-backlink"><span class="section-number">11.4.8.2. </span>Configuring for a proxy</a><a class="headerlink" href="#configuring-for-a-proxy" title="Permalink to this heading">¶</a></h4>
<p>By default, Docker does not work if you are behind a proxy, and it fails in
two different ways.</p>
<p>The first problem is that Docker itself must be told to use a proxy. This
manifests as:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>hello-world
<span class="go">Unable to find image &#39;hello-world:latest&#39; locally</span>
<span class="go">Pulling repository hello-world</span>
<span class="go">Get https://index.docker.io/v1/repositories/library/hello-world/images: dial tcp 54.152.161.54:443: connection refused</span>
</pre></div>
</div>
<p>If you have a systemd system, the <a class="reference external" href="https://docs.docker.com/engine/admin/systemd/#http-proxy">Docker documentation</a> explains how to
configure this. If you don’t have a systemd system, then
<code class="code docutils literal notranslate"><span class="pre">/etc/default/docker</span></code> might be the place to go?</p>
<p>The second problem is that programs executed during build (<code class="code docutils literal notranslate"><span class="pre">RUN</span></code>
instructions) need to know about the proxy as well. This manifests as images
failing to build because they can’t download stuff from the internet.</p>
<p>One fix is to configure your <code class="code docutils literal notranslate"><span class="pre">.bashrc</span></code> or equivalent to:</p>
<ol class="arabic">
<li><p>Set the proxy environment variables:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">HTTP_PROXY</span><span class="o">=</span>http://proxy.example.com:8088
<span class="nb">export</span><span class="w"> </span><span class="nv">http_proxy</span><span class="o">=</span><span class="nv">$HTTP_PROXY</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">HTTPS_PROXY</span><span class="o">=</span><span class="nv">$HTTP_PROXY</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">https_proxy</span><span class="o">=</span><span class="nv">$HTTP_PROXY</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">NO_PROXY</span><span class="o">=</span><span class="s1">&#39;localhost,127.0.0.1,.example.com&#39;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">no_proxy</span><span class="o">=</span><span class="nv">$NO_PROXY</span>
</pre></div>
</div>
</li>
<li><p>Configure a <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code> wrapper:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run &quot;docker build&quot; with specified arguments, adding proxy variables if</span>
<span class="c1"># set. Assumes &quot;sudo&quot; is needed to run &quot;docker&quot;.</span>
<span class="k">function</span><span class="w"> </span>docker-build<span class="w"> </span><span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$HTTP_PROXY</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>sudo<span class="w"> </span>docker<span class="w"> </span>build<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span>sudo<span class="w"> </span>docker<span class="w"> </span>build<span class="w"> </span>--build-arg<span class="w"> </span><span class="nv">HTTP_PROXY</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HTTP_PROXY</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                          </span>--build-arg<span class="w"> </span><span class="nv">HTTPS_PROXY</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HTTPS_PROXY</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                          </span>--build-arg<span class="w"> </span><span class="nv">NO_PROXY</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$NO_PROXY</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                          </span>--build-arg<span class="w"> </span><span class="nv">http_proxy</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$http_proxy</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                          </span>--build-arg<span class="w"> </span><span class="nv">https_proxy</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$https_proxy</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                          </span>--build-arg<span class="w"> </span><span class="nv">no_proxy</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$no_proxy</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                          </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="how-can-i-build-images-for-a-foreign-architecture">
<h3><a class="toc-backref" href="#id40" role="doc-backlink"><span class="section-number">11.4.9. </span>How can I build images for a foreign architecture?</a><a class="headerlink" href="#how-can-i-build-images-for-a-foreign-architecture" title="Permalink to this heading">¶</a></h3>
<section id="qemu">
<h4><a class="toc-backref" href="#id41" role="doc-backlink"><span class="section-number">11.4.9.1. </span>QEMU</a><a class="headerlink" href="#qemu" title="Permalink to this heading">¶</a></h4>
<p>Suppose you want to build Charliecloud containers on a system which has a
different architecture from the target system.</p>
<p>It’s straightforward as long as you can install suitable packages on the build
system (your personal computer?). You just need the magic of QEMU via a
distribution package with a name like Debian’s <code class="code docutils literal notranslate"><span class="pre">qemu-user-static</span></code>. For
use in an image root this needs to be the <code class="code docutils literal notranslate"><span class="pre">-static</span></code> version, not plain
<code class="code docutils literal notranslate"><span class="pre">qemu-user</span></code>, and contain a <code class="code docutils literal notranslate"><span class="pre">qemu-*-static</span></code> executable for your
target architecture. In case it doesn’t install “binfmt” hooks (telling Linux
how to run foreign binaries), you’ll need to make that work — perhaps it’s in
another package.</p>
<p>That’s all you need to make building with <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> work with a base
foreign architecture image and the <code class="code docutils literal notranslate"><span class="pre">--arch</span></code> option. It’s significantly
slower than native, but quite usable — about half the speed of native for the
ppc64le target with a build taking minutes on a laptop with a magnetic disc.
There’s a catch that images in <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> storage aren’t distinguished
by architecture except by any name you give them, e.g., a base image like
<code class="code docutils literal notranslate"><span class="pre">debian:11</span></code> pulled with <code class="code docutils literal notranslate"><span class="pre">--arch</span> <span class="pre">ppc64le</span></code> will overwrite a native
x86 one.</p>
<p>For example, to build a ppc64le image on a Debian Buster amd64 host:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>uname<span class="w"> </span>-m
<span class="go">x86_64</span>
<span class="gp">$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>qemu-user-static
<span class="gp">$ </span>ch-image<span class="w"> </span>pull<span class="w"> </span>--arch<span class="w"> </span>ppc64le<span class="w"> </span>alpine:3.17
<span class="gp">$ </span><span class="nb">printf</span><span class="w"> </span><span class="s1">&#39;FROM alpine:3.17\nRUN apk add coreutils\n&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>ch-image<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>foo<span class="w"> </span>-
<span class="gp">$ </span>ch-convert<span class="w"> </span>alpine:3.17<span class="w"> </span>/var/tmp/foo
<span class="gp">$ </span>ch-run<span class="w"> </span>/var/tmp/foo<span class="w"> </span>--<span class="w"> </span>uname<span class="w"> </span>-m
<span class="go">ppc64le</span>
</pre></div>
</div>
</section>
<section id="proot">
<h4><a class="toc-backref" href="#id42" role="doc-backlink"><span class="section-number">11.4.9.2. </span>PRoot</a><a class="headerlink" href="#proot" title="Permalink to this heading">¶</a></h4>
<p>Another way to build a foreign image, which works even without <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> to
install <code class="code docutils literal notranslate"><span class="pre">qemu-*-static</span></code>, is to populate a chroot for it with the <a class="reference external" href="https://proot-me.github.io/">PRoot</a> tool, whose <code class="code docutils literal notranslate"><span class="pre">-q</span></code> option allows
specifying a <code class="code docutils literal notranslate"><span class="pre">qemu-*-static</span></code> binary (perhaps obtained by unpacking a
distribution package).</p>
</section>
</section>
<section id="how-can-i-use-tarball-base-images-from-e-g-linuxcontainers-org">
<h3><a class="toc-backref" href="#id43" role="doc-backlink"><span class="section-number">11.4.10. </span>How can I use tarball base images from e.g. linuxcontainers.org?</a><a class="headerlink" href="#how-can-i-use-tarball-base-images-from-e-g-linuxcontainers-org" title="Permalink to this heading">¶</a></h3>
<p>If you can’t find an image repository from which to pull for the distribution
and architecture of interest, it is worth looking at the extensive collection
of rootfs archives <a class="reference external" href="https://uk.lxd.images.canonical.com/images/">maintained by linuxcontainers.org</a>. They are meant for LXC, but
are fine as a basis for Charliecloud.</p>
<p>For example, this would leave a <code class="code docutils literal notranslate"><span class="pre">ppc64le/alpine:3.17</span></code> image du jour in
the registry for use in a Dockerfile <code class="code docutils literal notranslate"><span class="pre">FROM</span></code> line. Note that
linuxcontainers.org uses the opposite order for “le” in the architecture name.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>wget<span class="w"> </span>https://uk.lxd.images.canonical.com/images/alpine/3.15/ppc64el/default/20220304_13:00/rootfs.tar.xz
<span class="gp">$ </span>ch-image<span class="w"> </span>import<span class="w"> </span>rootfs.tar.xz<span class="w"> </span>ppc64le/alpine:3.17
</pre></div>
</div>
</section>
<section id="how-can-i-control-charlieclouds-quietness-or-verbosity">
<span id="faq-verbosity"></span><h3><a class="toc-backref" href="#id44" role="doc-backlink"><span class="section-number">11.4.11. </span>How can I control Charliecloud’s quietness or verbosity?</a><a class="headerlink" href="#how-can-i-control-charlieclouds-quietness-or-verbosity" title="Permalink to this heading">¶</a></h3>
<p>Charliecloud logs various chatter about what is going on to standard error.
This is distinct from <em>output</em>, e.g., <code class="code docutils literal notranslate"><span class="pre">ch-image</span> <span class="pre">list</span></code> prints the list of
images to standard output. We use reasonably standard log levels:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p><strong>Error</strong>. Some error condition that makes it impossible to proceed. The
program exits soon after printing the error. Examples: unknown image
type, Dockerfile parse error. (There is an internal distinction between
“fatal” and “error” levels, but this isn’t really meaningful to users.)</p></li>
<li><p><strong>Warning</strong>. Unexpected condition the user needs to know about but that
should not stop the program. Examples: <code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">--mount</span></code> with a
directory image (which does not use a mount point), unsupported
Dockerfile instructions that are ignored.</p></li>
<li><p><strong>Info</strong>. Chatter useful enough to be printed by default. Example:
progress messages during image download and unpacking. (<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> is
silent during normal operations and does not have any “info” logging.)</p></li>
<li><p><strong>Verbose</strong>. Diagnostic information useful for debugging user containers,
the Charliecloud installation, and Charliecloud itself. Examples:
<code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">--join</span></code> coordination progress, <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> internal
paths, Dockerfile parse tree.</p></li>
<li><p><strong>Debug</strong>. More detailed diagnostic information useful for debugging
Charliecloud. Examples: data structures unserialized from image registry
metadata JSON, image reference parse tree.</p></li>
<li><p><strong>Trace</strong>; printed if <code class="code docutils literal notranslate"><span class="pre">-vvv</span></code>. Grotesquely detailed diagnostic
information for debugging Charliecloud, to the extent it interferes with
normal use. A sensible person might use a <a class="reference external" href="https://twitter.com/wesamo__/status/1464764461831663626">debugger</a> instead.
Examples: component-by-component progress of bind-mount target directory
analysis/creation, text of image registry JSON, every single file
unpacked from image layers.</p></li>
</ol>
</div></blockquote>
<p>Charliecloud also runs sub-programs at various times, notably commands in
<code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instructions and <code class="code docutils literal notranslate"><span class="pre">git(1)</span></code> to manage the build cache. These
programs have their own standard error and standard output streams, which
Charliecloud either suppresses or passes through depending on verbosity level.</p>
<p>Most Charliecloud programs accept <code class="code docutils literal notranslate"><span class="pre">-v</span></code> to increase logging verbosity and
<code class="code docutils literal notranslate"><span class="pre">-q</span></code> to decrease it. Generally:</p>
<blockquote>
<div><ul class="simple">
<li><p>Each <code class="code docutils literal notranslate"><span class="pre">-v</span></code> (up to three) makes Charliecloud noisier.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">-q</span></code> suppresses normal logging.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">-qq</span></code> also suppresses stdout for the program and its subprocesses,
and warnings from the program.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">-qqq</span></code> also suppresses subprocess stderr. (This means subprocesses
are completely silenced no matter what goes wrong!)</p></li>
</ul>
</div></blockquote>
<p>This table list which logging is printed at which verbosity levels (✅
indicates printed, ❌ suppressed).</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p><code class="code docutils literal notranslate"><span class="pre">-vvv</span></code></p></th>
<th class="head"><p><code class="code docutils literal notranslate"><span class="pre">-vv</span></code></p></th>
<th class="head"><p><code class="code docutils literal notranslate"><span class="pre">-v</span></code></p></th>
<th class="head"><p>def.</p></th>
<th class="head"><p><code class="code docutils literal notranslate"><span class="pre">-q</span></code></p></th>
<th class="head"><p><code class="code docutils literal notranslate"><span class="pre">-qq</span></code></p></th>
<th class="head"><p><code class="code docutils literal notranslate"><span class="pre">-qqq</span></code></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>trace</p></td>
<td><p>✅</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
</tr>
<tr class="row-odd"><td><p>debug</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
</tr>
<tr class="row-even"><td><p>verbose</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
</tr>
<tr class="row-odd"><td><p>info</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
</tr>
<tr class="row-even"><td><p>program stdout</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>[1]</p></td>
<td><p>[1]</p></td>
<td><p>[1]</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
</tr>
<tr class="row-odd"><td><p>subprocess stdout</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>[1]</p></td>
<td><p>[1]</p></td>
<td><p>[1] [2]</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
</tr>
<tr class="row-even"><td><p>warning</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
</tr>
<tr class="row-odd"><td><p>subprocess stderr</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>❌</p></td>
</tr>
<tr class="row-even"><td><p>error</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<ol class="arabic simple">
<li><p>Charliecloud handles subprocess stdout on case-by-case basis for these log
levels. For example, sometimes it’s passed through by default (e.g.,
<code class="code docutils literal notranslate"><span class="pre">RUN</span></code>) and sometimes it’s captured for internal use (e.g., many
<code class="code docutils literal notranslate"><span class="pre">git(1)</span></code> invocations).</p></li>
<li><p>In the case of <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>, the user command is considered a subprocess,
e.g. <code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">-q</span> <span class="pre">example</span> <span class="pre">--</span> <span class="pre">echo</span> <span class="pre">foo</span></code> will produce no output.</p></li>
</ol>
</section>
<section id="how-do-i-handle-extended-attributes-in-charliecloud">
<span id="faq-xattrs"></span><h3><a class="toc-backref" href="#id45" role="doc-backlink"><span class="section-number">11.4.12. </span>How do I handle extended attributes in Charliecloud?</a><a class="headerlink" href="#how-do-i-handle-extended-attributes-in-charliecloud" title="Permalink to this heading">¶</a></h3>
<p>As noted in section <a class="reference internal" href="ch-image.html#ch-image-build-cache"><span class="std std-ref">Build cache</span></a>, Charliecloud doesn’t support
extended attributes (xattrs) by default. Support for xattrs  can be enabled for
<code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> and <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> by specifying <code class="code docutils literal notranslate"><span class="pre">--xattrs</span></code> or
setting <code class="code docutils literal notranslate"><span class="pre">$CH_XATTRS</span></code>. This will make <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> save and restore
xattrs via the build cache, and will make <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> preserve xattrs on
conversion. Important caveats include:</p>
<ol class="arabic simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> and <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> cannot read xattrs in privileged
namespaces (e.g. <code class="code docutils literal notranslate"><span class="pre">trusted</span></code> and <code class="code docutils literal notranslate"><span class="pre">security</span></code>). Extended attributes
in these namespaces will never be saved or restored via the cache, and will
never be preserved when converting between image formats.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">ch-image</span> <span class="pre">import</span></code> cannot handle xattrs. This is a limitation of the
Python <a class="reference external" href="https://docs.python.org/3/library/tarfile.html">tarfile</a> library,
which as of version 3.12.1 doesn’t support xattrs (see CPython issue <a class="reference external" href="https://github.com/python/cpython/issues/113293">#113293</a>).</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">ch-convert</span> <span class="pre">-o</span> <span class="pre">ch-image</span></code> uses <code class="code docutils literal notranslate"><span class="pre">ch-image</span> <span class="pre">import</span></code> under the hood.
This in conjunction with (2) means that <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> cannot preserve
xattrs when converting to the <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> format.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">ch-image</span> <span class="pre">pull</span></code> uses the tarfile library, so xattrs will be lost when
pulling from a registry.</p></li>
<li><p>Support for xattrs varies among filesystems, e.g. tmpfs didn’t support xattrs
in the <code class="code docutils literal notranslate"><span class="pre">user</span></code> namespace prior to Linux kernel <a class="reference external" href="https://kernelnewbies.org/Linux_6.6#TMPFSe">upstream 6.6</a> (Oct 2023).</p></li>
</ol>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ch-test.html" class="btn btn-neutral float-left" title="10. ch-test" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="best_practices.html" class="btn btn-neutral float-right" title="12. Best practices" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Charliecloud a Series of LF Projects, LLC and others (web content and website). For web site terms of use, trademark policy and other project policies please see: https://lfprojects.org.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
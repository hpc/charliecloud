<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>7. ch-image &mdash; Charliecloud 0.38 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="8. ch-run" href="ch-run.html" />
    <link rel="prev" title="6. ch-fromhost" href="ch-fromhost.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Charliecloud
              <img src="_static/logo-sidebar.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.38
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">1. Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">2. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-checkns.html">3. <code class="code docutils literal notranslate"><span class="pre">ch-checkns</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-completion.bash.html">4. <code class="code docutils literal notranslate"><span class="pre">ch-completion.bash</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-convert.html">5. <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-fromhost.html">6. <code class="code docutils literal notranslate"><span class="pre">ch-fromhost</span></code></a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">7. <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code></a><ul>
<li class="toctree-l2"><a class="reference internal" href="#synopsis">7.1. Synopsis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#description">7.2. Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#architecture">7.3. Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#authentication">7.4. Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="#storage-directory">7.5. Storage directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#build-cache">7.6. Build cache</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">7.6.1. Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compared-to-other-implementations">7.6.2. Compared to other implementations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#de-duplication-and-garbage-collection">7.6.3. De-duplication and garbage collection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#large-file-threshold">7.6.4. Large file threshold</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example">7.6.5. Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#build">7.7. <code class="code docutils literal notranslate"><span class="pre">build</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">7.7.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">7.7.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#privilege-model">7.7.3. Privilege model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">7.7.3.1. Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#root-emulation-mode-fakeroot">7.7.3.2. Root emulation mode <code class="code docutils literal notranslate"><span class="pre">fakeroot</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#root-emulation-mode-seccomp-default">7.7.3.3. Root emulation mode <code class="code docutils literal notranslate"><span class="pre">seccomp</span></code> (default)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run-logging">7.7.3.4. <code class="code docutils literal notranslate"><span class="pre">RUN</span></code>  logging</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#compatibility-and-behavior-differences">7.7.4. Compatibility and behavior differences</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#context-directory">7.7.4.1. Context directory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#variable-substitution">7.7.4.2. Variable substitution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#arg">7.7.4.3. <code class="code docutils literal notranslate"><span class="pre">ARG</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#from">7.7.4.4. <code class="code docutils literal notranslate"><span class="pre">FROM</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#label">7.7.4.5. <code class="code docutils literal notranslate"><span class="pre">LABEL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#copy">7.7.4.6. <code class="code docutils literal notranslate"><span class="pre">COPY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#features-we-do-not-plan-to-support">7.7.4.7. Features we do not plan to support</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#rsync-dockerfile-extension">7.7.5. <code class="code docutils literal notranslate"><span class="pre">RSYNC</span></code> (Dockerfile extension)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id6">7.7.5.1. Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#arguments">7.7.5.2. Arguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#disallowed-rsync-1-features">7.7.5.3. Disallowed <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code> features</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">7.7.5.4. Build cache</a></li>
<li class="toctree-l4"><a class="reference internal" href="#examples-and-tutorial">7.7.5.5. Examples and tutorial</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#examples">7.7.6. Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id8">7.8. <code class="code docutils literal notranslate"><span class="pre">build-cache</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#delete">7.9. <code class="code docutils literal notranslate"><span class="pre">delete</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#gestalt">7.10. <code class="code docutils literal notranslate"><span class="pre">gestalt</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#list">7.11. <code class="code docutils literal notranslate"><span class="pre">list</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id9">7.11.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">7.11.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">7.11.3. Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#import">7.12. <code class="code docutils literal notranslate"><span class="pre">import</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#pull">7.13. <code class="code docutils literal notranslate"><span class="pre">pull</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id12">7.13.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">7.13.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id14">7.13.3. Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#push">7.14. <code class="code docutils literal notranslate"><span class="pre">push</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id15">7.14.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id16">7.14.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id17">7.14.3. Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#reset">7.15. <code class="code docutils literal notranslate"><span class="pre">reset</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#undelete">7.16. <code class="code docutils literal notranslate"><span class="pre">undelete</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#environment-variables">7.17. Environment variables</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ch-run.html">8. <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-run-oci.html">9. <code class="code docutils literal notranslate"><span class="pre">ch-run-oci</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-test.html">10. <code class="code docutils literal notranslate"><span class="pre">ch-test</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">11. Frequently asked questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="best_practices.html">12. Best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev.html">13. Contributor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Charliecloud</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">7. </span><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code></li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ch-image">
<h1><span class="section-number">7. </span><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code><a class="headerlink" href="#ch-image" title="Permalink to this heading">¶</a></h1>
<p>Build and manage images; completely unprivileged.</p>
<section id="synopsis">
<h2><span class="section-number">7.1. </span>Synopsis<a class="headerlink" href="#synopsis" title="Permalink to this heading">¶</a></h2>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>build<span class="w"> </span><span class="o">[</span>-t<span class="w"> </span>TAG<span class="o">]</span><span class="w"> </span><span class="o">[</span>-f<span class="w"> </span>DOCKERFILE<span class="o">]</span><span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>CONTEXT
<span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>build-cache<span class="w"> </span><span class="o">[</span>...<span class="o">]</span>
<span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>delete<span class="w"> </span>IMAGE_GLOB<span class="w"> </span><span class="o">[</span>IMAGE_GLOB<span class="w"> </span>...<span class="o">]</span>
<span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>gestalt<span class="w"> </span><span class="o">[</span>SELECTOR<span class="o">]</span>
<span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>import<span class="w"> </span>PATH<span class="w"> </span>IMAGE_REF
<span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>list<span class="w"> </span><span class="o">[</span>-l<span class="o">]</span><span class="w"> </span><span class="o">[</span>IMAGE_REF<span class="o">]</span>
<span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>pull<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>IMAGE_REF<span class="w"> </span><span class="o">[</span>DEST_REF<span class="o">]</span>
<span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>push<span class="w"> </span><span class="o">[</span>--image<span class="w"> </span>DIR<span class="o">]</span><span class="w"> </span>IMAGE_REF<span class="w"> </span><span class="o">[</span>DEST_REF<span class="o">]</span>
<span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>reset
<span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>undelete<span class="w"> </span>IMAGE_REF
<span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">{</span><span class="w"> </span>--help<span class="w"> </span><span class="p">|</span><span class="w"> </span>--version<span class="w"> </span><span class="p">|</span><span class="w"> </span>--dependencies<span class="w"> </span><span class="o">}</span>
</pre></div>
</div>
</section>
<section id="description">
<h2><span class="section-number">7.2. </span>Description<a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h2>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> is a tool for building and manipulating container images, but
not running them (for that you want <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>). It is completely
unprivileged, with no setuid/setgid/setcap helpers. Many operations can use
caching for speed. The action to take is specified by a sub-command.</p>
<p>Options that print brief information and then exit:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">-h</span></code>, <code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt><dd><p>Print help and exit successfully. If specified before the sub-command,
print general help and list of sub-commands; if after the sub-command,
print help specific to that sub-command.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--dependencies</span></code></dt><dd><p>Report dependency problems on standard output, if any, and exit. If all is
well, there is no output and the exit is successful; in case of problems,
the exit is unsuccessful.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt><dd><p>Print version number and exit successfully.</p>
</dd>
</dl>
</div></blockquote>
<p>Common options placed before or after the sub-command:</p>
<blockquote>
<div><dl>
<dt><code class="code docutils literal notranslate"><span class="pre">-a</span></code>, <code class="code docutils literal notranslate"><span class="pre">--arch</span> <span class="pre">ARCH</span></code></dt><dd><p>Use <code class="code docutils literal notranslate"><span class="pre">ARCH</span></code> for architecture-aware registry operations. (See section
“Architecture” below for details.)</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--always-download</span></code></dt><dd><p>Download all files when pulling, even if they are already in builder
storage. Note that <code class="code docutils literal notranslate"><span class="pre">ch-image</span> <span class="pre">pull</span></code> will always retrieve the most
up-to-date image; this option is mostly for debugging.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--auth</span></code></dt><dd><p>Authenticate with the remote repository, then (if successful) make all
subsequent requests in authenticated mode. For most subcommands, the
default is to never authenticate, i.e., make all requests anonymously. The
exception is <code class="code docutils literal notranslate"><span class="pre">push</span></code>, which implies <code class="code docutils literal notranslate"><span class="pre">--auth</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--break</span> <span class="pre">MODULE:LINE</span></code></dt><dd><p>Set a <a class="reference external" href="https://docs.python.org/3/library/pdb.html">PDB</a> breakpoint at
line number <code class="code docutils literal notranslate"><span class="pre">LINE</span></code> of module named <code class="code docutils literal notranslate"><span class="pre">MODULE</span></code> (typically the
filename with <code class="code docutils literal notranslate"><span class="pre">.py</span></code> removed, or <code class="code docutils literal notranslate"><span class="pre">__main__</span></code> for
<code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> itself). That is, a PDB debugger shell will open before
executing the specified line.</p>
<p>This is accomplished by re-parsing the module, injecting <code class="code docutils literal notranslate"><span class="pre">import</span>
<span class="pre">pdb;</span> <span class="pre">pdb.set_trace()</span></code> into the parse tree, re-compiling the tree, and
replacing the module’s code with the result. This has various gotchas,
including (1) module-level code in the target module is executed twice,
(2) the option is parsed with bespoke early code so command line argument
parsing itself can be debugged, (3) breakpoints on function definition
will trigger while the module is being re-executed, not when the function
is called (break on the first line of the function body instead), and
(4) other weirdness we haven’t yet characterized.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--cache</span></code></dt><dd><p>Enable build cache. Default if a sufficiently new Git is available. See
section <a class="reference internal" href="#ch-image-build-cache"><span class="std std-ref">Build cache</span></a> for details.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--cache-large</span> <span class="pre">SIZE</span></code></dt><dd><p>Set the cache’s large file threshold to <code class="code docutils literal notranslate"><span class="pre">SIZE</span></code> MiB, or <code class="code docutils literal notranslate"><span class="pre">0</span></code> for
no large files, which is the default. Values greater than zero can speed
up many builds but can also cause performance degradation.
<strong>Experimental.</strong> See section <a class="reference internal" href="#ch-image-bu-large"><span class="std std-ref">Large file threshold</span></a> for details.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--debug</span></code></dt><dd><p>Add a stack trace to fatal error hints. This can also be done by setting
the environment variable <code class="code docutils literal notranslate"><span class="pre">CH_IMAGE_DEBUG</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-cache</span></code></dt><dd><p>Disable build cache. Default if a sufficiently new Git is not available.
This option turns off the cache completely; if you want to re-execute a
Dockerfile and store the new results in cache, use <code class="code docutils literal notranslate"><span class="pre">--rebuild</span></code>
instead.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-lock</span></code></dt><dd><p>Disable storage directory locking. This lets you run as many concurrent
<code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> instances as you want against the same storage directory,
which risks corruption but may be OK for some workloads.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-xattrs</span></code></dt><dd><p>Enforce default handling of xattrs, i.e. do not save them in the build cache
or restore them on rebuild. This is the default, but the option is provided
to override the <code class="code docutils literal notranslate"><span class="pre">$CH_XATTRS</span></code> environment variable.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--password-many</span></code></dt><dd><p>Re-prompt the user every time a registry password is needed.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--profile</span></code></dt><dd><p>Dump profile to files <code class="code docutils literal notranslate"><span class="pre">/tmp/chofile.p</span></code> (<code class="code docutils literal notranslate"><span class="pre">cProfile</span></code> dump
format) and <code class="code docutils literal notranslate"><span class="pre">/tmp/chofile.txt</span></code> (text summary). You can convert the
former to a PDF call graph with <code class="code docutils literal notranslate"><span class="pre">gprof2dot</span> <span class="pre">-f</span> <span class="pre">pstats</span> <span class="pre">/tmp/chofile.p</span>
<span class="pre">|</span> <span class="pre">dot</span> <span class="pre">-Tpdf</span> <span class="pre">-o</span> <span class="pre">/tmp/chofile.pdf</span></code>. This excludes time spend in
subprocesses. Profile data should still be written on fatal errors, but
not if the program crashes.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-q,</span> <span class="pre">--quiet</span></code></dt><dd><p>Be quieter; can be repeated. Incompatible with <code class="code docutils literal notranslate"><span class="pre">-v</span></code> and suppresses
<code class="code docutils literal notranslate"><span class="pre">--debug</span></code> regardless of option order. See the <a class="reference internal" href="faq.html#faq-verbosity"><span class="std std-ref">FAQ entry on
verbosity</span></a> for details.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--rebuild</span></code></dt><dd><p>Execute all instructions, even if they are build cache hits, except for
<code class="code docutils literal notranslate"><span class="pre">FROM</span></code> which is retrieved from cache on hit.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-s</span></code>, <code class="code docutils literal notranslate"><span class="pre">--storage</span> <span class="pre">DIR</span></code></dt><dd><p>Set the storage directory (see below for important details).</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--tls-no-verify</span></code></dt><dd><p>Don’t verify TLS certificates of the repository. (Do not use this option
unless you understand the risks.)</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-v</span></code>, <code class="code docutils literal notranslate"><span class="pre">--verbose</span></code></dt><dd><p>Print extra chatter; can be repeated. See the <a class="reference internal" href="faq.html#faq-verbosity"><span class="std std-ref">FAQ entry on verbosity</span></a> for details.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--xattrs</span></code></dt><dd><p>Save xattrs and ACLs in the build cache, and restore them when rebuilding
from the cache.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="architecture">
<h2><span class="section-number">7.3. </span>Architecture<a class="headerlink" href="#architecture" title="Permalink to this heading">¶</a></h2>
<p>Charliecloud provides the option <code class="code docutils literal notranslate"><span class="pre">--arch</span> <span class="pre">ARCH</span></code> to specify the
architecture for architecture-aware registry operations. The argument
<code class="code docutils literal notranslate"><span class="pre">ARCH</span></code> can be: (1) <code class="code docutils literal notranslate"><span class="pre">yolo</span></code>, to bypass architecture-aware code and
use the registry’s default architecture; (2) <code class="code docutils literal notranslate"><span class="pre">host</span></code>, to use the host’s
architecture, obtained with the equivalent of <code class="code docutils literal notranslate"><span class="pre">uname</span> <span class="pre">-m</span></code> (default if
<code class="code docutils literal notranslate"><span class="pre">--arch</span></code> not specified); or (3) an architecture name. If the specified
architecture is not available, the error message will list which ones are.</p>
<p><strong>Notes:</strong></p>
<ol class="arabic simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> is limited to one image per image reference in
builder storage at a time, regardless of architecture. For example, if
you say <code class="code docutils literal notranslate"><span class="pre">ch-image</span> <span class="pre">pull</span> <span class="pre">--arch=foo</span> <span class="pre">baz</span></code> and then <code class="code docutils literal notranslate"><span class="pre">ch-image</span>
<span class="pre">pull</span> <span class="pre">--arch=bar</span> <span class="pre">baz</span></code>, builder storage will contain one image called
“baz”, with architecture “bar”.</p></li>
<li><p>Images’ default architecture is usually <code class="code docutils literal notranslate"><span class="pre">amd64</span></code>, so this is
usually what you get with <code class="code docutils literal notranslate"><span class="pre">--arch=yolo</span></code>. Similarly, if a
registry image is architecture-unaware, it will still be pulled with
<code class="code docutils literal notranslate"><span class="pre">--arch=amd64</span></code> and <code class="code docutils literal notranslate"><span class="pre">--arch=host</span></code> on x86-64 hosts (other
host architectures must specify <code class="code docutils literal notranslate"><span class="pre">--arch=yolo</span></code> to pull
architecture-unaware images).</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">uname</span> <span class="pre">-m</span></code> and image registries often use different names for
the same architecture. For example, what <code class="code docutils literal notranslate"><span class="pre">uname</span> <span class="pre">-m</span></code> reports as
“x86_64” is known to registries as “amd64”. <code class="code docutils literal notranslate"><span class="pre">--arch=host</span></code> should
translate if needed, but it’s useful to know this is happening.
Directly specified architecture names are passed to the registry
without translation.</p></li>
<li><p>Registries treat architecture as a pair of items, architecture and
sometimes variant (e.g., “arm” and “v7”). Charliecloud treats
architecture as a simple string and converts to/from the registry view
transparently.</p></li>
</ol>
</section>
<section id="authentication">
<h2><span class="section-number">7.4. </span>Authentication<a class="headerlink" href="#authentication" title="Permalink to this heading">¶</a></h2>
<p>Charliecloud does not have configuration files; thus, it has no separate
<code class="code docutils literal notranslate"><span class="pre">login</span></code> subcommand to store secrets. Instead, Charliecloud will prompt
for a username and password when authentication is needed. Note that some
repositories refer to the secret as something other than a “password”; e.g.,
GitLab calls it a “personal access token (PAT)”, Quay calls it an “application
token”, and nVidia NGC calls it an “API token”.</p>
<p>For non-interactive authentication, you can use environment variables
<code class="code docutils literal notranslate"><span class="pre">CH_IMAGE_USERNAME</span></code> and <code class="code docutils literal notranslate"><span class="pre">CH_IMAGE_PASSWORD</span></code>. Only do this if you
fully understand the implications for your specific use case, because it is
difficult to securely store secrets in environment variables.</p>
<p>By default for most subcommands, all registry access is anonymous. To instead
use authenticated access for everything, specify <code class="code docutils literal notranslate"><span class="pre">--auth</span></code> or set the
environment variable <code class="code docutils literal notranslate"><span class="pre">$CH_IMAGE_AUTH=yes</span></code>. The exception is
<code class="code docutils literal notranslate"><span class="pre">push</span></code>, which always runs in authenticated mode. Even for pulling public
images, it can be useful to authenticate for registries that have per-user
rate limits, such as <a class="reference external" href="https://docs.docker.com/docker-hub/download-rate-limit/">Docker Hub</a>. (Older versions
of Charliecloud started with anonymous access, then tried to upgrade to
authenticated if it seemed necessary. However, this turned out to be brittle;
see issue <a class="reference external" href="https://github.com/hpc/charliecloud/issues/1318">#1318</a>.)</p>
<p>The username and password are remembered for the life of the process and
silently re-offered to the registry if needed. One case when this happens is
on push to a private registry: many registries will first offer a read-only
token when <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> checks if something exists, then re-authenticate
when upgrading the token to read-write for upload. If your site uses one-time
passwords such as provided by a security device, you can specify
<code class="code docutils literal notranslate"><span class="pre">--password-many</span></code> to provide a new secret each time.</p>
<p>These values are not saved persistently, e.g. in a file. Note that we do use
normal Python variables for this information, without pinning them into
physical RAM with <a class="reference external" href="https://man7.org/linux/man-pages/man2/mlock.2.html">mlock(2)</a> or any other special
treatment, so we cannot guarantee they will never reach non-volatile storage.</p>
<div class="admonition-technical-details admonition">
<p class="admonition-title">Technical details</p>
<p>Most registries use something called <a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc6750">Bearer authentication</a>, where the client (e.g.,
Charliecloud) includes a <em>token</em> in the headers of every HTTP request.</p>
<p>The authorization dance is different from the typical UNIX approach, where
there is a separate login sequence before any content requests are made.
The client starts by simply making the HTTP request it wants (e.g., to
<code class="code docutils literal notranslate"><span class="pre">GET</span></code> an image manifest), and if the registry doesn’t like the
client’s token (or if there is no token because the client doesn’t have one
yet), it replies with HTTP 401 Unauthorized, but crucially it also provides
instructions in the response header on how to get a token. The client then
follows those instructions, obtains a token, re-tries the request, and
(hopefully) all is well. This approach also allows a client to upgrade a
token if needed, e.g. when transitioning from asking if a layer exists to
uploading its content.</p>
<p>The distinction between Charliecloud’s anonymous mode and authenticated
modes is that it will only ask for anonymous tokens in anonymous mode and
authenticated tokens in authenticated mode. That is, anonymous mode does
involve an authentication procedure to obtain a token, but this
“authentication” is done anonymously. (Yes, it’s confusing.)</p>
<p>Registries also often reply HTTP 401 when an image does not exist, rather
than the seemingly more correct HTTP 404 Not Found. This is to avoid
information leakage about the existence of images the client is not allowed
to pull, and it’s why Charliecloud never says an image simply does not
exist.</p>
</div>
</section>
<section id="storage-directory">
<h2><span class="section-number">7.5. </span>Storage directory<a class="headerlink" href="#storage-directory" title="Permalink to this heading">¶</a></h2>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> maintains state using normal files and directories located in
its <em>storage directory</em>; contents include various caches and temporary images
used for building.</p>
<p>In descending order of priority, this directory is located at:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">-s</span></code>, <code class="code docutils literal notranslate"><span class="pre">--storage</span> <span class="pre">DIR</span></code></dt><dd><p>Command line option.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">$CH_IMAGE_STORAGE</span></code></dt><dd><p>Environment variable. The path must be absolute, because the variable is
likely set in a very different context than when it’s used, which seems
error-prone on what a relative path is relative to.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">/var/tmp/$USER.ch</span></code></dt><dd><p>Default. (Previously, the default was <code class="code docutils literal notranslate"><span class="pre">/var/tmp/$USER/ch-image</span></code>. If
a valid storage directory is found at the old default path,
<code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> tries to move it to the new default path.)</p>
</dd>
</dl>
</div></blockquote>
<p>Unlike many container implementations, there is no notion of storage drivers,
graph drivers, etc., to select and/or configure.</p>
<p>The storage directory can reside on any single filesystem (i.e., it cannot be
split across multiple filesystems). However, it contains lots of small files
and metadata traffic can be intense. For example, the Charliecloud test suite
uses approximately 400,000 files and directories in the storage directory as
of this writing. Place it on a filesystem appropriate for this; tmpfs’es such
as <code class="code docutils literal notranslate"><span class="pre">/var/tmp</span></code> are a good choice if you have enough RAM (<code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> is
not recommended because <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> bind-mounts it into containers by
default).</p>
<p>While you can currently poke around in the storage directory and find unpacked
images runnable with <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>, this is not a supported use case. The
supported workflow uses <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> to obtain a packed image; see the
tutorial for details.</p>
<p>The storage directory format changes on no particular schedule.
<code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> is normally able to upgrade directories produced by a given
Charliecloud version up to one year after that version’s release. Upgrades
outside this window and downgrades are not supported. In these cases,
<code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> will refuse to run until you delete and re-initialize the
storage directory with <code class="code docutils literal notranslate"><span class="pre">ch-image</span> <span class="pre">reset</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Network filesystems, especially Lustre, are typically bad choices for the
storage directory. This is a site-specific question and your local support
will likely have strong opinions.</p>
</div>
</section>
<section id="build-cache">
<span id="ch-image-build-cache"></span><h2><span class="section-number">7.6. </span>Build cache<a class="headerlink" href="#build-cache" title="Permalink to this heading">¶</a></h2>
<section id="overview">
<h3><span class="section-number">7.6.1. </span>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h3>
<p>Subcommands that create images, such as <code class="code docutils literal notranslate"><span class="pre">build</span></code> and <code class="code docutils literal notranslate"><span class="pre">pull</span></code>, can
use a build cache to speed repeated operations. That is, an image is created
by starting from the empty image and executing a sequence of instructions,
largely Dockerfile instructions but also some others like “pull” and “import”.
Some instructions are expensive to execute (e.g., <code class="code docutils literal notranslate"><span class="pre">RUN</span> <span class="pre">wget</span>
<span class="pre">http://slow.example.com/bigfile</span></code> or transferring data billed by the byte), so
it’s often cheaper to retrieve their results from cache instead.</p>
<p>The build cache uses a relatively new Git under the hood; see the installation
instructions for version requirements. Charliecloud implements workarounds for
Git’s various storage limitations, so things like file metadata and Git
repositories within the image should work. <strong>Important exception</strong>: No files
named <code class="code docutils literal notranslate"><span class="pre">.git*</span></code> or other Git metadata are permitted in the image’s root
directory.</p>
<p><a class="reference external" href="https://man7.org/linux/man-pages/man7/xattr.7.html">Extended attributes</a>
(xattrs) are ignored by the build cache by default. Cache support for xattrs
belonging to unprivileged xattr namespaces (e.g. <code class="code docutils literal notranslate"><span class="pre">user</span></code>) can be enabled by
specifying the <code class="code docutils literal notranslate"><span class="pre">--xattrs</span></code> option or by setting the <code class="code docutils literal notranslate"><span class="pre">CH_XATTRS</span></code>
environment variable. If <code class="code docutils literal notranslate"><span class="pre">CH_XATTRS</span></code> is set, you override it with
<code class="code docutils literal notranslate"><span class="pre">--no-xattrs</span></code>. <strong>Note that extended attributes in privileged xattr
namespaces (e.g. :code:‘trusted‘) cannot be read by :code:‘ch-image‘ and will
always be lost without warning.</strong></p>
<p>The cache has three modes: <em>enabled</em>, <em>disabled</em>, and a hybrid mode called
<em>rebuild</em> where the cache is fully enabled for <code class="code docutils literal notranslate"><span class="pre">FROM</span></code> instructions, but
all other operations re-execute and re-cache their results. The purpose of
<em>rebuild</em> is to do a clean rebuild of a Dockerfile atop a known-good base
image.</p>
<p>Enabled mode is selected with <code class="code docutils literal notranslate"><span class="pre">--cache</span></code> or setting
<code class="code docutils literal notranslate"><span class="pre">$CH_IMAGE_CACHE</span></code> to <code class="code docutils literal notranslate"><span class="pre">enabled</span></code>, disabled mode with
<code class="code docutils literal notranslate"><span class="pre">--no-cache</span></code> or <code class="code docutils literal notranslate"><span class="pre">disabled</span></code>, and rebuild mode with
<code class="code docutils literal notranslate"><span class="pre">--rebuild</span></code> or <code class="code docutils literal notranslate"><span class="pre">rebuild</span></code>. The default mode is <em>enabled</em> if an
appropriate Git is installed, otherwise <em>disabled</em>.</p>
</section>
<section id="compared-to-other-implementations">
<h3><span class="section-number">7.6.2. </span>Compared to other implementations<a class="headerlink" href="#compared-to-other-implementations" title="Permalink to this heading">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section is a lightly edited excerpt from our paper “<a class="reference external" href="https://arxiv.org/abs/2309.00166">Charliecloud’s
layer-free, Git-based container build cache</a>”.</p>
</div>
<p>Existing tools such as Docker and Podman implement their build cache with a
layered (union) filesystem such as <a class="reference external" href="https://github.com/torvalds/linux/blob/af5f239/Documentation/filesystems/overlayfs.rst">OverlayFS</a>
or <a class="reference external" href="https://github.com/containers/fuse-overlayfs/tree/v1.12">FUSE-OverlayFS</a>
and tar archives to represent the content of each layer; this approach is
<a class="reference external" href="https://github.com/opencontainers/image-spec/blob/63b8bd0/spec.md">standardized by OCI</a>. The
layered cache works, but it has drawbacks in three critical areas:</p>
<ol class="arabic">
<li><p><strong>Diff format.</strong> The tar format is poorly standardized and <a class="reference external" href="https://www.cyphar.com/blog/post/20190121-ociv2-images-i-tar">not designed
for diffs</a>.
Notably, tar cannot represent file deletion. The workaround used for OCI
layers is specially named <em>whiteout</em> files, which means the tar archives
cannot be unpacked by standard UNIX tools and require special
container-specific processing.</p></li>
<li><p><strong>Cache overhead.</strong> Each time a Dockerfile instruction is started, a new
overlay filesystem is mounted atop the existing layer stack. File metadata
operations in the instruction then start at the top layer and descend the
stack until the layer containing the desired file is reached. The cost of
these operations is therefore proportional to the number of layers, i.e.,
the number of instructions between the empty root image and the instruction
being executed. This results in a <a class="reference external" href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">best practice</a>
of large, complex instructions to minimize their number, which can conflict
with simpler, more numerous instructions the user might prefer.</p></li>
<li><p><strong>De-duplication.</strong> Identical files on layers with an ancestry relationship
(i.e., instruction <em>A</em> precedes <em>B</em> in a build) are stored only once.
However, identical files on layers without this relationship are stored
multiple times. For example, if instructions <em>B</em> and <em>B’</em> both follow <em>A</em> —
perhaps because <em>B</em> was modified and the image rebuilt — then any files
created by both <em>B</em> and <em>B’</em> will be stored twice.</p>
<p>Also, similar files are never de-duplicated, regardless of ancestry. For
example, if instruction <em>A</em> creates a file and subsequently instruction <em>B</em>
modifies a single bit in that file, both versions are stored in their
entirety.</p>
</li>
</ol>
<p>Our Git-based cache addresses the three drawbacks: (1) Git is purpose-built to
store changing directory trees, (2) cache overhead is imposed only at
instruction commit time, and (3) Git de-duplicates both identical and similar
files. Also, it is based on an extremely widely used tool that enjoys development
support from well-resourced actors, in particular on scaling (e.g.,
Microsoft’s large-repository accelerator <a class="reference external" href="https://devblogs.microsoft.com/devops/introducing-scalar/">Scalar</a> was recently
<a class="reference external" href="https://github.blog/2022-10-03-highlights-from-git-2-38/">merged into Git</a>).</p>
<p>In addition to these structural advantages, performance experiments reported in our paper above show that the Git-based approach is as good as (and sometimes better than) overlay-based caches. On build time, the two approaches are broadly similar, with one or the other being faster depending on context. Both had performance problems on NFS. Notably, however, the Git-based cache was much faster for a 129-instruction Dockerfile. On disk usage, the winner depended on the condition. For example, we saw the layered cache storing large sibling layers redundantly; on the other hand, the Git-based cache has some obvious redundancies as well, and one must compact it for full de-duplication benefit. However, Git’s de-duplication was quite effective in some conditions and we suspect will prove even better in more realistic scenarios.</p>
<p>That is, we believe our results show that the Git-based build cache is highly competitive with the layered approach, with no obvious inferiority so far and hints that it may be superior on important dimensions. We have ongoing work to explore these questions in more detail.</p>
</section>
<section id="de-duplication-and-garbage-collection">
<h3><span class="section-number">7.6.3. </span>De-duplication and garbage collection<a class="headerlink" href="#de-duplication-and-garbage-collection" title="Permalink to this heading">¶</a></h3>
<p>Charliecloud’s build cache takes advantage of Git’s file de-duplication
features. This operates across the entire build cache, i.e., files are
de-duplicated no matter where in the cache they are found or the relationship
between their container images. Files are de-duplicated at different times
depending on whether they are identical or merely similar.</p>
<p><em>Identical</em> files are de-duplicated at <code class="code docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span></code> time; in
<code class="code docutils literal notranslate"><span class="pre">ch-image</span> <span class="pre">build</span></code> terms, that’s upon committing a successful instruction.
That is, it’s impossible to store two files with the same content in the build
cache. If you try — say with <code class="code docutils literal notranslate"><span class="pre">RUN</span> <span class="pre">yum</span> <span class="pre">install</span> <span class="pre">-y</span> <span class="pre">foo</span></code> in one Dockerfile
and <code class="code docutils literal notranslate"><span class="pre">RUN</span> <span class="pre">yum</span> <span class="pre">install</span> <span class="pre">-y</span> <span class="pre">foo</span> <span class="pre">bar</span></code> in another, which are different
instructions but both install RPM <code class="code docutils literal notranslate"><span class="pre">foo</span></code>’s files — the content is stored
once and each copy gets its own metadata and a pointer to the content, much
like filesystem hard links.</p>
<p><em>Similar</em> files, however, are only de-duplicated during Git’s garbage
collection process. When files are initially added to a Git repository (with
<code class="code docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span></code>), they are stored inside the repository as (possibly
compressed) individual files, called <em>objects</em> in Git jargon. Upon garbage
collection, which happens both automatically when certain parameters are met
and explicitly with <code class="code docutils literal notranslate"><span class="pre">git</span> <span class="pre">gc</span></code>, these files are archived and
(re-)compressed together into a single file called a <em>packfile</em>. Also,
existing packfiles may be re-written into the new one.</p>
<p>During this process, similar files are identified, and each set of similar
files is stored as one base file plus diffs to recover the others. (Similarity
detection seems to be based primarily on file size.) This <em>delta</em> process is
agnostic to alignment, which is an advantage over alignment-sensitive
block-level de-duplicating filesystems. Exception: “Large” files are not
compressed or de-duplicated. We use the Git default threshold of 512 MiB (as
of this writing).</p>
<p>Charliecloud runs Git garbage collection at two different times. First, a
lighter-weight garbage pass runs automatically when the number of loose files
(objects) grows beyond a limit. This limit is in flux as we learn more about
build cache performance, but it’s quite a bit higher than the Git default.
This garbage runs in the background and can continue after the build
completes; you may see Git processes using a lot of CPU.</p>
<p>An important limitation of the automatic garbage is that large packfiles
(again, this is in flux, but it’s several GiB) will not be re-packed, limiting
the scope of similar file detection. To address this, a heavier garbage
collection can be run manually with <code class="code docutils literal notranslate"><span class="pre">ch-image</span> <span class="pre">build-cache</span> <span class="pre">--gc</span></code>. This
will re-pack (and re-write) the entire build cache, de-duplicating all similar
files. In both cases, garbage uses all available cores.</p>
<p><code class="code docutils literal notranslate"><span class="pre">git</span> <span class="pre">build-cache</span></code> prints the specific garbage collection parameters in
use, and <code class="code docutils literal notranslate"><span class="pre">-v</span></code> can be added for more detail.</p>
</section>
<section id="large-file-threshold">
<span id="ch-image-bu-large"></span><h3><span class="section-number">7.6.4. </span>Large file threshold<a class="headerlink" href="#large-file-threshold" title="Permalink to this heading">¶</a></h3>
<p>Because Git uses content-addressed storage, upon commit, it must read in full
all files modified by an instruction. This I/O cost can be a significant
fraction of build time for some images. To mitigate this, regular files larger
than the experimental <em>large file threshold</em> are stored outside the Git
repository, somewhat like <a class="reference external" href="https://git-lfs.github.com/">Git Large File Storage</a>.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> copies large files in and out of images at each instruction
commit. It tries to do this with a fast metadata-only copy-on-write operation
called “reflink”, but that is only supported with the right Python version,
Linux kernel version, and filesystem. If unsupported, Charliecloud falls back
to an expensive standard copy, which is likely slower than letting Git deal
with the files. See <a class="reference internal" href="best_practices.html#best-practices-file-copy"><span class="std std-ref">File copy performance</span></a>
for details.</p>
<p>Every version of a large file is stored verbatim and uncompressed (e.g., a
large file with a one-byte change will be stored in full twice), so Git’s
de-duplication does not apply. <em>However</em>, on filesystems with reflink support,
files can share extents (e.g., each of the two files will have its own extent
containing the changed byte, but the rest of the extents will remain shared).
This provides de-duplication between large files images that share ancestry.
Also, unused large files are deleted by <code class="code docutils literal notranslate"><span class="pre">ch-image</span> <span class="pre">build-cache</span> <span class="pre">--gc</span></code>.</p>
<p>A final caveat: Large files in any image with the same path, mode, size, and
mtime (to nanosecond precision if possible) are considered identical, even if
their content is not actually identical (e.g., <code class="code docutils literal notranslate"><span class="pre">touch(1)</span></code> shenanigans
can corrupt an image).</p>
<p>Option <code class="code docutils literal notranslate"><span class="pre">--cache-large</span></code> sets the threshold in MiB; if not set,
environment variable <code class="code docutils literal notranslate"><span class="pre">CH_IMAGE_CACHE_LARGE</span></code> is used; if that is not set
either, the default value <code class="code docutils literal notranslate"><span class="pre">0</span></code> indicates that no files are considered
large.</p>
<p>(Note that Git has an unrelated setting called <code class="code docutils literal notranslate"><span class="pre">core.bigFileThreshold</span></code>.)</p>
</section>
<section id="example">
<h3><span class="section-number">7.6.5. </span>Example<a class="headerlink" href="#example" title="Permalink to this heading">¶</a></h3>
<p>Suppose we have this Dockerfile:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>a.df
<span class="go">FROM alpine:3.17</span>
<span class="go">RUN echo foo</span>
<span class="go">RUN echo bar</span>
</pre></div>
</div>
<p>On our first build, we get:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>foo<span class="w"> </span>-f<span class="w"> </span>a.df<span class="w"> </span>.
<span class="go">  1. FROM alpine:3.17</span>
<span class="go">[ ... pull chatter omitted ... ]</span>
<span class="go">  2. RUN echo foo</span>
<span class="go">copying image ...</span>
<span class="go">foo</span>
<span class="go">  3. RUN echo bar</span>
<span class="go">bar</span>
<span class="go">grown in 3 instructions: foo</span>
</pre></div>
</div>
<p>Note the dot after each instruction’s line number. This means that the
instruction was executed. You can also see this by the output of the two
<code class="code docutils literal notranslate"><span class="pre">echo</span></code> commands.</p>
<p>But on our second build, we get:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>foo<span class="w"> </span>-f<span class="w"> </span>a.df<span class="w"> </span>.
<span class="go">  1* FROM alpine:3.17</span>
<span class="go">  2* RUN echo foo</span>
<span class="go">  3* RUN echo bar</span>
<span class="go">copying image ...</span>
<span class="go">grown in 3 instructions: foo</span>
</pre></div>
</div>
<p>Here, instead of being executed, each instruction’s results were retrieved
from cache. (Charliecloud uses lazy retrieval; nothing is actually retrieved
until the end, as seen by the “copying image” message.) Cache hit for each
instruction is indicated by an asterisk (<code class="code docutils literal notranslate"><span class="pre">*</span></code>) after the line number.
Even for such a small and short Dockerfile, this build is noticeably faster
than the first.</p>
<p>We can also try a second, slightly different Dockerfile. Note that the first
three instructions are the same, but the third is different:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>c.df
<span class="go">FROM alpine:3.17</span>
<span class="go">RUN echo foo</span>
<span class="go">RUN echo qux</span>
<span class="gp">$ </span>ch-image<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>c<span class="w"> </span>-f<span class="w"> </span>c.df<span class="w"> </span>.
<span class="go">  1* FROM alpine:3.17</span>
<span class="go">  2* RUN echo foo</span>
<span class="go">  3. RUN echo qux</span>
<span class="go">copying image ...</span>
<span class="go">qux</span>
<span class="go">grown in 3 instructions: c</span>
</pre></div>
</div>
<p>Here, the first two instructions are hits from the first Dockerfile, but the
third is a miss, so Charliecloud retrieves that state and continues building.</p>
<p>We can also inspect the cache:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span>build-cache<span class="w"> </span>--tree
<span class="go">*  (c) RUN echo qux</span>
<span class="go">| *  (a) RUN echo bar</span>
<span class="go">|/</span>
<span class="go">*  RUN echo foo</span>
<span class="go">*  (alpine+3.9) PULL alpine:3.17</span>
<span class="go">*  (root) ROOT</span>

<span class="go">named images:     4</span>
<span class="go">state IDs:        5</span>
<span class="go">commits:          5</span>
<span class="go">files:          317</span>
<span class="go">disk used:        3 MiB</span>
</pre></div>
</div>
<p>Here there are four named images: <code class="code docutils literal notranslate"><span class="pre">a</span></code> and <code class="code docutils literal notranslate"><span class="pre">c</span></code> that we built, the
base image <code class="code docutils literal notranslate"><span class="pre">alpine:3.17</span></code> (written as <code class="code docutils literal notranslate"><span class="pre">alpine+3.9</span></code> because colon is
not allowed in Git branch names), and the empty base of everything
<code class="code docutils literal notranslate"><span class="pre">root</span></code>. Also note how <code class="code docutils literal notranslate"><span class="pre">a</span></code> and <code class="code docutils literal notranslate"><span class="pre">c</span></code> diverge after the last
common instruction <code class="code docutils literal notranslate"><span class="pre">RUN</span> <span class="pre">echo</span> <span class="pre">foo</span></code>.</p>
</section>
</section>
<section id="build">
<h2><span class="section-number">7.7. </span><code class="code docutils literal notranslate"><span class="pre">build</span></code><a class="headerlink" href="#build" title="Permalink to this heading">¶</a></h2>
<p>Build an image from a Dockerfile and put it in the storage directory.</p>
<section id="id2">
<h3><span class="section-number">7.7.1. </span>Synopsis<a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>build<span class="w"> </span><span class="o">[</span>-t<span class="w"> </span>TAG<span class="o">]</span><span class="w"> </span><span class="o">[</span>-f<span class="w"> </span>DOCKERFILE<span class="o">]</span><span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>CONTEXT
</pre></div>
</div>
</section>
<section id="id3">
<h3><span class="section-number">7.7.2. </span>Description<a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h3>
<p>See below for differences with other Dockerfile interpreters. Charliecloud
supports an extended instruction (<code class="code docutils literal notranslate"><span class="pre">RSYNC</span></code>), a few other instructions
behave slightly differently, and a few are ignored.</p>
<p>Note that <code class="code docutils literal notranslate"><span class="pre">FROM</span></code> implicitly pulls the base image if needed, so you may
want to read about the <code class="code docutils literal notranslate"><span class="pre">pull</span></code> subcommand below as well.</p>
<p>Required argument:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">CONTEXT</span></code></dt><dd><p>Path to context directory. This is the root of <code class="code docutils literal notranslate"><span class="pre">COPY</span></code> instructions
in the Dockerfile. If a single hyphen (<code class="code docutils literal notranslate"><span class="pre">-</span></code>) is specified: (a) read
the Dockerfile from standard input, (b) specifying <code class="code docutils literal notranslate"><span class="pre">--file</span></code> is an
error, and (c) there is no context, so <code class="code docutils literal notranslate"><span class="pre">COPY</span></code> will fail. (See
<code class="code docutils literal notranslate"><span class="pre">--file</span></code> for how to provide the Dockerfile on standard input while
also having a context.)</p>
</dd>
</dl>
</div></blockquote>
<p>Options:</p>
<blockquote>
<div><dl>
<dt><code class="code docutils literal notranslate"><span class="pre">-b</span></code>, <code class="code docutils literal notranslate"><span class="pre">--bind</span> <span class="pre">SRC[:DST]</span></code></dt><dd><p>For <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instructions only, bind-mount <code class="code docutils literal notranslate"><span class="pre">SRC</span></code> at guest
<code class="code docutils literal notranslate"><span class="pre">DST</span></code>. The default destination if not specified is to use the same
path as the host; i.e., the default is equivalent to
<code class="code docutils literal notranslate"><span class="pre">--bind=SRC:SRC</span></code>. If <code class="code docutils literal notranslate"><span class="pre">DST</span></code> does not exist, try to create it as
an empty directory, though images do have ten directories
<code class="code docutils literal notranslate"><span class="pre">/mnt/[0-9]</span></code> already available as mount points. Can be repeated.</p>
<p><strong>Note:</strong> See documentation for <code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">--bind</span></code> for important
caveats and gotchas.</p>
<p><strong>Note:</strong> Other instructions that modify the image filesystem, e.g.
<code class="code docutils literal notranslate"><span class="pre">COPY</span></code>, can only access host files from the context directory,
regardless of this option.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--build-arg</span> <span class="pre">KEY[=VALUE]</span></code></dt><dd><p>Set build-time variable <code class="code docutils literal notranslate"><span class="pre">KEY</span></code> defined by <code class="code docutils literal notranslate"><span class="pre">ARG</span></code> instruction
to <code class="code docutils literal notranslate"><span class="pre">VALUE</span></code>. If <code class="code docutils literal notranslate"><span class="pre">VALUE</span></code> not specified, use the value of
environment variable <code class="code docutils literal notranslate"><span class="pre">KEY</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-f</span></code>, <code class="code docutils literal notranslate"><span class="pre">--file</span> <span class="pre">DOCKERFILE</span></code></dt><dd><p>Use <code class="code docutils literal notranslate"><span class="pre">DOCKERFILE</span></code> instead of <code class="code docutils literal notranslate"><span class="pre">CONTEXT/Dockerfile</span></code>. If a single
hyphen (<code class="code docutils literal notranslate"><span class="pre">-</span></code>) is specified, read the Dockerfile from standard input;
like <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code>, the context directory is still available in
this case.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--force[=MODE]</span></code></dt><dd><p>Use unprivileged build with root emulation mode <code class="code docutils literal notranslate"><span class="pre">MODE</span></code>, which can be
<code class="code docutils literal notranslate"><span class="pre">fakeroot</span></code>, <code class="code docutils literal notranslate"><span class="pre">seccomp</span></code> (the default), or <code class="code docutils literal notranslate"><span class="pre">none</span></code>. See
section “Privilege model” below for details on what this does and when you
might need it.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--force-cmd=CMD,ARG1[,ARG2...]</span></code></dt><dd><p>If command <code class="code docutils literal notranslate"><span class="pre">CMD</span></code> is found in a <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instruction, add the
comma-separated <code class="code docutils literal notranslate"><span class="pre">ARGs</span></code> to it. For example,
<code class="code docutils literal notranslate"><span class="pre">--force-cmd=foo,-a,--bar=baz</span></code> would transform <code class="code docutils literal notranslate"><span class="pre">RUN</span> <span class="pre">foo</span> <span class="pre">-c</span></code>
into <code class="code docutils literal notranslate"><span class="pre">RUN</span> <span class="pre">foo</span> <span class="pre">-a</span> <span class="pre">--bar=baz</span> <span class="pre">-c</span></code>. This is intended to suppress
validation that defeats <code class="code docutils literal notranslate"><span class="pre">--force=seccomp</span></code> and implies that option.
Can be repeated. If specified, replaces (does not extend) the default
suppression options. Literal commas can be escaped with backslash;
importantly however, backslash will need to be protected from the shell
also. Section “Privilege model” below explains why you might need this.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-n</span></code>, <code class="code docutils literal notranslate"><span class="pre">--dry-run</span></code></dt><dd><p>Don’t actually execute any Dockerfile instructions.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--parse-only</span></code></dt><dd><p>Stop after parsing the Dockerfile.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-t</span></code>, <code class="code docutils literal notranslate"><span class="pre">--tag</span> <span class="pre">TAG</span></code></dt><dd><p>Name of image to create. If not specified, infer the name:</p>
<ol class="arabic simple">
<li><p>If Dockerfile named <code class="code docutils literal notranslate"><span class="pre">Dockerfile</span></code> with an extension: use the
extension with invalid characters stripped, e.g.
<code class="code docutils literal notranslate"><span class="pre">Dockerfile.&#64;FOO.bar</span></code> → <code class="code docutils literal notranslate"><span class="pre">foo.bar</span></code>.</p></li>
<li><p>If Dockerfile has extension <code class="code docutils literal notranslate"><span class="pre">df</span></code> or <code class="code docutils literal notranslate"><span class="pre">dockerfile</span></code>: use the
basename with the same transformation, e.g. <code class="code docutils literal notranslate"><span class="pre">baz.&#64;QUX.dockerfile</span></code>
-&gt; <code class="code docutils literal notranslate"><span class="pre">baz.qux</span></code>.</p></li>
<li><p>If context directory is not <code class="code docutils literal notranslate"><span class="pre">/</span></code>: use its name, i.e. the last
component of the absolute path to the context directory, with the same
transformation,</p></li>
<li><p>Otherwise (context directory is <code class="code docutils literal notranslate"><span class="pre">/</span></code>): use <code class="code docutils literal notranslate"><span class="pre">root</span></code>.</p></li>
</ol>
<p>If no colon present in the name, append <code class="code docutils literal notranslate"><span class="pre">:latest</span></code>.</p>
</dd>
</dl>
</div></blockquote>
<p>Uses <code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">-w</span> <span class="pre">-u0</span> <span class="pre">-g0</span> <span class="pre">--no-passwd</span> <span class="pre">--unsafe</span></code> to execute <code class="code docutils literal notranslate"><span class="pre">RUN</span></code>
instructions.</p>
</section>
<section id="privilege-model">
<h3><span class="section-number">7.7.3. </span>Privilege model<a class="headerlink" href="#privilege-model" title="Permalink to this heading">¶</a></h3>
<section id="id4">
<h4><span class="section-number">7.7.3.1. </span>Overview<a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h4>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> is a <em>fully</em> unprivileged image builder. It does not use any
setuid or setcap helper programs, and it does not use configuration files
<code class="code docutils literal notranslate"><span class="pre">/etc/subuid</span></code> or <code class="code docutils literal notranslate"><span class="pre">/etc/subgid</span></code>. This contrasts with the “rootless”
or “<a class="reference external" href="https://sylabs.io/guides/3.7/user-guide/fakeroot.html">fakeroot</a>” modes
of some competing builders, which do require privileged supporting code or
utilities.</p>
<p>Without root emulation, this approach does confuse programs that expect to have
real root privileges, most notably distribution package installers. This
subsection describes why that happens and what you can do about it.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> executes all instructions as the normal user who invokes it.
For <code class="code docutils literal notranslate"><span class="pre">RUN</span></code>, this is accomplished with <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> arguments including
<code class="code docutils literal notranslate"><span class="pre">-w</span> <span class="pre">--uid=0</span> <span class="pre">--gid=0</span></code>. That is, your host EUID and EGID are both mapped to
zero inside the container, and only one UID (zero) and GID (zero) are available
inside the container. Under this arrangement, processes running in the container
for each <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> <em>appear</em> to be running as root, but many privileged system
calls will fail without the root emulation methods described below. <strong>This
affects any fully unprivileged container build, not just Charliecloud.</strong></p>
<p>The most common time to see this is installing packages. For example, here is
RPM failing to <code class="code docutils literal notranslate"><span class="pre">chown(2)</span></code> a file, which makes the package update fail:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  Updating   : 1:dbus-1.10.24-13.el7_6.x86_64                            2/4
Error unpacking rpm package 1:dbus-1.10.24-13.el7_6.x86_64
error: unpacking of archive failed on file /usr/libexec/dbus-1/dbus-daemon-launch-helper;5cffd726: cpio: chown
  Cleanup    : 1:dbus-libs-1.10.24-12.el7.x86_64                         3/4
error: dbus-1:1.10.24-13.el7_6.x86_64: install failed
</pre></div>
</div>
<p>This one is (ironically) <code class="code docutils literal notranslate"><span class="pre">apt-get</span></code> failing to drop privileges:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>E: setgroups 65534 failed - setgroups (1: Operation not permitted)
E: setegid 65534 failed - setegid (22: Invalid argument)
E: seteuid 100 failed - seteuid (22: Invalid argument)
E: setgroups 0 failed - setgroups (1: Operation not permitted)
</pre></div>
</div>
<p>Charliecloud provides two different mechanisms to avoid these problems. Both
involve lying to the containerized process about privileged system calls, but
at very different levels of complexity.</p>
</section>
<section id="root-emulation-mode-fakeroot">
<h4><span class="section-number">7.7.3.2. </span>Root emulation mode <code class="code docutils literal notranslate"><span class="pre">fakeroot</span></code><a class="headerlink" href="#root-emulation-mode-fakeroot" title="Permalink to this heading">¶</a></h4>
<p>This mode uses <code class="code docutils literal notranslate"><span class="pre">fakeroot(1)</span></code> to maintain an elaborate web of deceit that
is internally consistent. This program intercepts both privileged system calls
(e.g., <code class="code docutils literal notranslate"><span class="pre">setuid(2)</span></code>) as well as other system calls whose return values
depend on those calls (e.g., <code class="code docutils literal notranslate"><span class="pre">getuid(2)</span></code>), faking success for privileged
system calls (perhaps making no system call at all) and altering return values
to be consistent with earlier fake success. Charliecloud automatically
installs the <code class="code docutils literal notranslate"><span class="pre">fakeroot(1)</span></code> program inside the container and then wraps
<code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instructions having known privilege needs with it. Thus, this mode
is only available for certain distributions.</p>
<p>The advantage of this mode is its consistency; e.g., careful programs that
check the new UID after attempting to change it will not notice anything
amiss. Its disadvantage is complexity: detailed knowledge and procedures for
multiple Linux distributions.</p>
<p>This mode has three basic steps:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>After <code class="code docutils literal notranslate"><span class="pre">FROM</span></code>, analyze the image to see what distribution it
contains, which determines the specific workarounds.</p></li>
<li><p>Before the user command in the first <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instruction where the
injection seems needed, install <code class="code docutils literal notranslate"><span class="pre">fakeroot(1)</span></code> in the image, if one
is not already installed, as well as any other necessary initialization
commands. For example, we turn off the <code class="code docutils literal notranslate"><span class="pre">apt</span></code> sandbox (for Debian
Buster) and configure EPEL but leave it disabled (for CentOS/RHEL).</p></li>
<li><p>Prepend <code class="code docutils literal notranslate"><span class="pre">fakeroot</span></code> to <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instructions that seem to need
it, e.g. ones that contain <code class="code docutils literal notranslate"><span class="pre">apt</span></code>, <code class="code docutils literal notranslate"><span class="pre">apt-get</span></code>, <code class="code docutils literal notranslate"><span class="pre">dpkg</span></code> for
Debian derivatives and <code class="code docutils literal notranslate"><span class="pre">dnf</span></code>, <code class="code docutils literal notranslate"><span class="pre">rpm</span></code>, or <code class="code docutils literal notranslate"><span class="pre">yum</span></code> for
RPM-based distributions.</p></li>
</ol>
</div></blockquote>
<p><code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instructions that <em>do not</em> seem to need modification are
unaffected by this mode.</p>
<p>The details are specific to each distribution. <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> analyzes image
content (e.g., grepping <code class="code docutils literal notranslate"><span class="pre">/etc/debian_version</span></code>) to select a
configuration; see <code class="code docutils literal notranslate"><span class="pre">lib/force.py</span></code> for details. <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> prints
exactly what it is doing.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Because of <code class="code docutils literal notranslate"><span class="pre">fakeroot</span></code> mode’s complexity, we plan to remove it if
<code class="code docutils literal notranslate"><span class="pre">seccomp</span></code> mode performs well enough. If you have a situation where
<code class="code docutils literal notranslate"><span class="pre">fakeroot</span></code> mode works and <code class="code docutils literal notranslate"><span class="pre">seccomp</span></code> does not, please let us
know.</p>
</div>
</section>
<section id="root-emulation-mode-seccomp-default">
<h4><span class="section-number">7.7.3.3. </span>Root emulation mode <code class="code docutils literal notranslate"><span class="pre">seccomp</span></code> (default)<a class="headerlink" href="#root-emulation-mode-seccomp-default" title="Permalink to this heading">¶</a></h4>
<p>This mode uses the kernel’s <code class="code docutils literal notranslate"><span class="pre">seccomp(2)</span></code> system call filtering to
intercept certain privileged system calls, do absolutely nothing, and return
success to the program.</p>
<p>Some system calls are quashed regardless of their arguments:
<code class="code docutils literal notranslate"><span class="pre">capset(2)</span></code>; <code class="code docutils literal notranslate"><span class="pre">chown(2)</span></code> and friends; <code class="code docutils literal notranslate"><span class="pre">kexec_load(2)</span></code> (used
to validate the filter itself); ; and <code class="code docutils literal notranslate"><span class="pre">setuid(2)</span></code>, <code class="code docutils literal notranslate"><span class="pre">setgid(2)</span></code>,
and <code class="code docutils literal notranslate"><span class="pre">setgroups(2)</span></code> along with the other system calls that change user or
group. <code class="code docutils literal notranslate"><span class="pre">mknod(2)</span></code> and <code class="code docutils literal notranslate"><span class="pre">mknodat(2)</span></code> are quashed if they try to
create a device file (e.g., creating FIFOs works normally).</p>
<p>The advantages of this approach is that it’s much simpler, it’s faster, it’s
completely agnostic to libc, and it’s mostly agnostic to distribution. The
disadvantage is that it’s a very lazy liar; even the most cursory consistency
checks will fail, e.g., <code class="code docutils literal notranslate"><span class="pre">getuid(2)</span></code> after <code class="code docutils literal notranslate"><span class="pre">setuid(2)</span></code>.</p>
<p>While this mode does not provide consistency, it does offer a hook to help
prevent programs asking for consistency. For example, <code class="code docutils literal notranslate"><span class="pre">apt-get</span> <span class="pre">-o</span>
<span class="pre">APT::Sandbox::User=root</span></code> will prevent <code class="code docutils literal notranslate"><span class="pre">apt-get</span></code> from attempting to drop
privileges, which <a class="reference external" href="https://salsa.debian.org/apt-team/apt/-/blob/cacdb549/apt-pkg/contrib/fileutl.cc#L3343">it verifies</a>,
exiting with failure if the correct IDs are not found (which they won’t be
under this approach). This can be expressed with
<code class="code docutils literal notranslate"><span class="pre">--force-cmd=apt-get,-o,APT::Sandbox::User=root</span></code>, though this particular
case is built-in and does not need to be specified. The full default
configuration, which is applied regardless of the image distribution, can be
examined in the source file <code class="code docutils literal notranslate"><span class="pre">force.py</span></code>. If any <code class="code docutils literal notranslate"><span class="pre">--force-cmd</span></code> are
specified, this replaces (rather than extends) the default configuration.</p>
<p>Note that because the substitutions are a simple regex with no knowledge of
shell syntax, they can cause unwanted modifications. For example, <code class="code docutils literal notranslate"><span class="pre">RUN</span>
<span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">-y</span> <span class="pre">apt-get</span></code> will be run as <code class="code docutils literal notranslate"><span class="pre">/bin/sh</span> <span class="pre">-c</span> <span class="pre">&quot;apt-get</span> <span class="pre">-o</span>
<span class="pre">APT::Sandbox::User=root</span> <span class="pre">install</span> <span class="pre">-y</span> <span class="pre">apt-get</span> <span class="pre">-o</span> <span class="pre">APT::Sandbox::User=root&quot;</span></code>. One
workaround is to add escape syntax transparent to the shell; e.g., <code class="code docutils literal notranslate"><span class="pre">RUN</span>
<span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">-y</span> <span class="pre">apt-get</span></code>.</p>
<p>This mode executes <em>all</em> <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instructions with the <code class="code docutils literal notranslate"><span class="pre">seccomp(2)</span></code>
filter and has no knowledge of which instructions actually used the
intercepted system calls. Therefore, the printed “instructions modified”
number is only a count of instructions with a hook applied as described above.</p>
</section>
<section id="run-logging">
<h4><span class="section-number">7.7.3.4. </span><code class="code docutils literal notranslate"><span class="pre">RUN</span></code>  logging<a class="headerlink" href="#run-logging" title="Permalink to this heading">¶</a></h4>
<p>In terminal output, image metadata, and the build cache, the <code class="code docutils literal notranslate"><span class="pre">RUN</span></code>
instruction is always logged as <code class="code docutils literal notranslate"><span class="pre">RUN.S</span></code>, <code class="code docutils literal notranslate"><span class="pre">RUN.F</span></code>, or <code class="code docutils literal notranslate"><span class="pre">RUN.N</span></code>.
The letter appended to the instruction reflects the root emulation mode used
during the build in which the instruction was executed. <code class="code docutils literal notranslate"><span class="pre">RUN.S</span></code> indicates
<code class="code docutils literal notranslate"><span class="pre">seccomp</span></code>, <code class="code docutils literal notranslate"><span class="pre">RUN.F</span></code> indicates <code class="code docutils literal notranslate"><span class="pre">fakeroot</span></code>, and <code class="code docutils literal notranslate"><span class="pre">RUN.N</span></code>
indicates that neither form of root emulation was used (<code class="code docutils literal notranslate"><span class="pre">--force=none</span></code>).</p>
</section>
</section>
<section id="compatibility-and-behavior-differences">
<h3><span class="section-number">7.7.4. </span>Compatibility and behavior differences<a class="headerlink" href="#compatibility-and-behavior-differences" title="Permalink to this heading">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> is an independent implementation and shares no code with
other Dockerfile interpreters. It uses a formal Dockerfile parsing grammar
developed from the <a class="reference external" href="https://docs.docker.com/engine/reference/builder/">Dockerfile reference documentation</a> and miscellaneous other
sources, which you can examine in the source code.</p>
<p>We believe this independence is valuable for several reasons. First, it helps
the community examine Dockerfile syntax and semantics critically, think
rigorously about what is really needed, and build a more robust standard.
Second, it yields disjoint sets of bugs (note that Podman, Buildah, and Docker
all share the same Dockerfile parser). Third, because it is a much smaller
code base, it illustrates how Dockerfiles work more clearly. Finally, it
allows straightforward extensions if needed to support scientific computing.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> tries hard to be compatible with Docker and other
interpreters, though as an independent implementation, it is not
bug-compatible.</p>
<p>The following subsections describe differences from the Dockerfile reference
that we expect to be approximately permanent. For not-yet-implemented features
and bugs in this area, see <a class="reference external" href="https://github.com/hpc/charliecloud/issues?q=is%3Aissue+is%3Aopen+sort%3Aupdated-desc+label%3Aimage">related issues</a>
on GitHub.</p>
<p>None of these are set in stone. We are very interested in feedback on our
assessments and open questions. This helps us prioritize new features and
revise our thinking about what is needed for HPC containers.</p>
<section id="context-directory">
<h4><span class="section-number">7.7.4.1. </span>Context directory<a class="headerlink" href="#context-directory" title="Permalink to this heading">¶</a></h4>
<p>The context directory is bind-mounted into the build, rather than copied like
Docker. Thus, the size of the context is immaterial, and the build reads
directly from storage like any other local process would (i.e., it is
reasonable use <code class="code docutils literal notranslate"><span class="pre">/</span></code> for the context). However, you still can’t
access anything outside the context directory.</p>
</section>
<section id="variable-substitution">
<h4><span class="section-number">7.7.4.2. </span>Variable substitution<a class="headerlink" href="#variable-substitution" title="Permalink to this heading">¶</a></h4>
<p>Variable substitution happens for <em>all</em> instructions, not just the ones listed
in the Dockerfile reference.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ARG</span></code> and <code class="code docutils literal notranslate"><span class="pre">ENV</span></code> cause cache misses upon <em>definition</em>, in contrast
with Docker where these variables miss upon <em>use</em>, except for certain
cache-excluded variables that never cause misses, listed below.</p>
<p>Note that <code class="code docutils literal notranslate"><span class="pre">ARG</span></code> and <code class="code docutils literal notranslate"><span class="pre">ENV</span></code> have different syntax despite very
similar semantics.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> passes the following proxy environment variables in to the
build. Changes to these variables do not cause a cache miss. They do not
require an <code class="code docutils literal notranslate"><span class="pre">ARG</span></code> instruction, as <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#predefined-args">documented</a> in the
Dockerfile reference. Unlike Docker, they are available if the same-named
environment variable is defined; <code class="code docutils literal notranslate"><span class="pre">--build-arg</span></code> is not required.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>HTTP_PROXY
http_proxy
HTTPS_PROXY
https_proxy
FTP_PROXY
ftp_proxy
NO_PROXY
no_proxy
</pre></div>
</div>
<p>In addition to those listed in the Dockerfile reference, these environment
variables are passed through in the same way:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>SSH_AUTH_SOCK
USER
</pre></div>
</div>
<p>Finally, these variables are also pre-defined but are unrelated to the host
environment:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">PATH</span><span class="o">=</span>/ch/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
<span class="nv">TAR_OPTIONS</span><span class="o">=</span>--no-same-owner
</pre></div>
</div>
</section>
<section id="arg">
<h4><span class="section-number">7.7.4.3. </span><code class="code docutils literal notranslate"><span class="pre">ARG</span></code><a class="headerlink" href="#arg" title="Permalink to this heading">¶</a></h4>
<p>Variables set with <code class="code docutils literal notranslate"><span class="pre">ARG</span></code> are available anywhere in the Dockerfile,
unlike Docker, where they only work in <code class="code docutils literal notranslate"><span class="pre">FROM</span></code> instructions, and possibly
in other <code class="code docutils literal notranslate"><span class="pre">ARG</span></code> before the first <code class="code docutils literal notranslate"><span class="pre">FROM</span></code>.</p>
</section>
<section id="from">
<h4><span class="section-number">7.7.4.4. </span><code class="code docutils literal notranslate"><span class="pre">FROM</span></code><a class="headerlink" href="#from" title="Permalink to this heading">¶</a></h4>
<p>The <code class="code docutils literal notranslate"><span class="pre">FROM</span></code> instruction accepts option <code class="code docutils literal notranslate"><span class="pre">--arg=NAME=VALUE</span></code>, which
serves the same purpose as the <code class="code docutils literal notranslate"><span class="pre">ARG</span></code> instruction. It can be repeated.</p>
</section>
<section id="label">
<h4><span class="section-number">7.7.4.5. </span><code class="code docutils literal notranslate"><span class="pre">LABEL</span></code><a class="headerlink" href="#label" title="Permalink to this heading">¶</a></h4>
<p>The <code class="code docutils literal notranslate"><span class="pre">LABEL</span></code> instruction accepts <code class="code docutils literal notranslate"><span class="pre">key=value</span></code> pairs to
add metadata for an image. Unlike Docker, multiline values are not supported;
see issue <a class="reference external" href="https://github.com/hpc/charliecloud/issues/1512">#1512</a>.
Can be repeated.</p>
</section>
<section id="copy">
<h4><span class="section-number">7.7.4.6. </span><code class="code docutils literal notranslate"><span class="pre">COPY</span></code><a class="headerlink" href="#copy" title="Permalink to this heading">¶</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The behavior described here matches Docker’s <a class="reference external" href="https://docs.docker.com/engine/deprecated/#legacy-builder-for-linux-images">now-deprecated legacy
builder</a>.
Docker’s new builder, BuildKit, has different behavior in some
cases, which we have not characterized.</p>
</div>
<p>Especially for people used to UNIX <code class="code docutils literal notranslate"><span class="pre">cp(1)</span></code>, the semantics of the
Dockerfile <code class="code docutils literal notranslate"><span class="pre">COPY</span></code> instruction can be confusing.</p>
<p>Most notably, when a source of the copy is a directory, the <em>contents</em> of that
directory, not the directory itself, are copied. This is documented, but it’s
a real gotcha because that’s not what <code class="code docutils literal notranslate"><span class="pre">cp(1)</span></code> does, and it means that
many things you can do in one <code class="code docutils literal notranslate"><span class="pre">cp(1)</span></code> command require multiple
<code class="code docutils literal notranslate"><span class="pre">COPY</span></code> instructions.</p>
<p>Also, the reference documentation is incomplete. In our experience, Docker
also behaves as follows; <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> does the same in an attempt to be
bug-compatible.</p>
<ol class="arabic simple">
<li><p>You can use absolute paths in the source; the root is the context
directory.</p></li>
<li><p>Destination directories are created if they don’t exist in the following
situations:</p>
<ol class="arabic simple">
<li><p>If the destination path ends in slash. (Documented.)</p></li>
<li><p>If the number of sources is greater than 1, either by wildcard or
explicitly, regardless of whether the destination ends in slash. (Not
documented.)</p></li>
<li><p>If there is a single source and it is a directory. (Not documented.)</p></li>
</ol>
</li>
<li><p>Symbolic links behave differently depending on how deep in the copied tree
they are. (Not documented.)</p>
<ol class="arabic simple">
<li><p>Symlinks at the top level — i.e., named as the destination or the
source, either explicitly or by wildcards — are dereferenced. They are
followed, and whatever they point to is used as the destination or
source, respectively.</p></li>
<li><p>Symlinks at deeper levels are not dereferenced, i.e., the symlink
itself is copied.</p></li>
</ol>
</li>
<li><p>If a directory appears at the same path in source and destination, and is
at the 2nd level or deeper, the source directory’s metadata (e.g.,
permissions) are copied to the destination directory. (Not documented.)</p></li>
<li><p>If an object (a) appears in both the source and destination, (b) is at the
2nd level or deeper, and (c) is different file types in source and
destination, the source object will overwrite the destination object. (Not
documented.)</p></li>
</ol>
<p>We expect the following differences to be permanent:</p>
<ul class="simple">
<li><p>Wildcards use Python glob semantics, not the Go semantics.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">COPY</span> <span class="pre">--chown</span></code> is ignored, because it doesn’t make sense in an
unprivileged build.</p></li>
</ul>
</section>
<section id="features-we-do-not-plan-to-support">
<h4><span class="section-number">7.7.4.7. </span>Features we do not plan to support<a class="headerlink" href="#features-we-do-not-plan-to-support" title="Permalink to this heading">¶</a></h4>
<ul class="simple">
<li><p>Parser directives are not supported. We have not identified a need for any
of them.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">EXPOSE</span></code>: Charliecloud does not use the network namespace, so
containerized processes can simply listen on a host port like other
unprivileged processes.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">HEALTHCHECK</span></code>: This instruction’s main use case is monitoring server
processes rather than applications. Also, it requires a container supervisor
daemon, which we have no plans to add.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">MAINTAINER</span></code> is deprecated.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">STOPSIGNAL</span></code> requires a container supervisor daemon process, which we
have no plans to add.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">USER</span></code> does not make sense for unprivileged builds.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">VOLUME</span></code>: Charliecloud
has good support for bind mounts; we anticipate that it will continue to
focus on that and will not introduce the volume management features that
Docker has.</p></li>
</ul>
</section>
</section>
<section id="rsync-dockerfile-extension">
<span id="ch-image-rsync"></span><h3><span class="section-number">7.7.5. </span><code class="code docutils literal notranslate"><span class="pre">RSYNC</span></code> (Dockerfile extension)<a class="headerlink" href="#rsync-dockerfile-extension" title="Permalink to this heading">¶</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This instruction is experimental and may change or be removed.</p>
</div>
<section id="id6">
<h4><span class="section-number">7.7.5.1. </span>Overview<a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h4>
<p>Copying files is often simple but has numerous difficult corner cases, e.g.
when dealing with symbolic or hard links. The standard instruction
<code class="code docutils literal notranslate"><span class="pre">COPY</span></code> deals with many of these corner cases differently from other UNIX
utilities, lacks complete documentation, and behaves inconsistently between
different Dockerfile interpreters (e.g., Docker’s legacy builder vs.
BuildKit), as detailed above. On the other hand, <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code> is an
extremely capable, widely used file copy tool, with detailed options to
specify behavior and 25 years of history dealing with weirdness.</p>
<p><code class="code docutils literal notranslate"><span class="pre">RSYNC</span></code> (also spelled <code class="code docutils literal notranslate"><span class="pre">NSYNC</span></code>) is a Charliecloud extension that
gives copying behavior identical to <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code>. In fact, Charliecloud’s
current implementation literally calls the host’s <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code> to do the
copy, though this may change in the future. There is no list form of
<code class="code docutils literal notranslate"><span class="pre">RSYNC</span></code>.</p>
<p>The two key usage challenges are trailing slashes on paths and symlink
handling. In particular, the default symlink handling seemed reasonable to us,
but you may want something different. See the arguments and examples below.
Importantly, <code class="code docutils literal notranslate"><span class="pre">COPY</span></code> is not any less fraught, and you have no choice
about what to do with symlinks.</p>
</section>
<section id="arguments">
<h4><span class="section-number">7.7.5.2. </span>Arguments<a class="headerlink" href="#arguments" title="Permalink to this heading">¶</a></h4>
<p><code class="code docutils literal notranslate"><span class="pre">RSYNC</span></code> takes the same arguments as <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code>, so refer to its
<a class="reference external" href="https://man7.org/linux/man-pages/man1/rsync.1.html">man page</a> for a
detailed explanation of all the options (with possible emphasis on its
<a class="reference external" href="https://man7.org/linux/man-pages/man1/rsync.1.html#SYMBOLIC_LINKS">symlink options</a>).
Sources are relative to the context directory even if they look absolute with
a leading slash. Any globbed sources are processed by <code class="code docutils literal notranslate"><span class="pre">ch-image(1)</span></code>
using Python rules, i.e., <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code> sees the expanded sources with no
wildcards. Relative destinations are relative to the image’s current working
directory, while absolute destinations refer to the image’s root.</p>
<p>For arguments that read input from a file (e.g. <code class="code docutils literal notranslate"><span class="pre">--exclude-from</span></code> or
<code class="code docutils literal notranslate"><span class="pre">--files-from</span></code>), relative paths are relative to the context directory,
absolute paths refer to the image root, and <code class="code docutils literal notranslate"><span class="pre">-</span></code> (standard input) is an
error.</p>
<p>For example,</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/foo</span>
RSYNC<span class="w"> </span>--foo<span class="w"> </span>src1<span class="w"> </span>src2<span class="w"> </span>dst
</pre></div>
</div>
<p>is translated to (the equivalent of):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/foo
<span class="gp">$ </span>rsync<span class="w"> </span>-@<span class="o">=</span>-1<span class="w"> </span>-AHSXpr<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-l<span class="w"> </span>--safe-links<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--foo<span class="w"> </span>/context/src1<span class="w"> </span>/context/src2<span class="w"> </span>/storage/imgroot/foo/dst2
</pre></div>
</div>
<p>Note the extensive default arguments to <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code>. <code class="code docutils literal notranslate"><span class="pre">RSYNC</span></code> takes
a single instruction option beginning with <code class="code docutils literal notranslate"><span class="pre">+</span></code> (plus) that is shorthand
for a group of <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code> options. This single option is one of:</p>
<blockquote>
<div><dl>
<dt><code class="code docutils literal notranslate"><span class="pre">+m</span></code></dt><dd><p>Preserves metadata and directory structure. Symlinks are skipped <em>with a
warning</em>. Equivalent to all of:</p>
<ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">-&#64;=-1</span></code>: use nanosecond precision when comparing timestamps.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">-A</span></code>: preserve ACLs.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">-H</span></code>: preserve hard link groups.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">-S</span></code>: preserve file sparseness when possible.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">-X</span></code>: preserve xattrs in <code class="code docutils literal notranslate"><span class="pre">user.*</span></code> namespace.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">-p</span></code>: preserve permissions.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">-r</span></code>: recurse into directories.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">--info=progress2</span></code> (only if stderr is a terminal): show progress
meter (note <a class="reference external" href="https://unix.stackexchange.com/questions/215271">subtleties in interpretation</a>).</p></li>
</ul>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">+l</span></code> (default)</dt><dd><p>Like <code class="code docutils literal notranslate"><span class="pre">+u</span></code>, but <em>silently skips</em> “unsafe” symlinks whose target is
outside the top-of-transfer directory. Preserves:</p>
<ul class="simple">
<li><p>Metadata.</p></li>
<li><p>Directory structure.</p></li>
<li><p>Symlinks, if a link’s target is within the “top-of-transfer directory”.
This is not the context directory and often not the source either. Also,
this creates broken symlinks if the target is not within the source but
is within the top-of-transfer. See examples below.</p></li>
</ul>
<p>Equivalent to the <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code> options listed for <code class="code docutils literal notranslate"><span class="pre">+m</span></code> plus
<code class="code docutils literal notranslate"><span class="pre">--links</span></code> (copy symlinks as symlinks unless otherwise specified) and
<code class="code docutils literal notranslate"><span class="pre">--safe-links</span></code> (silently skip unsafe symlinks).</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">+u</span></code></dt><dd><p>Like <code class="code docutils literal notranslate"><span class="pre">+l</span></code>, but <em>replaces</em> with their target “unsafe” symlinks whose
target is outside the top-of-transfer directory, and thus <em>can copy data
outside the context directory into the image</em>. Preserves:</p>
<ul class="simple">
<li><p>Metadata.</p></li>
<li><p>Directory structure.</p></li>
<li><p>Symlinks, if a link’s target is within the “top-of-transfer directory”.
This is not the context directory and often not the source either. Also,
this creates broken symlinks if the target is not within the source but
is within the top-of-transfer. See examples below.</p></li>
</ul>
<p>Equivalent to the <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code> options listed for <code class="code docutils literal notranslate"><span class="pre">+m</span></code> plus
<code class="code docutils literal notranslate"><span class="pre">--links</span></code> (copy symlinks as symlinks unless otherwise specified) and
<code class="code docutils literal notranslate"><span class="pre">--copy-unsafe-links</span></code> (copy the target of unsafe symlinks).</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">+z</span></code></dt><dd><p>No default arguments. Directories will not be descended, no metadata will
be preserved, and both hard and symbolic links will be ignored, except as
otherwise specified by <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code> options starting with a hyphen.
(Note that <code class="code docutils literal notranslate"><span class="pre">-a</span></code>/<code class="code docutils literal notranslate"><span class="pre">--archive</span></code> is discouraged because it omits
some metadata and handles symlinks inappropriately for containers.)</p>
</dd>
</dl>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code> supports a configuration file <code class="code docutils literal notranslate"><span class="pre">~/.popt</span></code> that alters
its command line processing. Currently, this configuration is respected for
<code class="code docutils literal notranslate"><span class="pre">RSYNC</span></code> arguments, but that may change without notice.</p>
</div>
</section>
<section id="disallowed-rsync-1-features">
<h4><span class="section-number">7.7.5.3. </span>Disallowed <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code> features<a class="headerlink" href="#disallowed-rsync-1-features" title="Permalink to this heading">¶</a></h4>
<p>A small number of <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code> features are actively disallowed:</p>
<blockquote>
<div><ol class="arabic">
<li><p><code class="code docutils literal notranslate"><span class="pre">rsync:</span></code> and <code class="code docutils literal notranslate"><span class="pre">ssh:</span></code> transports are an error. Charliecloud
needs access to the entire input to compute cache hit or miss, and these
transports make that impossible. It is possible these will become
available in the future (please let us know if that is your use case!).
For now, the workaround is to install <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code> in the image and
use it in a <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instruction, though only the instruction text
will be considered for the cache.</p></li>
<li><p>Option arguments must be delimited with <code class="code docutils literal notranslate"><span class="pre">=</span></code> (equals). For example,
to set the block size to 4 MiB, you must say <code class="code docutils literal notranslate"><span class="pre">--block-size=4M</span></code> or
<code class="code docutils literal notranslate"><span class="pre">-B=4M</span></code>. <code class="code docutils literal notranslate"><span class="pre">-B4M</span></code> will be interpreted as the three arguments
<code class="code docutils literal notranslate"><span class="pre">-B</span></code>, <code class="code docutils literal notranslate"><span class="pre">-4</span></code>, and <code class="code docutils literal notranslate"><span class="pre">-M</span></code>; <code class="code docutils literal notranslate"><span class="pre">--block-size</span> <span class="pre">4M</span></code> will be
interpreted as <code class="code docutils literal notranslate"><span class="pre">--block-size</span></code> with no argument and a copy source
named <code class="code docutils literal notranslate"><span class="pre">4M</span></code>. This is so Charliecloud can process <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code>
options without knowing which ones take an argument.</p></li>
<li><p>Invalid <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code> options:</p>
<dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">--daemon</span></code></dt><dd><p>Running <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code> in daemon mode does not make sense for
container build.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-n</span></code>, <code class="code docutils literal notranslate"><span class="pre">--dry-run</span></code></dt><dd><p>This makes the copy a no-op, and Charliecloud may want to use it
internally in the future.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--remove-source-files</span></code></dt><dd><p>This would let the instruction alter the context directory.</p>
</dd>
</dl>
</li>
</ol>
</div></blockquote>
<p>Note that there are likely other flags that don’t make sense and/or cause
undesirable behavior. We have not characterized this problem.</p>
</section>
<section id="id7">
<h4><span class="section-number">7.7.5.4. </span>Build cache<a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h4>
<p>The instruction is a cache hit if the metadata of all source files is
unchanged (specifically: filename, file type and permissions, xattrs, size,
and last modified time). Unlike Docker, Charliecloud does not use file
contents. This has two implications. First, it is possible to fool the cache
by manually restoring the last-modified time. Second, <code class="code docutils literal notranslate"><span class="pre">RSYNC</span></code> is
I/O-intensive even when it hits, because it must <code class="code docutils literal notranslate"><span class="pre">stat(2)</span></code> every source
file before checking the cache. However, this is still less I/O than reading
the file content too.</p>
<p>Notably, Charliecloud’s cache ignores <code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code>’s own internal notion
of whether anything would be transferred (e.g., <code class="code docutils literal notranslate"><span class="pre">rsync</span> <span class="pre">-ni</span></code>). This may
change in the future.</p>
</section>
<section id="examples-and-tutorial">
<h4><span class="section-number">7.7.5.5. </span>Examples and tutorial<a class="headerlink" href="#examples-and-tutorial" title="Permalink to this heading">¶</a></h4>
<p>All of these examples use the same input, whose content will be introduced
gradually, using edited output of <code class="code docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-oghR</span></code> (which is like <code class="code docutils literal notranslate"><span class="pre">ls</span>
<span class="pre">-lhR</span></code> but omits user and group). Examples assume a umask of <code class="code docutils literal notranslate"><span class="pre">0007</span></code>. The
Dockerfile instructions listed also assume a preceding:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">alpine:3.17</span>
<span class="k">RUN</span><span class="w"> </span>mkdir<span class="w"> </span>/dst
</pre></div>
</div>
<p>i.e., a simple base image containing a top-level directory <code class="code docutils literal notranslate"><span class="pre">dst</span></code>.</p>
<p>Many additional examples are available in the source code in the file
<code class="code docutils literal notranslate"><span class="pre">test/build/50_rsync.bats</span></code>.</p>
<p>We begin by copying regular files. The context directory <code class="code docutils literal notranslate"><span class="pre">ctx</span></code> contains,
in part, two directories containing one regular file each. Note that one of
these files (<code class="code docutils literal notranslate"><span class="pre">file-basic1</span></code>) and one of the directories (<code class="code docutils literal notranslate"><span class="pre">basic1</span></code>)
have strange permissions.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./ctx:</span>
<span class="go">drwx---r-x 2  60 Oct 11 13:20 basic1</span>
<span class="go">drwxrwx--- 2  60 Oct 11 13:20 basic2</span>

<span class="go">./ctx/basic1:</span>
<span class="go">-rw----r-- 1 12 Oct 11 13:20 file-basic1</span>

<span class="go">./ctx/basic2:</span>
<span class="go">-rw-rw---- 1 12 Oct 11 13:20 file-basic2</span>
</pre></div>
</div>
<p>The simplest form of <code class="code docutils literal notranslate"><span class="pre">RSYNC</span></code> is to copy a single file into a specified
directory:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span>RSYNC<span class="w"> </span>/basic1/file-basic1<span class="w"> </span>/dst
</pre></div>
</div>
<p>resulting in:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>-oghR<span class="w"> </span>dst
<span class="go">dst:</span>
<span class="go">-rw----r-- 1 12 Oct 11 13:26 file-basic1</span>
</pre></div>
</div>
<p>Note that <code class="code docutils literal notranslate"><span class="pre">file-basic1</span></code>’s metadata — here its odd permissions — are
preserved. <code class="code docutils literal notranslate"><span class="pre">1</span></code> is the number of hard links to the file, and <code class="code docutils literal notranslate"><span class="pre">12</span></code>
is the file size.</p>
<p>One can also rename the destination by specifying a new file name, and with
<code class="code docutils literal notranslate"><span class="pre">+z</span></code>, not copy metadata (from here on the <code class="code docutils literal notranslate"><span class="pre">ls</span></code> command is omitted
for brevity):</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span>RSYNC<span class="w"> </span>+z<span class="w"> </span>/basic1/file-basic1<span class="w"> </span>/dst/file-basic1_nom
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">-rw------- 1 12 Sep 21 15:51 file-basic1_nom</span>
</pre></div>
</div>
<p>A trailing slash on the destination creates a new directory and places the
source file within:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span>RSYNC<span class="w"> </span>/basic1/file-basic1<span class="w"> </span>/dst/new/
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">drwxrwx--- 1 22 Oct 11 13:26 new</span>

<span class="go">dst/new:</span>
<span class="go">-rw----r-- 1 12 Oct 11 13:26 file-basic1</span>
</pre></div>
</div>
<p>With multiple source files, the destination trailing slash is optional:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span>RSYNC<span class="w"> </span>/basic1/file-basic1<span class="w"> </span>/basic2/file-basic2<span class="w"> </span>/dst/newB
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">drwxrwx--- 1 44 Oct 11 13:26 newB</span>

<span class="go">dst/newB:</span>
<span class="go">-rw----r-- 1 12 Oct 11 13:26 file-basic1</span>
<span class="go">-rw-rw---- 1 12 Oct 11 13:26 file-basic2</span>
</pre></div>
</div>
<p>For directory sources, the presence or absence of a trailing slash is highly
significant. Without one, the directory itself is placed in the destination
(recall that this would rename a source <em>file</em>):</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span>RSYNC<span class="w"> </span>/basic1<span class="w"> </span>/dst/basic1_new
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">drwxrwx--- 1 12 Oct 11 13:28 basic1_new</span>

<span class="go">dst/basic1_new:</span>
<span class="go">drwx---r-x 1 22 Oct 11 13:28 basic1</span>

<span class="go">dst/basic1_new/basic1:</span>
<span class="go">-rw----r-- 1 12 Oct 11 13:28 file-basic1</span>
</pre></div>
</div>
<p>A source trailing slash means copy the <em>contents of</em> a directory rather than
the directory itself. Importantly, however, the directory’s metadata is copied
to the destination directory.</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span>RSYNC<span class="w"> </span>/basic1/<span class="w"> </span>/dst/basic1_renamed
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">drwx---r-x 1 22 Oct 11 13:28 basic1_renamed</span>

<span class="go">dst/basic1_renamed:</span>
<span class="go">-rw----r-- 1 12 Oct 11 13:28 file-basic1</span>
</pre></div>
</div>
<p>One gotcha is that <code class="code docutils literal notranslate"><span class="pre">RSYNC</span> <span class="pre">+z</span></code> is a no-op if the source is a directory:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span>RSYNC<span class="w"> </span>+z<span class="w"> </span>/basic1<span class="w"> </span>/dst/basic1_newC
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
</pre></div>
</div>
<p>At least <code class="code docutils literal notranslate"><span class="pre">-r</span></code> is needed with <code class="code docutils literal notranslate"><span class="pre">+z</span></code> in this case:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span>RSYNC<span class="w"> </span>+z<span class="w"> </span>-r<span class="w"> </span>/basic1/<span class="w"> </span>/dst/basic1_newD
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">drwx------ 1 22 Oct 11 13:28 basic1_newD</span>

<span class="go">dst/basic1_newD:</span>
<span class="go">-rw------- 1 12 Oct 11 13:28 file-basic1</span>
</pre></div>
</div>
<p>Multiple source directories can be specified, including with wildcards. This
example also illustrates that copies files are by default merged with content
already existing in the image.</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">RUN</span><span class="w"> </span>mkdir<span class="w"> </span>/dst/dstC<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span>file-dstC<span class="w"> </span>&gt;<span class="w"> </span>/dst/dstC/file-dstC
RSYNC<span class="w"> </span>/basic*<span class="w"> </span>/dst/dstC
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">drwxrwx--- 1 42 Oct 11 13:33 dstC</span>

<span class="go">dst/dstC:</span>
<span class="go">drwx---r-x 1 22 Oct 11 13:33 basic1</span>
<span class="go">drwxrwx--- 1 22 Oct 11 13:33 basic2</span>
<span class="go">-rw-rw---- 1 10 Oct 11 13:33 file-dstC</span>

<span class="go">dst/dstC/basic1:</span>
<span class="go">-rw----r-- 1 12 Oct 11 13:33 file-basic1</span>

<span class="go">dst/dstC/basic2:</span>
<span class="go">-rw-rw---- 1 12 Oct 11 13:33 file-basic2</span>
</pre></div>
</div>
<p>Trailing slashes can be specified independently for each source:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">RUN</span><span class="w"> </span>mkdir<span class="w"> </span>/dst/dstF<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span>file-dstF<span class="w"> </span>&gt;<span class="w"> </span>/dst/dstF/file-dstF
RSYNC<span class="w"> </span>/basic1<span class="w"> </span>/basic2/<span class="w"> </span>/dst/dstF
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">drwxrwx--- 1 52 Oct 11 13:33 dstF</span>

<span class="go">dst/dstF:</span>
<span class="go">drwx---r-x 1 22 Oct 11 13:33 basic1</span>
<span class="go">-rw-rw---- 1 12 Oct 11 13:33 file-basic2</span>
<span class="go">-rw-rw---- 1 10 Oct 11 13:33 file-dstF</span>

<span class="go">dst/dstF/basic1:</span>
<span class="go">-rw----r-- 1 12 Oct 11 13:33 file-basic1</span>
</pre></div>
</div>
<p>Bare <code class="code docutils literal notranslate"><span class="pre">/</span></code> (i.e., the entire context directory) is considered to have a
trailing slash:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span>RSYNC<span class="w"> </span>/<span class="w"> </span>/dst
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">drwx---r-x 1  22 Oct 11 13:33 basic1</span>
<span class="go">drwxrwx--- 1  22 Oct 11 13:33 basic2</span>

<span class="go">dst/basic1:</span>
<span class="go">-rw----r-- 1 12 Oct 11 13:33 file-basic1</span>

<span class="go">dst/basic2:</span>
<span class="go">-rw-rw---- 1 12 Oct 11 13:33 file-basic2</span>
</pre></div>
</div>
<p>To <em>replace</em> (rather than merge with) existing content, use <code class="code docutils literal notranslate"><span class="pre">--delete</span></code>.
Note also that wildcards can be combined with trailing slashes and that the
directory gets the metadata of the <em>first</em> slashed directory.</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">RUN</span><span class="w"> </span>mkdir<span class="w"> </span>/dst/dstG<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span>file-dstG<span class="w"> </span>&gt;<span class="w"> </span>/dst/dstG/file-dstG
RSYNC<span class="w"> </span>--delete<span class="w"> </span>/basic*/<span class="w"> </span>/dst/dstG
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">drwx---r-x 1 44 Oct 11 14:00 dstG</span>

<span class="go">dst/dstG:</span>
<span class="go">-rw----r-- 1 12 Oct 11 14:00 file-basic1</span>
<span class="go">-rw-rw---- 1 12 Oct 11 14:00 file-basic2</span>
</pre></div>
</div>
<p>Symbolic links in the source(s) add significant complexity. Like
<code class="code docutils literal notranslate"><span class="pre">rsync(1)</span></code>, <code class="code docutils literal notranslate"><span class="pre">RSYNC</span></code> can do one of three things with a given
symlink:</p>
<ol class="arabic simple">
<li><p>Ignore it, silently or with a warning.</p></li>
<li><p>Preserve it: copy as a symlink, with the same target.</p></li>
<li><p>Dereference it: copy the target instead.</p></li>
</ol>
<p>These actions are selected independently for <em>safe symlinks</em> and <em>unsafe
symlinks</em>. Safe symlinks are those which point to a target within the <em>top of
transfer</em>, which is the deepest directory in the source path with a trailing
slash. For example, <code class="code docutils literal notranslate"><span class="pre">/foo/bar</span></code>’s top-of-transfer is <code class="code docutils literal notranslate"><span class="pre">/foo</span></code>
(regardless of whether <code class="code docutils literal notranslate"><span class="pre">bar</span></code> is a directory or file), while
<code class="code docutils literal notranslate"><span class="pre">/foo/bar/</span></code>’s top-of-transfer is <code class="code docutils literal notranslate"><span class="pre">/foo/bar</span></code>.</p>
<p>For the symlink examples, the context contains two sub-directories with a
variety of symlinks, as well as a sibling file and directory outside the
context. All of these links are valid on the host. In this listing, the
absolute path to the parent of the context directory is replaced with
<code class="code docutils literal notranslate"><span class="pre">/...</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">.:</span>
<span class="go">drwxrwx--- 9 200 Oct 11 14:00 ctx</span>
<span class="go">drwxrwx--- 2  60 Oct 11 14:00 dir-out</span>
<span class="go">-rw-rw---- 1   9 Oct 11 14:00 file-out</span>

<span class="go">./ctx:</span>
<span class="go">drwxrwx--- 3 320 Oct 11 14:00 sym1</span>

<span class="go">./ctx/sym1:</span>
<span class="go">lrwxrwxrwx 1 13 Oct 11 14:00 dir-out_rel -&gt; ../../dir-out</span>
<span class="go">drwxrwx--- 2 60 Oct 11 14:00 dir-sym1</span>
<span class="go">lrwxrwxrwx 1  8 Oct 11 14:00 dir-sym1_direct -&gt; dir-sym1</span>
<span class="go">lrwxrwxrwx 1 10 Oct 11 14:00 dir-top_rel -&gt; ../dir-top</span>
<span class="go">lrwxrwxrwx 1 47 Oct 11 14:00 file-out_abs -&gt; /.../file-out</span>
<span class="go">lrwxrwxrwx 1 14 Oct 11 14:00 file-out_rel -&gt; ../../file-out</span>
<span class="go">-rw-rw---- 1 10 Oct 11 14:00 file-sym1</span>
<span class="go">lrwxrwxrwx 1 57 Oct 11 14:00 file-sym1_abs -&gt; /.../ctx/sym1/file-sym1</span>
<span class="go">lrwxrwxrwx 1  9 Oct 11 14:00 file-sym1_direct -&gt; file-sym1</span>
<span class="go">lrwxrwxrwx 1 17 Oct 11 14:00 file-sym1_upover -&gt; ../sym1/file-sym1</span>
<span class="go">lrwxrwxrwx 1 51 Oct 11 14:00 file-top_abs -&gt; /.../ctx/file-top</span>
<span class="go">lrwxrwxrwx 1 11 Oct 11 14:00 file-top_rel -&gt; ../file-top</span>

<span class="go">./ctx/sym1/dir-sym1:</span>
<span class="go">-rw-rw---- 1 14 Oct 11 14:00 dir-sym1.file</span>

<span class="go">./dir-out:</span>
<span class="go">-rw-rw---- 1 13 Oct 11 14:00 dir-out.file</span>
</pre></div>
</div>
<p>By default, safe symlinks are preserved while unsafe symlinks are silently
ignored:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span>RSYNC<span class="w"> </span>/sym1<span class="w"> </span>/dst
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">drwxrwx--- 1 206 Oct 11 17:10 sym1</span>

<span class="go">dst/sym1:</span>
<span class="go">drwxrwx--- 1 26 Oct 11 17:10 dir-sym1</span>
<span class="go">lrwxrwxrwx 1  8 Oct 11 17:10 dir-sym1_direct -&gt; dir-sym1</span>
<span class="go">lrwxrwxrwx 1 10 Oct 11 17:10 dir-top_rel -&gt; ../dir-top</span>
<span class="go">-rw-rw---- 1 10 Oct 11 17:10 file-sym1</span>
<span class="go">lrwxrwxrwx 1  9 Oct 11 17:10 file-sym1_direct -&gt; file-sym1</span>
<span class="go">lrwxrwxrwx 1 17 Oct 11 17:10 file-sym1_upover -&gt; ../sym1/file-sym1</span>
<span class="go">lrwxrwxrwx 1 17 Oct 11 17:10 file-sym2_upover -&gt; ../sym2/file-sym2</span>
<span class="go">lrwxrwxrwx 1 11 Oct 11 17:10 file-top_rel -&gt; ../file-top</span>

<span class="go">dst/sym1/dir-sym1:</span>
<span class="go">-rw-rw---- 1 14 Oct 11 17:10 dir-sym1.file</span>
</pre></div>
</div>
<p>The source files have four rough fates:</p>
<ol class="arabic simple">
<li><p>Regular files and directories (<code class="code docutils literal notranslate"><span class="pre">file-sym1</span></code> and <code class="code docutils literal notranslate"><span class="pre">dir-sym1</span></code>).
These are copied into the image unchanged, including metadata.</p></li>
<li><p>Safe symlinks, now broken. This is one of the gotchas of <code class="code docutils literal notranslate"><span class="pre">RSYNC</span></code>’s
top-of-transfer directory (here host path <code class="code docutils literal notranslate"><span class="pre">./ctx</span></code>, image path
<code class="code docutils literal notranslate"><span class="pre">/</span></code>) differing from the source directory (<code class="code docutils literal notranslate"><span class="pre">./ctx/sym1</span></code>,
<code class="code docutils literal notranslate"><span class="pre">/sym1</span></code>), because the latter lacks a trailing slash.
<code class="code docutils literal notranslate"><span class="pre">dir-top_rel</span></code>, <code class="code docutils literal notranslate"><span class="pre">file-sym2_upover</span></code>, and <code class="code docutils literal notranslate"><span class="pre">file-top_rel</span></code> all
ascend only as high as <code class="code docutils literal notranslate"><span class="pre">./ctx</span></code> (host path, <code class="code docutils literal notranslate"><span class="pre">/</span></code> image) before
re-descending. This is within the top-of-transfer, so the symlinks are safe
and thus copied unchanged, but their targets were not included in the copy.</p></li>
<li><p>Safe symlinks, still valid.</p>
<ol class="arabic simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">dir-sym1_direct</span></code> and <code class="code docutils literal notranslate"><span class="pre">file-sym1_direct</span></code> point directly to
files in the same directory.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">dir-sym1_upover</span></code> and <code class="code docutils literal notranslate"><span class="pre">file-sym1_upover</span></code> point to files in
the same directory, but by first ascending into their parent — within
the top-of-transfer, so they are safe — and then re-descending. If
<code class="code docutils literal notranslate"><span class="pre">sym1</span></code> were renamed during the copy, these links would break.</p></li>
</ol>
</li>
<li><p>Unsafe symlinks, which are ignored by the copy and do not appear in the
image.</p>
<ol class="arabic simple">
<li><p>Absolute symlinks are always unsafe (<code class="code docutils literal notranslate"><span class="pre">*_abs</span></code>).</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">dir-out_rel</span></code> and <code class="code docutils literal notranslate"><span class="pre">file-out_rel</span></code> are relative symlinks that
ascend above the top-of-transfer, in this case to targets outside the
context, and are thus unsafe.</p></li>
</ol>
</li>
</ol>
<p>The top-of-transfer can be changed to <code class="code docutils literal notranslate"><span class="pre">sym1</span></code> with a trailing slash. This
also adds <code class="code docutils literal notranslate"><span class="pre">sym1</span></code> to the destination so the resulting directory structure
is the same.</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span>RSYNC<span class="w"> </span>/sym1/<span class="w"> </span>/dst/sym1
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">drwxrwx--- 1 96 Oct 11 17:10 sym1</span>

<span class="go">dst/sym1:</span>
<span class="go">drwxrwx--- 1 26 Oct 11 17:10 dir-sym1</span>
<span class="go">lrwxrwxrwx 1  8 Oct 11 17:10 dir-sym1_direct -&gt; dir-sym1</span>
<span class="go">-rw-rw---- 1 10 Oct 11 17:10 file-sym1</span>
<span class="go">lrwxrwxrwx 1  9 Oct 11 17:10 file-sym1_direct -&gt; file-sym1</span>

<span class="go">dst/sym1/dir-sym1:</span>
<span class="go">-rw-rw---- 1 14 Oct 11 17:10 dir-sym1.file</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">*_upover</span></code> and <code class="code docutils literal notranslate"><span class="pre">*-out_rel</span></code> are now unsafe and replaced with their
targets.</p>
<p>Another common use case is to follow unsafe symlinks and copy their targets in
place of the links. This is accomplished with <code class="code docutils literal notranslate"><span class="pre">+u</span></code>:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span>RSYNC<span class="w"> </span>+u<span class="w"> </span>/sym1/<span class="w"> </span>/dst/sym1
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">drwxrwx--- 1 352 Oct 11 17:10 sym1</span>

<span class="go">dst/sym1:</span>
<span class="go">drwxrwx--- 1 24 Oct 11 17:10 dir-out_rel</span>
<span class="go">drwxrwx--- 1 26 Oct 11 17:10 dir-sym1</span>
<span class="go">lrwxrwxrwx 1  8 Oct 11 17:10 dir-sym1_direct -&gt; dir-sym1</span>
<span class="go">drwxrwx--- 1 24 Oct 11 17:10 dir-top_rel</span>
<span class="go">-rw-rw---- 1  9 Oct 11 17:10 file-out_abs</span>
<span class="go">-rw-rw---- 1  9 Oct 11 17:10 file-out_rel</span>
<span class="go">-rw-rw---- 1 10 Oct 11 17:10 file-sym1</span>
<span class="go">-rw-rw---- 1 10 Oct 11 17:10 file-sym1_abs</span>
<span class="go">lrwxrwxrwx 1  9 Oct 11 17:10 file-sym1_direct -&gt; file-sym1</span>
<span class="go">-rw-rw---- 1 10 Oct 11 17:10 file-sym1_upover</span>
<span class="go">-rw-rw---- 1 10 Oct 11 17:10 file-sym2_abs</span>
<span class="go">-rw-rw---- 1 10 Oct 11 17:10 file-sym2_upover</span>
<span class="go">-rw-rw---- 1  9 Oct 11 17:10 file-top_abs</span>
<span class="go">-rw-rw---- 1  9 Oct 11 17:10 file-top_rel</span>

<span class="go">dst/sym1/dir-out_rel:</span>
<span class="go">-rw-rw---- 1 13 Oct 11 17:10 dir-out.file</span>

<span class="go">dst/sym1/dir-sym1:</span>
<span class="go">-rw-rw---- 1 14 Oct 11 17:10 dir-sym1.file</span>

<span class="go">dst/sym1/dir-top_rel:</span>
<span class="go">-rw-rw---- 1 13 Oct 11 17:10 dir-top.file</span>
</pre></div>
</div>
<p>Now all the unsafe symlinks noted above are present in the image, but they
have changed to the normal files and directories pointed to.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This feature lets you copy files outside the context into the image, unlike
other container builders where <code class="code docutils literal notranslate"><span class="pre">COPY</span></code> can never access anything
outside the context.</p>
</div>
<p>The sources themselves, if symlinks, do not get special treatment:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span>RSYNC<span class="w"> </span>/sym1/file-sym1_direct<span class="w"> </span>/sym1/file-sym1_upover<span class="w"> </span>/dst
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">lrwxrwxrwx 1 9 Oct 11 17:10 file-sym1_direct -&gt; file-sym1</span>
</pre></div>
</div>
<p>Note that <code class="code docutils literal notranslate"><span class="pre">file-sym1_upover</span></code> does not appear in the image, despite being
named explicitly in the instruction, because it is an unsafe symlink.</p>
<p>If the <em>destination</em> is a symlink to a file, and the source is a file, the
link is replaced and the target is unchanged. (If the source is a directory,
that is an error.)</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">RUN</span><span class="w"> </span>touch<span class="w"> </span>/dst/file-dst<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>file-dst<span class="w"> </span>/dst/file-dst_direct
RSYNC<span class="w"> </span>/file-top<span class="w"> </span>/dst/file-dst_direct
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">-rw-rw---- 1 0 Oct 11 17:42 file-dst</span>
<span class="go">-rw-rw---- 1 9 Oct 11 17:42 file-dst_direct</span>
</pre></div>
</div>
<p>If the destination is a symlink to a directory, the link is followed:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">RUN</span><span class="w"> </span>mkdir<span class="w"> </span>/dst/dir-dst<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>dir-dst<span class="w"> </span>/dst/dir-dst_direct
RSYNC<span class="w"> </span>/file-top<span class="w"> </span>/dst/dir-dst_direct
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dst:</span>
<span class="go">drwxrwx--- 1 16 Oct 11 17:50 dir-dst</span>
<span class="go">lrwxrwxrwx 1  7 Oct 11 17:50 dir-dst_direct -&gt; dir-dst</span>

<span class="go">dst/dir-dst:</span>
<span class="go">-rw-rw---- 1 9 Oct 11 17:50 file-top</span>
</pre></div>
</div>
</section>
</section>
<section id="examples">
<h3><span class="section-number">7.7.6. </span>Examples<a class="headerlink" href="#examples" title="Permalink to this heading">¶</a></h3>
<p>Build image <code class="code docutils literal notranslate"><span class="pre">bar</span></code> using <code class="code docutils literal notranslate"><span class="pre">./foo/bar/Dockerfile</span></code> and context
directory <code class="code docutils literal notranslate"><span class="pre">./foo/bar</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>bar<span class="w"> </span>-f<span class="w"> </span>./foo/bar/Dockerfile<span class="w"> </span>./foo/bar
<span class="go">[...]</span>
<span class="go">grown in 4 instructions: bar</span>
</pre></div>
</div>
<p>Same, but infer the image name and Dockerfile from the context directory
path:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span>build<span class="w"> </span>./foo/bar
<span class="go">[...]</span>
<span class="go">grown in 4 instructions: bar</span>
</pre></div>
</div>
<p>Build using humongous vendor compilers you want to bind-mount instead of
installing into the image:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span>build<span class="w"> </span>--bind<span class="w"> </span>/opt/bigvendor:/opt<span class="w"> </span>.
<span class="gp">$ </span>cat<span class="w"> </span>Dockerfile
<span class="go">FROM centos:7</span>

<span class="go">RUN /opt/bin/cc hello.c</span>
<span class="gp">#</span>COPY<span class="w"> </span>/opt/lib/*.so<span class="w"> </span>/usr/local/lib<span class="w">   </span><span class="c1"># fail: COPY doesn’t bind mount</span>
<span class="go">RUN cp /opt/lib/*.so /usr/local/lib  # possible workaround</span>
<span class="go">RUN ldconfig</span>
</pre></div>
</div>
</section>
</section>
<section id="id8">
<h2><span class="section-number">7.8. </span><code class="code docutils literal notranslate"><span class="pre">build-cache</span></code><a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h2>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>build-cache<span class="w"> </span><span class="o">[</span>...<span class="o">]</span>
</pre></div>
</div>
<p>Print basic information about the cache. If <code class="code docutils literal notranslate"><span class="pre">-v</span></code> is given, also print
some Git statistics and the Git repository configuration.</p>
<p>If any of the following options are given, do the corresponding operation
before printing. Multiple options can be given, in which case they happen in
this order.</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">--dot</span></code></dt><dd><p>Create a DOT export of the tree named <code class="code docutils literal notranslate"><span class="pre">./build-cache.dot</span></code> and a PDF
rendering <code class="code docutils literal notranslate"><span class="pre">./build-cache.pdf</span></code>. Requires <code class="code docutils literal notranslate"><span class="pre">graphviz</span></code> and
<code class="code docutils literal notranslate"><span class="pre">git2dot</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--gc</span></code></dt><dd><p>Run Git garbage collection on the cache, including full de-duplication of
similar files. This will immediately remove all cache entries not
currently reachable from a named branch (which is likely to cause
corruption if the build cache is being accessed concurrently by another
process). The operation can take a long time on large caches.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--reset</span></code></dt><dd><p>Clear and re-initialize the build cache.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--tree</span></code></dt><dd><p>Print a text tree of the cache using Git’s <code class="code docutils literal notranslate"><span class="pre">git</span> <span class="pre">log</span> <span class="pre">--graph</span></code>
feature. If <code class="code docutils literal notranslate"><span class="pre">-v</span></code> is also given, the tree has more detail.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="delete">
<h2><span class="section-number">7.9. </span><code class="code docutils literal notranslate"><span class="pre">delete</span></code><a class="headerlink" href="#delete" title="Permalink to this heading">¶</a></h2>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>delete<span class="w"> </span>IMAGE_GLOB<span class="w"> </span><span class="o">[</span>IMAGE_GLOB<span class="w"> </span>...<span class="w"> </span><span class="o">]</span>
</pre></div>
</div>
<p>Delete the image(s) described by each <code class="code docutils literal notranslate"><span class="pre">IMAGE_GLOB</span></code> from the storage
directory (including all build stages).</p>
<p><code class="code docutils literal notranslate"><span class="pre">IMAGE_GLOB</span></code> can be either a plain image reference or an image reference
with glob characters to match multiple images. For example, <code class="code docutils literal notranslate"><span class="pre">ch-image</span>
<span class="pre">delete</span> <span class="pre">'foo*'</span></code> will delete all images whose names start with <code class="code docutils literal notranslate"><span class="pre">foo</span></code>.
Multiple images and/or globs can also be given in a single command line.</p>
<p>Importantly, this sub-command <em>does not</em> also remove the image from the build
cache. Therefore, it can be used to reduce the size of the storage directory,
trading off the time needed to retrieve an image from cache.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Glob characters must be quoted or otherwise protected from the shell, which
also desires to interpret them and will do so incorrectly.</p>
</div>
</section>
<section id="gestalt">
<h2><span class="section-number">7.10. </span><code class="code docutils literal notranslate"><span class="pre">gestalt</span></code><a class="headerlink" href="#gestalt" title="Permalink to this heading">¶</a></h2>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>gestalt<span class="w"> </span><span class="o">[</span>SELECTOR<span class="o">]</span>
</pre></div>
</div>
<p>Provide information about the <a class="reference external" href="https://apple.fandom.com/wiki/Gestalt">configuration and available features</a> of <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code>. End users
generally will not need this; it is intended for testing and debugging.</p>
<p><code class="code docutils literal notranslate"><span class="pre">SELECTOR</span></code> is one of:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">bucache</span></code>. Exit successfully if the build cache is available,
unsuccessfully with an error message otherwise. With <code class="code docutils literal notranslate"><span class="pre">-v</span></code>, also
print version information about dependencies.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">bucache-dot</span></code>. Exit successfully if build cache DOT trees can be
written, unsuccessfully with an error message otherwise. With <code class="code docutils literal notranslate"><span class="pre">-v</span></code>,
also print version information about dependencies.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">python-path</span></code>. Print the path to the Python interpreter in use and
exit successfully.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">storage-path</span></code>. Print the storage directory path and exit
successfully.</p></li>
</ul>
</div></blockquote>
</section>
<section id="list">
<h2><span class="section-number">7.11. </span><code class="code docutils literal notranslate"><span class="pre">list</span></code><a class="headerlink" href="#list" title="Permalink to this heading">¶</a></h2>
<p>Print information about images. If no argument given, list the images in
builder storage.</p>
<section id="id9">
<h3><span class="section-number">7.11.1. </span>Synopsis<a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>list<span class="w"> </span><span class="o">[</span>-l<span class="o">]</span><span class="w"> </span><span class="o">[</span>IMAGE_REF<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="id10">
<h3><span class="section-number">7.11.2. </span>Description<a class="headerlink" href="#id10" title="Permalink to this heading">¶</a></h3>
<p>Optional argument:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">-l</span></code>, <code class="code docutils literal notranslate"><span class="pre">--long</span></code></dt><dd><p>Use long format (name, last change timestamp) when listing images.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-u</span></code>, <code class="code docutils literal notranslate"><span class="pre">--undeletable</span></code></dt><dd><p>List images that can be undeleted. Can also be spelled <code class="code docutils literal notranslate"><span class="pre">--undeleteable</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code></dt><dd><p>Print details of what’s known about <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code>, both locally and in
the remote registry, if any.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="id11">
<h3><span class="section-number">7.11.3. </span>Examples<a class="headerlink" href="#id11" title="Permalink to this heading">¶</a></h3>
<p>List images in builder storage:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span>list
<span class="go">alpine:3.17 (amd64)</span>
<span class="go">alpine:latest (amd64)</span>
<span class="go">debian:buster (amd64)</span>
</pre></div>
</div>
<p>Print details about Debian Buster image:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span>list<span class="w"> </span>debian:buster
<span class="go">details of image:    debian:buster</span>
<span class="go">in local storage:    no</span>
<span class="go">full remote ref:     registry-1.docker.io:443/library/debian:buster</span>
<span class="go">available remotely:  yes</span>
<span class="go">remote arch-aware:   yes</span>
<span class="go">host architecture:   amd64</span>
<span class="go">archs available:     386       bae2738ed83</span>
<span class="go">                     amd64     98285d32477</span>
<span class="go">                     arm/v7    97247fd4822</span>
<span class="go">                     arm64/v8  122a0342878</span>
</pre></div>
</div>
<p>For remotely available images like Debian Buster, the associated digest is
listed beside each available architecture. Importantly, this feature does
<em>not</em> provide the hash of the local image, which is only calculated on push.</p>
</section>
</section>
<section id="import">
<h2><span class="section-number">7.12. </span><code class="code docutils literal notranslate"><span class="pre">import</span></code><a class="headerlink" href="#import" title="Permalink to this heading">¶</a></h2>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>import<span class="w"> </span>PATH<span class="w"> </span>IMAGE_REF
</pre></div>
</div>
<p>Copy the image at <code class="code docutils literal notranslate"><span class="pre">PATH</span></code> into builder storage with name
<code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code>. <code class="code docutils literal notranslate"><span class="pre">PATH</span></code> can be:</p>
<ul class="simple">
<li><p>an image directory</p></li>
<li><p>a tarball with no top-level directory (a.k.a. a “<a class="reference external" href="https://en.wikipedia.org/wiki/Tar_(computing)#Tarbomb">tarbomb</a>”)</p></li>
<li><p>a standard tarball with one top-level directory</p></li>
</ul>
<p>If the imported image contains Charliecloud metadata, that will be imported
unchanged, i.e., images exported from <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> builder storage will be
functionally identical when re-imported.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Descendant images (i.e., <code class="code docutils literal notranslate"><span class="pre">FROM</span></code> the imported <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code>) are
linked using <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code> only. If a new image is imported under a new
<code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code>, all instructions descending from that <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code>
will still hit, even if the new image is different.</p>
</div>
</section>
<section id="pull">
<h2><span class="section-number">7.13. </span><code class="code docutils literal notranslate"><span class="pre">pull</span></code><a class="headerlink" href="#pull" title="Permalink to this heading">¶</a></h2>
<p>Pull the image described by the image reference <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code> from a
repository to the local filesystem.</p>
<section id="id12">
<h3><span class="section-number">7.13.1. </span>Synopsis<a class="headerlink" href="#id12" title="Permalink to this heading">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>pull<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>IMAGE_REF<span class="w"> </span><span class="o">[</span>DEST_REF<span class="o">]</span>
</pre></div>
</div>
<p>See the FAQ for the gory details on specifying image references.</p>
</section>
<section id="id13">
<h3><span class="section-number">7.13.2. </span>Description<a class="headerlink" href="#id13" title="Permalink to this heading">¶</a></h3>
<p>Destination:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">DEST_REF</span></code></dt><dd><p>If specified, use this as the destination image reference, rather than
<code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code>. This lets you pull an image with a complicated
reference while storing it locally with a simpler one.</p>
</dd>
</dl>
</div></blockquote>
<p>Options:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">--last-layer</span> <span class="pre">N</span></code></dt><dd><p>Unpack only <code class="code docutils literal notranslate"><span class="pre">N</span></code> layers, leaving an incomplete image. This option is
intended for debugging.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--parse-only</span></code></dt><dd><p>Parse <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code>, print a parse report, and exit successfully
without talking to the internet or touching the storage directory.</p>
</dd>
</dl>
</div></blockquote>
<p>This script does a fair amount of validation and fixing of the layer tarballs
before flattening in order to support unprivileged use despite image problems
we frequently see in the wild. For example, device files are ignored, and file
and directory permissions are increased to a minimum of <code class="code docutils literal notranslate"><span class="pre">rwx------</span></code> and
<code class="code docutils literal notranslate"><span class="pre">rw-------</span></code> respectively. Note, however, that symlinks pointing outside
the image are permitted, because they are not resolved until runtime within a
container.</p>
<p>The following metadata in the pulled image is retained; all other metadata is
currently ignored. (If you have a need for additional metadata, please let us
know!)</p>
<blockquote>
<div><ul class="simple">
<li><p>Current working directory set with <code class="code docutils literal notranslate"><span class="pre">WORKDIR</span></code> is effective in
downstream Dockerfiles.</p></li>
<li><p>Environment variables set with <code class="code docutils literal notranslate"><span class="pre">ENV</span></code> are effective in downstream
Dockerfiles and also written to <code class="code docutils literal notranslate"><span class="pre">/ch/environment</span></code> for use in
<code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">--set-env</span></code>.</p></li>
<li><p>Mount point directories specified with <code class="code docutils literal notranslate"><span class="pre">VOLUME</span></code> are created in the
image if they don’t exist, but no other action is taken.</p></li>
</ul>
</div></blockquote>
<p>Note that some images (e.g., those with a “version 1 manifest”) do not contain
metadata. A warning is printed in this case.</p>
</section>
<section id="id14">
<h3><span class="section-number">7.13.3. </span>Examples<a class="headerlink" href="#id14" title="Permalink to this heading">¶</a></h3>
<p>Download the Debian Buster image matching the host’s architecture and place it
in the storage directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>uname<span class="w"> </span>-m
<span class="go">aarch32</span>
<span class="go">pulling image:    debian:buster</span>
<span class="go">requesting arch:  arm64/v8</span>
<span class="go">manifest list: downloading</span>
<span class="go">manifest: downloading</span>
<span class="go">config: downloading</span>
<span class="go">layer 1/1: c54d940: downloading</span>
<span class="go">flattening image</span>
<span class="go">layer 1/1: c54d940: listing</span>
<span class="go">validating tarball members</span>
<span class="go">resolving whiteouts</span>
<span class="go">layer 1/1: c54d940: extracting</span>
<span class="go">image arch: arm64</span>
<span class="go">done</span>
</pre></div>
</div>
<p>Same, specifying the architecture explicitly:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span>--arch<span class="o">=</span>arm/v7<span class="w"> </span>pull<span class="w"> </span>debian:buster
<span class="go">pulling image:    debian:buster</span>
<span class="go">requesting arch:  arm/v7</span>
<span class="go">manifest list: downloading</span>
<span class="go">manifest: downloading</span>
<span class="go">config: downloading</span>
<span class="go">layer 1/1: 8947560: downloading</span>
<span class="go">flattening image</span>
<span class="go">layer 1/1: 8947560: listing</span>
<span class="go">validating tarball members</span>
<span class="go">resolving whiteouts</span>
<span class="go">layer 1/1: 8947560: extracting</span>
<span class="go">image arch: arm (may not match host arm64/v8)</span>
</pre></div>
</div>
</section>
</section>
<section id="push">
<h2><span class="section-number">7.14. </span><code class="code docutils literal notranslate"><span class="pre">push</span></code><a class="headerlink" href="#push" title="Permalink to this heading">¶</a></h2>
<p>Push the image described by the image reference <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code> from the
local filesystem to a repository.</p>
<section id="id15">
<h3><span class="section-number">7.14.1. </span>Synopsis<a class="headerlink" href="#id15" title="Permalink to this heading">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>push<span class="w"> </span><span class="o">[</span>--image<span class="w"> </span>DIR<span class="o">]</span><span class="w"> </span>IMAGE_REF<span class="w"> </span><span class="o">[</span>DEST_REF<span class="o">]</span>
</pre></div>
</div>
<p>See the FAQ for the gory details on specifying image references.</p>
</section>
<section id="id16">
<h3><span class="section-number">7.14.2. </span>Description<a class="headerlink" href="#id16" title="Permalink to this heading">¶</a></h3>
<p>Destination:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">DEST_REF</span></code></dt><dd><p>If specified, use this as the destination image reference, rather than
<code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code>. This lets you push to a repository without permanently
adding a tag to the image.</p>
</dd>
</dl>
</div></blockquote>
<p>Options:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">--image</span> <span class="pre">DIR</span></code></dt><dd><p>Use the unpacked image located at <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> rather than an image in the
storage directory named <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code>.</p>
</dd>
</dl>
</div></blockquote>
<p>Because Charliecloud is fully unprivileged, the owner and group of files in
its images are not meaningful in the broader ecosystem. Thus, when pushed,
everything in the image is flattened to user:group <code class="code docutils literal notranslate"><span class="pre">root:root</span></code>. Also,
setuid/setgid bits are removed, to avoid surprises if the image is pulled by a
privileged container implementation.</p>
</section>
<section id="id17">
<h3><span class="section-number">7.14.3. </span>Examples<a class="headerlink" href="#id17" title="Permalink to this heading">¶</a></h3>
<p>Push a local image to the registry <code class="code docutils literal notranslate"><span class="pre">example.com:5000</span></code> at path
<code class="code docutils literal notranslate"><span class="pre">/foo/bar</span></code> with tag <code class="code docutils literal notranslate"><span class="pre">latest</span></code>. Note that in this form, the local
image must be named to match that remote reference.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span>push<span class="w"> </span>example.com:5000/foo/bar:latest
<span class="go">pushing image:   example.com:5000/foo/bar:latest</span>
<span class="go">layer 1/1: gathering</span>
<span class="go">layer 1/1: preparing</span>
<span class="go">preparing metadata</span>
<span class="go">starting upload</span>
<span class="go">layer 1/1: a1664c4: checking if already in repository</span>
<span class="go">layer 1/1: a1664c4: not present, uploading</span>
<span class="go">config: 89315a2: checking if already in repository</span>
<span class="go">config: 89315a2: not present, uploading</span>
<span class="go">manifest: uploading</span>
<span class="go">cleaning up</span>
<span class="go">done</span>
</pre></div>
</div>
<p>Same, except use local image <code class="code docutils literal notranslate"><span class="pre">alpine:3.17</span></code>. In this form, the local image
name does not have to match the destination reference.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span>push<span class="w"> </span>alpine:3.17<span class="w"> </span>example.com:5000/foo/bar:latest
<span class="go">pushing image:   alpine:3.17</span>
<span class="go">destination:     example.com:5000/foo/bar:latest</span>
<span class="go">layer 1/1: gathering</span>
<span class="go">layer 1/1: preparing</span>
<span class="go">preparing metadata</span>
<span class="go">starting upload</span>
<span class="go">layer 1/1: a1664c4: checking if already in repository</span>
<span class="go">layer 1/1: a1664c4: not present, uploading</span>
<span class="go">config: 89315a2: checking if already in repository</span>
<span class="go">config: 89315a2: not present, uploading</span>
<span class="go">manifest: uploading</span>
<span class="go">cleaning up</span>
<span class="go">done</span>
</pre></div>
</div>
<p>Same, except use unpacked image located at <code class="code docutils literal notranslate"><span class="pre">/var/tmp/image</span></code> rather than
an image in <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> storage. (Also, the sole layer is already present
in the remote registry, so we don’t upload it again.)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span>push<span class="w"> </span>--image<span class="w"> </span>/var/tmp/image<span class="w"> </span>example.com:5000/foo/bar:latest
<span class="go">pushing image:   example.com:5000/foo/bar:latest</span>
<span class="go">image path:      /var/tmp/image</span>
<span class="go">layer 1/1: gathering</span>
<span class="go">layer 1/1: preparing</span>
<span class="go">preparing metadata</span>
<span class="go">starting upload</span>
<span class="go">layer 1/1: 892e38d: checking if already in repository</span>
<span class="go">layer 1/1: 892e38d: already present</span>
<span class="go">config: 546f447: checking if already in repository</span>
<span class="go">config: 546f447: not present, uploading</span>
<span class="go">manifest: uploading</span>
<span class="go">cleaning up</span>
<span class="go">done</span>
</pre></div>
</div>
</section>
</section>
<section id="reset">
<h2><span class="section-number">7.15. </span><code class="code docutils literal notranslate"><span class="pre">reset</span></code><a class="headerlink" href="#reset" title="Permalink to this heading">¶</a></h2>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>reset
</pre></div>
</div>
<p>Delete all images and cache from ch-image builder storage.</p>
</section>
<section id="undelete">
<h2><span class="section-number">7.16. </span><code class="code docutils literal notranslate"><span class="pre">undelete</span></code><a class="headerlink" href="#undelete" title="Permalink to this heading">¶</a></h2>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-image<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>undelete<span class="w"> </span>IMAGE_REF
</pre></div>
</div>
<p>If <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code> has been deleted but is in the build cache, recover it
from the cache. Only available when the cache is enabled, and will not
overwrite <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code> if it exists.</p>
</section>
<section id="environment-variables">
<h2><span class="section-number">7.17. </span>Environment variables<a class="headerlink" href="#environment-variables" title="Permalink to this heading">¶</a></h2>
<dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">CH_IMAGE_USERNAME</span></code>, <code class="code docutils literal notranslate"><span class="pre">CH_IMAGE_PASSWORD</span></code></dt><dd><p>Username and password for registry authentication. <strong>See important caveats
in section “Authentication” above.</strong></p>
</dd>
</dl>
<dl>
<dt><code class="code docutils literal notranslate"><span class="pre">CH_LOG_FILE</span></code></dt><dd><p>If set, append log chatter to this file, rather than standard error. This is
useful for debugging situations where standard error is consumed or lost.</p>
<p>Also sets verbose mode if not already set (equivalent to <code class="code docutils literal notranslate"><span class="pre">--verbose</span></code>).</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">CH_LOG_FESTOON</span></code></dt><dd><p>If set, prepend PID and timestamp to logged chatter.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">CH_XATTRS</span></code></dt><dd><p>If set, save xattrs in the build cache and restore them when rebuilding from
the cache (equivalent to <code class="code docutils literal notranslate"><span class="pre">--xattrs</span></code>).</p>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ch-fromhost.html" class="btn btn-neutral float-left" title="6. ch-fromhost" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="ch-run.html" class="btn btn-neutral float-right" title="8. ch-run" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2014–2023, Triad National Security, LLC and others.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
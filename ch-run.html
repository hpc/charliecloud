<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>8. ch-run &mdash; Charliecloud 0.37 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="9. ch-run-oci" href="ch-run-oci.html" />
    <link rel="prev" title="7. ch-image" href="ch-image.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Charliecloud
              <img src="_static/logo-sidebar.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.37
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">1. Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">2. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-checkns.html">3. <code class="code docutils literal notranslate"><span class="pre">ch-checkns</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-completion.bash.html">4. <code class="code docutils literal notranslate"><span class="pre">ch-completion.bash</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-convert.html">5. <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-fromhost.html">6. <code class="code docutils literal notranslate"><span class="pre">ch-fromhost</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-image.html">7. <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code></a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">8. <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code></a><ul>
<li class="toctree-l2"><a class="reference internal" href="#synopsis">8.1. Synopsis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#description">8.2. Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#image-format">8.3. Image format</a></li>
<li class="toctree-l2"><a class="reference internal" href="#host-files-and-directories-available-in-container-via-bind-mounts">8.4. Host files and directories available in container via bind mounts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multiple-processes-in-the-same-container-with-join">8.5. Multiple processes in the same container with <code class="code docutils literal notranslate"><span class="pre">--join</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#writeable-overlay-with-write-fake">8.6. Writeable overlay with <code class="code docutils literal notranslate"><span class="pre">--write-fake</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#environment-variables">8.7. Environment variables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#default-behavior">8.7.1. Default behavior</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-variables-with-set-env-or-set-env0">8.7.2. Setting variables with <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code> or <code class="code docutils literal notranslate"><span class="pre">--set-env0</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#removing-variables-with-unset-env">8.7.3. Removing variables with <code class="code docutils literal notranslate"><span class="pre">--unset-env</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#examples">8.8. Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="#syslog">8.9. Syslog</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exit-status">8.10. Exit status</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ch-run-oci.html">9. <code class="code docutils literal notranslate"><span class="pre">ch-run-oci</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-test.html">10. <code class="code docutils literal notranslate"><span class="pre">ch-test</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">11. Frequently asked questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="best_practices.html">12. Best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev.html">13. Contributor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Charliecloud</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">8. </span><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code></li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ch-run">
<h1><span class="section-number">8. </span><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code><a class="headerlink" href="#ch-run" title="Permalink to this heading">¶</a></h1>
<p>Run a command in a Charliecloud container.</p>
<section id="synopsis">
<h2><span class="section-number">8.1. </span>Synopsis<a class="headerlink" href="#synopsis" title="Permalink to this heading">¶</a></h2>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span><span class="o">[</span>OPTION...<span class="o">]</span><span class="w"> </span>IMAGE<span class="w"> </span>--<span class="w"> </span>COMMAND<span class="w"> </span><span class="o">[</span>ARG...<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="description">
<h2><span class="section-number">8.2. </span>Description<a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h2>
<p>Run command <code class="code docutils literal notranslate"><span class="pre">COMMAND</span></code> in a fully unprivileged Charliecloud container using
the image specified by <code class="code docutils literal notranslate"><span class="pre">IMAGE</span></code>, which can be: (1) a path to a directory,
(2) the name of an image in <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> storage (e.g.
<code class="code docutils literal notranslate"><span class="pre">example.com:5050/foo</span></code>) or, if the proper support is enabled, a SquashFS
archive. <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> does not use any setuid or setcap helpers, even for
mounting SquashFS images with FUSE.</p>
<blockquote>
<div><dl>
<dt><code class="code docutils literal notranslate"><span class="pre">-b</span></code>, <code class="code docutils literal notranslate"><span class="pre">--bind=SRC[:DST]</span></code></dt><dd><p>Bind-mount <code class="code docutils literal notranslate"><span class="pre">SRC</span></code> at guest <code class="code docutils literal notranslate"><span class="pre">DST</span></code>. The default destination if
not specified is to use the same path as the host; i.e., the default is
<code class="code docutils literal notranslate"><span class="pre">--bind=SRC:SRC</span></code>. Can be repeated.</p>
<p>With a read-only image (the default), <code class="code docutils literal notranslate"><span class="pre">DST</span></code> must exist. However, if
<code class="code docutils literal notranslate"><span class="pre">--write</span></code> or <code class="code docutils literal notranslate"><span class="pre">--write-fake</span></code> are given, <code class="code docutils literal notranslate"><span class="pre">DST</span></code> will be
created as an empty directory (possibly with the tmpfs overmount trick
described in <a class="reference internal" href="faq.html#faq-mkdir-ro"><span class="std std-ref">--bind creates mount points within un-writeable directories!</span></a>). In this case, <code class="code docutils literal notranslate"><span class="pre">DST</span></code> must be
entirely within the image itself, i.e., <code class="code docutils literal notranslate"><span class="pre">DST</span></code> cannot enter a
previous bind mount. For example, <code class="code docutils literal notranslate"><span class="pre">--bind</span> <span class="pre">/foo:/tmp/foo</span></code> will fail
because <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> is shared with the host via bind-mount (unless
<code class="code docutils literal notranslate"><span class="pre">$TMPDIR</span></code> is set to something else or <code class="code docutils literal notranslate"><span class="pre">--private-tmp</span></code> is
given).</p>
<p>Most images have ten directories <code class="code docutils literal notranslate"><span class="pre">/mnt/[0-9]</span></code> already available as
mount points.</p>
<p>Symlinks in <code class="code docutils literal notranslate"><span class="pre">DST</span></code> are followed, and absolute links can have
surprising behavior. Bind-mounting happens after namespace setup but
before pivoting into the container image, so absolute links use the host
root. For example, suppose the image has a symlink <code class="code docutils literal notranslate"><span class="pre">/foo</span> <span class="pre">-&gt;</span> <span class="pre">/mnt</span></code>.
Then, <code class="code docutils literal notranslate"><span class="pre">--bind=/bar:/foo</span></code> will bind-mount on the <em>host’s</em>
<code class="code docutils literal notranslate"><span class="pre">/mnt</span></code>, which is inaccessible on the host because namespaces are
already set up and <em>also</em> inaccessible in the container because of the
subsequent pivot into the image. Currently, this problem is only detected
when <code class="code docutils literal notranslate"><span class="pre">DST</span></code> needs to be created: <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> will refuse to follow
absolute symlinks in this case, to avoid directory creation surprises.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-c</span></code>, <code class="code docutils literal notranslate"><span class="pre">--cd=DIR</span></code></dt><dd><p>Initial working directory in container.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--env-no-expand</span></code></dt><dd><p>Don’t expand variables when using <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--feature=FEAT</span></code></dt><dd><p>If feature <code class="code docutils literal notranslate"><span class="pre">FEAT</span></code> is enabled, exit with success. Valid values of
<code class="code docutils literal notranslate"><span class="pre">FEAT</span></code> are <code class="code docutils literal notranslate"><span class="pre">extglob</span></code> for extended globs, <code class="code docutils literal notranslate"><span class="pre">seccomp</span></code> for
<code class="code docutils literal notranslate"><span class="pre">seccomp(2)</span></code>, and <code class="code docutils literal notranslate"><span class="pre">squash</span></code> for squashfs archives.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-g</span></code>, <code class="code docutils literal notranslate"><span class="pre">--gid=GID</span></code></dt><dd><p>Run as group <code class="code docutils literal notranslate"><span class="pre">GID</span></code> within container.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--home</span></code></dt><dd><p>Bind-mount your host home directory (i.e., <code class="code docutils literal notranslate"><span class="pre">$HOME</span></code>) at guest
<code class="code docutils literal notranslate"><span class="pre">/home/$USER</span></code>, hiding any existing image content at that path.
Implies <code class="code docutils literal notranslate"><span class="pre">--write-fake</span></code> so the mount point can be created if needed.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-j</span></code>, <code class="code docutils literal notranslate"><span class="pre">--join</span></code></dt><dd><p>Use the same container (namespaces) as peer <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> invocations.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--join-pid=PID</span></code></dt><dd><p>Join the namespaces of an existing process.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--join-ct=N</span></code></dt><dd><p>Number of <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> peers (implies <code class="code docutils literal notranslate"><span class="pre">--join</span></code>; default: see
below).</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--join-tag=TAG</span></code></dt><dd><p>Label for <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> peer group (implies <code class="code docutils literal notranslate"><span class="pre">--join</span></code>; default: see
below).</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-m</span></code>, <code class="code docutils literal notranslate"><span class="pre">--mount=DIR</span></code></dt><dd><p>Use <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> for the SquashFS mount point, which must already exist. If
not specified, the default is <code class="code docutils literal notranslate"><span class="pre">/var/tmp/$USER.ch/mnt</span></code>, which <em>will</em>
be created if needed.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-passwd</span></code></dt><dd><p>By default, temporary <code class="code docutils literal notranslate"><span class="pre">/etc/passwd</span></code> and <code class="code docutils literal notranslate"><span class="pre">/etc/group</span></code> files are
created according to the UID and GID maps for the container and
bind-mounted into it. If this is specified, no such temporary files are
created and the image’s files are exposed.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-q</span></code>, <code class="code docutils literal notranslate"><span class="pre">--quiet</span></code></dt><dd><p>Be quieter; can be repeated. Incompatible with <code class="code docutils literal notranslate"><span class="pre">-v</span></code>. See the
<a class="reference internal" href="faq.html#faq-verbosity"><span class="std std-ref">How can I control Charliecloud’s quietness or verbosity?</span></a> for details.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-s</span></code>, <code class="code docutils literal notranslate"><span class="pre">--storage</span> <span class="pre">DIR</span></code></dt><dd><p>Set the storage directory. Equivalent to the same option for
<code class="code docutils literal notranslate"><span class="pre">ch-image(1)</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--seccomp</span></code></dt><dd><p>Using seccomp, intercept some system calls that would fail due to lack of
privilege, do nothing, and return fake success to the calling program.
This is intended for use by <code class="code docutils literal notranslate"><span class="pre">ch-image(1)</span></code> when building images; see
that man page for a detailed discussion.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-t</span></code>, <code class="code docutils literal notranslate"><span class="pre">--private-tmp</span></code></dt><dd><p>By default, the host’s <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> (or <code class="code docutils literal notranslate"><span class="pre">$TMPDIR</span></code> if set) is
bind-mounted at container <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code>. If this is specified, a new
<code class="code docutils literal notranslate"><span class="pre">tmpfs</span></code> is mounted on the container’s <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> instead.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--set-env</span></code>, <code class="code docutils literal notranslate"><span class="pre">--set-env=FILE</span></code>, <code class="code docutils literal notranslate"><span class="pre">--set-env=VAR=VALUE</span></code></dt><dd><p>Set environment variables with newline-separated file
(<code class="code docutils literal notranslate"><span class="pre">/ch/environment</span></code> within the image if not specified) or on the
command line. See below for details.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--set-env0</span></code>, <code class="code docutils literal notranslate"><span class="pre">--set-env0=FILE</span></code>, <code class="code docutils literal notranslate"><span class="pre">--set-env0=VAR=VALUE</span></code></dt><dd><p>Like <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code>, but file is null-byte separated.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-u</span></code>, <code class="code docutils literal notranslate"><span class="pre">--uid=UID</span></code></dt><dd><p>Run as user <code class="code docutils literal notranslate"><span class="pre">UID</span></code> within container.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--unsafe</span></code></dt><dd><p>Enable various unsafe behavior. For internal use only. Seriously, stay
away from this option.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--unset-env=GLOB</span></code></dt><dd><p>Unset environment variables whose names match <code class="code docutils literal notranslate"><span class="pre">GLOB</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-v</span></code>, <code class="code docutils literal notranslate"><span class="pre">--verbose</span></code></dt><dd><p>Print extra chatter; can be repeated. See the <a class="reference internal" href="faq.html#faq-verbosity"><span class="std std-ref">FAQ entry on verbosity</span></a> for details.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-w</span></code>, <code class="code docutils literal notranslate"><span class="pre">--write</span></code></dt><dd><p>Mount image read-write. By default, the image is mounted read-only. <em>This
option should be avoided for most use cases,</em> because (1) changing images
live (as opposed to prescriptively with a Dockerfile) destroys their
provenance and (2) SquashFS images, which is the best-practice format on
parallel filesystems, must be read-only. It is better to use
<code class="code docutils literal notranslate"><span class="pre">--write-fake</span></code> (for disposable data) or bind-mount host directories
(for retained data).</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-W</span></code>, <code class="code docutils literal notranslate"><span class="pre">--write-fake[=SIZE]</span></code></dt><dd><p>Overlay a writeable tmpfs on top of the image. This makes the image
<em>appear</em> read-write, but it actually remains read-only and unchanged. All
data “written” to the image are discarded when the container exits.</p>
<p>The size of the writeable filesystem <code class="code docutils literal notranslate"><span class="pre">SIZE</span></code> is any size
specification acceptable to <code class="code docutils literal notranslate"><span class="pre">tmpfs</span></code>, e.g. <code class="code docutils literal notranslate"><span class="pre">4m</span></code> for 4MiB or
<code class="code docutils literal notranslate"><span class="pre">50%</span></code> for half of physical memory. If this option is specified
without <code class="code docutils literal notranslate"><span class="pre">SIZE</span></code>, the default is <code class="code docutils literal notranslate"><span class="pre">12%</span></code>. Note (1) this limit is a
maximum — only actually stored files consume virtual memory — and
(2) <code class="code docutils literal notranslate"><span class="pre">SIZE</span></code> larger than memory can be requested without error (the
failure happens later if the actual contents become too large).</p>
<p>This requires kernel support and there are some caveats. See section
“<a class="reference internal" href="#ch-run-overlay"><span class="std std-ref">Writeable overlay with --write-fake</span></a>” below for details.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-?</span></code>, <code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt><dd><p>Print help and exit.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--usage</span></code></dt><dd><p>Print a short usage message and exit.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-V</span></code>, <code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt><dd><p>Print version and exit.</p>
</dd>
</dl>
</div></blockquote>
<p><strong>Note:</strong> Because <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> is fully unprivileged, it is not possible to
change UIDs and GIDs within the container (the relevant system calls fail). In
particular, setuid, setgid, and setcap executables do not work. As a
precaution, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> calls <code class="code docutils literal notranslate"><span class="pre">prctl(PR_SET_NO_NEW_PRIVS,</span> <span class="pre">1)</span></code> to
<a class="reference external" href="https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt">disable these executables</a> within the
container. This does not reduce functionality but is a “belt and suspenders”
precaution to reduce the attack surface should bugs in these system calls or
elsewhere arise.</p>
</section>
<section id="image-format">
<h2><span class="section-number">8.3. </span>Image format<a class="headerlink" href="#image-format" title="Permalink to this heading">¶</a></h2>
<p><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> supports two different image formats.</p>
<p>The first is a simple directory that contains a Linux filesystem tree. This
can be accomplished by:</p>
<ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> directly from <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> or another builder to a
directory.</p></li>
<li><p>Charliecloud’s tarball workflow: build or pull the image, <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code>
it to a tarball, transfer the tarball to the target system, then
<code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> the tarball to a directory.</p></li>
<li><p>Manually mount a SquashFS image, e.g. with <code class="code docutils literal notranslate"><span class="pre">squashfuse(1)</span></code> and then
un-mount it after run with <code class="code docutils literal notranslate"><span class="pre">fusermount</span> <span class="pre">-u</span></code>.</p></li>
<li><p>Any other workflow that produces an appropriate directory tree.</p></li>
</ul>
<p>The second is a SquashFS image archive mounted internally by <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>,
available if it’s linked with the optional <code class="code docutils literal notranslate"><span class="pre">libsquashfuse_ll</span></code> shared
library. <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> mounts the image filesystem, services all FUSE
requests, and unmounts it, all within <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>. See <code class="code docutils literal notranslate"><span class="pre">--mount</span></code>
above to set the mount point location.</p>
<p>Like other FUSE implementations, Charliecloud calls the <code class="code docutils literal notranslate"><span class="pre">fusermount3(1)</span></code>
utility to mount the SquashFS filesystem. However, <strong>this executable does not
need to be installed setuid root</strong>, and in fact <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> actively
suppresses its setuid bit if set (using <code class="code docutils literal notranslate"><span class="pre">prctl(2)</span></code>).</p>
<p>Prior versions of Charliecloud provided wrappers for the <code class="code docutils literal notranslate"><span class="pre">squashfuse</span></code>
and <code class="code docutils literal notranslate"><span class="pre">squashfuse_ll</span></code> SquashFS mount commands and <code class="code docutils literal notranslate"><span class="pre">fusermount</span> <span class="pre">-u</span></code>
unmount command. We removed these because we concluded they had minimal
value-add over the standard, unwrapped commands.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Currently, Charliecloud unmounts the SquashFS filesystem when user command
<code class="code docutils literal notranslate"><span class="pre">COMMAND</span></code>’s process exits. It does not monitor any of its child
processes. Therefore, if the user command spawns child processes and then
exits before them (e.g., some daemons), those children will have the image
unmounted from underneath them. In this case, the workaround is to
mount/unmount using external tools. We expect to remove this limitation in a
future version.</p>
</div>
</section>
<section id="host-files-and-directories-available-in-container-via-bind-mounts">
<h2><span class="section-number">8.4. </span>Host files and directories available in container via bind mounts<a class="headerlink" href="#host-files-and-directories-available-in-container-via-bind-mounts" title="Permalink to this heading">¶</a></h2>
<p>In addition to any directories specified by the user with <code class="code docutils literal notranslate"><span class="pre">--bind</span></code>,
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> has standard host files and directories that are bind-mounted
in as well.</p>
<p>The following host files and directories are bind-mounted at the same location
in the container. These give access to the host’s devices and various kernel
facilities. (Recall that Charliecloud provides minimal isolation and
containerized processes are mostly normal unprivileged processes.) They cannot
be disabled and are required; i.e., they must exist both on host and within
the image.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">/dev</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">/proc</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">/sys</span></code></p></li>
</ul>
</div></blockquote>
<p>Optional; bind-mounted only if path exists on both host and within the image,
without error or warning if not.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">/etc/hosts</span></code> and <code class="code docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code>. Because Charliecloud
containers share the host network namespace, they need the same hostname
resolution configuration.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">/etc/machine-id</span></code>. Provides a unique ID for the OS installation;
matching the host works for most situations. Needed to support D-Bus, some
software licensing situations, and likely other use cases. See also <a class="reference external" href="https://github.com/hpc/charliecloud/issues/1050">issue
#1050</a>.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">/var/lib/hugetlbfs</span></code> at guest <code class="code docutils literal notranslate"><span class="pre">/var/opt/cray/hugetlbfs</span></code>, and
<code class="code docutils literal notranslate"><span class="pre">/var/opt/cray/alps/spool</span></code>. These support Cray MPI.</p></li>
</ul>
</div></blockquote>
<p>Additional bind mounts done by default but can be disabled; see the options
above.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">$HOME</span></code> at <code class="code docutils literal notranslate"><span class="pre">/home/$USER</span></code> (and image <code class="code docutils literal notranslate"><span class="pre">/home</span></code> is hidden).
Makes user data and init files available.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> (or <code class="code docutils literal notranslate"><span class="pre">$TMPDIR</span></code> if set) at guest <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code>. Provides a
temporary directory that persists between container runs and is shared
with non-containerized application components.</p></li>
<li><p>temporary files at <code class="code docutils literal notranslate"><span class="pre">/etc/passwd</span></code> and <code class="code docutils literal notranslate"><span class="pre">/etc/group</span></code>. Usernames
and group names need to be customized for each container run.</p></li>
</ul>
</div></blockquote>
</section>
<section id="multiple-processes-in-the-same-container-with-join">
<h2><span class="section-number">8.5. </span>Multiple processes in the same container with <code class="code docutils literal notranslate"><span class="pre">--join</span></code><a class="headerlink" href="#multiple-processes-in-the-same-container-with-join" title="Permalink to this heading">¶</a></h2>
<p>By default, different <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> invocations use different user and mount
namespaces (i.e., different containers). While this has no impact on sharing
most resources between invocations, there are a few important exceptions.
These include:</p>
<ol class="arabic simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">ptrace(2)</span></code>, used by debuggers and related tools. One can attach a
debugger to processes in descendant namespaces, but not sibling namespaces.
The practical effect of this is that (without <code class="code docutils literal notranslate"><span class="pre">--join</span></code>), you can’t
run a command with <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> and then attach to it with a debugger
also run with <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>.</p></li>
<li><p><em>Cross-memory attach</em> (CMA) is used by cooperating processes to communicate
by simply reading and writing one another’s memory. This is also not
permitted between sibling namespaces. This affects various MPI
implementations that use CMA to pass messages between ranks on the same
node, because it’s faster than traditional shared memory.</p></li>
</ol>
<p><code class="code docutils literal notranslate"><span class="pre">--join</span></code> is designed to address this by placing related <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>
commands (the “peer group”) in the same container. This is done by one of the
peers creating the namespaces with <code class="code docutils literal notranslate"><span class="pre">unshare(2)</span></code> and the others joining
with <code class="code docutils literal notranslate"><span class="pre">setns(2)</span></code>.</p>
<p>To do so, we need to know the number of peers and a name for the group. These
are specified by additional arguments that can (hopefully) be left at default
values in most cases:</p>
<ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">--join-ct</span></code> sets the number of peers. The default is the value of the
first of the following environment variables that is defined:
<code class="code docutils literal notranslate"><span class="pre">OMPI_COMM_WORLD_LOCAL_SIZE</span></code>, <code class="code docutils literal notranslate"><span class="pre">SLURM_STEP_TASKS_PER_NODE</span></code>,
<code class="code docutils literal notranslate"><span class="pre">SLURM_CPUS_ON_NODE</span></code>.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">--join-tag</span></code> sets the tag that names the peer group. The default is
environment variable <code class="code docutils literal notranslate"><span class="pre">SLURM_STEP_ID</span></code>, if defined; otherwise, the PID
of <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>’s parent. Tags can be re-used for peer groups that start
at different times, i.e., once all peer <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> have replaced
themselves with the user command, the tag can be re-used.</p></li>
</ul>
<p>Caveats:</p>
<ul class="simple">
<li><p>One cannot currently add peers after the fact, for example, if one decides
to start a debugger after the fact. (This is only required for code with
bugs and is thus an unusual use case.)</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> instances race. The winner of this race sets up the
namespaces, and the other peers use the winner to find the namespaces to
join. Therefore, if the user command of the winner exits, any remaining
peers will not be able to join the namespaces, even if they are still
active. There is currently no general way to specify which <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>
should be the winner.</p></li>
<li><p>If <code class="code docutils literal notranslate"><span class="pre">--join-ct</span></code> is too high, the winning <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>’s user command
exits before all peers join, or <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> itself crashes, IPC resources
such as semaphores and shared memory segments will be leaked. These appear
as files in <code class="code docutils literal notranslate"><span class="pre">/dev/shm/</span></code> and can be removed with <code class="code docutils literal notranslate"><span class="pre">rm(1)</span></code>.</p></li>
<li><p>Many of the arguments given to the race losers, such as the image path and
<code class="code docutils literal notranslate"><span class="pre">--bind</span></code>, will be ignored in favor of what was given to the winner.</p></li>
</ul>
</section>
<section id="writeable-overlay-with-write-fake">
<span id="ch-run-overlay"></span><h2><span class="section-number">8.6. </span>Writeable overlay with <code class="code docutils literal notranslate"><span class="pre">--write-fake</span></code><a class="headerlink" href="#writeable-overlay-with-write-fake" title="Permalink to this heading">¶</a></h2>
<p>If you need the image to stay read-only but appear writeable, you may be able
to use <code class="code docutils literal notranslate"><span class="pre">--write-fake</span></code> to overlay a writeable tmpfs atop the image. This
requires kernel support. Specifically:</p>
<ol class="arabic">
<li><p>To use the feature at all, you need unprivileged overlayfs support. This is
available in <a class="reference external" href="https://kernelnewbies.org/Linux_5.11#Unprivileged_Overlayfs_mounts">upstream 5.11</a>
(February 2021), but distributions vary considerably. If you don’t have
this, the container will fail to start with error “operation not
permitted”.</p></li>
<li><p>For a fully functional overlay, you need a tmpfs that supports xattrs in
the <code class="code docutils literal notranslate"><span class="pre">user</span></code> namespace. This is available in <a class="reference external" href="https://kernelnewbies.org/Linux_6.6#TMPFS">upstream 6.6</a> (October 2023). If you don’t
have this, most things will work fine, but some operations will fail with
“I/O error”, for example creating a directory with the same path as a
previously deleted directory. There will also be syslog noise about xattr
problems.</p>
<p>(overlayfs can also use xattrs in the <code class="code docutils literal notranslate"><span class="pre">trusted</span></code> namespace, but this
requires <code class="code docutils literal notranslate"><span class="pre">CAP_SYS_ADMIN</span></code> <a class="reference external" href="https://elixir.bootlin.com/linux/v5.11/source/kernel/capability.c#L447">on the host</a>
and thus is not helpful for unprivileged containers.)</p>
</li>
</ol>
</section>
<section id="environment-variables">
<h2><span class="section-number">8.7. </span>Environment variables<a class="headerlink" href="#environment-variables" title="Permalink to this heading">¶</a></h2>
<p><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> leaves environment variables unchanged, i.e. the host
environment is passed through unaltered, except:</p>
<ul class="simple">
<li><p>by default (<code class="code docutils literal notranslate"><span class="pre">--home</span></code> not specified), <code class="code docutils literal notranslate"><span class="pre">HOME</span></code> is set to
<code class="code docutils literal notranslate"><span class="pre">/root</span></code>, if it exists, and <code class="code docutils literal notranslate"><span class="pre">/</span></code> otherwise.</p></li>
<li><p>limited tweaks to avoid significant guest breakage;</p></li>
<li><p>user-set variables via <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code>;</p></li>
<li><p>user-unset variables via <code class="code docutils literal notranslate"><span class="pre">--unset-env</span></code>; and</p></li>
<li><p>set <code class="code docutils literal notranslate"><span class="pre">CH_RUNNING</span></code>.</p></li>
</ul>
<p>This section describes these features.</p>
<p>The default tweaks happen first, then <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code> and
<code class="code docutils literal notranslate"><span class="pre">--unset-env</span></code> in the order specified on the command line, and then
<code class="code docutils literal notranslate"><span class="pre">CH_RUNNING</span></code>. The two options can be repeated arbitrarily many times,
e.g. to add/remove multiple variable sets or add only some variables in a
file.</p>
<section id="default-behavior">
<h3><span class="section-number">8.7.1. </span>Default behavior<a class="headerlink" href="#default-behavior" title="Permalink to this heading">¶</a></h3>
<p>By default, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> makes the following environment variable changes:</p>
<dl>
<dt><code class="code docutils literal notranslate"><span class="pre">$CH_RUNNING</span></code></dt><dd><p>Set to <code class="code docutils literal notranslate"><span class="pre">Weird</span> <span class="pre">Al</span> <span class="pre">Yankovic</span></code>. While a process can figure out that it’s
in an unprivileged container and what namespaces are active without this
hint, that can be messy, and there is no way to tell that it’s a
<em>Charliecloud</em> container specifically. This variable makes such a test
simple and well-defined. (<strong>Note:</strong> This variable is unaffected by
<code class="code docutils literal notranslate"><span class="pre">--unset-env</span></code>.)</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">$HOME</span></code></dt><dd><p>If <code class="code docutils literal notranslate"><span class="pre">--home</span></code> is specified, then your home directory is bind-mounted
into the guest at <code class="code docutils literal notranslate"><span class="pre">/home/$USER</span></code>. If you also have a different home
directory path on the host, an inherited <code class="code docutils literal notranslate"><span class="pre">$HOME</span></code> will be incorrect
inside the guest, which confuses lots of software, notably Spack. Thus, with
<code class="code docutils literal notranslate"><span class="pre">--home</span></code>, <code class="code docutils literal notranslate"><span class="pre">$HOME</span></code> is set to <code class="code docutils literal notranslate"><span class="pre">/home/$USER</span></code> (by default, it
is unchanged.)</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">$PATH</span></code></dt><dd><p>Newer Linux distributions replace some root-level directories, such as
<code class="code docutils literal notranslate"><span class="pre">/bin</span></code>, with symlinks to their counterparts in <code class="code docutils literal notranslate"><span class="pre">/usr</span></code>.</p>
<p>Some of these distributions (e.g., Fedora 24) have also dropped <code class="code docutils literal notranslate"><span class="pre">/bin</span></code>
from the default <code class="code docutils literal notranslate"><span class="pre">$PATH</span></code>. This is a problem when the guest OS does
<em>not</em> have a merged <code class="code docutils literal notranslate"><span class="pre">/usr</span></code> (e.g., Debian 8 “Jessie”). Thus, we add
<code class="code docutils literal notranslate"><span class="pre">/bin</span></code> to <code class="code docutils literal notranslate"><span class="pre">$PATH</span></code> if it’s not already present.</p>
<p>Further reading:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://www.freedesktop.org/wiki/Software/systemd/TheCaseForTheUsrMerge/">The case for the /usr Merge</a></p></li>
<li><p><a class="reference external" href="https://fedoraproject.org/wiki/Features/UsrMove">Fedora</a></p></li>
<li><p><a class="reference external" href="https://wiki.debian.org/UsrMerge">Debian</a></p></li>
</ul>
</div></blockquote>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">$TMPDIR</span></code></dt><dd><p>Unset, because this is almost certainly a host path, and that host path is
made available in the guest at <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> unless <code class="code docutils literal notranslate"><span class="pre">--private-tmp</span></code> is
given.</p>
</dd>
</dl>
</section>
<section id="setting-variables-with-set-env-or-set-env0">
<h3><span class="section-number">8.7.2. </span>Setting variables with <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code> or <code class="code docutils literal notranslate"><span class="pre">--set-env0</span></code><a class="headerlink" href="#setting-variables-with-set-env-or-set-env0" title="Permalink to this heading">¶</a></h3>
<p>The purpose of these two options is to set environment variables within the
container. Values given replace any already in the environment (i.e.,
inherited from the host shell) or set by earlier uses of the options. These
flags take an optional argument with two possible forms:</p>
<ol class="arabic">
<li><p><strong>If the argument contains an equals sign</strong> (<code class="code docutils literal notranslate"><span class="pre">=</span></code>, ASCII 61), that
sets an environment variable directly. For example, to set <code class="code docutils literal notranslate"><span class="pre">FOO</span></code> to
the string value <code class="code docutils literal notranslate"><span class="pre">bar</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span>--set-env<span class="o">=</span><span class="nv">FOO</span><span class="o">=</span>bar<span class="w"> </span>...
</pre></div>
</div>
<p>Single straight quotes around the value (<code class="code docutils literal notranslate"><span class="pre">'</span></code>, ASCII 39) are stripped,
though be aware that both single and double quotes are also interpreted by
the shell. For example, this example is similar to the prior one; the
double quotes are removed by the shell and the single quotes are removed by
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span>--set-env<span class="o">=</span><span class="s2">&quot;&#39;BAZ=qux&#39;&quot;</span><span class="w"> </span>...
</pre></div>
</div>
</li>
<li><p><strong>If the argument does not contain an equals sign</strong>, it is a host path to a
file containing zero or more variables using the same syntax as above
(except with no prior shell processing).</p>
<p>With <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code>, this file contains a sequence of assignments
separated by newline (<code class="code docutils literal notranslate"><span class="pre">n</span></code> or ASCII 10); with <code class="code docutils literal notranslate"><span class="pre">--set-env0</span></code>, the
assignments are separated by the null byte (i.e., <code class="code docutils literal notranslate"><span class="pre">0</span></code> or ASCII 0).
Empty assignments are ignored, and no comments are interpreted. (This
syntax is designed to accept the output of <code class="code docutils literal notranslate"><span class="pre">printenv</span></code> and be easily
produced by other simple mechanisms.) The file need not be seekable.</p>
<p>For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>/tmp/env.txt
<span class="go">FOO=bar</span>
<span class="go">BAZ=&#39;qux&#39;</span>
<span class="gp">$ </span>ch-run<span class="w"> </span>--set-env<span class="o">=</span>/tmp/env.txt<span class="w"> </span>...
</pre></div>
</div>
<p>For directory images only (because the file is read before containerizing),
guest paths can be given by prepending the image path.</p>
</li>
<li><p><strong>If there is no argument</strong>, the file <code class="code docutils literal notranslate"><span class="pre">/ch/environment</span></code> within the
image is used. This file is commonly populated by <code class="code docutils literal notranslate"><span class="pre">ENV</span></code> instructions
in the Dockerfile. For example, equivalently to form 2:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>Dockerfile
<span class="go">[...]</span>
<span class="go">ENV FOO=bar</span>
<span class="go">ENV BAZ=qux</span>
<span class="go">[...]</span>
<span class="gp">$ </span>ch-image<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>foo<span class="w"> </span>.
<span class="gp">$ </span>ch-convert<span class="w"> </span>foo<span class="w"> </span>/var/tmp/foo.sqfs
<span class="gp">$ </span>ch-run<span class="w"> </span>--set-env<span class="w"> </span>/var/tmp/foo.sqfs<span class="w"> </span>--<span class="w"> </span>...
</pre></div>
</div>
<p>(Note the image path is interpreted correctly, not as the <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code>
argument.)</p>
<p>At present, there is no way to use files other than <code class="code docutils literal notranslate"><span class="pre">/ch/environment</span></code>
within SquashFS images.</p>
</li>
</ol>
<p>Environment variables are expanded for values that look like search paths,
unless <code class="code docutils literal notranslate"><span class="pre">--env-no-expand</span></code> is given prior to <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code>. In this
case, the value is a sequence of zero or more possibly-empty items separated
by colon (<code class="code docutils literal notranslate"><span class="pre">:</span></code>, ASCII 58). If an item begins with dollar sign (<code class="code docutils literal notranslate"><span class="pre">$</span></code>,
ASCII 36), then the rest of the item is the name of an environment variable.
If this variable is set to a non-empty value, that value is substituted for
the item; otherwise (i.e., the variable is unset or the empty string), the
item is deleted, including a delimiter colon. The purpose of omitting empty
expansions is to avoid surprising behavior such as an empty element in
<code class="code docutils literal notranslate"><span class="pre">$PATH</span></code> meaning <a class="reference external" href="https://devdocs.io/bash/bourne-shell-variables#PATH">the current directory</a>.</p>
<p>For example, to set <code class="code docutils literal notranslate"><span class="pre">HOSTPATH</span></code> to the search path in the current shell
(this is expanded by <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>, though letting the shell do it happens to
be equivalent):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span>--set-env<span class="o">=</span><span class="s1">&#39;HOSTPATH=$PATH&#39;</span><span class="w"> </span>...
</pre></div>
</div>
<p>To prepend <code class="code docutils literal notranslate"><span class="pre">/opt/bin</span></code> to this current search path:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span>--set-env<span class="o">=</span><span class="s1">&#39;PATH=/opt/bin:$PATH&#39;</span><span class="w"> </span>...
</pre></div>
</div>
<p>To prepend <code class="code docutils literal notranslate"><span class="pre">/opt/bin</span></code> to the search path set by the Dockerfile, as
retrieved from guest file <code class="code docutils literal notranslate"><span class="pre">/ch/environment</span></code> (here we really cannot let
the shell expand <code class="code docutils literal notranslate"><span class="pre">$PATH</span></code>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span>--set-env<span class="w"> </span>--set-env<span class="o">=</span><span class="s1">&#39;PATH=/opt/bin:$PATH&#39;</span><span class="w"> </span>...
</pre></div>
</div>
<p>Examples of valid assignment, assuming that environment variable <code class="code docutils literal notranslate"><span class="pre">BAR</span></code>
is set to <code class="code docutils literal notranslate"><span class="pre">bar</span></code> and <code class="code docutils literal notranslate"><span class="pre">UNSET</span></code> is unset or set to the empty string:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Assignment</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=bar</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bar</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=bar=baz</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bar=baz</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FLAGS=-march=foo</span> <span class="pre">-mtune=bar</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FLAGS</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">-march=foo</span> <span class="pre">-mtune=bar</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">FLAGS='-march=foo</span> <span class="pre">-mtune=bar'</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FLAGS</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">-march=foo</span> <span class="pre">-mtune=bar</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=$BAR</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bar</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=$BAR:baz</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bar:baz</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p>empty string</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=$UNSET</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p>empty string</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=baz:$UNSET:qux</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">baz:qux</span></code> (not <code class="code docutils literal notranslate"><span class="pre">baz::qux</span></code>)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=:bar:baz::</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">:bar:baz::</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=''</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p>empty string</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=''''</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">''</span></code> (two single quotes)</p></td>
</tr>
</tbody>
</table>
<p>Example invalid assignments:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Assignment</p></th>
<th class="head"><p>Problem</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span> <span class="pre">bar</span></code></p></td>
<td><p>no equals separator</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">=bar</span></code></p></td>
<td><p>name cannot be empty</p></td>
</tr>
</tbody>
</table>
<p>Example valid assignments that are probably not what you want:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Assignment</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Problem</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=&quot;bar&quot;</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">&quot;bar&quot;</span></code></p></td>
<td><p>double quotes aren’t stripped</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=bar</span> <span class="pre">#</span> <span class="pre">baz</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bar</span> <span class="pre">#</span> <span class="pre">baz</span></code></p></td>
<td><p>comments not supported</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=bartbaz</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bartbaz</span></code></p></td>
<td><p>backslashes are not special</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">​</span> <span class="pre">FOO=bar</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">​</span> <span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bar</span></code></p></td>
<td><p>leading space in key</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=</span> <span class="pre">bar</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">​</span> <span class="pre">bar</span></code></p></td>
<td><p>leading space in value</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">$FOO=bar</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">$FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bar</span></code></p></td>
<td><p>variables not expanded in key</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=$BAR</span> <span class="pre">baz:qux</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">qux</span></code></p></td>
<td><p>variable <code class="code docutils literal notranslate"><span class="pre">BAR</span> <span class="pre">baz</span></code> not set</p></td>
</tr>
</tbody>
</table>
</section>
<section id="removing-variables-with-unset-env">
<h3><span class="section-number">8.7.3. </span>Removing variables with <code class="code docutils literal notranslate"><span class="pre">--unset-env</span></code><a class="headerlink" href="#removing-variables-with-unset-env" title="Permalink to this heading">¶</a></h3>
<p>The purpose of <code class="code docutils literal notranslate"><span class="pre">--unset-env=GLOB</span></code> is to remove unwanted environment
variables. The argument <code class="code docutils literal notranslate"><span class="pre">GLOB</span></code> is a glob pattern (<a class="reference external" href="http://man7.org/linux/man-pages/man3/fnmatch.3.html">dialect</a> <code class="code docutils literal notranslate"><span class="pre">fnmatch(3)</span></code>
with the <code class="code docutils literal notranslate"><span class="pre">FNM_EXTMATCH</span></code> flag where supported); all variables with
matching names are removed from the environment.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Because the shell also interprets glob patterns, if any wildcard characters
are in <code class="code docutils literal notranslate"><span class="pre">GLOB</span></code>, it is important to put it in single quotes to avoid
surprises.</p>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">GLOB</span></code> must be a non-empty string.</p>
<p>Example 1: Remove the single environment variable <code class="code docutils literal notranslate"><span class="pre">FOO</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">FOO</span><span class="o">=</span>bar
<span class="gp">$ </span>env<span class="w"> </span><span class="p">|</span><span class="w"> </span>fgrep<span class="w"> </span>FOO
<span class="go">FOO=bar</span>
<span class="gp">$ </span>ch-run<span class="w"> </span>--unset-env<span class="o">=</span>FOO<span class="w"> </span><span class="nv">$CH_TEST_IMGDIR</span>/chtest<span class="w"> </span>--<span class="w"> </span>env<span class="w"> </span><span class="p">|</span><span class="w"> </span>fgrep<span class="w"> </span>FOO
<span class="gp">$</span>
</pre></div>
</div>
<p>Example 2: Hide from a container the fact that it’s running in a Slurm
allocation, by removing all variables beginning with <code class="code docutils literal notranslate"><span class="pre">SLURM</span></code>. You might
want to do this to test an MPI program with one rank and no launcher:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>salloc<span class="w"> </span>-N1
<span class="gp">$ </span>env<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span><span class="s1">&#39;^SLURM&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>wc
<span class="go">   44      44    1092</span>
<span class="gp">$ </span>ch-run<span class="w"> </span><span class="nv">$CH_TEST_IMGDIR</span>/mpihello-openmpi<span class="w"> </span>--<span class="w"> </span>/hello/hello
<span class="go">[... long error message ...]</span>
<span class="gp">$ </span>ch-run<span class="w"> </span>--unset-env<span class="o">=</span><span class="s1">&#39;SLURM*&#39;</span><span class="w"> </span><span class="nv">$CH_TEST_IMGDIR</span>/mpihello-openmpi<span class="w"> </span>--<span class="w"> </span>/hello/hello
<span class="go">0: MPI version:</span>
<span class="go">Open MPI v3.1.3, package: Open MPI root@c897a83f6f92 Distribution, ident: 3.1.3, repo rev: v3.1.3, Oct 29, 2018</span>
<span class="go">0: init ok cn001.localdomain, 1 ranks, userns 4026532530</span>
<span class="go">0: send/receive ok</span>
<span class="go">0: finalize ok</span>
</pre></div>
</div>
<p>Example 3: Clear the environment completely (remove all variables):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span>--unset-env<span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="nv">$CH_TEST_IMGDIR</span>/chtest<span class="w"> </span>--<span class="w"> </span>env
<span class="gp">$</span>
</pre></div>
</div>
<p>Example 4: Remove all environment variables <em>except</em> for those prefixed with
either <code class="code docutils literal notranslate"><span class="pre">WANTED_</span></code> or <code class="code docutils literal notranslate"><span class="pre">ALSO_WANTED_</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">WANTED_1</span><span class="o">=</span>yes
<span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">ALSO_WANTED_2</span><span class="o">=</span>yes
<span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">NOT_WANTED_1</span><span class="o">=</span>no
<span class="gp">$ </span>ch-run<span class="w"> </span>--unset-env<span class="o">=</span><span class="s1">&#39;!(WANTED_*|ALSO_WANTED_*)&#39;</span><span class="w"> </span><span class="nv">$CH_TEST_IMGDIR</span>/chtest<span class="w"> </span>--<span class="w"> </span>env
<span class="go">WANTED_1=yes</span>
<span class="go">ALSO_WANTED_2=yes</span>
<span class="gp">$</span>
</pre></div>
</div>
<p>Note that some programs, such as shells, set some environment variables even
if started with no init files:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span>--unset-env<span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="nv">$CH_TEST_IMGDIR</span>/debian_9ch<span class="w"> </span>--<span class="w"> </span>bash<span class="w"> </span>--noprofile<span class="w"> </span>--norc<span class="w"> </span>-c<span class="w"> </span>env
<span class="go">SHLVL=1</span>
<span class="go">PWD=/</span>
<span class="go">_=/usr/bin/env</span>
<span class="gp">$</span>
</pre></div>
</div>
</section>
</section>
<section id="examples">
<h2><span class="section-number">8.8. </span>Examples<a class="headerlink" href="#examples" title="Permalink to this heading">¶</a></h2>
<p>Run the command <code class="code docutils literal notranslate"><span class="pre">echo</span> <span class="pre">hello</span></code> inside a Charliecloud container using the
unpacked image at <code class="code docutils literal notranslate"><span class="pre">/data/foo</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-run<span class="w"> </span>/data/foo<span class="w"> </span>--<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>hello
<span class="go">hello</span>
</pre></div>
</div>
<p>Run an MPI job that can use CMA to communicate:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>srun<span class="w"> </span>ch-run<span class="w"> </span>--join<span class="w"> </span>/data/foo<span class="w"> </span>--<span class="w"> </span>bar
</pre></div>
</div>
</section>
<section id="syslog">
<h2><span class="section-number">8.9. </span>Syslog<a class="headerlink" href="#syslog" title="Permalink to this heading">¶</a></h2>
<p>By default, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> logs its command line to <a class="reference external" href="https://en.wikipedia.org/wiki/Syslog">syslog</a>. (This can be disabled by configuring
with <code class="code docutils literal notranslate"><span class="pre">--disable-syslog</span></code>.) This includes: (1) the invoking real UID, (2)
the number of command line arguments, and (3) the arguments, separated by
spaces. For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Dec 10 18:19:08 mybox ch-run: uid=1000 args=7: ch-run -v /var/tmp/00_tiny -- echo hello &quot;wor l}\$d&quot;</span>
</pre></div>
</div>
<p>Logging is one of the first things done during program initialization, even
before command line parsing. That is, almost all command lines are logged,
even if erroneous, and there is no logging of program success or failure.</p>
<p>Arguments are serialized with the following procedure. The purpose is to
provide a human-readable reconstruction of the command line while also
allowing each argument to be recovered byte-for-byte.</p>
<blockquote>
<div><ul class="simple">
<li><p>If an argument contains only printable ASCII bytes that are not
whitespace, shell metacharacters, double quote (<code class="code docutils literal notranslate"><span class="pre">&quot;</span></code>, ASCII 34
decimal), or backslash (<code class="code docutils literal notranslate"><span class="pre">​</span></code>, ASCII 92), then log it unchanged.</p></li>
<li><p>Otherwise, (a) enclose the argument in double quotes and
(b) backslash-escape double quotes, backslashes, and characters
interpreted by Bash (including POSIX shells) within double quotes.</p></li>
</ul>
</div></blockquote>
<p>The verbatim command line typed in the shell cannot be recovered, because not
enough information is provided to UNIX programs. For example,
<code class="code docutils literal notranslate"><span class="pre">echo  'foo'</span></code> is given to programs as a sequence of two arguments,
<code class="code docutils literal notranslate"><span class="pre">echo</span></code> and <code class="code docutils literal notranslate"><span class="pre">foo</span></code>; the two spaces and single quotes are removed by
the shell. The zero byte, ASCII NUL, cannot appear in arguments because it
would terminate the string.</p>
</section>
<section id="exit-status">
<h2><span class="section-number">8.10. </span>Exit status<a class="headerlink" href="#exit-status" title="Permalink to this heading">¶</a></h2>
<p>If there is an error during containerization, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> exits with status
non-zero. If the user command is started successfully, the exit status is that
of the user command, with one exception: if the image is an internally mounted
SquashFS filesystem and the user command is killed by a signal, the exit
status is 1 regardless of the signal value.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ch-image.html" class="btn btn-neutral float-left" title="7. ch-image" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="ch-run-oci.html" class="btn btn-neutral float-right" title="9. ch-run-oci" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2014–2023, Triad National Security, LLC and others.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
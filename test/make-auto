#!/usr/bin/env python

# If environment variable CH_TEST_OMIT is set, then avoid Dockerfiles that
# seem lengthy. This supports job time limits in Travis CI. See source code
# below for the heuristic.

from __future__ import print_function

import os
import os.path
import sys

mode = sys.argv[1]

print("""\
# Do not edit this file; it's autogenerated.

load common
""")

for path in sys.argv[2:]:
   (d, f) = os.path.split(path)
   if (f == 'Dockerfile'):
      tag = os.path.basename(d)         # enclosing directory
   else:
      tag = os.path.splitext(f)[1][1:]  # extension

   try:
      if (os.environ["CH_TEST_OMIT"] in tag):
         continue
   except KeyError:
      pass

   if (mode == "build"):
      print("""\

@test 'docker-build %(tag)s' {
    docker-build -t %(tag)s --file=%(path)s ..
    docker_ok %(tag)s
}

@test 'ch-docker2tar %(tag)s' {
    TARBALL=$TARDIR/%(tag)s.tar.gz
    ch-docker2tar %(tag)s $TARDIR
    tarball_ok $TARBALL
}
""" % locals())

   if (mode == "run"):
      print("""\

@test 'ch-tar2dir %(tag)s' {
    TARBALL=$TARDIR/%(tag)s.tar.gz
    IMG=$IMGDIR/%(tag)s
    if [[ -d $IMG && -f $IMG/WEIRD_AL_YANKOVIC ]]; then
        # image exists, remove so we can test new unpack
        rm -Rf $IMG
    fi
    ch-tar2dir $TARBALL $IMG  # new unpack
    image_ok $IMG
    ch-tar2dir $TARBALL $IMG  # overwrite
    image_ok $IMG
}

@test 'ch-run %(tag)s /bin/true' {
    IMG=$IMGDIR/%(tag)s
    ch-run $IMG /bin/true
}

""" % locals())

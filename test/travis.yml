dist: xenial
sudo: required
language: c
compiler: gcc

# This defines a "matrix" of jobs. Each combination of environment variables
# defines a different job. They run in parallel, five at a time. We have
# divided the matrix into "stages"; if any stage has a failure, testing stops
# and the remaining stages are skipped. Note that some stages are conditional.
#
# We do not do any full-scope tests, because they give a >10-minute gap in
# output, so Travis times out.
#
# FIXME: Each job starts with a cold Docker cache, which wastes work heating
# it up in parallel. It would be nice if "make test-build" could be done
# serially before splitting into parallel jobs.
#
#   TARBALL=              # build in Git checkout & use embedded Bats
#   TARBALL=archive       # build from "git archive" tarball & use system Bats
#   TARBALL=export        # build from "make export" tarball & use system Bats
#   TARBALL=export-bats   # build from "make export" tarball & use embedded Bats
#   INSTALL=              # run from build directory
#   INSTALL=yes           # make install to /usr/local, run that one
#
# Additional options:
#
#   CH_BUILDER              # which builder to use
#   MINIMAL_DEPS            # test with minimal dependencies (no fancy tools)
#   SUDO_RM_FIRST           # remove sudo before build (implied if non-Docker)
#   SUDO_RM_AFTER_BUILD     # remove sudo after build
#   SUDO_AVOID_AFTER_BUILD  # set CH_TEST_DONT_SUDO after build
#
stages:
  - quick
  - builders
  - install
  - misc
jobs:
  include:
    - stage: quick
      env:
        - CH_BUILDER=docker CH_TEST_SCOPE=quick
    - stage: builders
      env:
        - CH_BUILDER=buildah-runc
        - CH_BUILDER=buildah-setuid
        - CH_BUILDER=ch-grow
        - CH_BUILDER=docker
    - stage: install
      if: branch = master OR type = pull_request
      env:
        - CH_BUILDER=buildah-runc    TARBALL=export       INSTALL=yes
        - CH_BUILDER=buildah-setuid  TARBALL=export       INSTALL=yes
        - CH_BUILDER=ch-grow         TARBALL=export       INSTALL=yes
        - CH_BUILDER=docker          TARBALL=export       INSTALL=yes
        - CH_BUILDER=docker          TARBALL=export-bats  INSTALL=yes
    - stage: misc
      if: branch = master OR type = pull_request
      env:
        - CH_BUILDER=buildah-setuid  MINIMAL_DEPS=yes
        - CH_BUILDER=ch-grow         MINIMAL_DEPS=yes
        - CH_BUILDER=docker          MINIMAL_DEPS=yes
        - CH_BUILDER=docker          SUDO_RM_AFTER_BUILD=yes
        - CH_BUILDER=docker          SUDO_AVOID_AFTER_BUILD=yes

addons:
  apt:
    sources:
      - sourceline: 'ppa:projectatomic/ppa'
    packages:
      - python3-pip
      - python3-setuptools

install:
  - echo $SHELL
  - set -ex
  - . test/travis-install.bash  # source b/c we're setting variables

before_script:
  - set -ex
  - . test/travis-before.bash

script:
  - test/travis.bash

after_script:
  - free -m
  - df -h

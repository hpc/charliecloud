#!/bin/bash
# ch-test-scope: quick

# Build and test an image directory using ch-build2dir.

set -e

srcdir="$1"
tarball_gz="${2}.tar.gz"
workdir="$3"

tag='build2dir'

cd "$srcdir"

if ( ! command -v docker &> /dev/null); then
    echo 'docker not found' 1>&2
    exit 65
fi

ch-build2dir -t "$tag" --file=Dockerfile.alpine36 "$srcdir" "$workdir"

# Validate image artifact
ch-run "${workdir}/${tag}" -- /bin/true

# FIXME: the tarball artifact is validated by proxy, i.e., the image shouldn't
# be able run if the tarball is corrupt. Furthermore, in the event that the 
# tarball is corrupt and ch-run /bin/true still managed to succeed, make-auto
# doesn't add any mechanisms that would address this.

# Required by make-auto
mv "${workdir}/${tag}.tar.gz" "$tarball_gz"

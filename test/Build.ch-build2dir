#!/bin/bash
# ch-test-scope: standard

# Generate image directory using ch-build2dir and stage it for testing.

set -e

srcdir=$1
tarball_gz="${2}.tar.gz"
workdir=$3

tag='build2dir'

cd "$srcdir"

if ( ! command -v docker &> /dev/null); then
    echo 'docker not found' 1>&2
    exit 65
fi

ch-build2dir -t "$tag" --file=Dockerfile.alpine39 "$srcdir" "$workdir"

cd "${workdir}/${tag}"
tar czf "../${tag}.tar.gz" *
mv "${workdir}/${tag}.tar.gz" "$tarball_gz"

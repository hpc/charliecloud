<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>6. ch-fromhost &mdash; Charliecloud 0.39~pre+a1fe557 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="7. ch-image" href="ch-image.html" />
    <link rel="prev" title="5. ch-convert" href="ch-convert.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Charliecloud
              <img src="_static/logo-sidebar.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.39~pre+a1fe557
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">1. Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">2. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-checkns.html">3. <code class="code docutils literal notranslate"><span class="pre">ch-checkns</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-completion.bash.html">4. <code class="code docutils literal notranslate"><span class="pre">ch-completion.bash</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-convert.html">5. <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code></a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">6. <code class="code docutils literal notranslate"><span class="pre">ch-fromhost</span></code></a><ul>
<li class="toctree-l2"><a class="reference internal" href="#synopsis">6.1. Synopsis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#description">6.2. Description</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#arbitrary-files">6.2.1. Arbitrary files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#libfabric">6.2.2. Libfabric</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#options">6.3. Options</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#to-specify-which-files-to-inject">6.3.1. To specify which files to inject</a></li>
<li class="toctree-l3"><a class="reference internal" href="#to-specify-the-destination-within-the-image">6.3.2. To specify the destination within the image</a></li>
<li class="toctree-l3"><a class="reference internal" href="#additional-arguments">6.3.3. Additional arguments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#when-to-use-ch-fromhost">6.4. When to use <code class="code docutils literal notranslate"><span class="pre">ch-fromhost</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#libfabric-usage-and-quirks">6.5. Libfabric usage and quirks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#notes">6.6. Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bugs">6.7. Bugs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#examples">6.8. Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">6.8.1. libfabric</a></li>
<li class="toctree-l3"><a class="reference internal" href="#arbitrary">6.8.2. Arbitrary</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#acknowledgements">6.9. Acknowledgements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ch-image.html">7. <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-run.html">8. <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-run-oci.html">9. <code class="code docutils literal notranslate"><span class="pre">ch-run-oci</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-test.html">10. <code class="code docutils literal notranslate"><span class="pre">ch-test</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">11. Frequently asked questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="best_practices.html">12. Best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev.html">13. Contributor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Charliecloud</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">6. </span><code class="code docutils literal notranslate"><span class="pre">ch-fromhost</span></code></li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ch-fromhost">
<h1><span class="section-number">6. </span><code class="code docutils literal notranslate"><span class="pre">ch-fromhost</span></code><a class="headerlink" href="#ch-fromhost" title="Permalink to this heading">¶</a></h1>
<p>Inject files from the host into an image directory, with various magic.</p>
<section id="synopsis">
<h2><span class="section-number">6.1. </span>Synopsis<a class="headerlink" href="#synopsis" title="Permalink to this heading">¶</a></h2>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-fromhost<span class="w"> </span><span class="o">[</span>OPTION<span class="w"> </span>...<span class="o">]</span><span class="w"> </span><span class="o">[</span>FILE_OPTION<span class="w"> </span>...<span class="o">]</span><span class="w"> </span>IMGDIR
</pre></div>
</div>
</section>
<section id="description">
<h2><span class="section-number">6.2. </span>Description<a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This command is experimental. Features may be incomplete and/or buggy.
Please report any issues you find, so we can fix them!</p>
</div>
<p>Inject files from the host into the Charliecloud image directory
<code class="code docutils literal notranslate"><span class="pre">IMGDIR</span></code>.</p>
<p>The purpose of this command is to inject arbitrary host files into a container
necessary to access host specific resources; usually GPU or proprietary
interconnects. <strong>It is not a general copy-to-image tool</strong>; see further
discussion on use cases below.</p>
<p>It should be run after:code:<cite>ch-convert</cite> and before <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>. After
invocation, the image is no longer portable to other hosts.</p>
<p>Injection is not atomic; if an error occurs partway through injection, the
image is left in an undefined state and should be re-unpacked from storage.
Injection is currently implemented using a simple file copy, but that may
change in the future.</p>
<p>Arbitrary file and libfabric injection are handled differently.</p>
<section id="arbitrary-files">
<h3><span class="section-number">6.2.1. </span>Arbitrary files<a class="headerlink" href="#arbitrary-files" title="Permalink to this heading">¶</a></h3>
<p>Arbitrary file paths that contain the strings <code class="code docutils literal notranslate"><span class="pre">/bin</span></code> or
<code class="code docutils literal notranslate"><span class="pre">/sbin</span></code> are assumed to be executables and placed in <code class="code docutils literal notranslate"><span class="pre">/usr/bin</span></code>
within the container. Paths that are not loadable libfabric providers and
contain the strings <code class="code docutils literal notranslate"><span class="pre">/lib</span></code> or <code class="code docutils literal notranslate"><span class="pre">.so</span></code> are assumed to be shared
libraries and are placed in the first-priority directory reported by
<code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code> (see <code class="code docutils literal notranslate"><span class="pre">--lib-path</span></code> below). Other files are placed in the
directory specified by <code class="code docutils literal notranslate"><span class="pre">--dest</span></code>.</p>
<p>If any shared libraries are injected, run <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code> inside the
container (using <code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">-w</span></code>) after injection.</p>
</section>
<section id="libfabric">
<h3><span class="section-number">6.2.2. </span>Libfabric<a class="headerlink" href="#libfabric" title="Permalink to this heading">¶</a></h3>
<p>MPI implementations have numerous ways of communicating messages over
interconnects. We use libfabric (OFI), an OpenFabric framework that
exports fabric communication services to applications, to manage these
communications with built-in, or loadable, fabric providers.</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://ofiwg.github.io/libfabric">https://ofiwg.github.io/libfabric</a></p></li>
<li><p><a class="reference external" href="https://ofiwg.github.io/libfabric/v1.14.0/man/fi_provider.3.html">https://ofiwg.github.io/libfabric/v1.14.0/man/fi_provider.3.html</a></p></li>
</ul>
</div></blockquote>
<p>Using OFI, we can (a) uniformly manage fabric communication services for both
OpenMPI and MPICH, and (b) use simplified methods of accessing proprietary host
hardware, e.g., Cray’s Gemini/Aries and Slingshot (CXI).</p>
<p>OFI providers implement the application facing software interfaces needed to
access network specific protocols, drivers, and hardware. Loadable providers,
i.e., compiled OFI libraries that end in <code class="code docutils literal notranslate"><span class="pre">-fi.so</span></code>, for example, Cray’s
<code class="code docutils literal notranslate"><span class="pre">libgnix-fi.so</span></code>, can be copied into, and used, by an image with a MPI
configured against OFI. Alternatively, the image’s <code class="code docutils literal notranslate"><span class="pre">libfabric.so</span></code> can
be overwritten with the host’s. See details and quirks below.</p>
</section>
</section>
<section id="options">
<h2><span class="section-number">6.3. </span>Options<a class="headerlink" href="#options" title="Permalink to this heading">¶</a></h2>
<section id="to-specify-which-files-to-inject">
<h3><span class="section-number">6.3.1. </span>To specify which files to inject<a class="headerlink" href="#to-specify-which-files-to-inject" title="Permalink to this heading">¶</a></h3>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">-c</span></code>, <code class="code docutils literal notranslate"><span class="pre">--cmd</span> <span class="pre">CMD</span></code></dt><dd><p>Inject files listed in the standard output of command <code class="code docutils literal notranslate"><span class="pre">CMD</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-f</span></code>, <code class="code docutils literal notranslate"><span class="pre">--file</span> <span class="pre">FILE</span></code></dt><dd><p>Inject files listed in the file <code class="code docutils literal notranslate"><span class="pre">FILE</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-p</span></code>, <code class="code docutils literal notranslate"><span class="pre">--path</span> <span class="pre">PATH</span></code></dt><dd><p>Inject the file at <code class="code docutils literal notranslate"><span class="pre">PATH</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--cray-cxi</span></code></dt><dd><p>Inject cray-libfabric for slingshot. This is equivalent to
<code class="code docutils literal notranslate"><span class="pre">--path</span> <span class="pre">$CH_FROMHOST_OFI_CXI</span></code>, where <code class="code docutils literal notranslate"><span class="pre">$CH_FROMHOST_OFI_CXI</span></code> is
the path the Cray host libfabric <code class="code docutils literal notranslate"><span class="pre">libfabric.so</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--cray-gni</span></code></dt><dd><p>Inject cray gemini/aries GNI libfabric provider <code class="code docutils literal notranslate"><span class="pre">libgnix-fi.so</span></code>. This
is equivalent to <code class="code docutils literal notranslate"><span class="pre">--fi-provider</span> <span class="pre">$CH_FROMHOST_OFI_GNI</span></code>, where
<code class="code docutils literal notranslate"><span class="pre">CH_FROMHOST_OFI_GNI</span></code> is the path to the Cray host ugni provider
<code class="code docutils literal notranslate"><span class="pre">libgnix-fi.so</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--nvidia</span></code></dt><dd><p>Use <code class="code docutils literal notranslate"><span class="pre">nvidia-container-cli</span> <span class="pre">list</span></code> (from <code class="code docutils literal notranslate"><span class="pre">libnvidia-container</span></code>)
to find executables and libraries to inject.</p>
</dd>
</dl>
</div></blockquote>
<p>These can be repeated, and at least one must be specified.</p>
</section>
<section id="to-specify-the-destination-within-the-image">
<h3><span class="section-number">6.3.2. </span>To specify the destination within the image<a class="headerlink" href="#to-specify-the-destination-within-the-image" title="Permalink to this heading">¶</a></h3>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">-d</span></code>, <code class="code docutils literal notranslate"><span class="pre">--dest</span> <span class="pre">DST</span></code></dt><dd><p>Place files specified later in directory <code class="code docutils literal notranslate"><span class="pre">IMGDIR/DST</span></code>, overriding the
inferred destination, if any. If a file’s destination cannot be inferred
and <code class="code docutils literal notranslate"><span class="pre">--dest</span></code> has not been specified, exit with an error. This can be
repeated to place files in varying destinations.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="additional-arguments">
<h3><span class="section-number">6.3.3. </span>Additional arguments<a class="headerlink" href="#additional-arguments" title="Permalink to this heading">¶</a></h3>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">--print-cray-fi</span></code></dt><dd><p>Print inferred destination for libfabric replacement.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--print-fi</span></code></dt><dd><p>Print the guest destination path for libfabric provider(s).</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--print-lib</span></code></dt><dd><p>Print the guest destination path for shared libraries inferred as
described above.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-ldconfig</span></code></dt><dd><p>Don’t run <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code> even if we appear to have injected shared
libraries.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-h</span></code>, <code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt><dd><p>Print help and exit.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-v</span></code>, <code class="code docutils literal notranslate"><span class="pre">--verbose</span></code></dt><dd><p>Be more verbose about what is going on. Can be repeated.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt><dd><p>Print version and exit.</p>
</dd>
</dl>
</div></blockquote>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code> often prints scary-looking warnings on stderr even
everything is going well. By default, we suppress these, but you can see
them with sufficient verbosity. For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-fromhost<span class="w"> </span>--print-lib<span class="w"> </span>/var/tmp/bullseye
<span class="go">/usr/local/lib</span>
<span class="gp">$ </span>ch-fromhost<span class="w"> </span>-v<span class="w"> </span>--print-lib<span class="w"> </span>/var/tmp/bullseye
<span class="go">asking ldconfig for inferred shared library destination</span>
<span class="go">inferred shared library destination: /var/tmp/bullseye//usr/local/lib</span>
<span class="go">/usr/local/lib</span>
<span class="gp">$ </span>ch-fromhost<span class="w"> </span>-v<span class="w"> </span>-v<span class="w"> </span>--print-lib<span class="w"> </span>/var/tmp/bullseye
<span class="go">asking ldconfig for inferred shared library destination</span>
<span class="go">/sbin/ldconfig: Can&#39;t stat /usr/local/lib/x86_64-linux-gnu: No such file or directory</span>
<span class="go">/sbin/ldconfig: Path `/lib/x86_64-linux-gnu&#39; given more than once</span>
<span class="go">/sbin/ldconfig: Path `/usr/lib/x86_64-linux-gnu&#39; given more than once</span>
<span class="go">/sbin/ldconfig: /lib/x86_64-linux-gnu/ld-2.31.so is the dynamic linker, ignoring</span>
<span class="go">inferred shared library destination: /var/tmp/bullseye//usr/local/lib</span>
<span class="go">/usr/local/lib</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://github.com/hpc/charliecloud/issues/732">issue #732</a> for an
example of how this was confusing for users.</p>
</div>
</section>
</section>
<section id="when-to-use-ch-fromhost">
<h2><span class="section-number">6.4. </span>When to use <code class="code docutils literal notranslate"><span class="pre">ch-fromhost</span></code><a class="headerlink" href="#when-to-use-ch-fromhost" title="Permalink to this heading">¶</a></h2>
<p>This command does a lot of heuristic magic; while it <em>can</em> copy arbitrary
files into an image, this usage is discouraged and prone to error. Here are
some use cases and the recommended approach:</p>
<ol class="arabic simple">
<li><p><em>I have some files on my build host that I want to include in the image.</em>
Use the <code class="code docutils literal notranslate"><span class="pre">COPY</span></code> instruction within your Dockerfile. Note that it’s OK
to build an image that meets your specific needs but isn’t generally
portable, e.g., only runs on specific micro-architectures you’re using.</p></li>
<li><p><em>I have an already built image and want to install a program I compiled
separately into the image.</em> Consider whether a building a new derived image
with a Dockerfile is appropriate. Another good option is to bind-mount the
directory containing your program at run time. A less good option is to
<code class="code docutils literal notranslate"><span class="pre">cp(1)</span></code> the program into your image, because this permanently alters
the image in a non-reproducible way.</p></li>
<li><p><em>I have some shared libraries that I need in the image for functionality or
performance, and they aren’t available in a place where I can use</em>
<code class="code docutils literal notranslate"><span class="pre">COPY</span></code>. This is the intended use case of <code class="code docutils literal notranslate"><span class="pre">ch-fromhost</span></code>. You can
use <code class="code docutils literal notranslate"><span class="pre">--cmd</span></code>, <code class="code docutils literal notranslate"><span class="pre">--file</span></code>, <code class="code docutils literal notranslate"><span class="pre">--ofi</span></code>, and/or <code class="code docutils literal notranslate"><span class="pre">--path</span></code> to
put together a custom solution. But, please consider filing an issue so we
can package your functionality with a tidy option like <code class="code docutils literal notranslate"><span class="pre">--nvidia</span></code>.</p></li>
</ol>
</section>
<section id="libfabric-usage-and-quirks">
<h2><span class="section-number">6.5. </span>Libfabric usage and quirks<a class="headerlink" href="#libfabric-usage-and-quirks" title="Permalink to this heading">¶</a></h2>
<p>The implementation of libfabric provider injection and replacement is
experimental and has a couple quirks.</p>
<ol class="arabic">
<li><p>Containers must have the following software installed:</p>
<ol class="loweralpha simple">
<li><p>libfabric (<a class="reference external" href="https://ofiwg.github.io/libfabric/">https://ofiwg.github.io/libfabric/</a>). See
<code class="code docutils literal notranslate"><span class="pre">charliecloud/examples/Dockerfile.libfabric</span></code>.</p></li>
<li><p>Corresponding open source MPI implementation configured and built against
the container libfabric, e.g.,
- <a class="reference external" href="https://www.mpich.org/">MPICH</a>, or
- <a class="reference external" href="https://www.open-mpi.org/">OpenMPI</a>.
See <code class="code docutils literal notranslate"><span class="pre">charliecloud/examples/Dockerfile.mpich</span></code> and
<code class="code docutils literal notranslate"><span class="pre">charliecloud/examples/Dockerfile.openmpi</span></code>.</p></li>
</ol>
</li>
<li><p>At run time, a libfabric provider can be specified with the variable
<code class="code docutils literal notranslate"><span class="pre">FI_PROVIDER</span></code>. The path to search for shared providers can be specified
with <code class="code docutils literal notranslate"><span class="pre">FI_PROVIDER_PATH</span></code>. These variables can be inherited from the host
or explicitly set with the container’s environment file
<code class="code docutils literal notranslate"><span class="pre">/ch/environent</span></code> via <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code>.</p>
<p>To avoid issues and reduce complexity, the inferred injection destination
for libfabric providers and replacement will always at the path in the image
where <code class="code docutils literal notranslate"><span class="pre">libfabric.so</span></code> is found.</p>
</li>
<li><p>The Cray GNI loadable provider, <code class="code docutils literal notranslate"><span class="pre">libgnix-fi.so</span></code>, will link to
compiler(s) in the programming environment by default. For example, if it
is built under the <code class="code docutils literal notranslate"><span class="pre">PrgEnv-intel</span></code> programming environment, it will have
links to files at paths <code class="code docutils literal notranslate"><span class="pre">/opt/gcc</span></code> and <code class="code docutils literal notranslate"><span class="pre">/opt/intel</span></code> that
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> will not bind automatically.</p>
<p>Managing all possible bind mount paths is untenable. Thus, this experimental
implementation injects libraries linked to a <code class="code docutils literal notranslate"><span class="pre">libgnix-fi.so</span></code> built
with the minimal modules necessary to compile, i.e.:</p>
<ul class="simple">
<li><p>modules</p></li>
<li><p>craype-network-aries</p></li>
<li><p>eproxy</p></li>
<li><p>slurm</p></li>
<li><p>cray-mpich</p></li>
<li><p>craype-haswell</p></li>
<li><p>craype-hugepages2M</p></li>
</ul>
<p>A Cray GNI provider linked against more complicated PE’s will still work,
assuming 1) the user explicitly bind-mounts missing libraries listed from
its <code class="code docutils literal notranslate"><span class="pre">ldd</span></code> output, and 2) all such libraries do not conflict with
container functionality, e.g., <code class="code docutils literal notranslate"><span class="pre">glibc.so</span></code>, etc.</p>
</li>
<li><p>At the time of this writing, a Cray Slingshot optimized provider is not
available; however, recent libfabric source acitivity indicates there may be
at some point, see: <a class="reference external" href="https://github.com/ofiwg/libfabric/pull/7839We">https://github.com/ofiwg/libfabric/pull/7839We</a>.</p>
<p>For now, on Cray systems with Slingshot, CXI, we need overwrite the
container’s <code class="code docutils literal notranslate"><span class="pre">libfabric.so</span></code> with the hosts using <code class="code docutils literal notranslate"><span class="pre">--path</span></code>. See
examples for details.</p>
</li>
<li><p>Tested only for C programs compiled with GCC. Additional bind mount or
kludging may be needed for untested use cases. If you’d like to use another
compiler or programming environment, please get in touch so we can implement
the necessary support.</p></li>
</ol>
<p>Please file a bug if we missed anything above or if you know how to make the
code better.</p>
</section>
<section id="notes">
<h2><span class="section-number">6.6. </span>Notes<a class="headerlink" href="#notes" title="Permalink to this heading">¶</a></h2>
<p>Symbolic links are dereferenced, i.e., the files pointed to are injected, not
the links themselves.</p>
<p>As a corollary, do not include symlinks to shared libraries. These will be
re-created by <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code>.</p>
<p>There are two alternate approaches for nVidia GPU libraries:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Link <code class="code docutils literal notranslate"><span class="pre">libnvidia-containers</span></code> into <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> and call the
library functions directly. However, this would mean that Charliecloud
would either (a) need to be compiled differently on machines with and
without nVidia GPUs or (b) have <code class="code docutils literal notranslate"><span class="pre">libnvidia-containers</span></code> available
even on machines without nVidia GPUs. Neither of these is consistent with
Charliecloud’s philosophies of simplicity and minimal dependencies.</p></li>
<li><p>Use <code class="code docutils literal notranslate"><span class="pre">nvidia-container-cli</span> <span class="pre">configure</span></code> to do the injecting. This
would require that containers have a half-started state, where the
namespaces are active and everything is mounted but <code class="code docutils literal notranslate"><span class="pre">pivot_root(2)</span></code>
has not been performed. This is not feasible because Charliecloud has no
notion of a half-started container.</p></li>
</ol>
</div></blockquote>
<p>Further, while these alternate approaches would simplify or eliminate this
script for nVidia GPUs, they would not solve the problem for other situations.</p>
</section>
<section id="bugs">
<h2><span class="section-number">6.7. </span>Bugs<a class="headerlink" href="#bugs" title="Permalink to this heading">¶</a></h2>
<p>File paths may not contain colons or newlines.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code> tends to print <code class="code docutils literal notranslate"><span class="pre">stat</span></code> errors; these are typically
non-fatal and occur when trying to probe common library paths. See <a class="reference external" href="https://github.com/hpc/charliecloud/issues/732">issue #732</a>.</p>
</section>
<section id="examples">
<h2><span class="section-number">6.8. </span>Examples<a class="headerlink" href="#examples" title="Permalink to this heading">¶</a></h2>
<section id="id2">
<h3><span class="section-number">6.8.1. </span>libfabric<a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h3>
<p>Cray Slingshot CXI injection.</p>
<p>Replace image libabfric, i.e., <code class="code docutils literal notranslate"><span class="pre">libfabric.so</span></code>, with Cray host’s
libfabric at host path <code class="code docutils literal notranslate"><span class="pre">/opt/cray-libfabric/lib64/libfabric.so</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-fromhost<span class="w"> </span>-v<span class="w"> </span>--path<span class="w"> </span>/opt/cray-libfabric/lib64/libfabric.so<span class="w"> </span>/tmp/ompi
<span class="go">[ debug ] queueing files</span>
<span class="go">[ debug ]    cray libfabric: /opt/cray-libfabric/lib64/libfabric.so</span>
<span class="go">[ debug ] searching image for inferred libfabric destiation</span>
<span class="go">[ debug ]    found /tmp/ompi/usr/local/lib/libfabric.so</span>
<span class="go">[ debug ] adding cray libfabric libraries</span>
<span class="go">[ debug ]    skipping /lib64/libcom_err.so.2</span>
<span class="go">[...]</span>
<span class="go">[ debug ] queueing files</span>
<span class="go">[ debug ]    shared library: /usr/lib64/libcxi.so.1</span>
<span class="go">[ debug ] queueing files</span>
<span class="go">[ debug ]    shared library: /usr/lib64/libcxi.so.1.2.1</span>
<span class="go">[ debug ] queueing files</span>
<span class="go">[ debug ]    shared library: /usr/lib64/libjson-c.so.3</span>
<span class="go">[ debug ] queueing files</span>
<span class="go">[ debug ]    shared library: /usr/lib64/libjson-c.so.3.0.1</span>
<span class="go">[...]</span>
<span class="go">[ debug ] queueing files</span>
<span class="go">[ debug ]    shared library: /usr/lib64/libssh.so.4</span>
<span class="go">[ debug ] queueing files</span>
<span class="go">[ debug ]    shared library: /usr/lib64/libssh.so.4.7.4</span>
<span class="go">[...]</span>
<span class="go">[ debug ] inferred shared library destination: /tmp/ompi//usr/local/lib</span>
<span class="go">[ debug ] injecting into image: /tmp/ompi/</span>
<span class="go">[ debug ]    mkdir -p /tmp/ompi//var/lib/hugetlbfs</span>
<span class="go">[ debug ]    mkdir -p /tmp/ompi//var/spool/slurmd</span>
<span class="go">[ debug ]    echo &#39;/usr/lib64&#39; &gt;&gt; /tmp/ompi//etc/ld.so.conf.d/ch-ofi.conf</span>
<span class="go">[ debug ]    /opt/cray-libfabric/lib64/libfabric.so -&gt; /usr/local/lib (inferred)</span>
<span class="go">[ debug ]    /usr/lib64/libcxi.so.1 -&gt; /usr/local/lib (inferred)</span>
<span class="go">[ debug ]    /usr/lib64/libcxi.so.1.2.1 -&gt; /usr/local/lib (inferred)</span>
<span class="go">[ debug ]    /usr/lib64/libjson-c.so.3 -&gt; /usr/local/lib (inferred)</span>
<span class="go">[ debug ]    /usr/lib64/libjson-c.so.3.0.1 -&gt; /usr/local/lib (inferred)</span>
<span class="go">[ debug ]    /usr/lib64/libssh.so.4 -&gt; /usr/local/lib (inferred)</span>
<span class="go">[ debug ]    /usr/lib64/libssh.so.4.7.4 -&gt; /usr/local/lib (inferred)</span>
<span class="go">[ debug ] running ldconfig</span>
<span class="go">[ debug ]    ch-run -w /tmp/ompi/ -- /sbin/ldconfig</span>
<span class="go">[ debug ] validating ldconfig cache</span>
<span class="go">done</span>
</pre></div>
</div>
<p>Same as above, except also inject Cray’s <code class="code docutils literal notranslate"><span class="pre">fi_info</span></code> to verify Slingshot
provider access.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-fromhost<span class="w"> </span>-v<span class="w"> </span>--path<span class="w"> </span>/opt/cray/libfabric/1.15.0.0/lib64/libfabric.so<span class="w"> </span><span class="se">\</span>
<span class="w">              </span>-d<span class="w"> </span>/usr/local/bin<span class="w"> </span><span class="se">\</span>
<span class="w">              </span>--path<span class="w"> </span>/opt/cray/libfabric/1.15.0.0/lib64/libfabric.so<span class="w"> </span><span class="se">\</span>
<span class="w">              </span>/tmp/ompi
<span class="go">[...]</span>
<span class="gp">$ </span>ch-run<span class="w"> </span>/tmp/ompi/<span class="w"> </span>--<span class="w"> </span>fi_info<span class="w"> </span>-p<span class="w"> </span>cxi
<span class="go">provider: cxi</span>
<span class="go">  fabric: cxi</span>
<span class="go">  [...]</span>
<span class="go">  type: FI_EP_RDM</span>
<span class="go">  protocol: FI_PROTO_CXI</span>
</pre></div>
</div>
<p>Cray GNI shared provider injection.</p>
<p>Add Cray host built GNI provider <code class="code docutils literal notranslate"><span class="pre">libgnix-fi.so</span></code> to the image and verify
with <code class="code docutils literal notranslate"><span class="pre">fi_info</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-fromhost<span class="w"> </span>-v<span class="w"> </span>--path<span class="w"> </span>/home/ofi/libgnix-fi.so<span class="w"> </span>/tmp/ompi
<span class="go">[ debug ] queueing files</span>
<span class="go">[ debug ]    libfabric shared provider: /home/ofi/libgnix-fi.so</span>
<span class="go">[ debug ] searching /tmp/ompi for libfabric shared provider destination</span>
<span class="go">[ debug ]    found: /tmp/ompi/usr/local/lib/libfabric.so</span>
<span class="go">[ debug ] inferred provider destination: //usr/local/lib/libfabric</span>
<span class="go">[ debug ] injecting into image: /tmp/ompi</span>
<span class="go">[ debug ]    mkdir -p /tmp/ompi//usr/local/lib/libfabric</span>
<span class="go">[ debug ]    mkdir -p /tmp/ompi/var/lib/hugetlbfs</span>
<span class="go">[ debug ]    mkdir -p /tmp/ompi/var/opt/cray/alps/spool</span>
<span class="go">[ debug ]    mkdir -p /tmp/ompi/opt/cray/wlm_detect</span>
<span class="go">[ debug ]    mkdir -p /tmp/ompi/etc/opt/cray/wlm_detect</span>
<span class="go">[ debug ]    mkdir -p /tmp/ompi/opt/cray/udreg</span>
<span class="go">[ debug ]    mkdir -p /tmp/ompi/opt/cray/xpmem</span>
<span class="go">[ debug ]    mkdir -p /tmp/ompi/opt/cray/ugni</span>
<span class="go">[ debug ]    mkdir -p /tmp/ompi/opt/cray/alps</span>
<span class="go">[ debug ]    echo &#39;/lib64&#39; &gt;&gt; /tmp/ompi/etc/ld.so.conf.d/ch-ofi.conf</span>
<span class="go">[ debug ]    echo &#39;/opt/cray/alps/lib64&#39; &gt;&gt; /tmp/ompi/etc/ld.so.conf.d/ch-ofi.conf</span>
<span class="go">[ debug ]    echo &#39;/opt/cray/udreg/lib64&#39; &gt;&gt; /tmp/ompi/etc/ld.so.conf.d/ch-ofi.conf</span>
<span class="go">[ debug ]    echo &#39;/opt/cray/ugni/lib64&#39; &gt;&gt; /tmp/ompi/etc/ld.so.conf.d/ch-ofi.conf</span>
<span class="go">[ debug ]    echo &#39;/opt/cray/wlm_detect/lib64&#39; &gt;&gt; /tmp/ompi/etc/ld.so.conf.d/ch-ofi.conf</span>
<span class="go">[ debug ]    echo &#39;/opt/cray/xpmem/lib64&#39; &gt;&gt; /tmp/ompi/etc/ld.so.conf.d/ch-ofi.conf</span>
<span class="go">[ debug ]    echo &#39;/usr/lib64&#39; &gt;&gt; /tmp/ompi/etc/ld.so.conf.d/ch-ofi.conf</span>
<span class="go">[ debug ]    /home/ofi/libgnix-fi.so -&gt; //usr/local/lib/libfabric (inferred)</span>
<span class="go">[ debug ] running ldconfig</span>
<span class="go">[ debug ]    ch-run -w /tmp/ompi -- /sbin/ldconfig</span>
<span class="go">[ debug ] validating ldconfig cache</span>
<span class="go">done</span>

<span class="gp">$ </span>ch-run<span class="w"> </span>/tmp/ompi<span class="w"> </span>--<span class="w"> </span>fi_info<span class="w"> </span>-p<span class="w"> </span>gni
<span class="go">provider: gni</span>
<span class="go">  fabric: gni</span>
<span class="go">  [...]</span>
<span class="go">  type: FI_EP_RDM</span>
<span class="go">  protocol: FI_PROTO_GNI</span>
</pre></div>
</div>
</section>
<section id="arbitrary">
<h3><span class="section-number">6.8.2. </span>Arbitrary<a class="headerlink" href="#arbitrary" title="Permalink to this heading">¶</a></h3>
<p>Place shared library <code class="code docutils literal notranslate"><span class="pre">/usr/lib64/libfoo.so</span></code> at path
<code class="code docutils literal notranslate"><span class="pre">/usr/lib/libfoo.so</span></code> (assuming <code class="code docutils literal notranslate"><span class="pre">/usr/lib</span></code> is the first directory
searched by the dynamic loader in the image), within the image
<code class="code docutils literal notranslate"><span class="pre">/var/tmp/baz</span></code> and executable <code class="code docutils literal notranslate"><span class="pre">/bin/bar</span></code> at path
<code class="code docutils literal notranslate"><span class="pre">/usr/bin/bar</span></code>. Then, create appropriate symlinks to <code class="code docutils literal notranslate"><span class="pre">libfoo</span></code> and
update the <code class="code docutils literal notranslate"><span class="pre">ld.so</span></code> cache.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>qux.txt
<span class="go">/bin/bar</span>
<span class="go">/usr/lib64/libfoo.so</span>
<span class="gp">$ </span>ch-fromhost<span class="w"> </span>--file<span class="w"> </span>qux.txt<span class="w"> </span>/var/tmp/baz
</pre></div>
</div>
<p>Same as above:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-fromhost<span class="w"> </span>--cmd<span class="w"> </span><span class="s1">&#39;cat qux.txt&#39;</span><span class="w"> </span>/var/tmp/baz
</pre></div>
</div>
<p>Same as above:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-fromhost<span class="w"> </span>--path<span class="w"> </span>/bin/bar<span class="w"> </span>--path<span class="w"> </span>/usr/lib64/libfoo.so<span class="w"> </span>/var/tmp/baz
</pre></div>
</div>
<p>Same as above, but place the files into <code class="code docutils literal notranslate"><span class="pre">/corge</span></code> instead (and the shared
library will not be found by <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-fromhost<span class="w"> </span>--dest<span class="w"> </span>/corge<span class="w"> </span>--file<span class="w"> </span>qux.txt<span class="w"> </span>/var/tmp/baz
</pre></div>
</div>
<p>Same as above, and also place file <code class="code docutils literal notranslate"><span class="pre">/etc/quux</span></code> at <code class="code docutils literal notranslate"><span class="pre">/etc/quux</span></code>
within the container:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-fromhost<span class="w"> </span>--file<span class="w"> </span>qux.txt<span class="w"> </span>--dest<span class="w"> </span>/etc<span class="w"> </span>--path<span class="w"> </span>/etc/quux<span class="w"> </span>/var/tmp/baz
</pre></div>
</div>
<p>Inject the executables and libraries recommended by nVidia into the image, and
then run <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ch-fromhost<span class="w"> </span>--nvidia<span class="w"> </span>/var/tmp/baz
<span class="go">asking ldconfig for shared library destination</span>
<span class="go">/sbin/ldconfig: Can’t stat /libx32: No such file or directory</span>
<span class="go">/sbin/ldconfig: Can’t stat /usr/libx32: No such file or directory</span>
<span class="go">shared library destination: /usr/lib64//bind9-export</span>
<span class="go">injecting into image: /var/tmp/baz</span>
<span class="go">  /usr/bin/nvidia-smi -&gt; /usr/bin (inferred)</span>
<span class="go">  /usr/bin/nvidia-debugdump -&gt; /usr/bin (inferred)</span>
<span class="go">  /usr/bin/nvidia-persistenced -&gt; /usr/bin (inferred)</span>
<span class="go">  /usr/bin/nvidia-cuda-mps-control -&gt; /usr/bin (inferred)</span>
<span class="go">  /usr/bin/nvidia-cuda-mps-server -&gt; /usr/bin (inferred)</span>
<span class="go">  /usr/lib64/libnvidia-ml.so.460.32.03 -&gt; /usr/lib64//bind9-export (inferred)</span>
<span class="go">  /usr/lib64/libnvidia-cfg.so.460.32.03 -&gt; /usr/lib64//bind9-export (inferred)</span>
<span class="go">[...]</span>
<span class="go">  /usr/lib64/libGLESv2_nvidia.so.460.32.03 -&gt; /usr/lib64//bind9-export (inferred)</span>
<span class="go">  /usr/lib64/libGLESv1_CM_nvidia.so.460.32.03 -&gt; /usr/lib64//bind9-export (inferred)</span>
<span class="go">running ldconfig</span>
</pre></div>
</div>
</section>
</section>
<section id="acknowledgements">
<h2><span class="section-number">6.9. </span>Acknowledgements<a class="headerlink" href="#acknowledgements" title="Permalink to this heading">¶</a></h2>
<p>This command was inspired by the similar <a class="reference external" href="http://www.nersc.gov/research-and-development/user-defined-images/">Shifter</a> feature
that allows Shifter containers to use the Cray Aries network. We particularly
appreciate the help provided by Shane Canon and Doug Jacobsen during our
implementation of <code class="code docutils literal notranslate"><span class="pre">--cray-mpi</span></code>.</p>
<p>We appreciate the advice of Ryan Olson at nVidia on implementing
<code class="code docutils literal notranslate"><span class="pre">--nvidia</span></code>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ch-convert.html" class="btn btn-neutral float-left" title="5. ch-convert" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="ch-image.html" class="btn btn-neutral float-right" title="7. ch-image" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Charliecloud a Series of LF Projects, LLC and others (web content and website). For web site terms of use, trademark policy and other project policies please see: https://lfprojects.org.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
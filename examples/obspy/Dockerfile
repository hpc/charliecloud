# ch-test-scope: standard
# ch-test-arch-exclude: aarch64  # no obspy Conda package
# ch-test-arch-exclude: ppc64le  # no obspy Conda package?
FROM almalinux_8ch

RUN dnf install -y --setopt=install_weak_deps=false \
                libpng-devel \
                which \
                zlib-devel \
 && dnf clean all

WORKDIR /usr/local/src
# Install ImageMagick
# The latest, 7.1.0, fails to install with a cryptic libtool error. ¯\_(ツ)_/¯
ARG MAGICK_VERSION=7.0.11-14
RUN wget -nv -O ImageMagick-${MAGICK_VERSION}.tar.gz \
    "https://github.com/ImageMagick/ImageMagick/archive/refs/tags/${MAGICK_VERSION}.tar.gz" \
 && tar xf ImageMagick-${MAGICK_VERSION}.tar.gz \
 && cd ImageMagick-${MAGICK_VERSION} \
 && ./configure --prefix=/usr/local \
 && make -j $(getconf _NPROCESSORS_ONLN) install \
 && rm -Rf ../ImageMagick-${MAGICK_VERSION}

# Install Miniconda. Notes/gotchas:
#
#   1. Install into /usr/local. Some of the instructions [e.g., 1] warn
#      against putting conda in $PATH; others don't. However it seems to work
#      and then we don't need to muck with the path.
#
#   2. Use latest version so we catch sooner if things explode.
#
# [1]: https://docs.anaconda.com/anaconda/user-guide/faq/
ARG MC_VERSION=latest
ARG MC_FILE=Miniconda3-$MC_VERSION-Linux-x86_64.sh
RUN wget -nv https://repo.anaconda.com/miniconda/$MC_FILE
RUN bash $MC_FILE -bf -p /usr/local
RUN rm -Rf $MC_FILE
RUN which conda && conda --version
# Disable automatic conda upgrades for predictable versioning.
RUN conda config --set auto_update_conda False

# Install obspy, also latest. This is a container, so don't bother creating a
# new environment for obspy.
# See: https://github.com/obspy/obspy/wiki/Installation-via-Anaconda
RUN conda config --add channels conda-forge
RUN conda install --yes obspy

# Hello world program and input from docs.
WORKDIR /
RUN wget -nv http://examples.obspy.org/RJOB_061005_072159.ehz.new
COPY hello.py .
RUN chmod 755 ./hello.py

# Add bind-mount DST files and directories for example tests.
RUN mkdir /diff \
 && echo "example bind mount DST file" > /inp_a \
 && echo "example bind mount DST file" > /inp_b

# Unlike the paraview example, we have to once again ldconfig here, otherwise
# /usr/local/lib links are not resolved.
RUN /sbin/ldconfig

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3. Charliecloud command reference &mdash; Charliecloud 0.27 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="4. Frequently asked questions (FAQ)" href="faq.html" />
    <link rel="prev" title="2. Tutorial" href="tutorial.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Charliecloud
            <img src="_static/logo-sidebar.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.27
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">1. Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">2. Tutorial</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3. Charliecloud command reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ch-checkns">3.1. ch-checkns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#synopsis">3.1.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#description">3.1.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example">3.1.3. Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-convert">3.2. ch-convert</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">3.2.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">3.2.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#image-formats">3.2.3. Image formats</a></li>
<li class="toctree-l3"><a class="reference internal" href="#format-inference">3.2.4. Format inference</a></li>
<li class="toctree-l3"><a class="reference internal" href="#examples">3.2.5. Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-fromhost">3.3. ch-fromhost</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">3.3.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">3.3.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#options">3.3.3. Options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#to-specify-which-files-to-inject">3.3.3.1. To specify which files to inject</a></li>
<li class="toctree-l4"><a class="reference internal" href="#to-specify-the-destination-within-the-image">3.3.3.2. To specify the destination within the image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#additional-arguments">3.3.3.3. Additional arguments</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#when-to-use-ch-fromhost">3.3.4. When to use <code class="code docutils literal notranslate"><span class="pre">ch-fromhost</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cray-mpi-dependencies-and-quirks">3.3.5. <code class="code docutils literal notranslate"><span class="pre">--cray-mpi</span></code> dependencies and quirks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#notes">3.3.6. Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bugs">3.3.7. Bugs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">3.3.8. Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#acknowledgements">3.3.9. Acknowledgements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-image">3.4. ch-image</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id6">3.4.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">3.4.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#authentication">3.4.3. Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="#storage-directory">3.4.4. Storage directory</a></li>
<li class="toctree-l3"><a class="reference internal" href="#build">3.4.5. <code class="code docutils literal notranslate"><span class="pre">build</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id8">3.4.5.1. Synopsis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">3.4.5.2. Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#privilege-model">3.4.5.3. Privilege model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compatibility-with-other-dockerfile-interpreters">3.4.5.4. Compatibility with other Dockerfile interpreters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">3.4.5.5. Examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#delete">3.4.6. <code class="code docutils literal notranslate"><span class="pre">delete</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#list">3.4.7. <code class="code docutils literal notranslate"><span class="pre">list</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id11">3.4.7.1. Synopsis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">3.4.7.2. Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">3.4.7.3. Examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#import">3.4.8. <code class="code docutils literal notranslate"><span class="pre">import</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#pull">3.4.9. <code class="code docutils literal notranslate"><span class="pre">pull</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id14">3.4.9.1. Synopsis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">3.4.9.2. Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">3.4.9.3. Examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#push">3.4.10. <code class="code docutils literal notranslate"><span class="pre">push</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id17">3.4.10.1. Synopsis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">3.4.10.2. Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id19">3.4.10.3. Examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#reset">3.4.11. <code class="code docutils literal notranslate"><span class="pre">reset</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#storage-path">3.4.12. <code class="code docutils literal notranslate"><span class="pre">storage-path</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#environment-variables">3.4.13. Environment variables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-run">3.5. ch-run</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id20">3.5.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id21">3.5.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#image-format">3.5.3. Image format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#host-files-and-directories-available-in-container-via-bind-mounts">3.5.4. Host files and directories available in container via bind mounts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multiple-processes-in-the-same-container-with-join">3.5.5. Multiple processes in the same container with <code class="code docutils literal notranslate"><span class="pre">--join</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id22">3.5.6. Environment variables</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#default-behavior">3.5.6.1. Default behavior</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setting-variables-with-set-env">3.5.6.2. Setting variables with <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#removing-variables-with-unset-env">3.5.6.3. Removing variables with <code class="code docutils literal notranslate"><span class="pre">--unset-env</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id23">3.5.7. Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#syslog">3.5.8. Syslog</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exit-status">3.5.9. Exit status</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-run-oci">3.6. ch-run-oci</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id25">3.6.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id26">3.6.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#operations">3.6.3. Operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#create">3.6.3.1. <code class="code docutils literal notranslate"><span class="pre">create</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#id27">3.6.3.2. <code class="code docutils literal notranslate"><span class="pre">delete</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#kill">3.6.3.3. <code class="code docutils literal notranslate"><span class="pre">kill</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#start">3.6.3.4. <code class="code docutils literal notranslate"><span class="pre">start</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#state">3.6.3.5. <code class="code docutils literal notranslate"><span class="pre">state</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#unsupported-oci-features">3.6.4. Unsupported OCI features</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id28">3.6.5. Environment variables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-ssh">3.7. ch-ssh</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id29">3.7.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id30">3.7.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id31">3.7.3. Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ch-test">3.8. ch-test</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id32">3.8.1. Synopsis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id33">3.8.2. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id34">3.8.3. Exit status</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id35">3.8.4. Bugs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id36">3.8.5. Examples</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">4. Frequently asked questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev.html">5. Contributor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Charliecloud</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li><span class="section-number">3. </span>Charliecloud command reference</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="charliecloud-command-reference">
<h1><span class="section-number">3. </span>Charliecloud command reference<a class="headerlink" href="#charliecloud-command-reference" title="Permalink to this headline">¶</a></h1>
<p>This section is a comprehensive description of the usage and arguments of the
Charliecloud commands. Its content is identical to the commands’ man pages.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#ch-checkns" id="id37">ch-checkns</a></p></li>
<li><p><a class="reference internal" href="#ch-convert" id="id38">ch-convert</a></p></li>
<li><p><a class="reference internal" href="#ch-fromhost" id="id39">ch-fromhost</a></p></li>
<li><p><a class="reference internal" href="#ch-image" id="id40">ch-image</a></p></li>
<li><p><a class="reference internal" href="#ch-run" id="id41">ch-run</a></p></li>
<li><p><a class="reference internal" href="#ch-run-oci" id="id42">ch-run-oci</a></p></li>
<li><p><a class="reference internal" href="#ch-ssh" id="id43">ch-ssh</a></p></li>
<li><p><a class="reference internal" href="#ch-test" id="id44">ch-test</a></p></li>
</ul>
</div>
<section id="ch-checkns">
<h2><a class="toc-backref" href="#id37"><span class="section-number">3.1. </span>ch-checkns</a><a class="headerlink" href="#ch-checkns" title="Permalink to this headline">¶</a></h2>
<p>Check <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> prerequisites, e.g., namespaces and <code class="code docutils literal notranslate"><span class="pre">pivot_root(2)</span></code>.</p>
<section id="synopsis">
<h3><span class="section-number">3.1.1. </span>Synopsis<a class="headerlink" href="#synopsis" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-checkns
</pre></div>
</div>
</section>
<section id="description">
<h3><span class="section-number">3.1.2. </span>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h3>
<p>Check <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> prerequisites, e.g., namespaces and <code class="code docutils literal notranslate"><span class="pre">pivot_root(2)</span></code>.</p>
</section>
<section id="example">
<h3><span class="section-number">3.1.3. </span>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-checkns
<span class="go">ok</span>
</pre></div>
</div>
</section>
</section>
<section id="ch-convert">
<h2><a class="toc-backref" href="#id38"><span class="section-number">3.2. </span>ch-convert</a><a class="headerlink" href="#ch-convert" title="Permalink to this headline">¶</a></h2>
<p>Convert an image from one format to another.</p>
<section id="id1">
<h3><span class="section-number">3.2.1. </span>Synopsis<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-convert <span class="o">[</span>-i FMT<span class="o">]</span> <span class="o">[</span>-o FMT<span class="o">]</span> <span class="o">[</span>OPTION ...<span class="o">]</span> IN OUT
</pre></div>
</div>
</section>
<section id="id2">
<h3><span class="section-number">3.2.2. </span>Description<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Copy image <code class="code docutils literal notranslate"><span class="pre">IN</span></code> to <code class="code docutils literal notranslate"><span class="pre">OUT</span></code> and convert its format. Replace
<code class="code docutils literal notranslate"><span class="pre">OUT</span></code> if it already exists, unless <code class="code docutils literal notranslate"><span class="pre">--no-clobber</span></code> is specified. It
is an error if <code class="code docutils literal notranslate"><span class="pre">IN</span></code> and <code class="code docutils literal notranslate"><span class="pre">OUT</span></code> have the same format; use the
format’s own tools for that case.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> can run container images that are plain directories or
(optionally) SquashFS archives. However, images can take on a variety of other
formats as well. The main purpose of this tool is to make images in those
other formats available to <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>.</p>
<p>For best performance, <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> should be invoked only once,
producing the final format actually needed.</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">IN</span></code></dt><dd><p>Descriptor for the input image. For image builders, this is an image
reference; otherwise, it’s a filesystem path.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">OUT</span></code></dt><dd><p>Descriptor for the output image.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-h</span></code>, <code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt><dd><p>Print help and exit.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-i</span></code>, <code class="code docutils literal notranslate"><span class="pre">--in-fmt</span> <span class="pre">FMT</span></code></dt><dd><p>Input image format is <code class="code docutils literal notranslate"><span class="pre">FMT</span></code>. If omitted, inferred as described below.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-n</span></code>, <code class="code docutils literal notranslate"><span class="pre">--dry-run</span></code></dt><dd><p>Don’t read the input or write the output. Useful for testing format
inference.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-clobber</span></code></dt><dd><p>Error if <code class="code docutils literal notranslate"><span class="pre">OUT</span></code> already exists, rather than replacing it.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-o</span></code>, <code class="code docutils literal notranslate"><span class="pre">--out-fmt</span> <span class="pre">FMT</span></code></dt><dd><p>Output image format is <code class="code docutils literal notranslate"><span class="pre">FMT</span></code>; inferred if omitted.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--tmp</span> <span class="pre">DIR</span></code></dt><dd><p>A sub-directory for temporary storage is created in <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> and
removed at the end of a successful conversion. <strong>If this script crashes or
errors out, the temporary directory is left behind to assist in
debugging.</strong> Storage may be needed up to twice the uncompressed size of
the image, depending on the input and output formats. Default:
<code class="code docutils literal notranslate"><span class="pre">$TMPDIR</span></code> if specified; otherwise <code class="code docutils literal notranslate"><span class="pre">/var/tmp</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-v</span></code>, <code class="code docutils literal notranslate"><span class="pre">--verbose</span></code></dt><dd><p>Print extra chatter. Can be repeated.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="image-formats">
<h3><span class="section-number">3.2.3. </span>Image formats<a class="headerlink" href="#image-formats" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> knows about these values of <code class="code docutils literal notranslate"><span class="pre">FMT</span></code>:</p>
<blockquote>
<div><dl>
<dt><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code></dt><dd><p>Internal storage for Charliecloud’s unprivileged image builder (Dockerfile
interpreter) <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">dir</span></code></dt><dd><p>Ordinary filesystem directory (i.e., not a mount point) containing an
unpacked image. Output directories that already exist are replaced if they
look like an image; otherwise, exit with an error.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">docker</span></code></dt><dd><p>Internal storage for Docker.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">squash</span></code></dt><dd><p>SquashFS filesystem archive containing the flattened image. SquashFS
archives are much like tar archives but are mountable, including by
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>’s internal SquashFUSE mounting. Most systems have at least
the SquashFS-Tools installed which allows unpacking into a directory, just
like tar. Due to this greater flexibility, SquashFS is preferred to tar.</p>
<p><strong>Note:</strong> Conversions to and from SquashFS are quite noisy due to the
verbosity of the underlying <code class="code docutils literal notranslate"><span class="pre">mksquashfs(1)</span></code> and
<code class="code docutils literal notranslate"><span class="pre">unsquashfs(1)</span></code> tools.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">tar</span></code></dt><dd><p>Tar archive containing the flattened image with no layer sub-archives;
i.e., the output of <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">export</span></code> works but the output of
<code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">save</span></code> does not. Output tarballs are always gzipped and must
end in <code class="code docutils literal notranslate"><span class="pre">.tar.gz</span></code>; input tarballs can be any compression acceptable
to <code class="code docutils literal notranslate"><span class="pre">tar(1)</span></code>.</p>
</dd>
</dl>
</div></blockquote>
<p>All of these are local formats; <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> does not know how to push
or pull images.</p>
</section>
<section id="format-inference">
<h3><span class="section-number">3.2.4. </span>Format inference<a class="headerlink" href="#format-inference" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> tries to save typing by guessing formats when they are
reasonably clear. This is done against filenames, rather than file contents,
so the rules are the same for output descriptors that do not yet exist.</p>
<p>Format inference is done for both <code class="code docutils literal notranslate"><span class="pre">IN</span></code> and <code class="code docutils literal notranslate"><span class="pre">OUT</span></code>. The first
matching glob below yields the inferred format. Paths need not exist in the
filesystem.</p>
<blockquote>
<div><ol class="arabic simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">*.sqfs</span></code>, <code class="code docutils literal notranslate"><span class="pre">*.squash</span></code>, <code class="code docutils literal notranslate"><span class="pre">*.squashfs</span></code>: SquashFS.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">*.tar</span></code>, <code class="code docutils literal notranslate"><span class="pre">*.t?z</span></code>, <code class="code docutils literal notranslate"><span class="pre">*.tar.?</span></code>, <code class="code docutils literal notranslate"><span class="pre">*.tar.??</span></code>: Tarball.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">/*</span></code>, <code class="code docutils literal notranslate"><span class="pre">./*</span></code>, i.e. absolute path or relative path with
explicit dot: Directory.</p></li>
<li><p>If <cite>ch-image</cite> is installed: <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> internal storage.</p></li>
<li><p>If Docker is installed: Docker internal storage.</p></li>
<li><p>Otherwise: No format inference.</p></li>
</ol>
</div></blockquote>
</section>
<section id="examples">
<h3><span class="section-number">3.2.5. </span>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<p>Typical build-to-run sequence for image <code class="code docutils literal notranslate"><span class="pre">foo/bar</span></code> using <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>’s
internal SquashFUSE code, inferring the output format:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> sudo docker build -t foo/bar -f Dockerfile .
<span class="go">[...]</span>
<span class="gp">$</span> ch-convert foo/bar:latest /var/tmp/foobar.sqfs
<span class="go">input:   docker    foo/bar:latest</span>
<span class="go">output:  squashfs  /var/tmp/foobar.sqfs</span>
<span class="go">copying ...</span>
<span class="go">done</span>
<span class="gp">$</span> ch-run /var/tmp/foobar.sqfs -- <span class="nb">echo</span> hello
<span class="go">hello</span>
</pre></div>
</div>
<p>Same conversion, but no format inference:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-convert -i ch-image -o squash foo/bar:latest /var/tmp/foobar.sqfs
<span class="go">input:   docker    foo/bar:latest</span>
<span class="go">output:  squashfs  /var/tmp/foobar.sqfs</span>
<span class="go">copying ...</span>
<span class="go">done</span>
</pre></div>
</div>
</section>
</section>
<section id="ch-fromhost">
<h2><a class="toc-backref" href="#id39"><span class="section-number">3.3. </span>ch-fromhost</a><a class="headerlink" href="#ch-fromhost" title="Permalink to this headline">¶</a></h2>
<p>Inject files from the host into an image directory, with various magic.</p>
<section id="id3">
<h3><span class="section-number">3.3.1. </span>Synopsis<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-fromhost <span class="o">[</span>OPTION ...<span class="o">]</span> <span class="o">[</span>FILE_OPTION ...<span class="o">]</span> IMGDIR
</pre></div>
</div>
</section>
<section id="id4">
<h3><span class="section-number">3.3.2. </span>Description<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This command is experimental. Features may be incomplete and/or buggy.
Please report any issues you find, so we can fix them!</p>
</div>
<p>Inject files from the host into the Charliecloud image directory
<code class="code docutils literal notranslate"><span class="pre">IMGDIR</span></code>.</p>
<p>The purpose of this command is to inject files into a container image that are
necessary to run the container on a specific host; e.g., GPU libraries that
are tied to a specific kernel version. <strong>It is not a general copy-to-image
tool</strong>; see further discussion on use cases below. It should be run after
<code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> and before <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>. After invocation, the image is
no longer portable to other hosts.</p>
<p>Injection is not atomic; if an error occurs partway through injection, the
image is left in an undefined state. Injection is currently implemented using
a simple file copy, but that may change in the future.</p>
<p>By default, file paths that contain the strings <code class="code docutils literal notranslate"><span class="pre">/bin</span></code> or <code class="code docutils literal notranslate"><span class="pre">/sbin</span></code>
are assumed to be executables and placed in <code class="code docutils literal notranslate"><span class="pre">/usr/bin</span></code> within the
container. File paths that contain the strings <code class="code docutils literal notranslate"><span class="pre">/lib</span></code> or <code class="code docutils literal notranslate"><span class="pre">.so</span></code> are
assumed to be shared libraries and are placed in the first-priority directory
reported by <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code> (see <code class="code docutils literal notranslate"><span class="pre">--lib-path</span></code> below). Other files are
placed in the directory specified by <code class="code docutils literal notranslate"><span class="pre">--dest</span></code>.</p>
<p>If any shared libraries are injected, run <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code> inside the
container (using <code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">-w</span></code>) after injection.</p>
</section>
<section id="options">
<h3><span class="section-number">3.3.3. </span>Options<a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h3>
<section id="to-specify-which-files-to-inject">
<h4><span class="section-number">3.3.3.1. </span>To specify which files to inject<a class="headerlink" href="#to-specify-which-files-to-inject" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">-c</span></code>, <code class="code docutils literal notranslate"><span class="pre">--cmd</span> <span class="pre">CMD</span></code></dt><dd><p>Inject files listed in the standard output of command <code class="code docutils literal notranslate"><span class="pre">CMD</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-f</span></code>, <code class="code docutils literal notranslate"><span class="pre">--file</span> <span class="pre">FILE</span></code></dt><dd><p>Inject files listed in the file <code class="code docutils literal notranslate"><span class="pre">FILE</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-p</span></code>, <code class="code docutils literal notranslate"><span class="pre">--path</span> <span class="pre">PATH</span></code></dt><dd><p>Inject the file at <code class="code docutils literal notranslate"><span class="pre">PATH</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--cray-mpi</span></code></dt><dd><p>Cray-enable MPICH/OpenMPI installed inside the image. See important details
below.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--nvidia</span></code></dt><dd><p>Use <code class="code docutils literal notranslate"><span class="pre">nvidia-container-cli</span> <span class="pre">list</span></code> (from <code class="code docutils literal notranslate"><span class="pre">libnvidia-container</span></code>)
to find executables and libraries to inject.</p>
</dd>
</dl>
</div></blockquote>
<p>These can be repeated, and at least one must be specified.</p>
</section>
<section id="to-specify-the-destination-within-the-image">
<h4><span class="section-number">3.3.3.2. </span>To specify the destination within the image<a class="headerlink" href="#to-specify-the-destination-within-the-image" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">-d</span></code>, <code class="code docutils literal notranslate"><span class="pre">--dest</span> <span class="pre">DST</span></code></dt><dd><p>Place files specified later in directory <code class="code docutils literal notranslate"><span class="pre">IMGDIR/DST</span></code>, overriding the
inferred destination, if any. If a file’s destination cannot be inferred
and <code class="code docutils literal notranslate"><span class="pre">--dest</span></code> has not been specified, exit with an error. This can be
repeated to place files in varying destinations.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="additional-arguments">
<h4><span class="section-number">3.3.3.3. </span>Additional arguments<a class="headerlink" href="#additional-arguments" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">--lib-path</span></code></dt><dd><p>Print the guest destination path for shared libraries inferred as
described above.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-ldconfig</span></code></dt><dd><p>Don’t run <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code> even if we appear to have injected shared
libraries.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-h</span></code>, <code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt><dd><p>Print help and exit.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-v</span></code>, <code class="code docutils literal notranslate"><span class="pre">--verbose</span></code></dt><dd><p>List the injected files.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt><dd><p>Print version and exit.</p>
</dd>
</dl>
</div></blockquote>
</section>
</section>
<section id="when-to-use-ch-fromhost">
<h3><span class="section-number">3.3.4. </span>When to use <code class="code docutils literal notranslate"><span class="pre">ch-fromhost</span></code><a class="headerlink" href="#when-to-use-ch-fromhost" title="Permalink to this headline">¶</a></h3>
<p>This command does a lot of heuristic magic; while it <em>can</em> copy arbitrary
files into an image, this usage is discouraged and prone to error. Here are
some use cases and the recommended approach:</p>
<ol class="arabic simple">
<li><p><em>I have some files on my build host that I want to include in the image.</em>
Use the <code class="code docutils literal notranslate"><span class="pre">COPY</span></code> instruction within your Dockerfile. Note that it’s OK
to build an image that meets your specific needs but isn’t generally
portable, e.g., only runs on specific micro-architectures you’re using.</p></li>
<li><p><em>I have an already built image and want to install a program I compiled
separately into the image.</em> Consider whether a building a new derived image
with a Dockerfile is appropriate. Another good option is to bind-mount the
directory containing your program at run time. A less good option is to
<code class="code docutils literal notranslate"><span class="pre">cp(1)</span></code> the program into your image, because this permanently alters
the image in a non-reproducible way.</p></li>
<li><p><em>I have some shared libraries that I need in the image for functionality or
performance, and they aren’t available in a place where I can use</em>
<code class="code docutils literal notranslate"><span class="pre">COPY</span></code>. This is the intended use case of <code class="code docutils literal notranslate"><span class="pre">ch-fromhost</span></code>. You can
use <code class="code docutils literal notranslate"><span class="pre">--cmd</span></code>, <code class="code docutils literal notranslate"><span class="pre">--file</span></code>, and/or <code class="code docutils literal notranslate"><span class="pre">--path</span></code> to put together a
custom solution. But, please consider filing an issue so we can package
your functionality with a tidy option like <code class="code docutils literal notranslate"><span class="pre">--cray-mpi</span></code> or
<code class="code docutils literal notranslate"><span class="pre">--nvidia</span></code>.</p></li>
</ol>
</section>
<section id="cray-mpi-dependencies-and-quirks">
<h3><span class="section-number">3.3.5. </span><code class="code docutils literal notranslate"><span class="pre">--cray-mpi</span></code> dependencies and quirks<a class="headerlink" href="#cray-mpi-dependencies-and-quirks" title="Permalink to this headline">¶</a></h3>
<p>The implementation of <code class="code docutils literal notranslate"><span class="pre">--cray-mpi</span></code> is messy, foul smelling, and brittle.
It replaces or overrides the MPICH or OpenMPI libraries installed in the
container. Users should be aware of the following.</p>
<ol class="arabic simple">
<li><p>Containers must have the following software installed:</p>
<ol class="loweralpha simple">
<li><p>Corresponding open source MPI implementation. (<a class="reference external" href="https://www.mpich.org/">MPICH</a> and <a class="reference external" href="https://www.open-mpi.org/">OpenMPI</a>.)</p></li>
<li><p><a class="reference external" href="https://github.com/hpc/patchelf">PatchELF with our patches</a>.
Use the <code class="code docutils literal notranslate"><span class="pre">shrink-soname</span></code> branch. (MPICH only.)</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">libgfortran.so.3</span></code>, because Cray’s <code class="code docutils literal notranslate"><span class="pre">libmpi.so.12</span></code>
links to it. (MPICH only.)</p></li>
</ol>
</li>
<li><p>Applications must be dynamically linked to <code class="code docutils literal notranslate"><span class="pre">libmpi.so.12</span></code> (not e.g.
<code class="code docutils literal notranslate"><span class="pre">libmpich.so.12</span></code>).</p>
<ol class="loweralpha simple">
<li><p>How to configure MPICH to accomplish this is not yet clear to us;
<code class="code docutils literal notranslate"><span class="pre">test/Dockerfile.mpich</span></code> does it, while the Debian packages do not.
(MPICH only.)</p></li>
</ol>
</li>
<li><p>An ABI compatible module for the given MPI implementation must be loaded
when <code class="code docutils literal notranslate"><span class="pre">ch-fromhost</span></code> is invoked.</p>
<ol class="loweralpha simple">
<li><p>Load the <code class="code docutils literal notranslate"><span class="pre">cray-mpich-abi</span></code> module. (MPICH only.)</p></li>
<li><p>We recommend loading the module of a version as close to what
is installed in the image as possible. This OpenMPI install needs to be
built such that libmpi contains all needed plugins (as opposed to them
being standalone shared libraries). See <a class="reference external" href="https://www.open-mpi.org/faq/?category=building">OpenMPI’s documentation</a> for how to do this.
(OpenMPI only.)</p></li>
</ol>
</li>
<li><p>Tested only for C programs compiled with GCC, and it probably won’t work
otherwise. If you’d like to use another compiler or another programming
language, please get in touch so we can implement the necessary support.</p></li>
</ol>
<p>Please file a bug if we missed anything above or if you know how to make the
code better.</p>
</section>
<section id="notes">
<h3><span class="section-number">3.3.6. </span>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h3>
<p>Symbolic links are dereferenced, i.e., the files pointed to are injected, not
the links themselves.</p>
<p>As a corollary, do not include symlinks to shared libraries. These will be
re-created by <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code>.</p>
<p>There are two alternate approaches for nVidia GPU libraries:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Link <code class="code docutils literal notranslate"><span class="pre">libnvidia-containers</span></code> into <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> and call the
library functions directly. However, this would mean that Charliecloud
would either (a) need to be compiled differently on machines with and
without nVidia GPUs or (b) have <code class="code docutils literal notranslate"><span class="pre">libnvidia-containers</span></code> available
even on machines without nVidia GPUs. Neither of these is consistent with
Charliecloud’s philosophies of simplicity and minimal dependencies.</p></li>
<li><p>Use <code class="code docutils literal notranslate"><span class="pre">nvidia-container-cli</span> <span class="pre">configure</span></code> to do the injecting. This
would require that containers have a half-started state, where the
namespaces are active and everything is mounted but <code class="code docutils literal notranslate"><span class="pre">pivot_root(2)</span></code>
has not been performed. This is not feasible because Charliecloud has no
notion of a half-started container.</p></li>
</ol>
</div></blockquote>
<p>Further, while these alternate approaches would simplify or eliminate this
script for nVidia GPUs, they would not solve the problem for other situations.</p>
</section>
<section id="bugs">
<h3><span class="section-number">3.3.7. </span>Bugs<a class="headerlink" href="#bugs" title="Permalink to this headline">¶</a></h3>
<p>File paths may not contain colons or newlines.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code> tends to print <code class="code docutils literal notranslate"><span class="pre">stat</span></code> errors; these are typically
non-fatal and occur when trying to probe common library paths. See <a class="reference external" href="https://github.com/hpc/charliecloud/issues/732">issue #732</a>.</p>
</section>
<section id="id5">
<h3><span class="section-number">3.3.8. </span>Examples<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>Place shared library <code class="code docutils literal notranslate"><span class="pre">/usr/lib64/libfoo.so</span></code> at path
<code class="code docutils literal notranslate"><span class="pre">/usr/lib/libfoo.so</span></code> (assuming <code class="code docutils literal notranslate"><span class="pre">/usr/lib</span></code> is the first directory
searched by the dynamic loader in the image), within the image
<code class="code docutils literal notranslate"><span class="pre">/var/tmp/baz</span></code> and executable <code class="code docutils literal notranslate"><span class="pre">/bin/bar</span></code> at path
<code class="code docutils literal notranslate"><span class="pre">/usr/bin/bar</span></code>. Then, create appropriate symlinks to <code class="code docutils literal notranslate"><span class="pre">libfoo</span></code> and
update the <code class="code docutils literal notranslate"><span class="pre">ld.so</span></code> cache.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cat qux.txt
<span class="go">/bin/bar</span>
<span class="go">/usr/lib64/libfoo.so</span>
<span class="gp">$</span> ch-fromhost --file qux.txt /var/tmp/baz
</pre></div>
</div>
<p>Same as above:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-fromhost --cmd <span class="s1">&#39;cat qux.txt&#39;</span> /var/tmp/baz
</pre></div>
</div>
<p>Same as above:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-fromhost --path /bin/bar --path /usr/lib64/libfoo.so /var/tmp/baz
</pre></div>
</div>
<p>Same as above, but place the files into <code class="code docutils literal notranslate"><span class="pre">/corge</span></code> instead (and the shared
library will not be found by <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-fromhost --dest /corge --file qux.txt /var/tmp/baz
</pre></div>
</div>
<p>Same as above, and also place file <code class="code docutils literal notranslate"><span class="pre">/etc/quux</span></code> at <code class="code docutils literal notranslate"><span class="pre">/etc/quux</span></code>
within the container:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-fromhost --file qux.txt --dest /etc --path /etc/quux /var/tmp/baz
</pre></div>
</div>
<p>Inject the executables and libraries recommended by nVidia into the image, and
then run <code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-fromhost --nvidia /var/tmp/baz
<span class="go">asking ldconfig for shared library destination</span>
<span class="go">/sbin/ldconfig: Can&#39;t stat /libx32: No such file or directory</span>
<span class="go">/sbin/ldconfig: Can&#39;t stat /usr/libx32: No such file or directory</span>
<span class="go">shared library destination: /usr/lib64//bind9-export</span>
<span class="go">injecting into image: /var/tmp/baz</span>
<span class="go">  /usr/bin/nvidia-smi -&gt; /usr/bin (inferred)</span>
<span class="go">  /usr/bin/nvidia-debugdump -&gt; /usr/bin (inferred)</span>
<span class="go">  /usr/bin/nvidia-persistenced -&gt; /usr/bin (inferred)</span>
<span class="go">  /usr/bin/nvidia-cuda-mps-control -&gt; /usr/bin (inferred)</span>
<span class="go">  /usr/bin/nvidia-cuda-mps-server -&gt; /usr/bin (inferred)</span>
<span class="go">  /usr/lib64/libnvidia-ml.so.460.32.03 -&gt; /usr/lib64//bind9-export (inferred)</span>
<span class="go">  /usr/lib64/libnvidia-cfg.so.460.32.03 -&gt; /usr/lib64//bind9-export (inferred)</span>
<span class="go">[...]</span>
<span class="go">  /usr/lib64/libGLESv2_nvidia.so.460.32.03 -&gt; /usr/lib64//bind9-export (inferred)</span>
<span class="go">  /usr/lib64/libGLESv1_CM_nvidia.so.460.32.03 -&gt; /usr/lib64//bind9-export (inferred)</span>
<span class="go">running ldconfig</span>
</pre></div>
</div>
<p>Inject the Cray-enabled MPI libraries into the image, and then run
<code class="code docutils literal notranslate"><span class="pre">ldconfig</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-fromhost --cray-mpi /var/tmp/baz
<span class="go">asking ldconfig for shared library destination</span>
<span class="go">/sbin/ldconfig: Can&#39;t stat /libx32: No such file or directory</span>
<span class="go">/sbin/ldconfig: Can&#39;t stat /usr/libx32: No such file or directory</span>
<span class="go">shared library destination: /usr/lib64//bind9-export</span>
<span class="go">found shared library: /usr/lib64/liblustreapi.so.1</span>
<span class="go">found shared library: /opt/cray/xpmem/default/lib64/libxpmem.so.0</span>
<span class="go">[...]</span>
<span class="go">injecting into image: /var/tmp/baz</span>
<span class="go">  rm -f /var/tmp/openmpi/usr/lib64//bind9-export/libopen-rte.so.40</span>
<span class="go">  rm -f /var/tmp/openmpi/usr/lib64/bind9-export/libopen-rte.so.40</span>
<span class="go">[...]</span>
<span class="go">  mkdir -p /var/tmp/openmpi/var/opt/cray/alps/spool</span>
<span class="go">  mkdir -p /var/tmp/openmpi/etc/opt/cray/wlm_detect</span>
<span class="go">[...]</span>
<span class="go">  /usr/lib64/liblustreapi.so.1 -&gt; /usr/lib64//bind9-export (inferred)</span>
<span class="go">  /opt/cray/xpmem/default/lib64/libxpmem.so.0 -&gt; /usr/lib64//bind9-export (inferred)</span>
<span class="go">[...]</span>
<span class="go">  /etc/opt/cray/wlm_detect/active_wlm -&gt; /etc/opt/cray/wlm_detect</span>
<span class="go">running ldconfig</span>
</pre></div>
</div>
</section>
<section id="acknowledgements">
<h3><span class="section-number">3.3.9. </span>Acknowledgements<a class="headerlink" href="#acknowledgements" title="Permalink to this headline">¶</a></h3>
<p>This command was inspired by the similar <a class="reference external" href="http://www.nersc.gov/research-and-development/user-defined-images/">Shifter</a> feature
that allows Shifter containers to use the Cray Aries network. We particularly
appreciate the help provided by Shane Canon and Doug Jacobsen during our
implementation of <code class="code docutils literal notranslate"><span class="pre">--cray-mpi</span></code>.</p>
<p>We appreciate the advice of Ryan Olson at nVidia on implementing
<code class="code docutils literal notranslate"><span class="pre">--nvidia</span></code>.</p>
</section>
</section>
<section id="ch-image">
<h2><a class="toc-backref" href="#id40"><span class="section-number">3.4. </span>ch-image</a><a class="headerlink" href="#ch-image" title="Permalink to this headline">¶</a></h2>
<p>Build and manage images; completely unprivileged.</p>
<section id="id6">
<h3><span class="section-number">3.4.1. </span>Synopsis<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> build <span class="o">[</span>-t TAG<span class="o">]</span> <span class="o">[</span>-f DOCKERFILE<span class="o">]</span> <span class="o">[</span>...<span class="o">]</span> CONTEXT
<span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> delete IMAGE_REF
<span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> import PATH IMAGE_REF
<span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> list <span class="o">[</span>IMAGE_REF<span class="o">]</span>
<span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> pull <span class="o">[</span>...<span class="o">]</span> IMAGE_REF <span class="o">[</span>IMAGE_DIR<span class="o">]</span>
<span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> push <span class="o">[</span>--image DIR<span class="o">]</span> IMAGE_REF <span class="o">[</span>DEST_REF<span class="o">]</span>
<span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> reset
<span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> storage-path
<span class="gp">$</span> ch-image <span class="o">{</span> --help <span class="p">|</span> --version <span class="p">|</span> --dependencies <span class="o">}</span>
</pre></div>
</div>
</section>
<section id="id7">
<h3><span class="section-number">3.4.2. </span>Description<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> is a tool for building and manipulating container images, but
not running them (for that you want <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>). It is completely
unprivileged, with no setuid/setgid/setcap helpers. The action to take is
specified by a sub-command.</p>
<p>Options that print brief information and then exit:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">-h</span></code>, <code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt><dd><p>Print help and exit successfully. If specified before the sub-command,
print general help and list of sub-commands; if after the sub-command,
print help specific to that sub-command.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--dependencies</span></code></dt><dd><p>Report dependency problems on standard output, if any, and exit. If all is
well, there is no output and the exit is successful; in case of problems,
the exit is unsuccessful.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt><dd><p>Print version number and exit successfully.</p>
</dd>
</dl>
</div></blockquote>
<p>Common options placed before the sub-command:</p>
<blockquote>
<div><dl>
<dt><code class="code docutils literal notranslate"><span class="pre">-a</span></code>, <code class="code docutils literal notranslate"><span class="pre">--arch</span> <span class="pre">ARCH</span></code></dt><dd><p>Use <code class="code docutils literal notranslate"><span class="pre">ARCH</span></code> for architecture-aware registry operations, currently
<code class="code docutils literal notranslate"><span class="pre">pull</span></code> and pulls done within <code class="code docutils literal notranslate"><span class="pre">build</span></code>. <code class="code docutils literal notranslate"><span class="pre">ARCH</span></code> can be:
(1) <code class="code docutils literal notranslate"><span class="pre">yolo</span></code>, to bypass architecture-aware code and use the
registry’s default architecture; (2) <code class="code docutils literal notranslate"><span class="pre">host</span></code>, to use the host’s
architecture, obtained with the equivalent of <code class="code docutils literal notranslate"><span class="pre">uname</span> <span class="pre">-m</span></code> (default
if <code class="code docutils literal notranslate"><span class="pre">--arch</span></code> not specified); or (3) an architecture name. If the
specified architecture is not available, the error message will list
which ones are.</p>
<p><strong>Notes:</strong></p>
<ol class="arabic simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> is limited to one image per image reference in
builder storage at a time, regardless of architecture. For example, if
you say <code class="code docutils literal notranslate"><span class="pre">ch-image</span> <span class="pre">pull</span> <span class="pre">--arch=foo</span> <span class="pre">baz</span></code> and then <code class="code docutils literal notranslate"><span class="pre">ch-image</span>
<span class="pre">pull</span> <span class="pre">--arch=bar</span> <span class="pre">baz</span></code>, builder storage will contain one image called
“baz”, with architecture “bar”.</p></li>
<li><p>Images’ default architecture is usually <code class="code docutils literal notranslate"><span class="pre">amd64</span></code>, so this is
usually what you get with <code class="code docutils literal notranslate"><span class="pre">--arch=yolo</span></code>. Similarly, if a
registry image is architecture-unaware, it will still be pulled with
<code class="code docutils literal notranslate"><span class="pre">--arch=amd64</span></code> and <code class="code docutils literal notranslate"><span class="pre">--arch=host</span></code> on x86-64 hosts (other
host architectures must specify <code class="code docutils literal notranslate"><span class="pre">--arch=yolo</span></code> to pull
architecture-unaware images).</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">uname</span> <span class="pre">-m</span></code> and image registries often use different names for
the same architecture. For example, what <code class="code docutils literal notranslate"><span class="pre">uname</span> <span class="pre">-m</span></code> reports as
“x86_64” is known to registries as “amd64”. <code class="code docutils literal notranslate"><span class="pre">--arch=host</span></code> should
translate if needed, but it’s useful to know this is happening.
Directly specified architecture names are passed to the registry
without translation.</p></li>
<li><p>Registries treat architecture as a pair of items, architecture and
sometimes variant (e.g., “arm” and “v7”). Charliecloud treats
architecture as a simple string and converts to/from the registry view
transparently.</p></li>
</ol>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-cache</span></code></dt><dd><p>Download everything needed, ignoring the cache.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--password-many</span></code></dt><dd><p>Re-prompt the user every time a registry password is needed.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-s</span></code>, <code class="code docutils literal notranslate"><span class="pre">--storage</span> <span class="pre">DIR</span></code></dt><dd><p>Set the storage directory (see below for important details).</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--tls-no-verify</span></code></dt><dd><p>Don’t verify TLS certificates of the repository. (Do not use this option
unless you understand the risks.)</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-v</span></code>, <code class="code docutils literal notranslate"><span class="pre">--verbose</span></code></dt><dd><p>Print extra chatter; can be repeated.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="authentication">
<h3><span class="section-number">3.4.3. </span>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h3>
<p>If the remote repository needs authentication, Charliecloud will prompt you
for a username and password. Note that some repositories call the secret
something other than “password”; e.g., GitLab calls it a “personal access
token (PAT)”.</p>
<p>These values are remembered for the life of the process and silently
re-offered to the registry if needed. One case when this happens is on push to
a private registry: many registries will first offer a read-only token when
<code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> checks if something exists, then re-authenticate when
upgrading the token to read-write for upload. If your site uses one-time
passwords such as provided by a security device, you can specify
<code class="code docutils literal notranslate"><span class="pre">--password-many</span></code> to provide a new secret each time.</p>
<p>These values are not saved persistently, e.g. in a file. Note that we do use
normal Python variables for this information, without pinning them into
physical RAM with <a class="reference external" href="https://man7.org/linux/man-pages/man2/mlock.2.html">mlock(2)</a> or any other special
treatment, so we cannot guarantee they will never reach non-volatile storage.</p>
<p>There is no separate <code class="code docutils literal notranslate"><span class="pre">login</span></code> subcommand like Docker. For non-interactive
authentication, you can use environment variables <code class="code docutils literal notranslate"><span class="pre">CH_IMAGE_USERNAME</span></code>
and <code class="code docutils literal notranslate"><span class="pre">CH_IMAGE_PASSWORD</span></code>. Only do this if you fully understand the
implications for your specific use case, because it is difficult to securely
store secrets in environment variables.</p>
</section>
<section id="storage-directory">
<h3><span class="section-number">3.4.4. </span>Storage directory<a class="headerlink" href="#storage-directory" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> maintains state using normal files and directories located in
its <em>storage directory</em>; contents include temporary images used for building
and various caches.</p>
<p>In descending order of priority, this directory is located at:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">-s</span></code>, <code class="code docutils literal notranslate"><span class="pre">--storage</span> <span class="pre">DIR</span></code></dt><dd><p>Command line option.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">$CH_IMAGE_STORAGE</span></code></dt><dd><p>Environment variable.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">/var/tmp/$USER.ch</span></code></dt><dd><p>Default. (Previously, the default was <code class="code docutils literal notranslate"><span class="pre">/var/tmp/$USER/ch-image</span></code>. If
a valid storage directory is found at the old default path,
<code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> tries to move it to the new default path.)</p>
</dd>
</dl>
</div></blockquote>
<p>Unlike many container implementations, there is no notion of storage drivers,
graph drivers, etc., to select and/or configure.</p>
<p>The storage directory can reside on any filesystem. However, it contains lots
of small files and metadata traffic can be intense. For example, the
Charliecloud test suite uses approximately 400,000 files and directories in
the storage directory as of this writing. Place it on a filesystem appropriate
for this; tmpfs’es such as <code class="code docutils literal notranslate"><span class="pre">/var/tmp</span></code> are a good choice if you have
enough RAM (<code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> is not recommended because <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> bind-mounts
it into containers by default).</p>
<p>While you can currently poke around in the storage directory and find unpacked
images runnable with <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>, this is not a supported use case. The
supported workflow uses <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> to obtain a packed image; see the
tutorial for details.</p>
<p>The storage directory format changes on no particular schedule. Often
<code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> is able to upgrade the directory; however, downgrading is not
supported and sometimes upgrade is not possible. In these cases,
<code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> will refuse to run until you delete and re-initialize the
directory with <code class="code docutils literal notranslate"><span class="pre">ch-image</span> <span class="pre">reset</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Network filesystems, especially Lustre, are typically bad choices for the
storage directory. This is a site-specific question and your local support
will likely have strong opinions.</p>
</div>
</section>
<section id="build">
<h3><span class="section-number">3.4.5. </span><code class="code docutils literal notranslate"><span class="pre">build</span></code><a class="headerlink" href="#build" title="Permalink to this headline">¶</a></h3>
<p>Build an image from a Dockerfile and put it in the storage directory.</p>
<section id="id8">
<h4><span class="section-number">3.4.5.1. </span>Synopsis<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> build <span class="o">[</span>-t TAG<span class="o">]</span> <span class="o">[</span>-f DOCKERFILE<span class="o">]</span> <span class="o">[</span>...<span class="o">]</span> CONTEXT
</pre></div>
</div>
</section>
<section id="id9">
<h4><span class="section-number">3.4.5.2. </span>Description<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>Uses <code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">-w</span> <span class="pre">-u0</span> <span class="pre">-g0</span> <span class="pre">--no-home</span> <span class="pre">--no-passwd</span></code> to execute <code class="code docutils literal notranslate"><span class="pre">RUN</span></code>
instructions. Note that <code class="code docutils literal notranslate"><span class="pre">FROM</span></code> implicitly pulls the base image if
needed, so you may want to read about the <code class="code docutils literal notranslate"><span class="pre">pull</span></code> subcommand below as
well.</p>
<p>Required argument:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">CONTEXT</span></code></dt><dd><p>Path to context directory. This is the root of <code class="code docutils literal notranslate"><span class="pre">COPY</span></code> instructions
in the Dockerfile. If a single hyphen (<code class="code docutils literal notranslate"><span class="pre">-</span></code>) is specified: (a) read
the Dockerfile from standard input, (b) specifying <code class="code docutils literal notranslate"><span class="pre">--file</span></code> is an
error, and (c) there is no context, so <code class="code docutils literal notranslate"><span class="pre">COPY</span></code> will fail. (See
<code class="code docutils literal notranslate"><span class="pre">--file</span></code> for how to provide the Dockerfile on standard input while
also having a context.)</p>
</dd>
</dl>
</div></blockquote>
<p>Options:</p>
<blockquote>
<div><dl>
<dt><code class="code docutils literal notranslate"><span class="pre">-b</span></code>, <code class="code docutils literal notranslate"><span class="pre">--bind</span> <span class="pre">SRC[:DST]</span></code></dt><dd><p>For <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instructions only, bind-mount <code class="code docutils literal notranslate"><span class="pre">SRC</span></code> at guest
<code class="code docutils literal notranslate"><span class="pre">DST</span></code>. The default destination if not specified is to use the same
path as the host; i.e., the default is equivalent to
<code class="code docutils literal notranslate"><span class="pre">--bind=SRC:SRC</span></code>. If <code class="code docutils literal notranslate"><span class="pre">DST</span></code> does not exist, try to create it as
an empty directory, though images do have ten directories
<code class="code docutils literal notranslate"><span class="pre">/mnt/[0-9]</span></code> already available as mount points. Can be repeated.</p>
<p><strong>Note:</strong> See documentation for <code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">--bind</span></code> for important
caveats and gotchas.</p>
<p><strong>Note:</strong> Other instructions that modify the image filesystem, e.g.
<code class="code docutils literal notranslate"><span class="pre">COPY</span></code>, can only access host files from the context directory,
regardless of this option.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--build-arg</span> <span class="pre">KEY[=VALUE]</span></code></dt><dd><p>Set build-time variable <code class="code docutils literal notranslate"><span class="pre">KEY</span></code> defined by <code class="code docutils literal notranslate"><span class="pre">ARG</span></code> instruction
to <code class="code docutils literal notranslate"><span class="pre">VALUE</span></code>. If <code class="code docutils literal notranslate"><span class="pre">VALUE</span></code> not specified, use the value of
environment variable <code class="code docutils literal notranslate"><span class="pre">KEY</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-f</span></code>, <code class="code docutils literal notranslate"><span class="pre">--file</span> <span class="pre">DOCKERFILE</span></code></dt><dd><p>Use <code class="code docutils literal notranslate"><span class="pre">DOCKERFILE</span></code> instead of <code class="code docutils literal notranslate"><span class="pre">CONTEXT/Dockerfile</span></code>. If a single
hyphen (<code class="code docutils literal notranslate"><span class="pre">-</span></code>) is specified, read the Dockerfile from standard input;
like <code class="code docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code>, the context directory is still available in
this case.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--force</span></code></dt><dd><p>Inject the unprivileged build workarounds; see discussion later in this
section for details on what this does and when you might need it. If a
build fails and <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> thinks <code class="code docutils literal notranslate"><span class="pre">--force</span></code> would help, it
will suggest it.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-n</span></code>, <code class="code docutils literal notranslate"><span class="pre">--dry-run</span></code></dt><dd><p>Don’t actually execute any Dockerfile instructions.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-force-detect</span></code></dt><dd><p>Don’t try to detect if the workarounds in <code class="code docutils literal notranslate"><span class="pre">--force</span></code> would help.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--parse-only</span></code></dt><dd><p>Stop after parsing the Dockerfile.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-t</span></code>, <code class="code docutils literal notranslate"><span class="pre">--tag</span> <span class="pre">TAG</span></code></dt><dd><p>Name of image to create. If not specified, infer the name:</p>
<ol class="arabic simple">
<li><p>If Dockerfile named <code class="code docutils literal notranslate"><span class="pre">Dockerfile</span></code> with an extension: use the
extension with invalid characters stripped, e.g.
<code class="code docutils literal notranslate"><span class="pre">Dockerfile.&#64;FOO.bar</span></code> → <code class="code docutils literal notranslate"><span class="pre">foo.bar</span></code>.</p></li>
<li><p>If Dockerfile has extension <code class="code docutils literal notranslate"><span class="pre">dockerfile</span></code>: use the basename with
the same transformation, e.g. <code class="code docutils literal notranslate"><span class="pre">baz.&#64;QUX.dockerfile</span></code> -&gt;
<code class="code docutils literal notranslate"><span class="pre">baz.qux</span></code>.</p></li>
<li><p>If context directory is not <code class="code docutils literal notranslate"><span class="pre">/</span></code>: use its name, i.e. the last
component of the absolute path to the context directory, with the same
transformation,</p></li>
<li><p>Otherwise (context directory is <code class="code docutils literal notranslate"><span class="pre">/</span></code>): use <code class="code docutils literal notranslate"><span class="pre">root</span></code>.</p></li>
</ol>
<p>If no colon present in the name, append <code class="code docutils literal notranslate"><span class="pre">:latest</span></code>.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="privilege-model">
<h4><span class="section-number">3.4.5.3. </span>Privilege model<a class="headerlink" href="#privilege-model" title="Permalink to this headline">¶</a></h4>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> is a <em>fully</em> unprivileged image builder. It does not use any
setuid or setcap helper programs, and it does not use configuration files
<code class="code docutils literal notranslate"><span class="pre">/etc/subuid</span></code> or <code class="code docutils literal notranslate"><span class="pre">/etc/subgid</span></code>. This contrasts with the “rootless”
or “<a class="reference external" href="https://sylabs.io/guides/3.7/user-guide/fakeroot.html">fakeroot</a>” modes
of some competing builders, which do require privileged supporting code or
utilities.</p>
<p>This approach does yield some quirks. We provide built-in workarounds that
should mostly work (i.e., <code class="code docutils literal notranslate"><span class="pre">--force</span></code>), but it can be helpful to
understand what is going on.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> executes all instructions as the normal user who invokes it.
For <code class="code docutils literal notranslate"><span class="pre">RUN</span></code>, this is accomplished with <code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">-w</span> <span class="pre">--uid=0</span> <span class="pre">--gid=0</span></code>
(and some other arguments), i.e., your host EUID and EGID both mapped to zero
inside the container, and only one UID (zero) and GID (zero) are available
inside the container. Under this arrangement, processes running in the
container for each <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> <em>appear</em> to be running as root, but many
privileged system calls will fail without the workarounds described below.
<strong>This affects any fully unprivileged container build, not just
Charliecloud.</strong></p>
<p>The most common time to see this is installing packages. For example, here is
RPM failing to <code class="code docutils literal notranslate"><span class="pre">chown(2)</span></code> a file, which makes the package update fail:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  Updating   : 1:dbus-1.10.24-13.el7_6.x86_64                            2/4
Error unpacking rpm package 1:dbus-1.10.24-13.el7_6.x86_64
error: unpacking of archive failed on file /usr/libexec/dbus-1/dbus-daemon-launch-helper;5cffd726: cpio: chown
  Cleanup    : 1:dbus-libs-1.10.24-12.el7.x86_64                         3/4
error: dbus-1:1.10.24-13.el7_6.x86_64: install failed
</pre></div>
</div>
<p>This one is (ironically) <code class="code docutils literal notranslate"><span class="pre">apt-get</span></code> failing to drop privileges:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>E: setgroups 65534 failed - setgroups (1: Operation not permitted)
E: setegid 65534 failed - setegid (22: Invalid argument)
E: seteuid 100 failed - seteuid (22: Invalid argument)
E: setgroups 0 failed - setgroups (1: Operation not permitted)
</pre></div>
</div>
<p>By default, nothing is done to avoid these problems, though <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code>
does try to detect if the workarounds could help. <code class="code docutils literal notranslate"><span class="pre">--force</span></code> activates
the workarounds: <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> injects extra commands to intercept these
system calls and fake a successful result, using <code class="code docutils literal notranslate"><span class="pre">fakeroot(1)</span></code>. There
are three basic steps:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>After <code class="code docutils literal notranslate"><span class="pre">FROM</span></code>, analyze the image to see what distribution it
contains, which determines the specific workarounds.</p></li>
<li><p>Before the user command in the first <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instruction where the
injection seems needed, install <code class="code docutils literal notranslate"><span class="pre">fakeroot(1)</span></code> in the image, if one
is not already installed, as well as any other necessary initialization
commands. For example, we turn off the <code class="code docutils literal notranslate"><span class="pre">apt</span></code> sandbox (for Debian
Buster) and configure EPEL but leave it disabled (for CentOS/RHEL).</p></li>
<li><p>Prepend <code class="code docutils literal notranslate"><span class="pre">fakeroot</span></code> to <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> instructions that seem to need
it, e.g. ones that contain <code class="code docutils literal notranslate"><span class="pre">apt</span></code>, <code class="code docutils literal notranslate"><span class="pre">apt-get</span></code>, <code class="code docutils literal notranslate"><span class="pre">dpkg</span></code> for
Debian derivatives and <code class="code docutils literal notranslate"><span class="pre">dnf</span></code>, <code class="code docutils literal notranslate"><span class="pre">rpm</span></code>, or <code class="code docutils literal notranslate"><span class="pre">yum</span></code> for
RPM-based distributions.</p></li>
</ol>
</div></blockquote>
<p>The details are specific to each distribution. <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> analyzes image
content (e.g., grepping <code class="code docutils literal notranslate"><span class="pre">/etc/debian_version</span></code>) to select a
configuration; see <code class="code docutils literal notranslate"><span class="pre">lib/fakeroot.py</span></code> for details. <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code>
prints exactly what it is doing.</p>
</section>
<section id="compatibility-with-other-dockerfile-interpreters">
<h4><span class="section-number">3.4.5.4. </span>Compatibility with other Dockerfile interpreters<a class="headerlink" href="#compatibility-with-other-dockerfile-interpreters" title="Permalink to this headline">¶</a></h4>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> is an independent implementation and shares no code with
other Dockerfile interpreters. It uses a formal Dockerfile parsing grammar
developed from the <a class="reference external" href="https://docs.docker.com/engine/reference/builder/">Dockerfile reference documentation</a> and miscellaneous other
sources, which you can examine in the source code.</p>
<p>We believe this independence is valuable for several reasons. First, it helps
the community examine Dockerfile syntax and semantics critically, think
rigorously about what is really needed, and build a more robust standard.
Second, it yields disjoint sets of bugs (note that Podman, Buildah, and Docker
all share the same Dockerfile parser). Third, because it is a much smaller
code base, it illustrates how Dockerfiles work more clearly. Finally, it
allows straightforward extensions if needed to support scientific computing.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> tries hard to be compatible with Docker and other
interpreters, though as an independent implementation, it is not
bug-compatible.</p>
<p>The following subsections describe differences from the Dockerfile reference
that we expect to be approximately permanent. For not-yet-implemented features
and bugs in this area, see <a class="reference external" href="https://github.com/hpc/charliecloud/issues?q=is%3Aissue+is%3Aopen+sort%3Aupdated-desc+label%3Aimage">related issues</a>
on GitHub.</p>
<p>None of these are set in stone. We are very interested in feedback on our
assessments and open questions. This helps us prioritize new features and
revise our thinking about what is needed for HPC containers.</p>
<section id="context-directory">
<h5><span class="section-number">3.4.5.4.1. </span>Context directory<a class="headerlink" href="#context-directory" title="Permalink to this headline">¶</a></h5>
<p>The context directory is bind-mounted into the build, rather than copied like
Docker. Thus, the size of the context is immaterial, and the build reads
directly from storage like any other local process would. However, you still
can’t access anything outside the context directory.</p>
</section>
<section id="variable-substitution">
<h5><span class="section-number">3.4.5.4.2. </span>Variable substitution<a class="headerlink" href="#variable-substitution" title="Permalink to this headline">¶</a></h5>
<p>Variable substitution happens for <em>all</em> instructions, not just the ones listed
in the Dockerfile reference.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ARG</span></code> and <code class="code docutils literal notranslate"><span class="pre">ENV</span></code> cause cache misses upon <em>definition</em>, in contrast
with Docker where these variables miss upon <em>use</em>, except for certain
cache-excluded variables that never cause misses, listed below.</p>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> passes the following proxy environment variables in to the
build. Changes to these variables do not cause a cache miss. They do not
require an <code class="code docutils literal notranslate"><span class="pre">ARG</span></code> instruction, as <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#predefined-args">documented</a> in the
Dockerfile reference. Unlike Docker, they are available if the same-named
environment variable is defined; <code class="code docutils literal notranslate"><span class="pre">--build-arg</span></code> is not required.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>HTTP_PROXY
http_proxy
HTTPS_PROXY
https_proxy
FTP_PROXY
ftp_proxy
NO_PROXY
no_proxy
</pre></div>
</div>
<p>In addition to those listed in the Dockerfile reference, these environment
variables are passed through in the same way:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>SSH_AUTH_SOCK
USER
</pre></div>
</div>
<p>Finally, these variables are also pre-defined but are unrelated to the host
environment:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">PATH</span><span class="o">=</span>/ch/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
<span class="nv">TAR_OPTIONS</span><span class="o">=</span>--no-same-owner
</pre></div>
</div>
<p>Note that <code class="code docutils literal notranslate"><span class="pre">ARG</span></code> and <code class="code docutils literal notranslate"><span class="pre">ENV</span></code> have different syntax despite very
similar semantics.</p>
</section>
<section id="copy">
<h5><span class="section-number">3.4.5.4.3. </span><code class="code docutils literal notranslate"><span class="pre">COPY</span></code><a class="headerlink" href="#copy" title="Permalink to this headline">¶</a></h5>
<p>Especially for people used to UNIX <code class="code docutils literal notranslate"><span class="pre">cp(1)</span></code>, the semantics of the
Dockerfile <code class="code docutils literal notranslate"><span class="pre">COPY</span></code> instruction can be confusing.</p>
<p>Most notably, when a source of the copy is a directory, the <em>contents</em> of that
directory, not the directory itself, are copied. This is documented, but it’s
a real gotcha because that’s not what <code class="code docutils literal notranslate"><span class="pre">cp(1)</span></code> does, and it means that
many things you can do in one <code class="code docutils literal notranslate"><span class="pre">cp(1)</span></code> command require multiple
<code class="code docutils literal notranslate"><span class="pre">COPY</span></code> instructions.</p>
<p>Also, the reference documentation is incomplete. In our experience, Docker
also behaves as follows; <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> does the same in an attempt to be
bug-compatible.</p>
<ol class="arabic">
<li><p>You can use absolute paths in the source; the root is the context
directory.</p></li>
<li><p>Destination directories are created if they don’t exist in the following
situations:</p>
<ol class="arabic simple">
<li><p>If the destination path ends in slash. (Documented.)</p></li>
<li><p>If the number of sources is greater than 1, either by wildcard or
explicitly, regardless of whether the destination ends in slash. (Not
documented.)</p></li>
<li><p>If there is a single source and it is a directory. (Not documented.)</p></li>
</ol>
</li>
<li><p>Symbolic links behave differently depending on how deep in the copied tree
they are. (Not documented.)</p>
<ol class="arabic simple">
<li><p>Symlinks at the top level — i.e., named as the destination or the
source, either explicitly or by wildcards — are dereferenced. They are
followed, and whatever they point to is used as the destination or
source, respectively.</p></li>
<li><p>Symlinks at deeper levels are not dereferenced, i.e., the symlink
itself is copied.</p></li>
</ol>
</li>
<li><p>If a directory appears at the same path in source and destination, and is
at the 2nd level or deeper, the source directory’s metadata (e.g.,
permissions) are copied to the destination directory. (Not documented.)</p></li>
<li><p>If an object appears in both the source and destination, and is at the 2nd
level or deeper, and is of different types in the source and destination,
then the source object will overwrite the destination object. (Not
documented.) For example, if <code class="code docutils literal notranslate"><span class="pre">/tmp/foo/bar</span></code> is a regular file, and
<code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> is the context directory, then the following Dockerfile
snippet will result in a <em>file</em> in the container at <code class="code docutils literal notranslate"><span class="pre">/foo/bar</span></code>
(copied from <code class="code docutils literal notranslate"><span class="pre">/tmp/foo/bar</span></code>); the directory and all its contents will
be lost.</p>
<blockquote>
<div><div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">RUN</span> mkdir -p /foo/bar <span class="o">&amp;&amp;</span> touch /foo/bar/baz
<span class="k">COPY</span> foo /foo
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<p>We expect the following differences to be permanent:</p>
<ul class="simple">
<li><p>Wildcards use Python glob semantics, not the Go semantics.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">COPY</span> <span class="pre">--chown</span></code> is ignored, because it doesn’t make sense in an
unprivileged build.</p></li>
</ul>
</section>
<section id="features-we-do-not-plan-to-support">
<h5><span class="section-number">3.4.5.4.4. </span>Features we do not plan to support<a class="headerlink" href="#features-we-do-not-plan-to-support" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p>Parser directives are not supported. We have not identified a need for any
of them.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">EXPOSE</span></code>: Charliecloud does not use the network namespace, so
containerized processes can simply listen on a host port like other
unprivileged processes.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">HEALTHCHECK</span></code>: This instruction’s main use case is monitoring server
processes rather than applications. Also, implementing it requires a
container supervisor daemon, which we have no plans to add.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">MAINTAINER</span></code> is deprecated.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">STOPSIGNAL</span></code> requires a container supervisor daemon process, which we
have no plans to add.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">USER</span></code> does not make sense for unprivileged builds.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">VOLUME</span></code>: This instruction is not currently supported. Charliecloud
has good support for bind mounts; we anticipate that it will continue to
focus on that and will not introduce the volume management features that
Docker has.</p></li>
</ul>
</section>
</section>
<section id="id10">
<h4><span class="section-number">3.4.5.5. </span>Examples<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p>Build image <code class="code docutils literal notranslate"><span class="pre">bar</span></code> using <code class="code docutils literal notranslate"><span class="pre">./foo/bar/Dockerfile</span></code> and context
directory <code class="code docutils literal notranslate"><span class="pre">./foo/bar</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image build -t bar -f ./foo/bar/Dockerfile ./foo/bar
<span class="go">[...]</span>
<span class="go">grown in 4 instructions: bar</span>
</pre></div>
</div>
<p>Same, but infer the image name and Dockerfile from the context directory
path:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image build ./foo/bar
<span class="go">[...]</span>
<span class="go">grown in 4 instructions: bar</span>
</pre></div>
</div>
<p>Build using humongous vendor compilers you want to bind-mount instead of
installing into the image:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image build --bind /opt/bigvendor:/opt .
<span class="gp">$</span> cat Dockerfile
<span class="go">FROM centos:7</span>

<span class="go">RUN /opt/bin/cc hello.c</span>
<span class="gp">#</span>COPY /opt/lib/*.so /usr/local/lib   <span class="c1"># fail: COPY doesn&#39;t bind mount</span>
<span class="go">RUN cp /opt/lib/*.so /usr/local/lib  # possible workaround</span>
<span class="go">RUN ldconfig</span>
</pre></div>
</div>
</section>
</section>
<section id="delete">
<h3><span class="section-number">3.4.6. </span><code class="code docutils literal notranslate"><span class="pre">delete</span></code><a class="headerlink" href="#delete" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> delete IMAGE_REF
</pre></div>
</div>
<p>Delete the image described by the image reference <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code> from the
storage directory.</p>
</section>
<section id="list">
<h3><span class="section-number">3.4.7. </span><code class="code docutils literal notranslate"><span class="pre">list</span></code><a class="headerlink" href="#list" title="Permalink to this headline">¶</a></h3>
<p>Print information about images. If no argument given, list the images in
builder storage.</p>
<section id="id11">
<h4><span class="section-number">3.4.7.1. </span>Synopsis<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> list <span class="o">[</span>IMAGE_REF<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="id12">
<h4><span class="section-number">3.4.7.2. </span>Description<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p>Optional argument:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code></dt><dd><p>Print details of what’s known about <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code>, both locally and in
the remote registry, if any.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="id13">
<h4><span class="section-number">3.4.7.3. </span>Examples<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p>List images in builder storage:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image list
<span class="go">alpine:3.9 (amd64)</span>
<span class="go">alpine:latest (amd64)</span>
<span class="go">debian:buster (amd64)</span>
</pre></div>
</div>
<p>Print details about Debian Buster image:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image list debian:buster
<span class="go">details of image:    debian:buster</span>
<span class="go">in local storage:    no</span>
<span class="go">full remote ref:     registry-1.docker.io:443/library/debian:buster</span>
<span class="go">available remotely:  yes</span>
<span class="go">remote arch-aware:   yes</span>
<span class="go">host architecture:   amd64</span>
<span class="go">archs available:     386 amd64 arm/v5 arm/v7 arm64/v8 mips64le ppc64le s390x</span>
</pre></div>
</div>
</section>
</section>
<section id="import">
<h3><span class="section-number">3.4.8. </span><code class="code docutils literal notranslate"><span class="pre">import</span></code><a class="headerlink" href="#import" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> import PATH IMAGE_REF
</pre></div>
</div>
<p>Copy the image at <code class="code docutils literal notranslate"><span class="pre">PATH</span></code> into builder storage with name
<code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code>. <code class="code docutils literal notranslate"><span class="pre">PATH</span></code> can be:</p>
<ul class="simple">
<li><p>an image directory</p></li>
<li><p>a tarball with no top-level directory (a.k.a. a “<a class="reference external" href="https://en.wikipedia.org/wiki/Tar_(computing)#Tarbomb">tarbomb</a>”)</p></li>
<li><p>a standard tarball with one top-level directory</p></li>
</ul>
<p>If the imported image contains Charliecloud metadata, that will be imported
unchanged, i.e., images exported from <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> builder storage will be
functionally identical when re-imported.</p>
</section>
<section id="pull">
<h3><span class="section-number">3.4.9. </span><code class="code docutils literal notranslate"><span class="pre">pull</span></code><a class="headerlink" href="#pull" title="Permalink to this headline">¶</a></h3>
<p>Pull the image described by the image reference <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code> from a
repository to the local filesystem.</p>
<section id="id14">
<h4><span class="section-number">3.4.9.1. </span>Synopsis<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> pull <span class="o">[</span>...<span class="o">]</span> IMAGE_REF <span class="o">[</span>IMAGE_DIR<span class="o">]</span>
</pre></div>
</div>
<p>See the FAQ for the gory details on specifying image references.</p>
</section>
<section id="id15">
<h4><span class="section-number">3.4.9.2. </span>Description<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<p>Destination:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">IMAGE_DIR</span></code></dt><dd><p>If specified, place the unpacked image at this path; it is then ready for
use by <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> or other tools. The storage directory will not
contain a copy of the image, i.e., it is only unpacked once.</p>
</dd>
</dl>
</div></blockquote>
<p>Options:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">--last-layer</span> <span class="pre">N</span></code></dt><dd><p>Unpack only <code class="code docutils literal notranslate"><span class="pre">N</span></code> layers, leaving an incomplete image. This option is
intended for debugging.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--parse-only</span></code></dt><dd><p>Parse <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code>, print a parse report, and exit successfully
without talking to the internet or touching the storage directory.</p>
</dd>
</dl>
</div></blockquote>
<p>This script does a fair amount of validation and fixing of the layer tarballs
before flattening in order to support unprivileged use despite image problems
we frequently see in the wild. For example, device files are ignored, and file
and directory permissions are increased to a minimum of <code class="code docutils literal notranslate"><span class="pre">rwx------</span></code> and
<code class="code docutils literal notranslate"><span class="pre">rw-------</span></code> respectively. Note, however, that symlinks pointing outside
the image are permitted, because they are not resolved until runtime within a
container.</p>
<p>The following metadata in the pulled image is retained; all other metadata is
currently ignored. (If you have a need for additional metadata, please let us
know!)</p>
<blockquote>
<div><ul class="simple">
<li><p>Current working directory set with <code class="code docutils literal notranslate"><span class="pre">WORKDIR</span></code> is effective in
downstream Dockerfiles.</p></li>
<li><p>Environment variables set with <code class="code docutils literal notranslate"><span class="pre">ENV</span></code> are effective in downstream
Dockerfiles and also written to <code class="code docutils literal notranslate"><span class="pre">/ch/environment</span></code> for use in
<code class="code docutils literal notranslate"><span class="pre">ch-run</span> <span class="pre">--set-env</span></code>.</p></li>
<li><p>Mount point directories specified with <code class="code docutils literal notranslate"><span class="pre">VOLUME</span></code> are created in the
image if they don’t exist, but no other action is taken.</p></li>
</ul>
</div></blockquote>
<p>Note that some images (e.g., those with a “version 1 manifest”) do not contain
metadata. A warning is printed in this case.</p>
</section>
<section id="id16">
<h4><span class="section-number">3.4.9.3. </span>Examples<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<p>Download the Debian Buster image matching the host’s architecture and place it
in the storage directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> uname -m
<span class="go">aarch32</span>
<span class="go">pulling image:    debian:buster</span>
<span class="go">requesting arch:  arm64/v8</span>
<span class="go">manifest list: downloading</span>
<span class="go">manifest: downloading</span>
<span class="go">config: downloading</span>
<span class="go">layer 1/1: c54d940: downloading</span>
<span class="go">flattening image</span>
<span class="go">layer 1/1: c54d940: listing</span>
<span class="go">validating tarball members</span>
<span class="go">resolving whiteouts</span>
<span class="go">layer 1/1: c54d940: extracting</span>
<span class="go">image arch: arm64</span>
<span class="go">done</span>
</pre></div>
</div>
<p>Same, specifying the architecture explicitly:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image --arch<span class="o">=</span>arm/v7 pull debian:buster
<span class="go">pulling image:    debian:buster</span>
<span class="go">requesting arch:  arm/v7</span>
<span class="go">manifest list: downloading</span>
<span class="go">manifest: downloading</span>
<span class="go">config: downloading</span>
<span class="go">layer 1/1: 8947560: downloading</span>
<span class="go">flattening image</span>
<span class="go">layer 1/1: 8947560: listing</span>
<span class="go">validating tarball members</span>
<span class="go">resolving whiteouts</span>
<span class="go">layer 1/1: 8947560: extracting</span>
<span class="go">image arch: arm (may not match host arm64/v8)</span>
</pre></div>
</div>
<p>Download the same image and place it in <code class="code docutils literal notranslate"><span class="pre">/tmp/buster</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image pull debian:buster /tmp/buster
<span class="go">[...]</span>
<span class="gp">$</span> ls /tmp/buster
<span class="go">bin   dev  home  lib64  mnt  proc  run   srv  tmp  var</span>
<span class="go">boot  etc  lib   media  opt  root  sbin  sys  usr</span>
</pre></div>
</div>
</section>
</section>
<section id="push">
<h3><span class="section-number">3.4.10. </span><code class="code docutils literal notranslate"><span class="pre">push</span></code><a class="headerlink" href="#push" title="Permalink to this headline">¶</a></h3>
<p>Push the image described by the image reference <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code> from the
local filesystem to a repository.</p>
<section id="id17">
<h4><span class="section-number">3.4.10.1. </span>Synopsis<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> push <span class="o">[</span>--image DIR<span class="o">]</span> IMAGE_REF <span class="o">[</span>DEST_REF<span class="o">]</span>
</pre></div>
</div>
<p>See the FAQ for the gory details on specifying image references.</p>
</section>
<section id="id18">
<h4><span class="section-number">3.4.10.2. </span>Description<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<p>Destination:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">DEST_REF</span></code></dt><dd><p>If specified, use this as the destination image reference, rather than
<code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code>. This lets you push to a repository without permanently
adding a tag to the image.</p>
</dd>
</dl>
</div></blockquote>
<p>Options:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">--image</span> <span class="pre">DIR</span></code></dt><dd><p>Use the unpacked image located at <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> rather than an image in the
storage directory named <code class="code docutils literal notranslate"><span class="pre">IMAGE_REF</span></code>.</p>
</dd>
</dl>
</div></blockquote>
<p>Because Charliecloud is fully unprivileged, the owner and group of files in
its images are not meaningful in the broader ecosystem. Thus, when pushed,
everything in the image is flattened to user:group <code class="code docutils literal notranslate"><span class="pre">root:root</span></code>. Also,
setuid/setgid bits are removed, to avoid surprises if the image is pulled by a
privileged container implementation.</p>
</section>
<section id="id19">
<h4><span class="section-number">3.4.10.3. </span>Examples<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<p>Push a local image to the registry <code class="code docutils literal notranslate"><span class="pre">example.com:5000</span></code> at path
<code class="code docutils literal notranslate"><span class="pre">/foo/bar</span></code> with tag <code class="code docutils literal notranslate"><span class="pre">latest</span></code>. Note that in this form, the local
image must be named to match that remote reference.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image push example.com:5000/foo/bar:latest
<span class="go">pushing image:   example.com:5000/foo/bar:latest</span>
<span class="go">layer 1/1: gathering</span>
<span class="go">layer 1/1: preparing</span>
<span class="go">preparing metadata</span>
<span class="go">starting upload</span>
<span class="go">layer 1/1: a1664c4: checking if already in repository</span>
<span class="go">layer 1/1: a1664c4: not present, uploading</span>
<span class="go">config: 89315a2: checking if already in repository</span>
<span class="go">config: 89315a2: not present, uploading</span>
<span class="go">manifest: uploading</span>
<span class="go">cleaning up</span>
<span class="go">done</span>
</pre></div>
</div>
<p>Same, except use local image <code class="code docutils literal notranslate"><span class="pre">alpine:3.9</span></code>. In this form, the local image
name does not have to match the destination reference.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image push alpine:3.9 example.com:5000/foo/bar:latest
<span class="go">pushing image:   alpine:3.9</span>
<span class="go">destination:     example.com:5000/foo/bar:latest</span>
<span class="go">layer 1/1: gathering</span>
<span class="go">layer 1/1: preparing</span>
<span class="go">preparing metadata</span>
<span class="go">starting upload</span>
<span class="go">layer 1/1: a1664c4: checking if already in repository</span>
<span class="go">layer 1/1: a1664c4: not present, uploading</span>
<span class="go">config: 89315a2: checking if already in repository</span>
<span class="go">config: 89315a2: not present, uploading</span>
<span class="go">manifest: uploading</span>
<span class="go">cleaning up</span>
<span class="go">done</span>
</pre></div>
</div>
<p>Same, except use unpacked image located at <code class="code docutils literal notranslate"><span class="pre">/var/tmp/image</span></code> rather than
an image in <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> storage. (Also, the sole layer is already present
in the remote registry, so we don’t upload it again.)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image push --image /var/tmp/image example.com:5000/foo/bar:latest
<span class="go">pushing image:   example.com:5000/foo/bar:latest</span>
<span class="go">image path:      /var/tmp/image</span>
<span class="go">layer 1/1: gathering</span>
<span class="go">layer 1/1: preparing</span>
<span class="go">preparing metadata</span>
<span class="go">starting upload</span>
<span class="go">layer 1/1: 892e38d: checking if already in repository</span>
<span class="go">layer 1/1: 892e38d: already present</span>
<span class="go">config: 546f447: checking if already in repository</span>
<span class="go">config: 546f447: not present, uploading</span>
<span class="go">manifest: uploading</span>
<span class="go">cleaning up</span>
<span class="go">done</span>
</pre></div>
</div>
</section>
</section>
<section id="reset">
<h3><span class="section-number">3.4.11. </span><code class="code docutils literal notranslate"><span class="pre">reset</span></code><a class="headerlink" href="#reset" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> reset
</pre></div>
</div>
<p>Delete all images and cache from ch-image builder storage.</p>
</section>
<section id="storage-path">
<h3><span class="section-number">3.4.12. </span><code class="code docutils literal notranslate"><span class="pre">storage-path</span></code><a class="headerlink" href="#storage-path" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-image <span class="o">[</span>...<span class="o">]</span> storage-path
</pre></div>
</div>
<p>Print the storage directory path and exit.</p>
</section>
<section id="environment-variables">
<h3><span class="section-number">3.4.13. </span>Environment variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline">¶</a></h3>
<dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">CH_IMAGE_USERNAME</span></code>, <code class="code docutils literal notranslate"><span class="pre">CH_IMAGE_PASSWORD</span></code></dt><dd><p>Username and password for registry authentication. <strong>See important caveats
in section “Authentication” above.</strong></p>
</dd>
</dl>
<dl>
<dt><code class="code docutils literal notranslate"><span class="pre">CH_LOG_FILE</span></code></dt><dd><p>If set, append log chatter to this file, rather than standard error. This is
useful for debugging situations where standard error is consumed or lost.</p>
<p>Also sets verbose mode if not already set (equivalent to <code class="code docutils literal notranslate"><span class="pre">--verbose</span></code>).</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">CH_LOG_FESTOON</span></code></dt><dd><p>If set, prepend PID and timestamp to logged chatter.</p>
</dd>
</dl>
</section>
</section>
<section id="ch-run">
<span id="man-ch-run"></span><h2><a class="toc-backref" href="#id41"><span class="section-number">3.5. </span>ch-run</a><a class="headerlink" href="#ch-run" title="Permalink to this headline">¶</a></h2>
<p>Run a command in a Charliecloud container.</p>
<section id="id20">
<h3><span class="section-number">3.5.1. </span>Synopsis<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run <span class="o">[</span>OPTION...<span class="o">]</span> IMAGE -- CMD <span class="o">[</span>ARG...<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="id21">
<h3><span class="section-number">3.5.2. </span>Description<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<p>Run command <code class="code docutils literal notranslate"><span class="pre">CMD</span></code> in a fully unprivileged Charliecloud container using
the image located at <code class="code docutils literal notranslate"><span class="pre">IMAGE</span></code>, which can be either a directory or, if the
proper support is enabled, a SquashFS archive.</p>
<blockquote>
<div><dl>
<dt><code class="code docutils literal notranslate"><span class="pre">-b</span></code>, <code class="code docutils literal notranslate"><span class="pre">--bind=SRC[:DST]</span></code></dt><dd><p>Bind-mount <code class="code docutils literal notranslate"><span class="pre">SRC</span></code> at guest <code class="code docutils literal notranslate"><span class="pre">DST</span></code>. The default destination if
not specified is to use the same path as the host; i.e., the default is
<code class="code docutils literal notranslate"><span class="pre">--bind=SRC:SRC</span></code>. Can be repeated.</p>
<p>If <code class="code docutils literal notranslate"><span class="pre">--write</span></code> is given and <code class="code docutils literal notranslate"><span class="pre">DST</span></code> does not exist, it will be
created as an empty directory. However, <code class="code docutils literal notranslate"><span class="pre">DST</span></code> must be entirely
within the image itself; <code class="code docutils literal notranslate"><span class="pre">DST</span></code> cannot enter a previous bind mount.
For example, <code class="code docutils literal notranslate"><span class="pre">--bind</span> <span class="pre">/foo:/tmp/foo</span></code> will fail because <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code>
is shared with the host via bind-mount (unless <code class="code docutils literal notranslate"><span class="pre">$TMPDIR</span></code> is set to
something else or <code class="code docutils literal notranslate"><span class="pre">--private-tmp</span></code> is given).</p>
<p>Most images do have ten directories <code class="code docutils literal notranslate"><span class="pre">/mnt/[0-9]</span></code> already available
as mount points.</p>
<p>Symlinks in <code class="code docutils literal notranslate"><span class="pre">DST</span></code> are followed, and absolute links can have
surprising behavior. Bind-mounting happens after namespace setup but
before pivoting into the container image, so absolute links use the host
root. For example, suppose the image has a symlink <code class="code docutils literal notranslate"><span class="pre">/foo</span> <span class="pre">-&gt;</span> <span class="pre">/mnt</span></code>.
Then, <code class="code docutils literal notranslate"><span class="pre">--bind=/bar:/foo</span></code> will bind-mount on the <em>host’s</em>
<code class="code docutils literal notranslate"><span class="pre">/mnt</span></code>, which is inaccessible on the host because namespaces are
already set up and <em>also</em> inaccessible in the container because of the
subsequent pivot into the image. Currently, this problem is only detected
when <code class="code docutils literal notranslate"><span class="pre">DST</span></code> needs to be created: <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> will refuse to follow
absolute symlinks in this case, to avoid directory creation surprises.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-c</span></code>, <code class="code docutils literal notranslate"><span class="pre">--cd=DIR</span></code></dt><dd><p>Initial working directory in container.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--ch-ssh</span></code></dt><dd><p>Bind <code class="code docutils literal notranslate"><span class="pre">ch-ssh(1)</span></code> into container at <code class="code docutils literal notranslate"><span class="pre">/usr/bin/ch-ssh</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--env-no-expand</span></code></dt><dd><p>don’t expand variables when using <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code></p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-g</span></code>, <code class="code docutils literal notranslate"><span class="pre">--gid=GID</span></code></dt><dd><p>Run as group <code class="code docutils literal notranslate"><span class="pre">GID</span></code> within container.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-j</span></code>, <code class="code docutils literal notranslate"><span class="pre">--join</span></code></dt><dd><p>Use the same container (namespaces) as peer <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> invocations.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--join-pid=PID</span></code></dt><dd><p>Join the namespaces of an existing process.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--join-ct=N</span></code></dt><dd><p>Number of <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> peers (implies <code class="code docutils literal notranslate"><span class="pre">--join</span></code>; default: see
below).</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--join-tag=TAG</span></code></dt><dd><p>Label for <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> peer group (implies <code class="code docutils literal notranslate"><span class="pre">--join</span></code>; default: see
below).</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-m</span></code>, <code class="code docutils literal notranslate"><span class="pre">--mount=DIR</span></code></dt><dd><p>Use <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> for the SquashFS mount point, which must already exist. If
not specified, the default is <code class="code docutils literal notranslate"><span class="pre">/var/tmp/$USER.ch/mnt</span></code>, which <em>will</em>
be created if needed.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-home</span></code></dt><dd><p>By default, your host home directory (i.e., <code class="code docutils literal notranslate"><span class="pre">$HOME</span></code>) is bind-mounted
at guest <code class="code docutils literal notranslate"><span class="pre">/home/$USER</span></code>. This is accomplished by mounting a new
<code class="code docutils literal notranslate"><span class="pre">tmpfs</span></code> at <code class="code docutils literal notranslate"><span class="pre">/home</span></code>, which hides any image content under that
path. If this is specified, neither of these things happens and the
image’s <code class="code docutils literal notranslate"><span class="pre">/home</span></code> is exposed unaltered.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-passwd</span></code></dt><dd><p>By default, temporary <code class="code docutils literal notranslate"><span class="pre">/etc/passwd</span></code> and <code class="code docutils literal notranslate"><span class="pre">/etc/group</span></code> files are
created according to the UID and GID maps for the container and
bind-mounted into it. If this is specified, no such temporary files are
created and the image’s files are exposed.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-t</span></code>, <code class="code docutils literal notranslate"><span class="pre">--private-tmp</span></code></dt><dd><p>By default, the host’s <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> (or <code class="code docutils literal notranslate"><span class="pre">$TMPDIR</span></code> if set) is
bind-mounted at container <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code>. If this is specified, a new
<code class="code docutils literal notranslate"><span class="pre">tmpfs</span></code> is mounted on the container’s <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> instead.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--set-env</span></code>, <code class="code docutils literal notranslate"><span class="pre">--set-env=FILE</span></code>, <code class="code docutils literal notranslate"><span class="pre">--set-env=VAR=VALUE</span></code></dt><dd><p>Set environment variable(s). With:</p>
<blockquote>
<div><ul class="simple">
<li><p>no argument: as listed in file <code class="code docutils literal notranslate"><span class="pre">/ch/environment</span></code> within the
image. It is an error if the file does not exist or cannot be read.
(Note that with SquashFS images, it is not currently possible to use
other files within the image.)</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">FILE</span></code> (i.e., no equals in argument): as specified in file at
host path <code class="code docutils literal notranslate"><span class="pre">FILE</span></code>. Again, it is an error if the file cannot be
read.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">NAME=VALUE</span></code> (i.e., equals sign in argument): set variable
<code class="code docutils literal notranslate"><span class="pre">NAME</span></code> to <code class="code docutils literal notranslate"><span class="pre">VALUE</span></code>.</p></li>
</ul>
</div></blockquote>
<p>See below for details on how environment variables work in <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-u</span></code>, <code class="code docutils literal notranslate"><span class="pre">--uid=UID</span></code></dt><dd><p>Run as user <code class="code docutils literal notranslate"><span class="pre">UID</span></code> within container.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--unset-env=GLOB</span></code></dt><dd><p>Unset environment variables whose names match <code class="code docutils literal notranslate"><span class="pre">GLOB</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-v</span></code>, <code class="code docutils literal notranslate"><span class="pre">--verbose</span></code></dt><dd><p>Be more verbose (can be repeated).</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-w</span></code>, <code class="code docutils literal notranslate"><span class="pre">--write</span></code></dt><dd><p>Mount image read-write (by default, the image is mounted read-only).</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-?</span></code>, <code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt><dd><p>Print help and exit.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--usage</span></code></dt><dd><p>Print a short usage message and exit.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-V</span></code>, <code class="code docutils literal notranslate"><span class="pre">--version</span></code></dt><dd><p>Print version and exit.</p>
</dd>
</dl>
</div></blockquote>
<p><strong>Note:</strong> Because <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> is fully unprivileged, it is not possible to
change UIDs and GIDs within the container (the relevant system calls fail). In
particular, setuid, setgid, and setcap executables do not work. As a
precaution, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> calls <code class="code docutils literal notranslate"><span class="pre">prctl(PR_SET_NO_NEW_PRIVS,</span> <span class="pre">1)</span></code> to
<a class="reference external" href="https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt">disable these executables</a> within the
container. This does not reduce functionality but is a “belt and suspenders”
precaution to reduce the attack surface should bugs in these system calls or
elsewhere arise.</p>
</section>
<section id="image-format">
<h3><span class="section-number">3.5.3. </span>Image format<a class="headerlink" href="#image-format" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> supports two different image formats.</p>
<p>The first is a simple directory that contains a Linux filesystem tree. This
can be accomplished by:</p>
<ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> directly from <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> or another builder to a
directory.</p></li>
<li><p>Charliecloud’s tarball workflow: build or pull the image, <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code>
it to a tarball, transfer the tarball to the target system, then
<code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code> the tarball to a directory.</p></li>
<li><p>Manually mount a SquashFS image, e.g. with <code class="code docutils literal notranslate"><span class="pre">squashfuse(1)</span></code> and then
un-mount it after run with <code class="code docutils literal notranslate"><span class="pre">fusermount</span> <span class="pre">-u</span></code>.</p></li>
<li><p>Any other workflow that produces an appropriate directory tree.</p></li>
</ul>
<p>The second is a SquashFS image archive mounted internally by <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>,
available if it’s linked with the optional <code class="code docutils literal notranslate"><span class="pre">libsquashfuse_ll</span></code>.
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> mounts the image filesystem, services all FUSE requests, and
unmounts it, all within <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>. See <code class="code docutils literal notranslate"><span class="pre">--mount</span></code> above to set the
mount point location.</p>
<p>Prior versions of Charliecloud provided wrappers for the <code class="code docutils literal notranslate"><span class="pre">squashfuse</span></code>
and <code class="code docutils literal notranslate"><span class="pre">squashfuse_ll</span></code> SquashFS mount commands and <code class="code docutils literal notranslate"><span class="pre">fusermount</span> <span class="pre">-u</span></code>
unmount command. We removed these because we concluded they had minimal
value-add over the standard, unwrapped commands.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Currently, Charliecloud unmounts the SquashFS filesystem when user command
<code class="code docutils literal notranslate"><span class="pre">CMD</span></code>’s process exits. It does not monitor any of its child
processes. Therefore, if the user command spawns child processes and then
exits before them (e.g., some daemons), those children will have the image
unmounted from underneath them. In this case, the workaround is to
mount/unmount using external tools. We expect to remove this limitation in
a future version.</p>
</div>
</section>
<section id="host-files-and-directories-available-in-container-via-bind-mounts">
<h3><span class="section-number">3.5.4. </span>Host files and directories available in container via bind mounts<a class="headerlink" href="#host-files-and-directories-available-in-container-via-bind-mounts" title="Permalink to this headline">¶</a></h3>
<p>In addition to any directories specified by the user with <code class="code docutils literal notranslate"><span class="pre">--bind</span></code>,
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> has standard host files and directories that are bind-mounted
in as well.</p>
<p>The following host files and directories are bind-mounted at the same location
in the container. These give access to the host’s devices and various kernel
facilities. (Recall that Charliecloud provides minimal isolation and
containerized processes are mostly normal unprivileged processes.) They cannot
be disabled and are required; i.e., they must exist both on host and within
the image.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">/dev</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">/proc</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">/sys</span></code></p></li>
</ul>
</div></blockquote>
<p>Optional; bind-mounted only if path exists on both host and within the image,
without error or warning if not.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">/etc/hosts</span></code> and <code class="code docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code>. Because Charliecloud
containers share the host network namespace, they need the same hostname
resolution configuration.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">/etc/machine-id</span></code>. Provides a unique ID for the OS installation;
matching the host works for most situations. Needed to support D-Bus, some
software licensing situations, and likely other use cases. See also <a class="reference external" href="https://github.com/hpc/charliecloud/issues/1050">issue
#1050</a>.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">/var/lib/hugetlbfs</span></code> at guest <code class="code docutils literal notranslate"><span class="pre">/var/opt/cray/hugetlbfs</span></code>, and
<code class="code docutils literal notranslate"><span class="pre">/var/opt/cray/alps/spool</span></code>. These support Cray MPI.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">$PREFIX/bin/ch-ssh</span></code> at guest <code class="code docutils literal notranslate"><span class="pre">/usr/bin/ch-ssh</span></code>. SSH wrapper
that automatically containerizes after connecting.</p></li>
</ul>
</div></blockquote>
<p>Additional bind mounts done by default but can be disabled; see the options
above.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">$HOME</span></code> at <code class="code docutils literal notranslate"><span class="pre">/home/$USER</span></code> (and image <code class="code docutils literal notranslate"><span class="pre">/home</span></code> is hidden).
Makes user data and init files available.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> (or <code class="code docutils literal notranslate"><span class="pre">$TMPDIR</span></code> if set) at guest <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code>. Provides a
temporary directory that persists between container runs and is shared
with non-containerized application components.</p></li>
<li><p>temporary files at <code class="code docutils literal notranslate"><span class="pre">/etc/passwd</span></code> and <code class="code docutils literal notranslate"><span class="pre">/etc/group</span></code>. Usernames
and group names need to be customized for each container run.</p></li>
</ul>
</div></blockquote>
</section>
<section id="multiple-processes-in-the-same-container-with-join">
<h3><span class="section-number">3.5.5. </span>Multiple processes in the same container with <code class="code docutils literal notranslate"><span class="pre">--join</span></code><a class="headerlink" href="#multiple-processes-in-the-same-container-with-join" title="Permalink to this headline">¶</a></h3>
<p>By default, different <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> invocations use different user and mount
namespaces (i.e., different containers). While this has no impact on sharing
most resources between invocations, there are a few important exceptions.
These include:</p>
<ol class="arabic simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">ptrace(2)</span></code>, used by debuggers and related tools. One can attach a
debugger to processes in descendant namespaces, but not sibling namespaces.
The practical effect of this is that (without <code class="code docutils literal notranslate"><span class="pre">--join</span></code>), you can’t
run a command with <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> and then attach to it with a debugger
also run with <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>.</p></li>
<li><p><em>Cross-memory attach</em> (CMA) is used by cooperating processes to communicate
by simply reading and writing one another’s memory. This is also not
permitted between sibling namespaces. This affects various MPI
implementations that use CMA to pass messages between ranks on the same
node, because it’s faster than traditional shared memory.</p></li>
</ol>
<p><code class="code docutils literal notranslate"><span class="pre">--join</span></code> is designed to address this by placing related <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>
commands (the “peer group”) in the same container. This is done by one of the
peers creating the namespaces with <code class="code docutils literal notranslate"><span class="pre">unshare(2)</span></code> and the others joining
with <code class="code docutils literal notranslate"><span class="pre">setns(2)</span></code>.</p>
<p>To do so, we need to know the number of peers and a name for the group. These
are specified by additional arguments that can (hopefully) be left at default
values in most cases:</p>
<ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">--join-ct</span></code> sets the number of peers. The default is the value of the
first of the following environment variables that is defined:
<code class="code docutils literal notranslate"><span class="pre">OMPI_COMM_WORLD_LOCAL_SIZE</span></code>, <code class="code docutils literal notranslate"><span class="pre">SLURM_STEP_TASKS_PER_NODE</span></code>,
<code class="code docutils literal notranslate"><span class="pre">SLURM_CPUS_ON_NODE</span></code>.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">--join-tag</span></code> sets the tag that names the peer group. The default is
environment variable <code class="code docutils literal notranslate"><span class="pre">SLURM_STEP_ID</span></code>, if defined; otherwise, the PID
of <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>’s parent. Tags can be re-used for peer groups that start
at different times, i.e., once all peer <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> have replaced
themselves with the user command, the tag can be re-used.</p></li>
</ul>
<p>Caveats:</p>
<ul class="simple">
<li><p>One cannot currently add peers after the fact, for example, if one decides
to start a debugger after the fact. (This is only required for code with
bugs and is thus an unusual use case.)</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> instances race. The winner of this race sets up the
namespaces, and the other peers use the winner to find the namespaces to
join. Therefore, if the user command of the winner exits, any remaining
peers will not be able to join the namespaces, even if they are still
active. There is currently no general way to specify which <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>
should be the winner.</p></li>
<li><p>If <code class="code docutils literal notranslate"><span class="pre">--join-ct</span></code> is too high, the winning <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>’s user command
exits before all peers join, or <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> itself crashes, IPC resources
such as semaphores and shared memory segments will be leaked. These appear
as files in <code class="code docutils literal notranslate"><span class="pre">/dev/shm/</span></code> and can be removed with <code class="code docutils literal notranslate"><span class="pre">rm(1)</span></code>.</p></li>
<li><p>Many of the arguments given to the race losers, such as the image path and
<code class="code docutils literal notranslate"><span class="pre">--bind</span></code>, will be ignored in favor of what was given to the winner.</p></li>
</ul>
</section>
<section id="id22">
<h3><span class="section-number">3.5.6. </span>Environment variables<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> leaves environment variables unchanged, i.e. the host
environment is passed through unaltered, except:</p>
<ul class="simple">
<li><p>limited tweaks to avoid significant guest breakage;</p></li>
<li><p>user-set variables via <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code>;</p></li>
<li><p>user-unset variables via <code class="code docutils literal notranslate"><span class="pre">--unset-env</span></code>; and</p></li>
<li><p>set <code class="code docutils literal notranslate"><span class="pre">CH_RUNNING</span></code>.</p></li>
</ul>
<p>This section describes these features.</p>
<p>The default tweaks happen first, then <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code> and
<code class="code docutils literal notranslate"><span class="pre">--unset-env</span></code> in the order specified on the command line, and then
<code class="code docutils literal notranslate"><span class="pre">CH_RUNNING</span></code>. The two options can be repeated arbitrarily many times,
e.g. to add/remove multiple variable sets or add only some variables in a
file.</p>
<section id="default-behavior">
<h4><span class="section-number">3.5.6.1. </span>Default behavior<a class="headerlink" href="#default-behavior" title="Permalink to this headline">¶</a></h4>
<p>By default, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> makes the following environment variable changes:</p>
<ul>
<li><p><code class="code docutils literal notranslate"><span class="pre">$CH_RUNNING</span></code>: Set to <code class="code docutils literal notranslate"><span class="pre">Weird</span> <span class="pre">Al</span> <span class="pre">Yankovic</span></code>. While a process can
figure out that it’s in an unprivileged container and what namespaces are
active without this hint, that can be messy, and there is no way to tell
that it’s a <em>Charliecloud</em> container specifically. This variable makes such
a test simple and well-defined. (<strong>Note:</strong> This variable is unaffected by
<code class="code docutils literal notranslate"><span class="pre">--unset-env</span></code>.)</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">$HOME</span></code>: If the path to your home directory is not <code class="code docutils literal notranslate"><span class="pre">/home/$USER</span></code>
on the host, then an inherited <code class="code docutils literal notranslate"><span class="pre">$HOME</span></code> will be incorrect inside the
guest. This confuses some software, such as Spack. Thus, we change
<code class="code docutils literal notranslate"><span class="pre">$HOME</span></code> to <code class="code docutils literal notranslate"><span class="pre">/home/$USER</span></code>, unless <code class="code docutils literal notranslate"><span class="pre">--no-home</span></code> is specified,
in which case it is left unchanged.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">$PATH</span></code>: Newer Linux distributions replace some root-level
directories, such as <code class="code docutils literal notranslate"><span class="pre">/bin</span></code>, with symlinks to their counterparts in
<code class="code docutils literal notranslate"><span class="pre">/usr</span></code>.</p>
<p>Some of these distributions (e.g., Fedora 24) have also dropped <code class="code docutils literal notranslate"><span class="pre">/bin</span></code>
from the default <code class="code docutils literal notranslate"><span class="pre">$PATH</span></code>. This is a problem when the guest OS does
<em>not</em> have a merged <code class="code docutils literal notranslate"><span class="pre">/usr</span></code> (e.g., Debian 8 “Jessie”). Thus, we add
<code class="code docutils literal notranslate"><span class="pre">/bin</span></code> to <code class="code docutils literal notranslate"><span class="pre">$PATH</span></code> if it’s not already present.</p>
<p>Further reading:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://www.freedesktop.org/wiki/Software/systemd/TheCaseForTheUsrMerge/">The case for the /usr Merge</a></p></li>
<li><p><a class="reference external" href="https://fedoraproject.org/wiki/Features/UsrMove">Fedora</a></p></li>
<li><p><a class="reference external" href="https://wiki.debian.org/UsrMerge">Debian</a></p></li>
</ul>
</div></blockquote>
</li>
<li><p><code class="code docutils literal notranslate"><span class="pre">$TMPDIR</span></code>: Unset, because this is almost certainly a host path, and
that host path is made available in the guest at <code class="code docutils literal notranslate"><span class="pre">/tmp</span></code> unless
<code class="code docutils literal notranslate"><span class="pre">--private-tmp</span></code> is given.</p></li>
</ul>
</section>
<section id="setting-variables-with-set-env">
<h4><span class="section-number">3.5.6.2. </span>Setting variables with <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code><a class="headerlink" href="#setting-variables-with-set-env" title="Permalink to this headline">¶</a></h4>
<p>The purpose of <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code> is to set environment variables within the
container. Values given replace any already in the environment (i.e.,
inherited from the host shell) or set by earlier <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code>. This flag
takes an optional argument with two possible forms:</p>
<ol class="arabic">
<li><p><strong>If the argument contains an equals sign</strong> (<code class="code docutils literal notranslate"><span class="pre">=</span></code>, ASCII 61), that
sets an environment variable directly. For example, to set <code class="code docutils literal notranslate"><span class="pre">FOO</span></code> to
the string value <code class="code docutils literal notranslate"><span class="pre">bar</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run --set-env<span class="o">=</span><span class="nv">FOO</span><span class="o">=</span>bar ...
</pre></div>
</div>
<p>Single straight quotes around the value (<code class="code docutils literal notranslate"><span class="pre">'</span></code>, ASCII 39) are stripped,
though be aware that both single and double quotes are also interpreted by
the shell. For example, this example is similar to the prior one; the
double quotes are removed by the shell and the single quotes are removed by
<code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run --set-env<span class="o">=</span><span class="s2">&quot;&#39;BAZ=qux&#39;&quot;</span> ...
</pre></div>
</div>
</li>
<li><p><strong>If the argument does not contain an equals sign</strong>, it is a host path to a
file containing zero or more variables using the same syntax as above
(except with no prior shell processing). This file contains a sequence of
assignments separated by newlines. Empty lines are ignored, and no comments
are interpreted. (This syntax is designed to accept the output of
<code class="code docutils literal notranslate"><span class="pre">printenv</span></code> and be easily produced by other simple mechanisms.) For
example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cat /tmp/env.txt
<span class="go">FOO=bar</span>
<span class="go">BAZ=&#39;qux&#39;</span>
<span class="gp">$</span> ch-run --set-env<span class="o">=</span>/tmp/env.txt ...
</pre></div>
</div>
<p>For directory images only (because the file is read before containerizing),
guest paths can be given by prepending the image path.</p>
</li>
<li><p><strong>If there is no argument</strong>, the file <code class="code docutils literal notranslate"><span class="pre">/ch/environment</span></code> within the
image is used. This file is commonly populated by <code class="code docutils literal notranslate"><span class="pre">ENV</span></code> instructions
in the Dockerfile. For example, equivalently to form 2:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cat Dockerfile
<span class="go">[...]</span>
<span class="go">ENV FOO=bar</span>
<span class="go">ENV BAZ=qux</span>
<span class="go">[...]</span>
<span class="gp">$</span> ch-image build -t foo .
<span class="gp">$</span> ch-convert foo /var/tmp/foo.sqfs
<span class="gp">$</span> ch-run --set-env /var/tmp/foo.sqfs -- ...
</pre></div>
</div>
<p>(Note the image path is interpreted correctly, not as the <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code>
argument.)</p>
<p>At present, there is no way to use files other than <code class="code docutils literal notranslate"><span class="pre">/ch/environment</span></code>
within SquashFS images.</p>
</li>
</ol>
<p>Environment variables are expanded for values that look like search paths,
unless <code class="code docutils literal notranslate"><span class="pre">--env-no-expand</span></code> is given prior to <code class="code docutils literal notranslate"><span class="pre">--set-env</span></code>. In this
case, the value is a sequence of zero or more possibly-empty items separated
by colon (<code class="code docutils literal notranslate"><span class="pre">:</span></code>, ASCII 58). If an item begins with dollar sign (<code class="code docutils literal notranslate"><span class="pre">$</span></code>,
ASCII 36), then the rest of the item is the name of an environment variable.
If this variable is set to a non-empty value, that value is substituted for
the item; otherwise (i.e., the variable is unset or the empty string), the
item is deleted, including a delimiter colon. The purpose of omitting empty
expansions is to avoid surprising behavior such as an empty element in
<code class="code docutils literal notranslate"><span class="pre">$PATH</span></code> meaning <a class="reference external" href="https://devdocs.io/bash/bourne-shell-variables#PATH">the current directory</a>.</p>
<p>For example, to set <code class="code docutils literal notranslate"><span class="pre">HOSTPATH</span></code> to the search path in the current shell
(this is expanded by <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>, though letting the shell do it happens to
be equivalent):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run --set-env<span class="o">=</span><span class="s1">&#39;HOSTPATH=$PATH&#39;</span> ...
</pre></div>
</div>
<p>To prepend <code class="code docutils literal notranslate"><span class="pre">/opt/bin</span></code> to this current search path:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run --set-env<span class="o">=</span><span class="s1">&#39;PATH=/opt/bin:$PATH&#39;</span> ...
</pre></div>
</div>
<p>To prepend <code class="code docutils literal notranslate"><span class="pre">/opt/bin</span></code> to the search path set by the Dockerfile, as
retrieved from guest file <code class="code docutils literal notranslate"><span class="pre">/ch/environment</span></code> (here we really cannot let
the shell expand <code class="code docutils literal notranslate"><span class="pre">$PATH</span></code>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run --set-env --set-env<span class="o">=</span><span class="s1">&#39;PATH=/opt/bin:$PATH&#39;</span> ...
</pre></div>
</div>
<p>Examples of valid assignment, assuming that environment variable <code class="code docutils literal notranslate"><span class="pre">BAR</span></code>
is set to <code class="code docutils literal notranslate"><span class="pre">bar</span></code> and <code class="code docutils literal notranslate"><span class="pre">UNSET</span></code> is unset or set to the empty string:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Assignment</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=bar</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bar</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=bar=baz</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bar=baz</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FLAGS=-march=foo</span> <span class="pre">-mtune=bar</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FLAGS</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">-march=foo</span> <span class="pre">-mtune=bar</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">FLAGS='-march=foo</span> <span class="pre">-mtune=bar'</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FLAGS</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">-march=foo</span> <span class="pre">-mtune=bar</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=$BAR</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bar</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=$BAR:baz</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bar:baz</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p>empty string</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=$UNSET</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p>empty string</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=baz:$UNSET:qux</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">baz:qux</span></code> (not <code class="code docutils literal notranslate"><span class="pre">baz::qux</span></code>)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=:bar:baz::</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">:bar:baz::</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=''</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p>empty string</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=''''</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">''</span></code> (two single quotes)</p></td>
</tr>
</tbody>
</table>
<p>Example invalid assignments:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Assignment</p></th>
<th class="head"><p>Problem</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span> <span class="pre">bar</span></code></p></td>
<td><p>no equals separator</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">=bar</span></code></p></td>
<td><p>name cannot be empty</p></td>
</tr>
</tbody>
</table>
<p>Example valid assignments that are probably not what you want:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Assignment</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Problem</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=&quot;bar&quot;</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">&quot;bar&quot;</span></code></p></td>
<td><p>double quotes aren’t stripped</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=bar</span> <span class="pre">#</span> <span class="pre">baz</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bar</span> <span class="pre">#</span> <span class="pre">baz</span></code></p></td>
<td><p>comments not supported</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=bar\tbaz</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bar\tbaz</span></code></p></td>
<td><p>backslashes are not special</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">​</span> <span class="pre">FOO=bar</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">​</span> <span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bar</span></code></p></td>
<td><p>leading space in key</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=</span> <span class="pre">bar</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">​</span> <span class="pre">bar</span></code></p></td>
<td><p>leading space in value</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">$FOO=bar</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">$FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">bar</span></code></p></td>
<td><p>variables not expanded in key</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">FOO=$BAR</span> <span class="pre">baz:qux</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">FOO</span></code></p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">qux</span></code></p></td>
<td><p>variable <code class="code docutils literal notranslate"><span class="pre">BAR</span> <span class="pre">baz</span></code> not set</p></td>
</tr>
</tbody>
</table>
</section>
<section id="removing-variables-with-unset-env">
<h4><span class="section-number">3.5.6.3. </span>Removing variables with <code class="code docutils literal notranslate"><span class="pre">--unset-env</span></code><a class="headerlink" href="#removing-variables-with-unset-env" title="Permalink to this headline">¶</a></h4>
<p>The purpose of <code class="code docutils literal notranslate"><span class="pre">--unset-env=GLOB</span></code> is to remove unwanted environment
variables. The argument <code class="code docutils literal notranslate"><span class="pre">GLOB</span></code> is a glob pattern (<a class="reference external" href="http://man7.org/linux/man-pages/man3/fnmatch.3.html">dialect</a> <code class="code docutils literal notranslate"><span class="pre">fnmatch(3)</span></code>
with no flags); all variables with matching names are removed from the
environment.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Because the shell also interprets glob patterns, if any wildcard characters
are in <code class="code docutils literal notranslate"><span class="pre">GLOB</span></code>, it is important to put it in single quotes to avoid
surprises.</p>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">GLOB</span></code> must be a non-empty string.</p>
<p>Example 1: Remove the single environment variable <code class="code docutils literal notranslate"><span class="pre">FOO</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">export</span> <span class="nv">FOO</span><span class="o">=</span>bar
<span class="gp">$</span> env <span class="p">|</span> fgrep FOO
<span class="go">FOO=bar</span>
<span class="gp">$</span> ch-run --unset-env<span class="o">=</span>FOO <span class="nv">$CH_TEST_IMGDIR</span>/chtest -- env <span class="p">|</span> fgrep FOO
<span class="gp">$</span>
</pre></div>
</div>
<p>Example 2: Hide from a container the fact that it’s running in a Slurm
allocation, by removing all variables beginning with <code class="code docutils literal notranslate"><span class="pre">SLURM</span></code>. You might
want to do this to test an MPI program with one rank and no launcher:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> salloc -N1
<span class="gp">$</span> env <span class="p">|</span> egrep <span class="s1">&#39;^SLURM&#39;</span> <span class="p">|</span> wc
<span class="go">   44      44    1092</span>
<span class="gp">$</span> ch-run <span class="nv">$CH_TEST_IMGDIR</span>/mpihello-openmpi -- /hello/hello
<span class="go">[... long error message ...]</span>
<span class="gp">$</span> ch-run --unset-env<span class="o">=</span><span class="s1">&#39;SLURM*&#39;</span> <span class="nv">$CH_TEST_IMGDIR</span>/mpihello-openmpi -- /hello/hello
<span class="go">0: MPI version:</span>
<span class="go">Open MPI v3.1.3, package: Open MPI root@c897a83f6f92 Distribution, ident: 3.1.3, repo rev: v3.1.3, Oct 29, 2018</span>
<span class="go">0: init ok cn001.localdomain, 1 ranks, userns 4026532530</span>
<span class="go">0: send/receive ok</span>
<span class="go">0: finalize ok</span>
</pre></div>
</div>
<p>Example 3: Clear the environment completely (remove all variables):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run --unset-env<span class="o">=</span><span class="s1">&#39;*&#39;</span> <span class="nv">$CH_TEST_IMGDIR</span>/chtest -- env
<span class="gp">$</span>
</pre></div>
</div>
<p>Note that some programs, such as shells, set some environment variables even
if started with no init files:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run --unset-env<span class="o">=</span><span class="s1">&#39;*&#39;</span> <span class="nv">$CH_TEST_IMGDIR</span>/debian9 -- bash --noprofile --norc -c env
<span class="go">SHLVL=1</span>
<span class="go">PWD=/</span>
<span class="go">_=/usr/bin/env</span>
<span class="gp">$</span>
</pre></div>
</div>
</section>
</section>
<section id="id23">
<h3><span class="section-number">3.5.7. </span>Examples<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h3>
<p>Run the command <code class="code docutils literal notranslate"><span class="pre">echo</span> <span class="pre">hello</span></code> inside a Charliecloud container using the
unpacked image at <code class="code docutils literal notranslate"><span class="pre">/data/foo</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run /data/foo -- <span class="nb">echo</span> hello
<span class="go">hello</span>
</pre></div>
</div>
<p>Run an MPI job that can use CMA to communicate:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> srun ch-run --join /data/foo -- bar
</pre></div>
</div>
</section>
<section id="syslog">
<h3><span class="section-number">3.5.8. </span>Syslog<a class="headerlink" href="#syslog" title="Permalink to this headline">¶</a></h3>
<p>By default, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> logs its command line to <a class="reference external" href="https://en.wikipedia.org/wiki/Syslog">syslog</a>. (This can be disabled by configuring
with <code class="code docutils literal notranslate"><span class="pre">--disable-syslog</span></code>.) This includes: (1) the invoking real UID, (2)
the number of command line arguments, and (3) the arguments, separated by
spaces. For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Dec 10 18:19:08 mybox ch-run: uid=1000 args=7: ch-run -v /var/tmp/00_tiny -- echo hello &quot;wor l}\$d&quot;</span>
</pre></div>
</div>
<p>Logging is one of the first things done during program initialization, even
before command line parsing. That is, almost all command lines are logged,
even if erroneous, and there is no logging of program success or failure.</p>
<p>Arguments are serialized with the following procedure. The purpose is to
provide a human-readable reconstruction of the command line while also
allowing each argument to be recovered byte-for-byte.</p>
<blockquote>
<div><ul class="simple">
<li><p>If an argument contains only printable ASCII bytes that are not
whitespace, shell metacharacters, double quote (<code class="code docutils literal notranslate"><span class="pre">&quot;</span></code>, ASCII 34
decimal), or backslash (<code class="code docutils literal notranslate"><span class="pre">\​</span></code>, ASCII 92), then log it unchanged.</p></li>
<li><p>Otherwise, (a) enclose the argument in double quotes and
(b) backslash-escape double quotes, backslashes, and characters
interpreted by Bash (including POSIX shells) within double quotes.</p></li>
</ul>
</div></blockquote>
<p>The verbatim command line typed in the shell cannot be recovered, because not
enough information is provided to UNIX programs. For example,
<code class="code docutils literal notranslate"><span class="pre">echo  'foo'</span></code> is given to programs as a sequence of two arguments,
<code class="code docutils literal notranslate"><span class="pre">echo</span></code> and <code class="code docutils literal notranslate"><span class="pre">foo</span></code>; the two spaces and single quotes are removed by
the shell. The zero byte, ASCII NUL, cannot appear in arguments because it
would terminate the string.</p>
</section>
<section id="exit-status">
<h3><span class="section-number">3.5.9. </span>Exit status<a class="headerlink" href="#exit-status" title="Permalink to this headline">¶</a></h3>
<p>If there is an error during containerization, <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> exits with status
non-zero. If the user command is started successfully, the exit status is that
of the user command, with one exception: if the image is an internally mounted
SquashFS filesystem and the user command is killed by a signal, the exit
status is 1 regardless of the signal value.</p>
</section>
</section>
<section id="ch-run-oci">
<h2><a class="toc-backref" href="#id42"><span class="section-number">3.6. </span>ch-run-oci</a><a class="headerlink" href="#ch-run-oci" title="Permalink to this headline">¶</a></h2>
<p>OCI wrapper for <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>.</p>
<section id="id25">
<h3><span class="section-number">3.6.1. </span>Synopsis<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run-oci OPERATION <span class="o">[</span>ARG ...<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="id26">
<h3><span class="section-number">3.6.2. </span>Description<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This command is experimental. Features may be incomplete and/or buggy. The
quality of code is not yet up to the usual Charliecloud standards, and
error handling is poor. Please report any issues you find, so we can fix
them!</p>
</div>
<p>Open Containers Initiative (OCI) wrapper for <code class="code docutils literal notranslate"><span class="pre">ch-run(1)</span></code>. You probably
don’t want to run this command directly; it is intended to interface with
other software that expects an OCI runtime. The current goal is to support
completely unprivileged image building (e.g. <code class="code docutils literal notranslate"><span class="pre">buildah</span>
<span class="pre">--runtime=ch-run-oci</span></code>) rather than general OCI container running.</p>
<p><em>Support of the OCI runtime specification is only partial.</em> This is for two
reasons. First, it’s an experimental and incomplete feature. More importantly,
the philosophy and goals of OCI differ significantly from those of
Charliecloud. Key differences include:</p>
<blockquote>
<div><ul class="simple">
<li><p>OCI is designed to run services, while Charliecloud is designed to run
scientific applications.</p></li>
<li><p>OCI containers are persistent things with a complex lifecycle, while
Charliecloud containers are simply UNIX processes.</p></li>
<li><p>OCI expects support for a variety of namespaces, while Charliecloud
supports user and mount, no more and no less.</p></li>
<li><p>OCI expects runtimes to maintain a supervisor process in addition to
user processes; Charliecloud has no need for this.</p></li>
<li><p>OCI expects runtimes to maintain state throughout the container lifecycle
in a location independent from the caller.</p></li>
</ul>
</div></blockquote>
<p>For these reasons, <code class="code docutils literal notranslate"><span class="pre">ch-run-oci</span></code> is a bit of a kludge, and much of what
it does is provide scaffolding to satisfy OCI requirements.</p>
<p>Which OCI features are and are not supported is provided in the rest of this
man page, and technical analysis and discussion are in the Contributor’s
Guide.</p>
<p>This command supports OCI version 1.0.0 only and fails with an error if other
versions are offered.</p>
</section>
<section id="operations">
<h3><span class="section-number">3.6.3. </span>Operations<a class="headerlink" href="#operations" title="Permalink to this headline">¶</a></h3>
<p>All OCI operations are accepted, but some are no-ops or merely scaffolding to
satisfy the caller. For comparison, see also:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/opencontainers/runtime-spec/blob/master/runtime.md">OCI runtime and lifecycle spec</a></p></li>
<li><p>The <a class="reference external" href="https://github.com/opencontainers/runc/tree/master/man">runc man pages</a></p></li>
</ul>
<section id="create">
<h4><span class="section-number">3.6.3.1. </span><code class="code docutils literal notranslate"><span class="pre">create</span></code><a class="headerlink" href="#create" title="Permalink to this headline">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run-oci create --bundle DIR --pid-file FILE <span class="o">[</span>--no-new-keyring<span class="o">]</span> CONTAINER_ID
</pre></div>
</div>
<p>Create a container. Charliecloud does not have separate create and start
phases, so this operation only sets up OCI-related scaffolding.</p>
<p>Arguments:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">--bundle</span> <span class="pre">DIR</span></code></dt><dd><p>Directory containing the OCI bundle. This must be <code class="code docutils literal notranslate"><span class="pre">/tmp/buildahYYY</span></code>,
where <code class="code docutils literal notranslate"><span class="pre">YYY</span></code> matches <code class="code docutils literal notranslate"><span class="pre">CONTAINER_ID</span></code> below.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--pid-file</span> <span class="pre">FILE</span></code></dt><dd><p>Filename to write the “container” process PID to. Note that for
Charliecloud, the process given is fake; see above. This must be
<code class="code docutils literal notranslate"><span class="pre">DIR/pid</span></code>, where <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> is given by <code class="code docutils literal notranslate"><span class="pre">--bundle</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--no-new-keyring</span></code></dt><dd><p>Ignored. (Charliecloud does not implement session keyrings.)</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">CONTAINER_ID</span></code></dt><dd><p>String to use as the container ID. This must be
<code class="code docutils literal notranslate"><span class="pre">buildah-buildahYYY</span></code>, where <code class="code docutils literal notranslate"><span class="pre">YYY</span></code> matches <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> above.</p>
</dd>
</dl>
</div></blockquote>
<p>Unsupported arguments:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">--console-socket</span> <span class="pre">PATH</span></code></dt><dd><p>UNIX socket to pass pseudoterminal file descriptor. Charliecloud does not
support pseudoterminals; fail with an error if this argument is given. For
Buildah, redirect its input from <code class="code docutils literal notranslate"><span class="pre">/dev/null</span></code> to prevent it from
requesting a pseudoterminal.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="id27">
<h4><span class="section-number">3.6.3.2. </span><code class="code docutils literal notranslate"><span class="pre">delete</span></code><a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run-oci delete CONTAINER_ID
</pre></div>
</div>
<p>Clean up the OCI-related scaffolding for specified container.</p>
</section>
<section id="kill">
<h4><span class="section-number">3.6.3.3. </span><code class="code docutils literal notranslate"><span class="pre">kill</span></code><a class="headerlink" href="#kill" title="Permalink to this headline">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run-oci <span class="nb">kill</span> CONTAINER_ID
</pre></div>
</div>
<p>No-op.</p>
</section>
<section id="start">
<h4><span class="section-number">3.6.3.4. </span><code class="code docutils literal notranslate"><span class="pre">start</span></code><a class="headerlink" href="#start" title="Permalink to this headline">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run-oci start CONTAINER_ID
</pre></div>
</div>
<p>Eexecute the user command specified at create time in a Charliecloud
container.</p>
</section>
<section id="state">
<h4><span class="section-number">3.6.3.5. </span><code class="code docutils literal notranslate"><span class="pre">state</span></code><a class="headerlink" href="#state" title="Permalink to this headline">¶</a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run-oci state CONTAINER_ID
</pre></div>
</div>
<p>Print the state of the given container on standard output as an OCI compliant
JSON document.</p>
</section>
</section>
<section id="unsupported-oci-features">
<h3><span class="section-number">3.6.4. </span>Unsupported OCI features<a class="headerlink" href="#unsupported-oci-features" title="Permalink to this headline">¶</a></h3>
<p>As noted above, various OCI features are not supported by Charliecloud. We
have tried to guess which features would be essential to callers;
<code class="code docutils literal notranslate"><span class="pre">ch-run-oci</span></code> fails with an error if these are requested. Otherwise, the
request is simply ignored.</p>
<p>We are interested in hearing about scientific-computing use cases for
unsupported features, so we can add support for things that are needed.</p>
<p>Our goal is for this man page to be comprehensive: every OCI runtime feature
should either work or be listed as unsupported.</p>
<p>Unsupported features that are an error:</p>
<blockquote>
<div><ul class="simple">
<li><p>Pseudoterminals</p></li>
<li><p>Hooks (prestart, poststart, and prestop)</p></li>
<li><p>Annotations</p></li>
<li><p>Joining existing namespaces</p></li>
<li><p>Intel Resource Director Technology (RDT)</p></li>
</ul>
</div></blockquote>
<p>Unsupported features that are ignored:</p>
<blockquote>
<div><ul class="simple">
<li><p>Mounts other than the root filesystem (we do use <code class="code docutils literal notranslate"><span class="pre">--no-home</span></code>)</p></li>
<li><p>User/group mappings beyond one user mapped to EUID and one group mapped to
EGID</p></li>
<li><p>Disabling <code class="code docutils literal notranslate"><span class="pre">prctl(PR_SET_NO_NEW_PRIVS)</span></code></p></li>
<li><p>Root filesystem propagation mode</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">sysctl</span></code> directives</p></li>
<li><p>masked and read-only paths (remaining unprivileged protects you)</p></li>
<li><p>Capabilities</p></li>
<li><p>rlimits</p></li>
<li><p>Devices (all devices are inherited from the host)</p></li>
<li><p>cgroups</p></li>
<li><p>seccomp</p></li>
<li><p>SELinux</p></li>
<li><p>AppArmor</p></li>
<li><p>Container hostname setting</p></li>
</ul>
</div></blockquote>
</section>
<section id="id28">
<h3><span class="section-number">3.6.5. </span>Environment variables<a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h3>
<dl>
<dt><code class="code docutils literal notranslate"><span class="pre">CH_LOG_FILE</span></code></dt><dd><p>If set, append log chatter to this file, rather than standard error. This is
useful for debugging situations where standard error is consumed or lost.</p>
<p>Also sets verbose mode if not already set (equivalent to <code class="code docutils literal notranslate"><span class="pre">--verbose</span></code>).</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">CH_LOG_FESTOON</span></code></dt><dd><p>If set, prepend PID and timestamp to logged chatter.</p>
</dd>
</dl>
<p><code class="code docutils literal notranslate"><span class="pre">CH_RUN_OCI_HANG</span></code></p>
<blockquote>
<div><p>If set to the name of a command (e.g., <code class="code docutils literal notranslate"><span class="pre">create</span></code>), sleep indefinitely
when that command is invoked. The purpose here is to halt a build so it can
be examined and debugged.</p>
</div></blockquote>
</section>
</section>
<section id="ch-ssh">
<h2><a class="toc-backref" href="#id43"><span class="section-number">3.7. </span>ch-ssh</a><a class="headerlink" href="#ch-ssh" title="Permalink to this headline">¶</a></h2>
<p>Run a remote command in a Charliecloud container.</p>
<section id="id29">
<h3><span class="section-number">3.7.1. </span>Synopsis<a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nv">CH_RUN_ARGS</span><span class="o">=</span><span class="s2">&quot;NEWROOT [ARG...]&quot;</span>
<span class="gp">$</span> ch-ssh <span class="o">[</span>OPTION...<span class="o">]</span> HOST CMD <span class="o">[</span>ARG...<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="id30">
<h3><span class="section-number">3.7.2. </span>Description<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h3>
<p>Runs command <code class="code docutils literal notranslate"><span class="pre">CMD</span></code> in a Charliecloud container on remote host
<code class="code docutils literal notranslate"><span class="pre">HOST</span></code>. Use the content of environment variable <code class="code docutils literal notranslate"><span class="pre">CH_RUN_ARGS</span></code> as
the arguments to <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> on the remote host.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Words in <code class="code docutils literal notranslate"><span class="pre">CH_RUN_ARGS</span></code> are delimited by spaces only; it is not shell
syntax.</p>
</div>
</section>
<section id="id31">
<h3><span class="section-number">3.7.3. </span>Example<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h3>
<p>On host bar.example.com, run the command <code class="code docutils literal notranslate"><span class="pre">echo</span> <span class="pre">hello</span></code> inside a
Charliecloud container using the unpacked image at <code class="code docutils literal notranslate"><span class="pre">/data/foo</span></code> with
starting directory <code class="code docutils literal notranslate"><span class="pre">/baz</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> hostname
<span class="go">foo</span>
<span class="gp">$</span> <span class="nb">export</span> <span class="nv">CH_RUN_ARGS</span><span class="o">=</span><span class="s1">&#39;--cd /baz /data/foo&#39;</span>
<span class="gp">$</span> ch-ssh bar.example.com -- hostname
<span class="go">bar</span>
</pre></div>
</div>
</section>
</section>
<section id="ch-test">
<h2><a class="toc-backref" href="#id44"><span class="section-number">3.8. </span>ch-test</a><a class="headerlink" href="#ch-test" title="Permalink to this headline">¶</a></h2>
<p>Run some or all of the Charliecloud test suite.</p>
<section id="id32">
<h3><span class="section-number">3.8.1. </span>Synopsis<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-test <span class="o">[</span>PHASE<span class="o">]</span> <span class="o">[</span>--scope SCOPE<span class="o">]</span> <span class="o">[</span>--pack-fmt FMT<span class="o">]</span> <span class="o">[</span>ARGS<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="id33">
<h3><span class="section-number">3.8.2. </span>Description<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h3>
<p>Charliecloud comes with a comprehensive test suite that exercises the
container workflow itself as well as a few example applications.
<code class="code docutils literal notranslate"><span class="pre">ch-test</span></code> coordinates running the test suite.</p>
<p>While the CLI has lots of options, the defaults are reasonable, and bare
<code class="code docutils literal notranslate"><span class="pre">ch-test</span></code> will give useful results in a few minutes on single-node,
internet-connected systems with a few GB available in <code class="code docutils literal notranslate"><span class="pre">/var/tmp</span></code>.</p>
<p>The test suite requires a few GB (standard scope) or tens of GB (full scope)
of storage for test fixtures:</p>
<ul class="simple">
<li><p><em>Builder storage</em> (e.g., layer cache). This goes wherever the builder puts
it.</p></li>
<li><p><em>Packed images directory</em>: image tarballs or SquashFS files.</p></li>
<li><p><em>Unpacked images directory</em>. Images are unpacked into and then run from
here.</p></li>
<li><p><em>Filesystem permissions</em> directories. These are used to test that the
kernel is enforcing permissions correctly. Note that this exercises the
kernel, not Charliecloud, and can be omitted from routine Charliecloud
testing.</p></li>
</ul>
<p>The first three are created when needed if they don’t exist, while the
filesystem permissions fixtures must be created manually, in order to
accommodate configurations where sudo is not available via the same login path
used for running tests.</p>
<p>The packed and unpacked image directories specified for testing are volatile.
The contents of these directories are deleted before the build and run phases,
respectively.</p>
<p>In all four cases, when creating directories, only the final path component is
created. Parent directories must already exist, i.e., <code class="code docutils literal notranslate"><span class="pre">ch-test</span></code> uses the
behavior of <code class="code docutils literal notranslate"><span class="pre">mkdir</span></code> rather than <code class="code docutils literal notranslate"><span class="pre">mkdir</span> <span class="pre">-p</span></code>.</p>
<p>Some of the tests exercise parallel functionality. If <code class="code docutils literal notranslate"><span class="pre">ch-test</span></code> is run
on a single node, multiple cores will be used; if in a Slurm allocation,
multiple nodes too.</p>
<p>The subset of tests to run mostly splits along two key dimensions. The <em>phase</em>
is which parts of the workflow to run. Different parts of the workflow can be
tested on different systems by copying the necessary artifacts between them,
e.g. by building images on one system and running them on another. The <em>scope</em>
allows trading off thoroughness versus time.</p>
<p><code class="code docutils literal notranslate"><span class="pre">PHASE</span></code> must be one of the following:</p>
<blockquote>
<div><dl>
<dt><code class="code docutils literal notranslate"><span class="pre">build</span></code></dt><dd><p>Image building and associated functionality, with the selected builder.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">run</span></code></dt><dd><p>Running containers and associated functionality. This requires a packed
images directory produced by a successful <code class="code docutils literal notranslate"><span class="pre">build</span></code> phase, which can
be copied from the build system if it’s not also the run system.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">examples</span></code></dt><dd><p>Example applications. Requires an unpacked images directory produced by a
successful <code class="code docutils literal notranslate"><span class="pre">run</span></code> phase.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">all</span></code></dt><dd><p>Execute phases <code class="code docutils literal notranslate"><span class="pre">build</span></code>, <code class="code docutils literal notranslate"><span class="pre">run</span></code>, and <code class="code docutils literal notranslate"><span class="pre">examples</span></code>, in that
order.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">mk-perm-dirs</span></code></dt><dd><p>Create the filesystem permissions directories. Requires
<code class="code docutils literal notranslate"><span class="pre">--perm-dirs</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">clean</span></code></dt><dd><p>Delete automatically-generated test files, and packed and unpacked image
directories.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">rm-perm-dirs</span></code></dt><dd><p>Remove the filesystem permissions directories. Requires
<code class="code docutils literal notranslate"><span class="pre">--perm-dirs</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-f</span></code>, <code class="code docutils literal notranslate"><span class="pre">--file</span> <span class="pre">FILE[:TEST]</span></code></dt><dd><p>Run the tests in the given file only, which can be an arbitrary
<code class="code docutils literal notranslate"><span class="pre">.bats</span></code> file, except for <code class="code docutils literal notranslate"><span class="pre">test.bats</span></code> under <code class="code docutils literal notranslate"><span class="pre">examples</span></code>,
where you must specify the corresponding Dockerfile or <code class="code docutils literal notranslate"><span class="pre">Build</span></code> file
instead. This is somewhat brittle and typically used for development or
debugging. For example, it does not check whether the pre-requisites of
whatever is in the file are satisfied. Often running <code class="code docutils literal notranslate"><span class="pre">build</span></code> and
<code class="code docutils literal notranslate"><span class="pre">run</span></code> first is sufficient, but this varies.</p>
<p>If <code class="code docutils literal notranslate"><span class="pre">TEST</span></code> is also given, then run only tests with name containing
that string, skipping the others. The separator is a literal colon. If the
string contains shell metacharacters such as space, you’ll need to quote
the argument to protect it from the shell.</p>
</dd>
</dl>
</div></blockquote>
<p>Scope is specified with:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">-s</span></code>, <code class="code docutils literal notranslate"><span class="pre">--scope</span> <span class="pre">SCOPE</span></code></dt><dd><p><code class="code docutils literal notranslate"><span class="pre">SCOPE</span></code> must be one of the following:</p>
<ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">quick</span></code>: Most important subset of workflow. Handy for development.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">standard</span></code>: All tested workflow functionality and a selection of
more important examples. (Default.)</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">full</span></code>: All available tests, including all examples.</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<p>Image format is specified with:</p>
<blockquote>
<div><dl>
<dt><code class="code docutils literal notranslate"><span class="pre">--pack-fmt</span> <span class="pre">FMT</span></code></dt><dd><p><code class="code docutils literal notranslate"><span class="pre">FMT</span></code> must be one of the following:</p>
<ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">squash-mount</span></code> or 🐘: SquashFS archive, run directly from the
archive using <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code>’s internal SquashFUSE functionality. In
this mode, tests that require writing to the image are skipped.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">tar-unpack</span></code> or 📠: Tarball, and the images are unpacked before
running.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">squash-unpack</span></code> or 🎃: SquashFS, and the images are unpacked
before running.</p></li>
</ul>
<p>Default: <code class="code docutils literal notranslate"><span class="pre">$CH_TEST_PACK_FMT</span></code> if set. Otherwise, if
<code class="code docutils literal notranslate"><span class="pre">mksquashfs(1)</span></code> is available and <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code> was built with
<code class="code docutils literal notranslate"><span class="pre">libsquashfuse</span></code> support, then <code class="code docutils literal notranslate"><span class="pre">squash-mount</span></code>, else
<code class="code docutils literal notranslate"><span class="pre">tar-unpack</span></code>.</p>
</dd>
</dl>
</div></blockquote>
<p>Additional arguments:</p>
<blockquote>
<div><dl>
<dt><code class="code docutils literal notranslate"><span class="pre">-b</span></code>, <code class="code docutils literal notranslate"><span class="pre">--builder</span> <span class="pre">BUILDER</span></code></dt><dd><p>Image builder to use. Default: <code class="code docutils literal notranslate"><span class="pre">$CH_TEST_BUILDER</span></code> if set, otherwise
<code class="code docutils literal notranslate"><span class="pre">ch-image</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--dry-run</span></code></dt><dd><p>Print summary of what would be tested and then exit.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">-h</span></code>, <code class="code docutils literal notranslate"><span class="pre">--help</span></code></dt><dd><p>Print usage and then exit.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--img-dir</span> <span class="pre">DIR</span></code></dt><dd><p>Set unpacked images directory to <code class="code docutils literal notranslate"><span class="pre">DIR</span></code>. In a multi-node allocation,
this directory may not be shared between nodes. Default:
<code class="code docutils literal notranslate"><span class="pre">$CH_TEST_IMGDIR</span></code> if set; otherwise <code class="code docutils literal notranslate"><span class="pre">/var/tmp/img</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--lustre</span> <span class="pre">DIR</span></code></dt><dd><p>Use <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> for run-phase Lustre tests. Default:
<code class="code docutils literal notranslate"><span class="pre">CH_TEST_LUSTREDIR</span></code> if set; otherwise skip them.</p>
<p>The tests will create, populate, and delete a new subdirectory under
<code class="code docutils literal notranslate"><span class="pre">DIR</span></code>, leaving everything else in <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> untouched.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--pack-dir</span> <span class="pre">DIR</span></code></dt><dd><p>Set packed images directory to <code class="code docutils literal notranslate"><span class="pre">DIR</span></code>. Default:
<code class="code docutils literal notranslate"><span class="pre">$CH_TEST_TARDIR</span></code> if set; otherwise <code class="code docutils literal notranslate"><span class="pre">/var/tmp/pack</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--pedantic</span> <span class="pre">(yes|no)</span></code></dt><dd><p>Some tests require configurations that are very specific (e.g., being a
member of at least two groups) or unusual (e.g., sudo to a non-root
group). If <code class="code docutils literal notranslate"><span class="pre">yes</span></code>, then fail if the requirement is not met; if
<code class="code docutils literal notranslate"><span class="pre">no</span></code>, then skip. The default is <code class="code docutils literal notranslate"><span class="pre">yes</span></code> for CI environments or
people listed in <code class="code docutils literal notranslate"><span class="pre">README.md</span></code>, <code class="code docutils literal notranslate"><span class="pre">no</span></code> otherwise.</p>
<p>If <code class="code docutils literal notranslate"><span class="pre">yes</span></code> and sudo seems to be available, implies <code class="code docutils literal notranslate"><span class="pre">--sudo</span></code>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--perm-dir</span> <span class="pre">DIR</span></code></dt><dd><p>Add <code class="code docutils literal notranslate"><span class="pre">DIR</span></code> to filesystem permission fixture directories; can be
specified multiple times. We recommend one such directory per mounted
filesystem type whose kernel module you do not trust; e.g., you probably
don’t need to test your <code class="code docutils literal notranslate"><span class="pre">tmpfs</span></code>es, but out-of-tree filesystems very
likely need this.</p>
<p>Implies <code class="code docutils literal notranslate"><span class="pre">--sudo</span></code>. Default: <code class="code docutils literal notranslate"><span class="pre">CH_TEST_PERMDIRS</span></code> if set;
otherwise skip the filesystem permissions tests.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">--sudo</span></code></dt><dd><p>Enable things that require sudo, such as certain privilege escalation
tests and creating/removing the filesystem permissions fixtures. Requires
generic <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> capabilities. Note that the Docker builder uses
<code class="code docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">docker</span></code> even without this option.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="id34">
<h3><span class="section-number">3.8.3. </span>Exit status<a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h3>
<p>Zero if all tests passed; non-zero if any failed. For setup and teardown
phases, zero if everything was created or deleted correctly, non-zero
otherwise.</p>
</section>
<section id="id35">
<h3><span class="section-number">3.8.4. </span>Bugs<a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h3>
<p>Bats will wait until all descendant processes finish before exiting, so if you
get into a failure mode where a test sequence doesn’t clean up all its
processes, <code class="code docutils literal notranslate"><span class="pre">ch-test</span></code> will hang.</p>
</section>
<section id="id36">
<h3><span class="section-number">3.8.5. </span>Examples<a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h3>
<p>Many systems can simply use the defaults. To run the <code class="code docutils literal notranslate"><span class="pre">build</span></code>,
<code class="code docutils literal notranslate"><span class="pre">run</span></code>, and <code class="code docutils literal notranslate"><span class="pre">examples</span></code> phases on a single system, without the
filesystem permissions tests:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-test
<span class="go">ch-test version 0.12</span>

<span class="go">ch-run: 0.12 /usr/local/bin/ch-run</span>
<span class="go">bats:   0.4.0 /usr/bin/bats</span>
<span class="go">tests:  /usr/local/libexec/charliecloud/test</span>

<span class="go">phase:                build run examples</span>
<span class="go">scope:                standard (default)</span>
<span class="go">builder:              docker (default)</span>
<span class="go">use generic sudo:     no (default)</span>
<span class="go">unpacked images dir:  /var/tmp/img (default)</span>
<span class="go">packed images dir:    /var/tmp/tar (default)</span>
<span class="go">fs permissions dirs:  skip (default)</span>

<span class="go">checking namespaces ...</span>
<span class="go">ok</span>

<span class="go">checking builder ...</span>
<span class="go">found: /usr/bin/docker 19.03.2</span>

<span class="go">bats build.bats build_auto.bats build_post.bats</span>
<span class="go"> ✓ documentation seems sane</span>
<span class="go"> ✓ version number seems sane</span>
<span class="go">[...]</span>
<span class="go">All tests passed.</span>
</pre></div>
</div>
<p>The next example is for a more complex setup like you might find in HPC
centers:</p>
<blockquote>
<div><ul class="simple">
<li><p>Non-default fixture directories.</p></li>
<li><p>Non-default scope.</p></li>
<li><p>Different build and run systems.</p></li>
<li><p>Run the filesystem permissions tests.</p></li>
</ul>
</div></blockquote>
<p>Output has been omitted.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(mybox)</span><span class="gp">$</span> ssh hpc-admin
<span class="gp gp-VirtualEnv">(hpc-admin)</span><span class="gp">$</span> ch-test mk-perm-dirs --perm-dir /scratch/<span class="nv">$USER</span>/perms <span class="se">\</span>
                                  --perm-dir /home/<span class="nv">$USER</span>/perms
<span class="gp gp-VirtualEnv">(hpc-admin)</span><span class="gp">$</span> <span class="nb">exit</span>
<span class="gp gp-VirtualEnv">(mybox)</span><span class="gp">$</span> ch-test build --scope full
<span class="gp gp-VirtualEnv">(mybox)</span><span class="gp">$</span> scp -r /var/tmp/pack hpc:/scratch/<span class="nv">$USER</span>/pack
<span class="gp gp-VirtualEnv">(mybox)</span><span class="gp">$</span> ssh hpc
<span class="gp gp-VirtualEnv">(hpc)</span><span class="gp">$</span> salloc -N2
<span class="gp gp-VirtualEnv">(cn001)</span><span class="gp">$</span> <span class="nb">export</span> <span class="nv">CH_TEST_TARDIR</span><span class="o">=</span>/scratch/<span class="nv">$USER</span>/pack
<span class="gp gp-VirtualEnv">(cn001)</span><span class="gp">$</span> <span class="nb">export</span> <span class="nv">CH_TEST_IMGDIR</span><span class="o">=</span>/local/tmp
<span class="gp gp-VirtualEnv">(cn001)</span><span class="gp">$</span> <span class="nb">export</span> <span class="nv">CH_TEST_PERMDIRS</span><span class="o">=</span><span class="s2">&quot;/scratch/</span><span class="nv">$USER</span><span class="s2">/perms /home/</span><span class="nv">$USER</span><span class="s2">/perms&quot;</span>
<span class="gp gp-VirtualEnv">(cn001)</span><span class="gp">$</span> <span class="nb">export</span> <span class="nv">CH_TEST_SCOPE</span><span class="o">=</span>full
<span class="gp gp-VirtualEnv">(cn001)</span><span class="gp">$</span> ch-test run
<span class="gp gp-VirtualEnv">(cn001)</span><span class="gp">$</span> ch-test examples
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tutorial.html" class="btn btn-neutral float-left" title="2. Tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="faq.html" class="btn btn-neutral float-right" title="4. Frequently asked questions (FAQ)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2014–2022, Triad National Security, LLC and others.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
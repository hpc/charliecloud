#!/bin/sh

set -e

libexec="$(cd "$(dirname "$0")" && pwd)"
. "${libexec}/base.sh"

# shellcheck disable=SC2034
usage=$(cat <<EOF
Pack a filesystem directory into a SquashFS file.

Usage:

  $ $(basename "$0") INDIR OUTDIR [ARGS ...]

ARGS are passed unchanged to mksquashfs.
EOF
)

sentinel=WEIRD_AL_YANKOVIC

parse_basic_args "$@"

if [ $# -lt 2 ]; then
    usage
fi

indir=$1
outdir=$2
shift 2

# Check input directory exists
if [ ! -e "$indir" ]; then
    echo "can't squash: ${indir} does not exist" 1>&2
    exit 1
fi
# Check input directory is a directory
if [ ! -d "$indir" ]; then
    echo "can't squash: ${indir} is not a directory" 1>&2
    exit 1
fi

# Check OUTDIR exists and is a directory
if [ ! -e "$outdir" ]; then
    echo "can't squash: ${outdir} does not exist" 1>&2
    exit 1
fi
if [ ! -d "$outdir" ]; then
    echo "can't squash: ${outdir} is not a directory" 1>&2
    exit 1
fi

# Ensure directories that ch-run needs exist.
temp=$(mktemp -d --tmpdir ch-dir2squash.XXXXXX)
echo 'This directory is a Charliecloud image.' > "${temp}/${sentinel}"
mkdir -p "${temp}/dev" "${temp}/etc" "${temp}/proc" "${temp}/sys"
touch "${temp}/etc/hosts" "${temp}/etc/resolv.conf"
for i in $(seq 0 9); do mkdir -p "${temp}/mnt/${i}"; done

# Create SquashFS file
image=$(basename "${indir}")
mksquashfs "${indir}" "${outdir}/${image}.sqfs" -noappend "$@"
ls -lh "${outdir}/${image}.sqfs"

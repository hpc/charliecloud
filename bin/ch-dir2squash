#!/bin/sh

set -e

libexec="$(cd "$(dirname "$0")" && pwd)"
. "${libexec}/base.sh"

# shellcheck disable=SC2034
usage=$(cat <<EOF
Pack a filesystem directory into a SquashFS file.

Usage:

  $ $(basename "$0") INDIR OUTDIR [ARGS ...]

ARGS are passed unchanged to "mksquashfs".
EOF
)

sentinel=WEIRD_AL_YANKOVIC

parse_basic_args "$@"

if [ $# -lt 2 ]; then
    usage
fi

indir=$1
outdir=$2
shift 2

# Check input directory exists
if [ ! -e "$indir" ]; then
    echo "can't squash: ${indir} does not exist" 1>&2
    exit 1
fi
# Check input directory is a directory
if [ ! -d "$indir" ]; then
    echo "can't squash: ${indir} is not a directory" 1>&2
    exit 1
fi

# Check OUTDIR exists and is a directory
if [ ! -e "$outdir" ]; then
    echo "can't squash: ${outdir} does not exist" 1>&2
    exit 1
fi
if [ ! -d "$outdir" ]; then
    echo "can't squash: ${outdir} is not a directory" 1>&2
    exit 1
fi

# Ensure directories that ch-run needs exist.
echo 'This directory is a Charliecloud image.' > "${indir}/${sentinel}"
mkdir -p "${indir}/dev" "${indir}/etc" "${indir}/proc" "${indir}/sys"
touch "${indir}/etc/hosts" "${indir}/etc/resolv.conf"
for i in $(seq 0 9); do mkdir -p "${indir}/mnt/${i}"; done

# Create SquashFS file
image=$(basename "${indir}")
mksquashfs "${indir}" "${outdir}/${image}.sqfs" -noappend "$@"
echo "squashed ${outdir}/${image}.sqfs OK"

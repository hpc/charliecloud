#!/bin/sh

libexec="$(cd "$(dirname "$0")" && pwd)"
. "${libexec}/base.sh"

# shellcheck disable=SC2034
usage=$(cat <<EOF
Flatten a Docker image into a Charliecloud image tarball.

Usage:

  $ $(basename "$0") IMAGE OUTDIR

You must have sufficient privilege (via sudo) to run the Docker commands.
EOF
)

parse_basic_args "$@"

if [ "$#" -ne 2 ]; then
    usage
fi

image=$1
outdir=$2
tar="$outdir"/$(echo "$image" | sed 's/\//./g').tar

cid=$(docker_ create --read-only "$image")
#docker_ ps -af "id=$cid"
docker_ export "$cid" > "${tar}"
docker_ rm "$cid" > /dev/null
docker_ inspect "$image" --format='{{range .Config.Env}}{{println .}}{{end}}' > docker-env
tar cf docker-env.tar docker-env
rm docker-env
tar --concatenate --file=docker-env.tar "$tar"
mv docker-env.tar "$tar"
gzip_ -6 -f "$tar"
ls -lh "${tar}.gz"

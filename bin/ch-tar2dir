#!/bin/sh

set -e

libexec="$(cd "$(dirname "$0")" && pwd)"
. "${libexec}/base.sh"

# shellcheck disable=SC2034
usage=$(cat <<EOF
Unpack a Docker export tarball into a directory.

Usage:

  $ $(basename "$0") TARBALL DIR
EOF
)

parse_basic_args "$@"

if [ "$1" = --verbose ]; then
    verbose=yes
    shift
fi
if [ $# -lt 2 ]; then
    usage
fi
tarball=$1
newroot=${2}/$(basename "${tarball%.tar.gz}")

sentinel=WEIRD_AL_YANKOVIC

# Is the tarball a regular file (or symlink) and readable?
if [ ! -f "$tarball" ] || [ ! -r "$tarball" ]; then
    echo "can't read ${tarball}" 1>&2
    exit 1
fi

if [ ! -d "$newroot" ]; then
    echo "creating new image ${newroot}"
else
    if    [ -f "${newroot}/${sentinel}" ] \
       && [ -d "${newroot}/bin" ] \
       && [ -d "${newroot}/lib" ] \
       && [ -d "${newroot}/usr" ]; then
        echo "replacing existing image ${newroot}" 1>&2
        rm -Rf --one-file-system "${newroot}"
    else
        echo "${newroot} exists but does not appear to be an image" 1>&2
        exit 1
    fi
fi

mkdir "$newroot"
# Use a pipe because PV ignores arguments if it's cat rather than PV.
#
# See FAQ on /dev exclusion. --no-wildcards-match-slash is needed to prevent *
# matching multiple directories; the tar default differs from sh behavior.
size=$(stat -c%s "$tarball")
  pv_ -s "$size" < "$tarball" \
| gzip_ -dc \
| tar x$verbose -C "$newroot" -f - \
      --anchored --no-wildcards-match-slash \
      --exclude='dev/*' --exclude='*/dev/*'
# Make all directories writeable so we can delete image later (hello, Red Hat).
find "$newroot" -type d -a ! -perm /200 -exec chmod u+w {} +

# If tarball had a single containing directory, move the contents up a level
# and remove the containing directory. It is non-trivial in POSIX sh to deal
# with hidden files; see https://unix.stackexchange.com/a/6397.
files=$(ls -Aq "$newroot")
if [ "$(echo "$files" | wc -l)" -eq 1 ]; then
    ( cd "${newroot}/${files}"
      for f in * .[!.]* ..?*; do
          [ -e "$f" ] && mv -- "$f" ..
      done )
    rmdir "${newroot}/${files}"
fi

# Ensure directories that ch-run needs exist.
echo 'This directory is a Charliecloud image.' > "${newroot}/${sentinel}"
mkdir -p "${newroot}/dev"
for i in $(seq 0 9); do mkdir -p "${newroot}/mnt/${i}"; done

echo "${newroot} unpacked ok"

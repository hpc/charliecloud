#!/bin/sh

libexec="$(cd "$(dirname "$0")" && pwd)"
. "${libexec}/base.sh"

# shellcheck disable=SC2034
usage=$(cat <<EOF
Build a Charliecloud image and unpack it into a directory in one command.

Usage:

  $ $(basename "$0") -t TAG [ARGS ...] CONTEXT OUTDIR

ARGS are passed unchanged to "ch-build".
EOF
)

parse_basic_args "$@"

if [ "$#" -lt 4 ]; then
    usage
fi
if [ "$1" ~!= -t ]; then
    usage
fi

tag=$2
context=$3
dest=$4

context=$1
dest=$2
shift 2

tag=$(basename "$PWD")

set -x

"${ch_bin}"/ch-build -t "$tag" "$context" "$@"
"${ch_bin}"/ch-docker2tar "$tag" "$dest"
"${ch_bin}"/ch-tar2dir "${dest}/${tag}.tar.gz" "$dest"
rm "${dest}/${tag}.tar.gz"

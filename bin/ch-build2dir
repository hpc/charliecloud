#!/bin/bash

libexec="$(cd "$(dirname "$0")" && pwd)"
. "${libexec}/base.sh"

# shellcheck disable=SC2034
usage=$(cat <<EOF
Build a Charliecloud image and unpack it into a directory in one command.

Usage:

  $ $(basename "$0") -t TAG [ARGS ...] CONTEXT OUTDIR

ARGS are passed unchanged to "ch-build".
EOF
)

parse_basic_args "$@"

[[ "$#" -gt 3 ]] || usage

# FIXME: the following block of code only works with bash. All of our utility
# scripts are POSIX sh.

args=("${@:1:$#-1}") # all but last arg
dest="${*: -1}"    # last arg
while [[ "$#" -gt 0 ]]; do
    opt=$1; shift
    case "$opt" in
       --tag|-t)
            tag="$1"
            ;;
    esac
done

set -x
"${ch_bin}"/ch-build "${args[@]}"
"${ch_bin}"/ch-docker2tar "$tag" "$dest"
"${ch_bin}"/ch-tar2dir "${dest}/${tag}.tar.gz" "$dest"

# FIXME: removing the tarball artifact will cause make-auto to break
# rm "${dest}/${tag}.tar.gz"
